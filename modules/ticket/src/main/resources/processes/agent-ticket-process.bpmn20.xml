<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:flowable="http://flowable.org/bpmn"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    targetNamespace="BytedeskTicket">

    <process id="agentTicketProcess" name="Agent Ticket Process" isExecutable="true">
        <startEvent id="start" name="Create Ticket"/>
        
        <!-- Priority Evaluation -->
        <sequenceFlow sourceRef="start" targetRef="evaluatePriority"/>
        <businessRuleTask id="evaluatePriority" name="Evaluate Priority"
            flowable:decisionRef="ticketPriorityRules"/>
            
        <!-- Assign to Agent -->
        <sequenceFlow sourceRef="evaluatePriority" targetRef="assignToAgent"/>
        <userTask id="assignToAgent" name="Agent Handle" flowable:assignee="${agentUid}">
            <documentation>Assigned agent handles the ticket</documentation>
            <extensionElements>
                <flowable:formProperty id="solution" name="Solution" type="string" required="true"/>
                <flowable:formProperty id="status" name="Status" type="enum">
                    <flowable:value id="resolved" name="Resolved"/>
                    <flowable:value id="pending" name="Pending"/>
                    <flowable:value id="escalated" name="Escalated"/>
                </flowable:formProperty>
            </extensionElements>
        </userTask>
        
        <!-- SLA Monitor -->
        <boundaryEvent id="slaTimer" attachedToRef="assignToAgent">
            <timerEventDefinition>
                <timeDuration>${slaTime}</timeDuration>
            </timerEventDefinition>
        </boundaryEvent>
        <sequenceFlow sourceRef="slaTimer" targetRef="slaNotification"/>
        <serviceTask id="slaNotification" name="SLA Timeout Notification"
            flowable:class="com.bytedesk.ticket.delegate.SLANotificationDelegate"/>
        <sequenceFlow sourceRef="slaNotification" targetRef="escalateTicket"/>
        
        <!-- Ticket Escalation -->
        <serviceTask id="escalateTicket" name="Escalate Ticket"
            flowable:class="com.bytedesk.ticket.delegate.TicketEscalationDelegate"/>
        <sequenceFlow sourceRef="escalateTicket" targetRef="supervisorHandle"/>
        
        <!-- Supervisor Handle -->
        <userTask id="supervisorHandle" name="Supervisor Handle" flowable:candidateGroups="supervisors">
            <documentation>Supervisor handles escalated ticket</documentation>
        </userTask>
        <sequenceFlow sourceRef="supervisorHandle" targetRef="assignToAgent"/>
        
        <!-- Customer Verification -->
        <sequenceFlow sourceRef="assignToAgent" targetRef="customerVerify"/>
        <userTask id="customerVerify" name="Customer Verify" flowable:assignee="${creator}">
            <documentation>Customer verifies if the issue is resolved</documentation>
            <extensionElements>
                <flowable:formProperty id="satisfied" name="Satisfied" type="boolean" required="true"/>
                <flowable:formProperty id="comment" name="Comment" type="string"/>
            </extensionElements>
        </userTask>
        
        <!-- Satisfaction Survey -->
        <sequenceFlow sourceRef="customerVerify" targetRef="satisfactionSurvey"/>
        <userTask id="satisfactionSurvey" name="Satisfaction Survey" flowable:assignee="${creator}">
            <extensionElements>
                <flowable:formProperty id="rating" name="Rating" type="enum">
                    <flowable:value id="5" name="Very Satisfied"/>
                    <flowable:value id="4" name="Satisfied"/>
                    <flowable:value id="3" name="Neutral"/>
                    <flowable:value id="2" name="Dissatisfied"/>
                    <flowable:value id="1" name="Very Dissatisfied"/>
                </flowable:formProperty>
                <flowable:formProperty id="feedback" name="Feedback" type="string"/>
            </extensionElements>
        </userTask>
        
        <sequenceFlow sourceRef="satisfactionSurvey" targetRef="end"/>
        <endEvent id="end" name="End Ticket"/>
    </process>
</definitions> 