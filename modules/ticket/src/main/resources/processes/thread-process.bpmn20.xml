<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:flowable="http://flowable.org/bpmn" targetNamespace="BytedeskThread" exporter="Flowable Open Source Modeler" exporterVersion="6.8.0">
  <process id="threadProcess" name="会话流程" isExecutable="true">
    <extensionElements>
      <flowable:executionListener event="start" delegateExpression="${threadExecutionListener}" />
      <flowable:executionListener event="end" delegateExpression="${threadExecutionListener}" />
    </extensionElements>
    <startEvent id="start" name="访客发起会话" flowable:formFieldValidation="true" />
    <exclusiveGateway id="isRobotEnabled" name="机器人接待?" />
    <sequenceFlow id="flow1" sourceRef="start" targetRef="isRobotEnabled" />
    <serviceTask id="robotService" name="机器人接待" flowable:delegateExpression="${threadRobotServiceDelegate}" />
    <serviceTask id="robotIdleTimeoutService" name="访客超时未发消息" flowable:delegateExpression="${threadRobotIdleTimeoutServiceDelegate}" />
    <sequenceFlow id="flowRobotTimeoutToEnd" sourceRef="robotIdleTimeoutService" targetRef="end" />
    <sequenceFlow id="flow2" sourceRef="isRobotEnabled" targetRef="robotService">
      <conditionExpression xsi:type="tFormalExpression">${robotEnabled == true}</conditionExpression>
    </sequenceFlow>
    <exclusiveGateway id="transferToHuman" name="是否转人工?" />
    <sequenceFlow id="flow3" sourceRef="robotService" targetRef="transferToHuman" />
    <sequenceFlow id="flow4" sourceRef="transferToHuman" targetRef="robotService">
      <conditionExpression xsi:type="tFormalExpression">${needHumanService == false}</conditionExpression>
    </sequenceFlow>
    <exclusiveGateway id="isAgentsBusy" name="坐席繁忙?" />
    <sequenceFlow id="flow5" sourceRef="transferToHuman" targetRef="isAgentsOnline">
      <conditionExpression xsi:type="tFormalExpression">${needHumanService == true}</conditionExpression>
    </sequenceFlow>
    <exclusiveGateway id="isAgentsOnline" name="坐席在线?" />
    <sequenceFlow id="flow6" sourceRef="isRobotEnabled" targetRef="isAgentsOnline">
      <conditionExpression xsi:type="tFormalExpression">${robotEnabled == false}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow17" sourceRef="isAgentsOnline" targetRef="isAgentsBusy">
      <conditionExpression xsi:type="tFormalExpression">${agentsOnline == true}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow18" sourceRef="isAgentsOnline" targetRef="end">
      <conditionExpression xsi:type="tFormalExpression">${agentsOnline == false}</conditionExpression>
    </sequenceFlow>
    <serviceTask id="queueService" name="排队等待" flowable:delegateExpression="${threadQueueServiceDelegate}" />
    <sequenceFlow id="flow7" sourceRef="isAgentsBusy" targetRef="queueService">
      <conditionExpression xsi:type="tFormalExpression">${agentsBusy == true}</conditionExpression>
    </sequenceFlow>
    <userTask id="humanService" name="人工接待" flowable:candidateGroups="${agentGroupId}" flowable:formFieldValidation="true">
      <documentation>客服人员接待访客</documentation>
      <extensionElements>
        <flowable:formProperty id="threadUid" name="会话ID" type="string" required="true" />
        <flowable:formProperty id="status" name="状态" type="enum" required="true">
          <flowable:value id="ACTIVE" name="接待中" />
          <flowable:value id="TRANSFER" name="需要转接" />
          <flowable:value id="INVITE" name="邀请协助" />
          <flowable:value id="RESOLVED" name="已解决" />
        </flowable:formProperty>
        <flowable:executionListener event="start" delegateExpression="${threadExecutionListener}" />
        <flowable:executionListener event="end" delegateExpression="${threadExecutionListener}" />
        <flowable:taskListener event="create" delegateExpression="${threadTaskListener}" />
        <flowable:taskListener event="assignment" delegateExpression="${threadTaskListener}" />
        <flowable:taskListener event="complete" delegateExpression="${threadTaskListener}" />
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow8" sourceRef="queueService" targetRef="humanService" />
    <sequenceFlow id="flow9" sourceRef="isAgentsBusy" targetRef="humanService">
      <conditionExpression xsi:type="tFormalExpression">${agentsBusy == false}</conditionExpression>
    </sequenceFlow>
    <boundaryEvent id="slaTimer" cancelActivity="false" attachedToRef="humanService">
      <timerEventDefinition>
        <timeDuration>${slaTime}</timeDuration>
      </timerEventDefinition>
    </boundaryEvent>
    <serviceTask id="slaNotification" name="SLA超时通知" flowable:delegateExpression="${threadSLATimeoutNotificationDelegate}" />
    <sequenceFlow id="flow10" sourceRef="slaTimer" targetRef="slaNotification" />
    <serviceTask id="transferService" name="转接服务" flowable:delegateExpression="${threadTransferServiceDelegate}" />
    <sequenceFlow id="flow12" sourceRef="transferService" targetRef="humanService" />
    <serviceTask id="inviteService" name="邀请协助" flowable:delegateExpression="${threadInviteServiceDelegate}" />
    <sequenceFlow id="flow13" sourceRef="humanService" targetRef="inviteService">
      <conditionExpression xsi:type="tFormalExpression">${status == 'INVITE'}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow14" sourceRef="inviteService" targetRef="humanService" />
    <userTask id="satisfactionSurvey" name="满意度评价" flowable:assignee="${visitorId}" flowable:formFieldValidation="true">
      <documentation>访客填写满意度评价</documentation>
      <extensionElements>
        <flowable:formProperty id="threadUid" name="会话ID" type="string" required="true" />
        <flowable:formProperty id="satisfaction" name="满意度" type="enum" required="true">
          <flowable:value id="VERY_SATISFIED" name="非常满意" />
          <flowable:value id="SATISFIED" name="满意" />
          <flowable:value id="NEUTRAL" name="一般" />
          <flowable:value id="UNSATISFIED" name="不满意" />
          <flowable:value id="VERY_UNSATISFIED" name="非常不满意" />
        </flowable:formProperty>
        <flowable:formProperty id="resolved" name="问题是否解决" type="boolean" required="true" />
        <flowable:formProperty id="comment" name="备注" type="string" />
        <flowable:executionListener event="end" delegateExpression="${threadExecutionListener}" />
        <modeler:initiator-can-complete xmlns:modeler="http://flowable.org/modeler">false</modeler:initiator-can-complete>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow15" sourceRef="humanService" targetRef="satisfactionSurvey">
      <conditionExpression xsi:type="tFormalExpression">${status == 'RESOLVED'}</conditionExpression>
    </sequenceFlow>
    <endEvent id="end" name="会话结束" />
    <sequenceFlow id="flow16" sourceRef="satisfactionSurvey" targetRef="end" />
    <sequenceFlow id="flow11" sourceRef="humanService" targetRef="transferService">
      <conditionExpression xsi:type="tFormalExpression">${status == 'TRANSFER'}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flowRobotTimeout" sourceRef="robotIdleTimer" targetRef="robotIdleTimeoutService" />
    <boundaryEvent id="robotIdleTimer" attachedToRef="robotService">
      <timerEventDefinition>
        <timeDuration>${robotIdleTimeout}</timeDuration>
      </timerEventDefinition>
    </boundaryEvent>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_threadProcess">
    <bpmndi:BPMNPlane id="BPMNPlane_threadProcess" bpmnElement="threadProcess">
      <bpmndi:BPMNShape id="BPMNShape_start" bpmnElement="start">
        <omgdc:Bounds x="100" y="215" width="30" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_isRobotEnabled" bpmnElement="isRobotEnabled" isMarkerVisible="true">
        <omgdc:Bounds x="180" y="210" width="40" height="40" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_robotService" bpmnElement="robotService">
        <omgdc:Bounds x="270" y="120" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_robotIdleTimeoutService" bpmnElement="robotIdleTimeoutService">
        <omgdc:Bounds x="410" y="15" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_transferToHuman" bpmnElement="transferToHuman" isMarkerVisible="true">
        <omgdc:Bounds x="420" y="130" width="40" height="40" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_isAgentsBusy" bpmnElement="isAgentsBusy" isMarkerVisible="true">
        <omgdc:Bounds x="320" y="210" width="40" height="40" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_isAgentsOnline" bpmnElement="isAgentsOnline" isMarkerVisible="true">
        <omgdc:Bounds x="250" y="210" width="40" height="40" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_queueService" bpmnElement="queueService">
        <omgdc:Bounds x="410" y="375" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_humanService" bpmnElement="humanService">
        <omgdc:Bounds x="520" y="200" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_slaNotification" bpmnElement="slaNotification">
        <omgdc:Bounds x="410" y="285" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_transferService" bpmnElement="transferService">
        <omgdc:Bounds x="680" y="120" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_inviteService" bpmnElement="inviteService">
        <omgdc:Bounds x="690" y="300" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_satisfactionSurvey" bpmnElement="satisfactionSurvey">
        <omgdc:Bounds x="680" y="200" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_end" bpmnElement="end">
        <omgdc:Bounds x="830" y="216" width="28" height="28" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="868" y="223" width="44" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_robotIdleTimer" bpmnElement="robotIdleTimer">
        <omgdc:Bounds x="272.58939309745017" y="104.36220459203628" width="31" height="31" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_slaTimer" bpmnElement="slaTimer">
        <omgdc:Bounds x="560.5" y="245.5" width="31" height="31" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="BPMNEdge_flow1" bpmnElement="flow1" flowable:sourceDockerX="15.0" flowable:sourceDockerY="15.0" flowable:targetDockerX="20.0" flowable:targetDockerY="20.0">
        <omgdi:waypoint x="129.9499974717603" y="230" />
        <omgdi:waypoint x="180" y="230" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flowRobotTimeoutToEnd" bpmnElement="flowRobotTimeoutToEnd" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="14.0" flowable:targetDockerY="14.0">
        <omgdi:waypoint x="509.9499999999504" y="45" />
        <omgdi:waypoint x="844" y="45" />
        <omgdi:waypoint x="844" y="216" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow2" bpmnElement="flow2" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="200" y="210" />
        <omgdi:waypoint x="200" y="150" />
        <omgdi:waypoint x="269.9999999999097" y="150" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow3" bpmnElement="flow3" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="20.0" flowable:targetDockerY="20.0">
        <omgdi:waypoint x="369.9499999999756" y="150" />
        <omgdi:waypoint x="420" y="150" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow4" bpmnElement="flow4" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="440" y="130" />
        <omgdi:waypoint x="440" y="100" />
        <omgdi:waypoint x="320" y="100" />
        <omgdi:waypoint x="320" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow5" bpmnElement="flow5" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="20.0" flowable:targetDockerY="20.0">
        <omgdi:waypoint x="440" y="169.9251246882793" />
        <omgdi:waypoint x="440" y="190" />
        <omgdi:waypoint x="270" y="190" />
        <omgdi:waypoint x="270" y="210" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow6" bpmnElement="flow6" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="20.0" flowable:targetDockerY="20.0">
        <omgdi:waypoint x="219.9357703281027" y="230" />
        <omgdi:waypoint x="250" y="230" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow17" bpmnElement="flow17" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="20.0" flowable:targetDockerY="20.0">
        <omgdi:waypoint x="289.9357703281027" y="230" />
        <omgdi:waypoint x="320" y="230" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow18" bpmnElement="flow18" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="14.0" flowable:targetDockerY="14.0">
        <omgdi:waypoint x="270" y="250" />
        <omgdi:waypoint x="270" y="500" />
        <omgdi:waypoint x="844" y="500" />
        <omgdi:waypoint x="844" y="244" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow7" bpmnElement="flow7" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="340" y="249.9443032552827" />
        <omgdi:waypoint x="340" y="405" />
        <omgdi:waypoint x="410" y="405" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow8" bpmnElement="flow8" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="509.949999999811" y="405" />
        <omgdi:waypoint x="570" y="405" />
        <omgdi:waypoint x="570" y="259.95" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow9" bpmnElement="flow9" flowable:sourceDockerX="20.0" flowable:sourceDockerY="20.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="359.94566492829205" y="230" />
        <omgdi:waypoint x="520" y="230" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow10" bpmnElement="flow10" flowable:sourceDockerX="15.5" flowable:sourceDockerY="15.5" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="561.9446216660114" y="267.52191442946304" />
        <omgdi:waypoint x="509.95000000000005" y="291.7241379310345" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow12" bpmnElement="flow12" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="730" y="120" />
        <omgdi:waypoint x="730" y="80" />
        <omgdi:waypoint x="570" y="80" />
        <omgdi:waypoint x="570" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow13" bpmnElement="flow13" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="600.4659345391904" y="259.95" />
        <omgdi:waypoint x="629" y="288" />
        <omgdi:waypoint x="690" y="311.0810810810811" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow14" bpmnElement="flow14" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="690" y="301.4285714285714" />
        <omgdi:waypoint x="642" y="274" />
        <omgdi:waypoint x="618.9989192263936" y="259.95" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow15" bpmnElement="flow15" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="619.9499999999999" y="230" />
        <omgdi:waypoint x="680" y="230" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow16" bpmnElement="flow16" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="14.0" flowable:targetDockerY="14.0">
        <omgdi:waypoint x="779.949999999996" y="230" />
        <omgdi:waypoint x="830" y="230" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow11" bpmnElement="flow11" flowable:sourceDockerX="50.0" flowable:sourceDockerY="30.0" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="619.9499999999999" y="205" />
        <omgdi:waypoint x="680" y="174.97500000000002" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flowRobotTimeout" bpmnElement="flowRobotTimeout" flowable:sourceDockerX="15.500000000000002" flowable:sourceDockerY="15.500000000000002" flowable:targetDockerX="50.0" flowable:targetDockerY="30.0">
        <omgdi:waypoint x="288.08939309745017" y="104.36220459203628" />
        <omgdi:waypoint x="288.08939309745017" y="45" />
        <omgdi:waypoint x="410" y="45" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
