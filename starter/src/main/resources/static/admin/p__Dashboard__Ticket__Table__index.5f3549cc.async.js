"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[5370],{15722:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(83910),a=n(44194),i={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M464 688a48 48 0 1096 0 48 48 0 10-96 0zm24-112h48c4.4 0 8-3.6 8-8V296c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8z"}}]},name:"exclamation-circle",theme:"outlined"},o=n(54183),s=function(e,t){return a.createElement(o.Z,(0,r.Z)({},e,{ref:t,icon:i}))};var l=a.forwardRef(s)},11090:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(83910),a=n(44194),i={icon:{tag:"svg",attrs:{"fill-rule":"evenodd",viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 912H144c-17.7 0-32-14.3-32-32V144c0-17.7 14.3-32 32-32h360c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8H184v656h656V520c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v360c0 17.7-14.3 32-32 32zM770.87 199.13l-52.2-52.2a8.01 8.01 0 014.7-13.6l179.4-21c5.1-.6 9.5 3.7 8.9 8.9l-21 179.4c-.8 6.6-8.9 9.4-13.6 4.7l-52.4-52.4-256.2 256.2a8.03 8.03 0 01-11.3 0l-42.4-42.4a8.03 8.03 0 010-11.3l256.1-256.3z"}}]},name:"export",theme:"outlined"},o=n(54183),s=function(e,t){return a.createElement(o.Z,(0,r.Z)({},e,{ref:t,icon:i}))};var l=a.forwardRef(s)},2484:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(83910),a=n(44194),i={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M456 231a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"more",theme:"outlined"},o=n(54183),s=function(e,t){return a.createElement(o.Z,(0,r.Z)({},e,{ref:t,icon:i}))};var l=a.forwardRef(s)},82669:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(83910),a=n(44194),i={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M696 480H544V328c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v152H328c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h152v152c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V544h152c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8z"}},{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}}]},name:"plus-circle",theme:"outlined"},o=n(54183),s=function(e,t){return a.createElement(o.Z,(0,r.Z)({},e,{ref:t,icon:i}))};var l=a.forwardRef(s)},36099:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(83910),a=n(44194),i={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372 0-89 31.3-170.8 83.5-234.8l523.3 523.3C682.8 852.7 601 884 512 884zm288.5-137.2L277.2 223.5C341.2 171.3 423 140 512 140c205.4 0 372 166.6 372 372 0 89-31.3 170.8-83.5 234.8z"}}]},name:"stop",theme:"outlined"},o=n(54183),s=function(e,t){return a.createElement(o.Z,(0,r.Z)({},e,{ref:t,icon:i}))};var l=a.forwardRef(s)},59908:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(83910),a=n(44194),i={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M400 317.7h73.9V656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V317.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 163a8 8 0 00-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"upload",theme:"outlined"},o=n(54183),s=function(e,t){return a.createElement(o.Z,(0,r.Z)({},e,{ref:t,icon:i}))};var l=a.forwardRef(s)},17509:function(e,t,n){n.d(t,{If:function(){return h},dF:function(){return d},j4:function(){return g},v$:function(){return m}});var r=n(90819),a=n.n(r),i=n(73193),o=n.n(i),s=n(89933),l=n.n(s),c=n(6844),u=n(19736);function d(e){return f.apply(this,arguments)}function f(){return(f=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/query/org",{method:"GET",params:o()(o()({},t),{},{channel:c.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return(p=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/create",{method:"POST",data:o()(o()({},t),{},{channel:c.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return v.apply(this,arguments)}function v(){return(v=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/update",{method:"POST",data:o()(o()({},t),{},{channel:c.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return x.apply(this,arguments)}function x(){return(x=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/delete",{method:"POST",data:o()(o()({},t),{},{channel:c.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},35350:function(e,t,n){n.r(t),n.d(t,{default:function(){return we}});var r=n(45332),a=n.n(r),i=n(44194),o=n(86567),s=n(88449),l=n(6844),c=n(85255),u=n(31167),d=n(84176),f=n.n(d),m=n(10154),p=n.n(m),g=n(73193),v=n.n(g),h=n(86222),x=n.n(h),y=n(90819),k=n.n(y),M=n(89933),b=n.n(M),w=n(93527),j=n(93755),S=n(14888),Z=n(47598),C=n(11394),F=n(44679),U=n(11090),I=n(2484),z=n(54881),E=n(67412),L=n(19736),D=n(46141),T=n(71277),O=n(3925),B=n(66810),R=n(77359),N=n(96596),_=n.n(N),A=n(76711),P=n.n(A),W=n(68737),q=n(65100),V=n(61689),J=n(9428),G=n(29589),$=n(74491),H=n(36125),X=n(30064),Y=n(86684),Q=n(68263),K=n(13847),ee=n(34718),te=n(85660),ne=n(36099),re=n(59908),ae=n(69456),ie=n(17509),oe=n(67728),se=n(51718),le=n(89957),ce=n.n(le),ue=n(31549),de=function(e){var t=e.fields,n=void 0===t?[]:t,r=e.fieldNamePrefix,a=void 0===r?"dynamicField_":r,i=e.translate,o=(0,L.useIntl)(),s=function(e){if(!e)return"";try{return i&&i(e)||e}catch(t){return console.error("translate field text failed:",t),e}};return null!=n&&n.length?(0,ue.jsx)(ue.Fragment,{children:n.map((function(e,t){var n,r,i,l=function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}(e,t),c="".concat(a).concat(l),u=(null==e?void 0:e.label)||(null==e?void 0:e.title)||"Field ".concat(t+1),d=s(u)||u,f=function(e,t){switch(e){case"text":switch(t){case"email":return o.formatMessage({id:"ticket.form.placeholder.email",defaultMessage:"请输入邮箱地址"});case"tel":return o.formatMessage({id:"ticket.form.placeholder.tel",defaultMessage:"请输入电话号码"});case"textarea":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入文本内容"});case"date":return o.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"datetime-local":return o.formatMessage({id:"ticket.form.placeholder.datetime",defaultMessage:"请选择日期时间"});default:return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}case"input":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"});case"textarea":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入多行文本"});case"select":return o.formatMessage({id:"ticket.form.placeholder.select",defaultMessage:"请选择"});case"datePicker":return o.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"timePicker":return o.formatMessage({id:"ticket.form.placeholder.time",defaultMessage:"请选择时间"});default:return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}}(null==e?void 0:e.type,null==e||null===(n=e.props)||void 0===n?void 0:n.type),m=null!=e&&e.required?[{required:!0,message:o.formatMessage({id:"ticket.form.required",defaultMessage:"{label}是必填项"},{label:d})}]:void 0;if("textarea"===(null==e?void 0:e.type)||"textarea"===(null==e||null===(r=e.props)||void 0===r?void 0:r.component))return(0,ue.jsx)(K.Z,{name:c,label:d,placeholder:f,rules:m},c);if("select"===(null==e?void 0:e.type)||"select"===(null==e||null===(i=e.props)||void 0===i?void 0:i.component)||"select"===(null==e?void 0:e.component)){var p,g,v,h=(null!==(p=null!==(g=null==e?void 0:e.options)&&void 0!==g?g:null==e||null===(v=e.props)||void 0===v?void 0:v.options)&&void 0!==p?p:[]).map((function(e,t){return"string"==typeof e?{label:s(e)||e,value:e}:"object"===ce()(e)?{label:s(e.label||e.value||e.text||"")||e.label||e.value||e.text||"",value:null!==(n=null!==(r=null!==(a=null!==(i=e.value)&&void 0!==i?i:e.key)&&void 0!==a?a:e.label)&&void 0!==r?r:e.text)&&void 0!==n?n:"".concat(t)}:{label:String(e),value:e};var n,r,a,i}));return(0,ue.jsx)(Q.Z,{name:c,label:d,placeholder:f,options:h,rules:m},c)}return(0,ue.jsx)(Y.Z,{name:c,label:d,placeholder:f,rules:m},c)}))}):null},fe={"star-1":"#FFB800","star-2":"#FF4D4F","star-3":"#52C41A","star-4":"#1890FF"},me=function(e){var t,n=e.open,r=e.isEdit,o=void 0!==r&&r,s=e.currentTicket,c=e.onSuccess,u=e.onCancel,d=X.A.useForm(),f=a()(d,1)[0],m=(0,L.useIntl)(),p=(0,F.Z)(),g=p.translateString,h=p.translateStringTranct,x=(0,S.u)((function(e){return e.currentOrg})),y=(0,i.useMemo)((function(){var e=m.formatMessage({id:"ticket.form.thread.none",defaultMessage:"不关联会话"});return[{label:e,value:"",dataSearch:e.toLowerCase()}]}),[m,g]),M=(0,i.useCallback)((function(e){return null!=e&&e.content&&h()||m.formatMessage({id:"ticket.form.thread.preview.empty",defaultMessage:"暂无最近消息"})}),[m,h]),Z=(0,i.useCallback)((function(e){var t,n=(null==e||null===(t=e.user)||void 0===t?void 0:t.avatar)||"";if(n.startsWith("http")||n.startsWith("data:"))return n}),[]),U=(0,i.useCallback)((function(e){if(!e||0===e.length)return null;var t=e.filter((function(e){return!!e}));return t.length?(0,ue.jsx)("span",{className:"ticket-thread-option__tags",children:t.map((function(e){return(0,ue.jsx)(B.Z,{color:"blue",className:"ticket-thread-option__tag",children:e.length>12?"".concat(e.slice(0,12),"..."):e},e)}))}):null}),[]),I=(0,i.useCallback)((function(e){var t,n,r=e;if(null==r||!r.thread)return(0,ue.jsx)("div",{className:"ticket-thread-option ticket-thread-option--empty",children:null==r?void 0:r.label});var a=r.thread,i=a.star?"star-".concat(a.star):void 0,o=i?fe[i]:void 0,s=g((null==a||null===(t=a.user)||void 0===t?void 0:t.nickname)||"")||a.uid,l=M(a),c=Z(a),u=(s||a.uid||"").toString().slice(0,1).toUpperCase(),d=null!==(n=null==a?void 0:a.unreadCount)&&void 0!==n?n:0,f=U(a.tagList),m=a.mute||!!f;return(0,ue.jsxs)("div",{className:"ticket-thread-option",style:o?{borderLeftColor:o,background:"".concat(o,"12")}:void 0,children:[(0,ue.jsx)("div",{className:"ticket-thread-option__avatar",children:(0,ue.jsx)(W.Z,{count:d||0,size:"small",children:(0,ue.jsx)(q.Z,{shape:"square",size:40,src:c,children:u})})}),(0,ue.jsxs)("div",{className:"ticket-thread-option__content",children:[(0,ue.jsx)("div",{className:"ticket-thread-option__top",children:(0,ue.jsxs)("span",{className:"ticket-thread-option__title",children:[a.top?(0,ue.jsx)(te.Z,{}):null,s]})}),m?(0,ue.jsxs)("div",{className:"ticket-thread-option__meta",children:[a.mute?(0,ue.jsx)(ne.Z,{className:"ticket-thread-option__mute"}):null,f]}):null,(0,ue.jsx)("div",{className:"ticket-thread-option__preview",children:l})]})]})}),[Z,M,U,g]),z=(0,i.useState)([]),E=a()(z,2),D=E[0],T=E[1],R=(0,i.useState)([]),N=a()(R,2),_=N[0],A=N[1],le=(0,i.useState)({uid:"",nickname:""}),ce=a()(le,2),me=ce[0],pe=ce[1],ge=(0,i.useState)(!1),ve=a()(ge,2),he=ve[0],xe=ve[1],ye=(0,i.useState)([]),ke=a()(ye,2),Me=ke[0],be=ke[1],we=(0,i.useState)([]),je=a()(we,2),Se=je[0],Ze=je[1],Ce=(0,i.useRef)([]),Fe=(0,i.useRef)(),Ue=(0,i.useState)(!1),Ie=a()(Ue,2),ze=Ie[0],Ee=Ie[1],Le=(0,i.useState)(),De=a()(Le,2),Te=De[0],Oe=De[1],Be=(0,i.useMemo)((function(){return"ticketSettingsSelection_".concat((null==x?void 0:x.uid)||"default")}),[null==x?void 0:x.uid]),Re=(0,i.useMemo)((function(){return Te?Se.find((function(e){return e.uid===Te})):void 0}),[Se,Te]),Ne=Boolean(null==Re?void 0:Re.customFormEnabled),_e=(0,i.useMemo)((function(){var e;if(!Ne)return[];var t=null==Re||null===(e=Re.form)||void 0===e?void 0:e.schema;if(!t)return[];try{var n=JSON.parse(t);if(Array.isArray(n))return n;if(Array.isArray(null==n?void 0:n.schema))return n.schema;if(Array.isArray(null==n?void 0:n.fields))return n.fields;if(Array.isArray(null==n?void 0:n.content))return n.content}catch(e){console.error("ticket form schema parse error",e)}return[]}),[Ne,null==Re||null===(t=Re.form)||void 0===t?void 0:t.schema]),Ae=(0,i.useCallback)((function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}),[]);(0,i.useEffect)((function(){Ce.current=Se}),[Se]),(0,i.useEffect)((function(){var e,t,n,r,a,i=Fe.current,s=null==Re?void 0:Re.uid;Fe.current=s;var l=null!==(e=null==Re?void 0:Re.categorySettings)&&void 0!==e?e:null==Re?void 0:Re.draftCategorySettings;if(null==l||null===(t=l.items)||void 0===t||!t.length)return T([]),void(o||f.setFieldsValue({categoryUid:void 0}));var c=l.items.filter((function(e){return Boolean(null==e?void 0:e.uid)&&!1!==(null==e?void 0:e.enabled)})).sort((function(e,t){var n,r;return(null!==(n=e.orderIndex)&&void 0!==n?n:0)-(null!==(r=t.orderIndex)&&void 0!==r?r:0)}));if(!c.length)return T([]),void(o||f.setFieldsValue({categoryUid:void 0}));if(T(c),!o){var u=f.getFieldValue("categoryUid");if(s!==i||!u||!c.some((function(e){return e.uid===u}))){var d=(null===(n=c.find((function(e){return e.uid===l.defaultCategoryUid})))||void 0===n?void 0:n.uid)||(null===(r=c.find((function(e){return e.defaultCategory})))||void 0===r?void 0:r.uid)||(null===(a=c[0])||void 0===a?void 0:a.uid);f.setFieldsValue({categoryUid:d||void 0})}}}),[Re,o,f,n]);var Pe=(0,i.useCallback)((function(e){var t,n;null!=e&&null!==(t=e.process)&&void 0!==t&&t.uid?f.setFieldsValue({processEntityUid:e.process.uid}):f.setFieldsValue({processEntityUid:void 0}),null!=e&&e.customFormEnabled&&null!=e&&null!==(n=e.form)&&void 0!==n&&n.uid?f.setFieldsValue({formEntityUid:e.form.uid}):f.setFieldsValue({formEntityUid:void 0})}),[f]),We=(0,i.useCallback)((function(e,t){var n=e||void 0,r=null!=t?t:Ce.current;Oe(n),f.setFieldsValue({ticketSettingsUid:n}),n?localStorage.setItem(Be,n):localStorage.removeItem(Be);var a=r.find((function(e){return e.uid===n}));Pe(a)}),[f,Be,Pe]),qe=(0,i.useCallback)(b()(k()().mark((function e(){var t,n,r,a,i,l,c,u,d,f;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=x&&x.uid){e.next=4;break}return Ze([]),We(void 0,[]),e.abrupt("return");case 4:return Ee(!0),e.prev=5,r={orgUid:x.uid,pageNumber:0,pageSize:200},e.next=9,(0,se.Bg)(r);case 9:a=e.sent,H.Z.debug("queryTicketSettingsByOrg response:",null==a?void 0:a.data,r),i=null!==(t=null==a||null===(n=a.data)||void 0===n?void 0:n.content)&&void 0!==t?t:[],Ze(i),o&&null!=s&&s.ticketSettingsUid&&i.some((function(e){return e.uid===s.ticketSettingsUid}))?l=s.ticketSettingsUid:(c=localStorage.getItem(Be),l=c&&i.some((function(e){return e.uid===c}))?c:null!==(u=null===(d=i.find((function(e){return e.isDefault})))||void 0===d?void 0:d.uid)&&void 0!==u?u:null===(f=i[0])||void 0===f?void 0:f.uid),H.Z.debug("Selected ticket settings UID:",l),We(l,i),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),console.error("Fetch ticket settings error:",e.t0),w.yw.error(m.formatMessage({id:"ticket.settings.load.error",defaultMessage:"获取工单设置失败"}));case 22:return e.prev=22,Ee(!1),e.finish(22);case 25:case"end":return e.stop()}}),e,null,[[5,18,22,25]])}))),[null==x?void 0:x.uid,m,o,null==s?void 0:s.ticketSettingsUid,We,Be]),Ve=(0,C.H)((function(e){return{departmentResult:e.departmentResult,setDepartmentResult:e.setDepartmentResult}})),Je=Ve.departmentResult,Ge=Ve.setDepartmentResult,$e=(0,i.useCallback)(function(){var e=b()(k()().mark((function e(t,n){var r,a,i,o,s;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a={pageNumber:0,pageSize:100,orgUid:null==x?void 0:x.uid,deptUid:t},e.next=4,(0,oe.z_)(a);case 4:i=e.sent,H.Z.debug("queryMembersByOrg response:",null==i?void 0:i.data,a),200===(null==i?void 0:i.code)&&null!=i&&null!==(r=i.data)&&void 0!==r&&r.content&&(o=null==i?void 0:i.data.content,A(o),n?(s=o.find((function(e){return e.uid===n})),f.setFieldsValue({assigneeUid:n}),pe(s||{uid:n,nickname:(null==s?void 0:s.nickname)||""})):(f.setFieldsValue({assigneeUid:void 0}),pe({uid:"",nickname:""}))),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch members error:",e.t0),w.yw.error(m.formatMessage({id:"ticket.member.load.error",defaultMessage:"加载成员失败"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}(),[null==x?void 0:x.uid,f,m]),He=(0,i.useCallback)((function(e){e===l.zBg?$e(""):$e(e)}),[$e]);(0,i.useEffect)((function(){if(o&&s){var e,t,n,r,i,c={description:s.description,status:s.status,priority:s.priority,threadUid:null==s?void 0:s.threadUid,departmentUid:null==s?void 0:s.departmentUid,categoryUid:null==s?void 0:s.categoryUid,assigneeUid:null===(e=s.assignee)||void 0===e?void 0:e.uid,uploadUids:null===(t=s.attachments)||void 0===t?void 0:t.map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})),processEntityUid:null==s?void 0:s.processEntityUid,ticketSettingsUid:null==s?void 0:s.ticketSettingsUid,formEntityUid:null==s?void 0:s.formEntityUid};if(s.schema)try{var u=JSON.parse(s.schema);if(u.formUid&&u.formData){var d="ticketFormSelection_".concat((null==x?void 0:x.uid)||"default");localStorage.setItem(d,u.formUid),Object.entries(u.formData).forEach((function(e){var t=a()(e,2),n=t[0],r=t[1];c["dynamicField_".concat(n)]=r}))}}catch(e){console.error("解析工单表单数据失败:",e)}if(f.setFieldsValue(c),be(null!==(n=null===(r=s.attachments)||void 0===r?void 0:r.map((function(e){return e.upload})))&&void 0!==n?n:[]),pe(s.assignee||{uid:"",nickname:""}),s.departmentUid)$e(s.departmentUid,null===(i=s.assignee)||void 0===i?void 0:i.uid)}else{var m=localStorage.getItem("ticketDraft");m&&f.setFieldsValue({description:m}),f.setFieldsValue({status:l.sM_,priority:l.GMZ,departmentUid:l.zBg,categoryUid:void 0}),pe({uid:"",nickname:""}),He(l.zBg),be([])}}),[n,o,s,null==x?void 0:x.uid,$e,He]);var Xe=function e(t,n){if(t.name.startsWith(l.VoP)?n.title=m.formatMessage({id:t.name,defaultMessage:t.name}):n.title=t.name,n.key=t.uid,n.value=t.uid,t.children){n.children=[];for(var r=0;r<t.children.length;r++){var a={title:"",key:"",children:[]};e(t.children[r],a),n.children.push(a)}}},Ye=(0,i.useMemo)((function(){for(var e,t,n=[],r=null!==(e=null==Je||null===(t=Je.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],a=0;a<r.length;a++){var i={title:"",key:"",children:[]};Xe(r[a],i),n.push(i)}return n}),[Je]),Qe=(0,i.useMemo)((function(){return[{title:m.formatMessage({id:"ticket.form.department.all",defaultMessage:"全部部门"}),key:l.zBg,value:l.zBg}].concat(P()(Ye))}),[Ye,m]),Ke=function(){var e=b()(k()().mark((function e(){var t,n;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={pageNumber:0,pageSize:100,orgUid:null==x?void 0:x.uid},e.next=4,(0,ie.dF)(t);case 4:n=e.sent,H.Z.debug("queryDepartmentsByOrg response:",null==n?void 0:n.data,t),200===(null==n?void 0:n.code)?Ge(n):w.yw.error(null==n?void 0:n.message),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch departments error:",e.t0),w.yw.error(m.formatMessage({id:"ticket.department.load.error"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}();(0,i.useEffect)((function(){n&&(Ke(),qe())}),[n,qe]);var et=function(){var e=b()(k()().mark((function e(){var t,n,r,a,i,u,d,p,g,h,y,M;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f.validateFields();case 3:if(i=e.sent,w.yw.loading(m.formatMessage({id:"ticket.submitting"}),0),i.threadUid,u=Boolean(Ne&&(null==Re||null===(t=Re.form)||void 0===t?void 0:t.uid)),d=u?new Set(_e.map((function(e,t){return"dynamicField_".concat(Ae(e,t))}))):new Set,p={},Object.keys(i).forEach((function(e){if(e.startsWith("dynamicField_")){if(u&&d.has(e)){var t=e.replace("dynamicField_","");p[t]=i[e]}delete i[e]}})),g=null,u&&null!=Re&&null!==(n=Re.form)&&void 0!==n&&n.uid&&(g={formUid:Re.form.uid,formName:Re.form.name,formSchema:Re.form.schema,formData:p}),(h=v()(v()({},i),{},{departmentUid:i.departmentUid===l.zBg?"":i.departmentUid,orgUid:null==x?void 0:x.uid,assignee:{uid:null==me?void 0:me.uid,nickname:null==me?void 0:me.nickname,type:l.Tls},uploadUids:(null==Me?void 0:Me.length)>0?P()(new Set(Me.map((function(e){return e.uid})))):[],schema:g?JSON.stringify(g):void 0})).ticketSettingsUid=i.ticketSettingsUid||Te,u&&!h.formEntityUid&&null!=Re&&null!==(r=Re.form)&&void 0!==r&&r.uid&&(h.formEntityUid=Re.form.uid),!h.processEntityUid&&null!=Re&&null!==(a=Re.process)&&void 0!==a&&a.uid&&(h.processEntityUid=Re.process.uid),!o||!s){e.next=25;break}return h.uid=s.uid,e.next=20,(0,j.O)(h);case 20:y=e.sent,H.Z.debug("updateTicket response",null==y?void 0:y.data,h),200===(null==y?void 0:y.code)?(w.yw.destroy(),w.yw.success(m.formatMessage({id:"ticket.update.success"})),c()):(w.yw.destroy(),w.yw.error(m.formatMessage({id:"ticket.update.failed"}))),e.next=30;break;case 25:return e.next=27,(0,j.ax)(h);case 27:M=e.sent,H.Z.debug("createTicket response",null==M?void 0:M.data,h),200===(null==M?void 0:M.code)?(w.yw.destroy(),w.yw.success(m.formatMessage({id:"ticket.create.success"})),c()):(w.yw.destroy(),w.yw.error(m.formatMessage({id:"ticket.create.failed"})));case 30:e.next=37;break;case 32:e.prev=32,e.t0=e.catch(0),w.yw.destroy(),console.error("Submit ticket error:",e.t0),w.yw.error(m.formatMessage({id:"ticket.submit.error"}));case 37:return e.prev=37,localStorage.removeItem("ticketDraft"),e.finish(37);case 40:case"end":return e.stop()}}),e,null,[[0,32,37,40]])})));return function(){return e.apply(this,arguments)}}(),tt=function(e){H.Z.debug("handleDelete",e),be((function(t){return t.filter((function(t){return t.uid!==e}))}))};return(0,ue.jsx)(V.Z,{title:m.formatMessage({id:o?"ticket.edit.title":"ticket.create.title",defaultMessage:o?"编辑工单":"创建工单"}),width:600,open:n,onClose:u,extra:(0,ue.jsxs)(J.Z,{children:[(0,ue.jsx)(G.Z,{style:{minWidth:220},placeholder:m.formatMessage({id:"ticket.form.ticketSettings.placeholder",defaultMessage:"请选择工单设置"}),value:Te,onChange:function(e){return function(e){We(e)}(e)},options:Se.map((function(e){return{label:g(e.name||""),value:e.uid}})),loading:ze,disabled:0===Se.length,showSearch:!0,filterOption:function(e,t){return((null==t?void 0:t.label)||"").toLowerCase().includes(e.toLowerCase())}}),(0,ue.jsx)(O.ZP,{onClick:u,children:m.formatMessage({id:"common.cancel"})}),(0,ue.jsx)(O.ZP,{type:"primary",onClick:et,children:m.formatMessage({id:"common.confirm"})})]}),children:(0,ue.jsxs)(X.A,{form:f,submitter:!1,children:[(0,ue.jsx)(Y.Z,{name:"ticketSettingsUid",hidden:!0,rules:0===Se.length?[]:[{required:!0,message:m.formatMessage({id:"ticket.form.ticketSettings.required",defaultMessage:"请选择工单设置"})}]}),Ne&&_e.length>0?(0,ue.jsx)(de,{fields:_e,fieldNamePrefix:"dynamicField_",translate:g}):null,(0,ue.jsx)(Y.Z,{name:"processEntityUid",hidden:!0}),(0,ue.jsx)(Y.Z,{name:"formEntityUid",hidden:!0}),D.length>0?(0,ue.jsx)(Q.Z,{name:"categoryUid",label:m.formatMessage({id:"ticket.form.category"}),rules:[{required:!0,message:m.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],options:D.map((function(e){return{label:g(e.name||"")||e.name||e.uid,value:e.uid}})),placeholder:m.formatMessage({id:"ticket.form.category.placeholder"})}):null,(0,ue.jsx)(K.Z,{name:"description",label:m.formatMessage({id:"ticket.form.description"}),rules:[{required:!0}],fieldProps:{onBlur:function(){H.Z.debug("handleDescriptionBlur",f.getFieldsValue());var e=f.getFieldValue("description");localStorage.setItem("ticketDraft",e)}}}),(0,ue.jsx)(Q.Z,{name:"priority",label:m.formatMessage({id:"ticket.form.priority"}),options:[{label:m.formatMessage({id:"ticket.priority.lowest"}),value:l.JTO},{label:m.formatMessage({id:"ticket.priority.low"}),value:l.sbT},{label:m.formatMessage({id:"ticket.priority.medium"}),value:l.GMZ},{label:m.formatMessage({id:"ticket.priority.high"}),value:l.Bt2},{label:m.formatMessage({id:"ticket.priority.urgent"}),value:l._Xr},{label:m.formatMessage({id:"ticket.priority.critical"}),value:l.Lx6}],rules:[{required:!0}]}),(0,ue.jsx)(X.A.Item,{name:"departmentUid",label:m.formatMessage({id:"ticket.form.department",defaultMessage:"所属部门"}),children:(0,ue.jsx)($.Z,{style:{width:"100%"},treeData:Qe,showSearch:!0,treeDefaultExpandAll:!1,popupMatchSelectWidth:!1,placeholder:m.formatMessage({id:"ticket.form.department.placeholder",defaultMessage:"请选择内部部门"}),onChange:function(e){return He(e||l.zBg)},allowClear:!1})}),(0,ue.jsx)(Q.Z,{name:"assigneeUid",label:m.formatMessage({id:"ticket.form.assignee"}),options:_.map((function(e){var t;return{label:e.nickname||(null===(t=e.user)||void 0===t?void 0:t.nickname),value:e.uid}})),placeholder:m.formatMessage({id:"ticket.form.assignee.placeholder"}),fieldProps:{onChange:function(e){var t=_.find((function(t){return t.uid===e}));pe(t||{uid:"",nickname:""})}},disabled:0===_.length}),(0,ue.jsx)(Q.Z,{name:"threadUid",label:m.formatMessage({id:"ticket.form.thread"}),options:y,fieldProps:{showSearch:!0,popupMatchSelectWidth:!1,optionLabelProp:"label",classNames:{popup:{root:"ticket-thread-select-dropdown"}},optionRender:function(e){return I(e)},filterOption:function(e,t){var n=t,r=e.toLowerCase();return((null==n?void 0:n.dataSearch)||"").includes(r)}},placeholder:m.formatMessage({id:"ticket.form.thread.placeholder"})}),he&&(0,ue.jsx)(ee.Z,{type:l.hcJ,isModalOpen:he,attachments:null==s?void 0:s.attachments,handleSubmit:function(e){var t;H.Z.debug("handleSubmit",e);var n=e||[];if(o&&null!=s&&null!==(t=s.attachments)&&void 0!==t&&t.length){var r=new Set((s.attachments||[]).map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})).filter((function(e){return Boolean(e)}))),a=n.filter((function(e){return!r.has(e.uid)}));be(a)}else be(n);xe(!1)},handleCancel:function(){xe(!1)}}),(0,ue.jsx)("div",{style:{marginTop:"16px",marginBottom:"16px",maxHeight:"200px",overflowY:"auto"},children:(0,ue.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"12px"},children:Me.map((function(e){return(0,ue.jsx)(ae.Z,{file:e,onDelete:tt},e.uid)}))})}),(0,ue.jsx)(O.ZP,{icon:(0,ue.jsx)(re.Z,{}),onClick:function(){return xe(!0)},children:m.formatMessage({id:"ticket.form.upload.button"})})]})})},pe=n(65819),ge=n(41587),ve=n(20921),he=n(8232),xe=n(12792),ye=function(e){var t=e.ticket,n=e.isThreadTicket,r=void 0!==n&&n,o=(0,S.u)((function(e){return e.currentOrg})),s=(0,i.useState)([]),c=a()(s,2),u=c[0],d=c[1],f=(0,i.useState)(!1),m=a()(f,2),p=m[0],g=m[1],v=(0,L.useIntl)();console.log("currentTicket",t,p);var h=(0,ge.Z)(),x=h.memberResult,y=h.setMemberResult,M=function(){var e=b()(k()().mark((function e(){var n,r;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,g(!0),n={pageNumber:0,pageSize:100,uid:null==t?void 0:t.uid},e.next=7,(0,j.EH)(n);case 7:r=e.sent,console.log("queryTicketHistoryActivity response:",null==r?void 0:r.data),200===r.code?d((null==r?void 0:r.data)||[]):(console.log("queryTicketHistoryActivity error:",null==r?void 0:r.data),w.yw.error(r.message)),g(!1),e.next=18;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("Fetch ticket history error:",e.t0),w.yw.error("获取工单历史记录失败"),g(!1);case 18:case"end":return e.stop()}}),e,null,[[2,13]])})));return function(){return e.apply(this,arguments)}}(),Z=function(){var e=b()(k()().mark((function e(){var t,n;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.yw.loading("loading"),t={pageNumber:0,pageSize:100,orgUid:null==o?void 0:o.uid},e.next=4,(0,oe.z_)(t);case 4:200===(n=e.sent).code?(w.yw.destroy(),y(n)):w.yw.destroy();case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,i.useEffect)((function(){r||(M(),Z())}),[t]);var C=function(e){if(!e)return"-";var t=x.data.content.find((function(t){return t.uid===e}));return(null==t?void 0:t.nickname)||""};return(0,ue.jsx)(ue.Fragment,{children:(0,ue.jsxs)(ve.Z,{spinning:p,children:[(0,ue.jsx)("p",{style:{fontSize:"16px",fontWeight:"bold",textAlign:"center"},children:"活动历史"}),(0,ue.jsx)(he.Z,{direction:"vertical",size:"small",current:u.length-1,style:{padding:"16px"},items:u.map((function(e,t){var n,r;return{title:(r=null==e?void 0:e.activityName,(r?r===l.sM_||r===l.Yux||r===l.sFW||r===l.W66||r===l.z1||r===l.yZA||r===l.pIN||r===l.XrC||r===l.L1h||r===l.yib||r===l.hwr||r===l.AzB||r===l.frw||r===l.xw4||r===l.qQU||r===l.GJZ?v.formatMessage({id:"ticket.status.".concat(r.toLowerCase())}):r:"")||"活动"),description:(0,ue.jsxs)("div",{children:[(null==e?void 0:e.assignee)&&(0,ue.jsxs)("div",{children:["处理人: ",C(null==e?void 0:e.assignee)||(null==e?void 0:e.assignee)]}),(0,ue.jsxs)("div",{children:["处理时间: ",(null===(n=e.startTime)||void 0===n?void 0:n.toLocaleString())||"-"]})]}),status:t===u.length-1?"process":"finish"}}))}),0===u.length&&(0,ue.jsx)(xe.Z,{description:"请选择工单查看流转过程"})]})})},ke=function(e){var t=e.open,n=e.ticket,r=e.onClose;return(0,ue.jsx)(ue.Fragment,{children:(0,ue.jsx)(V.Z,{open:t,onClose:function(){r()},title:"工单详情",children:(0,ue.jsx)(ye,{ticket:n,isThreadTicket:!1})})})},Me=["current","pageSize"],be=function(e){var t,n=e.ticketType,r=(0,L.useIntl)(),o=(0,i.useRef)(),s=(0,i.useState)(1),c=a()(s,2),u=c[0],d=c[1],m=(0,i.useState)(10),g=a()(m,2),h=g[0],y=g[1],M=(0,S.u)((function(e){return e.currentOrg})),N=(0,F.Z)().translateString,A=(0,Z.v)((function(e){return e.currentCategory})),P=(0,Z.v)((function(e){return e.categoryResult})),W=(0,C.H)((function(e){return e.departmentResult})),q=(0,i.useState)(!1),V=a()(q,2),J=V[0],G=V[1],$=(0,i.useState)(),X=a()($,2),Y=X[0],Q=X[1],K=(0,i.useState)(!1),ee=a()(K,2),te=ee[0],ne=ee[1],re=D.Z.useModal(),ae=a()(re,2),ie=ae[0],oe=ae[1],se=(0,i.useState)(!1),le=a()(se,2),ce=le[0],de=le[1],fe=(0,i.useState)([]),ge=a()(fe,2),ve=ge[0],he=ge[1],xe=(0,i.useState)([]),ye=a()(xe,2),be=ye[0],we=ye[1],je=(0,i.useState)({}),Se=a()(je,2),Ze=Se[0],Ce=Se[1],Fe=(0,i.useState)(0),Ue=a()(Fe,2),Ie=Ue[0],ze=Ue[1],Ee=(0,i.useMemo)((function(){var e,t=new Map;return function e(n){null!=n&&n.length&&n.forEach((function(n){var r;null!=n&&n.uid&&(t.set(n.uid,n),null!==(r=n.children)&&void 0!==r&&r.length&&e(n.children))}))}(null==P||null===(e=P.data)||void 0===e?void 0:e.content),t}),[P]),Le=(0,i.useMemo)((function(){var e,t=new Map;return function e(n){null!=n&&n.length&&n.forEach((function(n){var r;null!=n&&n.uid&&(t.set(n.uid,n),null!==(r=n.children)&&void 0!==r&&r.length&&e(n.children))}))}(null==W||null===(e=W.data)||void 0===e?void 0:e.content),t}),[W]);(0,i.useEffect)((function(){var e;null===(e=o.current)||void 0===e||e.reload()}),[null==A?void 0:A.uid,n]);var De=function(){var e=b()(k()().mark((function e(t){var n,a;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,j.M4)(t.uid);case 2:200===(n=e.sent).code?(w.yw.success(r.formatMessage({id:"delete.success",defaultMessage:"删除成功"})),null===(a=o.current)||void 0===a||a.reload()):w.yw.error(n.message);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Te=function(){var e=b()(k()().mark((function e(){var t,n,a,i,s,l;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==be.length){e.next=3;break}return w.yw.warning(r.formatMessage({id:"batch.delete.noselection",defaultMessage:"请选择要删除的项目"})),e.abrupt("return");case 3:w.yw.loading(r.formatMessage({id:"deleting",defaultMessage:"正在删除..."})),n=0,a=0,i=x()(be),e.prev=7,i.s();case 9:if((s=i.n()).done){e.next=23;break}return l=s.value,e.prev=11,e.next=14,(0,j.M4)(l.uid);case 14:200===e.sent.code?n++:a++,e.next=21;break;case 18:e.prev=18,e.t0=e.catch(11),a++;case 21:e.next=9;break;case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(7),i.e(e.t1);case 28:return e.prev=28,i.f(),e.finish(28);case 31:w.yw.destroy(),0===a?w.yw.success(r.formatMessage({id:"batch.delete.success",defaultMessage:"成功删除 {count} 条记录"},{count:n})):w.yw.warning(r.formatMessage({id:"batch.delete.partial",defaultMessage:"成功删除 {success} 条记录，失败 {fail} 条"},{success:n,fail:a})),he([]),we([]),null===(t=o.current)||void 0===t||t.reloadAndRest();case 36:case"end":return e.stop()}}),e,null,[[7,25,28,31],[11,18]])})));return function(){return e.apply(this,arguments)}}(),Oe=function(){var e=b()(k()().mark((function e(t,r,a){var i,o;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=localStorage.getItem(l.LA8),o=v()({categoryUid:(null==A?void 0:A.uid)===l.zBg?"":null==A?void 0:A.uid,orgUid:(null==M?void 0:M.uid)||"",accessToken:i||"",exportType:t,type:n},Ze),"current"===t?(o.pageNumber=String(u-1),o.pageSize=String(h)):"all"===t?(o.pageNumber="0",o.pageSize="1000"):"range"===t&&void 0!==r&&void 0!==a&&(o.pageNumber=String(r),o.pageSize=String(a)),window.open((0,pe.kG)()+"/api/v1/ticket/export?"+new URLSearchParams(o).toString());case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Be=function(e){for(var t=[],n=1e3,r=Math.ceil(e/n),a=function(){var r=i,a=i*n+1,o=Math.min((i+1)*n,e);t.push({key:"export-".concat(i),label:"".concat(a,"-").concat(o," (").concat(o-a+1,"条)"),onClick:function(){return Oe("range",r,n)}})},i=0;i<r;i++)a();return t},Re={selectedRowKeys:ve,onChange:function(e,t){he(e),we(t)}},Ne=function(){G(!1),Q(void 0),ne(!1)},_e=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left",align:"center"},{title:r.formatMessage({id:"ticket.number",defaultMessage:"工单编号"}),dataIndex:"ticketNumber",key:"ticketNumber",width:150},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.description"}),dataIndex:"description",ellipsis:!0,tooltip:r.formatMessage({id:"ticket.description.tooltip"})},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status"}),dataIndex:"status",tooltip:r.formatMessage({id:"ticket.status.tooltip"}),valueType:"select",valueEnum:(t={},p()(p()(p()(p()(p()(p()(p()(p()(p()(p()(t,l.sM_,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.sM_.toLowerCase())}),status:"Processing"}),l.Yux,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.Yux.toLowerCase())}),status:"Processing"}),l.sFW,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.sFW.toLowerCase())}),status:"Processing"}),l.W66,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.W66.toLowerCase())}),status:"Warning"}),l.z1,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.z1.toLowerCase())}),status:"Processing"}),l.yZA,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.yZA.toLowerCase())}),status:"Processing"}),l.pIN,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.pIN.toLowerCase())}),status:"Warning"}),l.XrC,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.XrC.toLowerCase())}),status:"Warning"}),l.L1h,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.L1h.toLowerCase())}),status:"Processing"}),l.yib,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.yib.toLowerCase())}),status:"Warning"}),p()(p()(p()(p()(p()(p()(t,l.hwr,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.hwr.toLowerCase())}),status:"Success"}),l.AzB,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.AzB.toLowerCase())}),status:"Warning"}),l.frw,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.frw.toLowerCase())}),status:"Default"}),l.xw4,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.xw4.toLowerCase())}),status:"Error"}),l.qQU,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.qQU.toLowerCase())}),status:"Success"}),l.GJZ,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(l.GJZ.toLowerCase())}),status:"Error"})),render:function(e,t){var n,r=(n={},p()(p()(p()(p()(p()(p()(p()(p()(p()(p()(n,l.sM_,"blue"),l.Yux,"geekblue"),l.sFW,"cyan"),l.W66,"magenta"),l.z1,"processing"),l.yZA,"lime"),l.pIN,"warning"),l.XrC,"orange"),l.L1h,"cyan"),l.yib,"volcano"),p()(p()(p()(p()(p()(p()(n,l.hwr,"success"),l.AzB,"purple"),l.frw,"default"),l.xw4,"error"),l.qQU,"green"),l.GJZ,"red"));return(0,ue.jsx)(B.Z,{color:r[t.status],children:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.status.".concat(t.status.toLowerCase())})})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority"}),dataIndex:"priority",tooltip:r.formatMessage({id:"ticket.priority.tooltip"}),valueType:"select",valueEnum:p()(p()(p()(p()(p()(p()({},l.JTO,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(l.JTO.toLowerCase())}),status:"Default"}),l.sbT,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(l.sbT.toLowerCase())}),status:"Processing"}),l.GMZ,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(l.GMZ.toLowerCase())}),status:"Warning"}),l.Bt2,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(l.Bt2.toLowerCase())}),status:"Warning"}),l._Xr,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(l._Xr.toLowerCase())}),status:"Error"}),l.Lx6,{text:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(l.Lx6.toLowerCase())}),status:"Error"}),render:function(e,t){var n,r=p()(p()(p()(p()(p()(p()({},l.JTO,"default"),l.sbT,"blue"),l.GMZ,"orange"),l.Bt2,"volcano"),l._Xr,"red"),l.Lx6,"purple");return(0,ue.jsx)(B.Z,{color:r[null==t?void 0:t.priority],children:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.priority.".concat(null==t||null===(n=t.priority)||void 0===n?void 0:n.toLowerCase())})})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.category"}),dataIndex:"categoryUid",key:"categoryUid",hideInSearch:!0,width:180,tooltip:r.formatMessage({id:"ticket.category.tooltip",defaultMessage:"工单所属分类"}),render:function(e,t){if(!t.categoryUid)return(0,ue.jsx)(B.Z,{color:"default",children:r.formatMessage({id:"ticket.category.unset",defaultMessage:"未设置分类"})});var n=Ee.get(t.categoryUid);return n?(0,ue.jsx)(B.Z,{color:"green",children:N(n.name)||n.name||n.uid}):(0,ue.jsx)(B.Z,{color:"default",children:r.formatMessage({id:"ticket.category.missing",defaultMessage:"未知分类"})})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.department",defaultMessage:"所属部门"}),dataIndex:"departmentUid",key:"departmentUid",hideInSearch:!0,width:200,tooltip:r.formatMessage({id:"ticket.department.tooltip",defaultMessage:"工单所属部门"}),render:function(e,t){if(!t.departmentUid)return(0,ue.jsx)(B.Z,{color:"default",children:r.formatMessage({id:"ticket.department.unset",defaultMessage:"未设置部门"})});var n=Le.get(t.departmentUid);if(!n)return(0,ue.jsx)(B.Z,{color:"default",children:r.formatMessage({id:"ticket.department.missing",defaultMessage:"未知部门"})});var a=N(n.name||n.name)||n.name||n.name||n.uid;return(0,ue.jsx)(B.Z,{color:"purple",children:a})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.assignee"}),dataIndex:"assignee",hideInSearch:!0,tooltip:r.formatMessage({id:"ticket.assignee.tooltip"}),render:function(e,t,n,r){var a;return(0,ue.jsx)(B.Z,{color:"blue",children:null==t||null===(a=t.assignee)||void 0===a?void 0:a.nickname})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.reporter"}),dataIndex:"reporter",hideInSearch:!0,tooltip:r.formatMessage({id:"ticket.reporter.tooltip"}),render:function(e,t,n,r){var a;return(0,ue.jsx)(B.Z,{color:"red",children:null==t||null===(a=t.reporter)||void 0===a?void 0:a.nickname})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.schema"}),dataIndex:"schema",hideInSearch:!0,ellipsis:!0,width:300,tooltip:r.formatMessage({id:"ticket.schema.tooltip"}),render:function(e,t){if(!t.schema)return(0,ue.jsx)("span",{style:{color:"#999"},children:"-"});try{var n=JSON.parse(t.schema);if(n.formData&&Object.keys(n.formData).length>0){var r=Object.entries(n.formData).filter((function(e){var t=a()(e,2),n=(t[0],t[1]);return null!=n&&""!==n})).map((function(e){var t,r=a()(e,2),i=r[0],o=r[1],s=(null===(t=n.fieldLabels)||void 0===t?void 0:t[i])||i,l=String(o);return"".concat(s,": ").concat(l.length>20?l.substring(0,20)+"...":l)}));return 0===r.length?(0,ue.jsx)("span",{style:{color:"#999"},children:"-"}):(0,ue.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",maxHeight:"60px",overflow:"hidden"},children:r.map((function(e,t){return(0,ue.jsx)(B.Z,{color:"geekblue",style:{fontSize:"11px",padding:"1px 4px"},children:e},t)}))})}}catch(e){console.error("解析 schema 数据失败:",e)}return(0,ue.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"createdAt"}),dataIndex:"createdAt",valueType:"dateTime",hideInSearch:!0,sorter:!0,tooltip:r.formatMessage({id:"ticket.createdAt.tooltip"}),render:function(e,t,n,r){return _()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"updatedAt"}),dataIndex:"updatedAt",valueType:"dateTime",hideInSearch:!0,sorter:!0,tooltip:r.formatMessage({id:"ticket.updatedAt.tooltip"}),render:function(e,t,n,r){return _()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,ue.jsx)(L.FormattedMessage,{id:"action"}),key:"option",dataIndex:"option",hideInSearch:!0,width:200,fixed:"right",tooltip:r.formatMessage({id:"ticket.action.tooltip"}),render:function(e,t){return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(O.ZP,{type:"link",onClick:function(){return Q(t),G(!0),void ne(!0)},children:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.action.edit"})}),(0,ue.jsx)(O.ZP,{type:"link",onClick:function(){return Q(t),void de(!0)},children:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.action.view"})}),(0,ue.jsx)(R.Z,{title:r.formatMessage({id:"deleteTip"}),description:"".concat(r.formatMessage({id:"deleteAffirm"}),"【").concat(t.description,"】？"),onConfirm:function(){return De(t)},okText:r.formatMessage({id:"ok"}),cancelText:r.formatMessage({id:"cancel"}),children:(0,ue.jsx)(O.ZP,{type:"link",children:(0,ue.jsx)(L.FormattedMessage,{id:"ticket.action.delete"})})})]})}}];return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(E.Z,{columns:_e,actionRef:o,cardBordered:!0,rowSelection:Re,scroll:{x:2100},request:function(){var e=b()(k()().mark((function e(t,r,a){var i,o,s,c,u,m,p,g;return k()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.current,o=t.pageSize,s=f()(t,Me),d(i),y(o),Ce(v()(v()({},s),{},{type:n})),c=void 0,u=void 0,r&&Object.keys(r).length>0&&(m=Object.keys(r)[0],c=m,u="ascend"===r[m]?"ascend":"descend"),p=v()(v()(v()({pageNumber:i-1,pageSize:o,orgUid:null==M?void 0:M.uid,type:n},(null==A?void 0:A.uid)!==l.zBg&&{categoryUid:null==A?void 0:A.uid}),s),{},{sortBy:c,sortDirection:u}),e.next=10,(0,j.N2)(p);case 10:return g=e.sent,H.Z.debug("queryTicketsByOrgUid response:",g,p),200===g.code?ze(null==g?void 0:g.data.totalElements):w.yw.error(g.message),e.abrupt("return",{data:null==g?void 0:g.data.content,success:!0,total:null==g?void 0:g.data.totalElements});case 14:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),editable:{type:"multiple"},rowKey:"uid",search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,onChange:function(e,t){d(e),t&&y(t)}},dateFormatter:"string",headerTitle:r.formatMessage({id:"ticket.list"}),toolBarRender:function(){var e=[],t=[{key:"export-current",icon:(0,ue.jsx)(U.Z,{}),label:r.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return Oe("current")}}];Ie>0&&(Ie<=1e3?t.push({key:"export-all",icon:(0,ue.jsx)(U.Z,{}),label:r.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(Ie,"条)"),onClick:function(){return Oe("all")}}):t.push({key:"export-range",icon:(0,ue.jsx)(U.Z,{}),label:r.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(Ie,"条)"),children:Be(Ie)})),e.push((0,ue.jsx)(T.Z,{menu:{items:t},placement:"bottom",children:(0,ue.jsxs)(O.ZP,{type:"primary",icon:(0,ue.jsx)(U.Z,{}),children:[r.formatMessage({id:"import.export",defaultMessage:"导出"}),(0,ue.jsx)(I.Z,{})]})},"importExport"));var n=[];return ve.length>0&&n.push({key:"batchDelete",icon:(0,ue.jsx)(z.Z,{}),danger:!0,label:r.formatMessage({id:"batch.delete"})+" (".concat(ve.length,")"),onClick:function(){ie.confirm({title:r.formatMessage({id:"batch.deleteTip"}),content:"".concat(r.formatMessage({id:"batch.deleteAffirm"})," ").concat(ve.length," ").concat(r.formatMessage({id:"items"}),"?"),onOk:Te,okText:r.formatMessage({id:"ok"}),cancelText:r.formatMessage({id:"cancel"})})}}),n.length>0&&e.push((0,ue.jsx)(T.Z,{menu:{items:n},placement:"bottom",children:(0,ue.jsxs)(O.ZP,{type:ve.length>0?"primary":"default",danger:ve.length>0,children:[ve.length>0?r.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(ve.length,")"):r.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,ue.jsx)(I.Z,{})]})},"batchOperations")),e}}),J&&(0,ue.jsx)(me,{open:J,isEdit:te,currentTicket:Y,onCancel:Ne,onSuccess:function(){var e;null===(e=o.current)||void 0===e||e.reload(),Ne()}}),ce&&(0,ue.jsx)(ke,{open:ce,ticket:Y,onClose:function(){return de(!1)}}),oe]})},we=function(){var e=(0,L.useIntl)(),t=(0,s.Z)(),n=t.leftSiderStyle,r=t.contentStyle,d=(0,i.useState)(l.IpQ),f=a()(d,2),m=f[0],p=f[1],g=m===l.IpQ?l.p$M:l.hXJ,v=[{key:l.dCh,label:e.formatMessage({id:"ticket.tab.external",defaultMessage:"外部工单"})},{key:l.IpQ,label:e.formatMessage({id:"ticket.tab.internal",defaultMessage:"内部工单"})}];return(0,ue.jsxs)(c.Z,{style:{height:"100%"},children:[(0,ue.jsx)(c.Z.Panel,{defaultSize:"15%",min:"15%",max:"40%",style:n,children:(0,ue.jsx)(o.Z,{type:g,level:l.whQ,showKbase:!1})}),(0,ue.jsx)(c.Z.Panel,{style:r,children:(0,ue.jsxs)("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:[(0,ue.jsx)(u.Z,{activeKey:m,onChange:function(e){p(e||l.IpQ)},items:v}),(0,ue.jsx)("div",{style:{flex:1,minHeight:0},children:(0,ue.jsx)(be,{ticketType:m})})]})})]})}},11394:function(e,t,n){n.d(t,{H:function(){return m}});var r=n(86222),a=n.n(r),i=n(76711),o=n.n(i),s=n(73193),l=n.n(s),c=n(6844),u=n(26557),d=n(26407),f=n(20744),m=(0,u.Ue)()((0,d.mW)((0,d.tJ)((0,f.n)((function(e,t){return{departmentResult:{data:{content:[]}},currentDepartment:{uid:c.zBg,nickname:c.zBg},insertDepartment:function(t){e((function(e){var n=e.departmentResult.data.content;if(t.parentUid){var r=n.find((function(e){return e.uid===t.parentUid}));r&&(r.children||(r.children=[]),r.children.push(t))}else n.push(t)}))},upgradeDepartment:function(t){e((function(e){var n=e.departmentResult.data.content,r=n.findIndex((function(e){return e.uid===t.uid}));-1!==r?n[r]=t:n.forEach((function(e){if(e.children){var n=e.children.findIndex((function(e){return e.uid===t.uid}));-1!==n&&(e.children[n]=t)}}))}))},setDepartmentResult:function(n){var r,a={uid:c.zBg,name:c.zBg};(e({departmentResult:l()(l()({},n),{},{data:{content:[a].concat(o()(n.data.content))}})}),""===t().currentDepartment.uid)&&((null===(r=n.data)||void 0===r||null===(r=r.content)||void 0===r?void 0:r.length)>0&&e({currentDepartment:n.data.content[0]}))},setCurrentDepartment:function(n){var r=t().departmentResult.data.content,a=r.findIndex((function(e){return e.uid===n.uid}));if(-1!==a){var i=[].concat(o()(r.slice(0,a)),[n],o()(r.slice(a+1))),s=l()(l()({},t().departmentResult),{},{data:{content:i}});e({departmentResult:s,currentDepartment:n})}else console.warn("Department with the specified uid not found."),e({currentDepartment:n})},removeDepartment:function(n){e((function(e){var t=e.departmentResult.data.content;e.departmentResult.data.content=function e(t,n){return t.filter((function(t){return t.uid!==n&&(t.children&&(t.children=e(t.children,n)),!0)}))}(t,n)})),t().currentDepartment.uid===n&&e({currentDepartment:{uid:""}})},setCurrentDepUid:function(n){var r,i,o=null===(r=t().departmentResult)||void 0===r||null===(r=r.data)||void 0===r||null===(r=r.content)||void 0===r?void 0:r.find((function(e){return e.uid===n}));if(o)e({currentDepartment:o});else{!function t(r){var i,o=a()(r);try{for(o.s();!(i=o.n()).done;){var s=i.value;if(s.uid===n)return void e({currentDepartment:s});s.children&&s.children.length>0&&t(s.children)}}catch(e){o.e(e)}finally{o.f()}}((null===(i=t().departmentResult)||void 0===i||null===(i=i.data)||void 0===i?void 0:i.content)||[])}},deleteDepartmentCache:function(){return e({},!0)}}})),{name:c.xY_})))},41587:function(e,t,n){n.d(t,{Z:function(){return s}});var r=n(6844),a=n(26557),i=n(26407),o=n(20744),s=(0,a.Ue)()((0,i.mW)((0,i.tJ)((0,o.n)((function(e,t){return{memberResult:{data:{content:[],totalElements:0}},insertMember:function(t){e((function(e){e.memberResult.data.content.unshift(t)}))},updateMember:function(t){e((function(e){var n=e.memberResult.data.content,r=n.findIndex((function(e){return e.uid===t.uid}));-1!==r?n[r]=t:console.warn("Member with uid ".concat(t.uid," not found."))}))},deleteMember:function(t){e((function(e){var n=e.memberResult.data.content,r=n.findIndex((function(e){return e.uid===t.uid}));-1!==r?n.splice(r,1):console.warn("Member with uid ".concat(t.uid," not found."))}))},setMemberResult:function(t){e({memberResult:t})},deleteMemberCache:function(){return e({},!0)}}})),{name:r.PQL})))},70984:function(e,t,n){n.d(t,{Z:function(){return w}});var r=n(44194),a=n(51865),i=n.n(a),o=n(34573),s=n(82640),l=n(76175),c=n(74083),u=n(77167);const d=["wrap","nowrap","wrap-reverse"],f=["flex-start","flex-end","start","end","center","space-between","space-around","space-evenly","stretch","normal","left","right"],m=["center","start","end","flex-start","flex-end","self-start","self-end","baseline","normal","stretch"];var p=function(e,t){return i()(Object.assign(Object.assign(Object.assign({},((e,t)=>{const n=!0===t.wrap?"wrap":t.wrap;return{[`${e}-wrap-${n}`]:n&&d.includes(n)}})(e,t)),((e,t)=>{const n={};return m.forEach((r=>{n[`${e}-align-${r}`]=t.align===r})),n[`${e}-align-stretch`]=!t.align&&!!t.vertical,n})(e,t)),((e,t)=>{const n={};return f.forEach((r=>{n[`${e}-justify-${r}`]=t.justify===r})),n})(e,t)))};const g=e=>{const{componentCls:t}=e;return{[t]:{display:"flex",margin:0,padding:0,"&-vertical":{flexDirection:"column"},"&-rtl":{direction:"rtl"},"&:empty":{display:"none"}}}},v=e=>{const{componentCls:t}=e;return{[t]:{"&-gap-small":{gap:e.flexGapSM},"&-gap-middle":{gap:e.flexGap},"&-gap-large":{gap:e.flexGapLG}}}},h=e=>{const{componentCls:t}=e,n={};return d.forEach((e=>{n[`${t}-wrap-${e}`]={flexWrap:e}})),n},x=e=>{const{componentCls:t}=e,n={};return m.forEach((e=>{n[`${t}-align-${e}`]={alignItems:e}})),n},y=e=>{const{componentCls:t}=e,n={};return f.forEach((e=>{n[`${t}-justify-${e}`]={justifyContent:e}})),n};var k=(0,c.I$)("Flex",(e=>{const{paddingXS:t,padding:n,paddingLG:r}=e,a=(0,u.IX)(e,{flexGapSM:t,flexGap:n,flexGapLG:r});return[g(a),v(a),h(a),x(a),y(a)]}),(()=>({})),{resetStyle:!1}),M=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(n[r[a]]=e[r[a]])}return n};const b=r.forwardRef(((e,t)=>{const{prefixCls:n,rootClassName:a,className:c,style:u,flex:d,gap:f,vertical:m=!1,component:g="div",children:v}=e,h=M(e,["prefixCls","rootClassName","className","style","flex","gap","vertical","component","children"]),{flex:x,direction:y,getPrefixCls:b}=r.useContext(l.E_),w=b("flex",n),[j,S,Z]=k(w),C=null!=m?m:null==x?void 0:x.vertical,F=i()(c,a,null==x?void 0:x.className,w,S,Z,p(w,e),{[`${w}-rtl`]:"rtl"===y,[`${w}-gap-${f}`]:(0,s.n)(f),[`${w}-vertical`]:C}),U=Object.assign(Object.assign({},null==x?void 0:x.style),u);return d&&(U.flex=d),f&&!(0,s.n)(f)&&(U.gap=f),j(r.createElement(g,Object.assign({ref:t,className:F,style:U},(0,o.Z)(h,["justify","wrap","align"])),v))}));var w=b}}]);