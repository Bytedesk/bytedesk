"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[2867],{2867:function(e,t,a){a.d(t,{Z:function(){return re}});var r=a(73193),s=a.n(r),n=a(84176),i=a.n(n),d=a(90819),l=a.n(d),o=a(89933),u=a.n(o),c=a(76711),f=a.n(c),m=a(45332),p=a.n(m),g=a(5286),h=a(36265),M=a(5861);function x(e){return v.apply(this,arguments)}function v(){return(v=u()(l()().mark((function e(t){return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,M.request)("/api/v1/license/query/org",{method:"GET",params:s()(s()({},t),{},{channel:h.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(e){return b.apply(this,arguments)}function b(){return(b=u()(l()().mark((function e(t){return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,M.request)("/api/v1/license/create",{method:"POST",data:s()(s()({},t),{},{channel:h.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e){return j.apply(this,arguments)}function j(){return(j=u()(l()().mark((function e(t){return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,M.request)("/api/v1/license/update",{method:"POST",data:s()(s()({},t),{},{channel:h.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(e){return k.apply(this,arguments)}function k(){return(k=u()(l()().mark((function e(t){return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,M.request)("/api/v1/license/delete",{method:"POST",data:s()(s()({},t),{},{channel:h.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var I=a(71865),E=a(83381),D=a(6992),S=a(31362),P=a(96082),Z=a(25709),C=a(44877),T=a(2157),A=a(98162),L=a(44194),Y=a(86222),B=a.n(Y),K=a(40845),q=a(44565),U=a(60857),O=a(2685),z=a(86469),R=a(13437),N=a(14999),V=a(19095),J=a(76185),_=a(51379),H=a(96596),X=a.n(H),$=a(31549),G=function(e){var t,a,r=e.isEdit,n=e.license,i=e.open,d=e.superUser,o=e.onClose,c=e.onSubmit,f=(0,M.useIntl)(),m=K.A.useForm(),g=p()(m,1)[0],x=(0,_.L)((function(e){return e.userInfo})),v=(0,I.u)((function(e){return e.currentOrg})),y=(0,L.useState)(""),b=p()(y,2),w=(b[0],b[1],(0,L.useState)(h.dbF)),j=p()(w,2),F=j[0],k=j[1],E=function(e){return(0,$.jsxs)("span",{children:[e,(0,$.jsx)("span",{style:{color:"#ff4d4f",marginLeft:4},children:"*"})]})},D=f.formatMessage({id:"license.endpoint.required",defaultMessage:"请至少绑定授权IP或授权域名"}),S=function(e){return(null!=e?e:"").split(",").map((function(e){return e.trim()})).filter((function(e){return Boolean(e)}))};return(0,L.useEffect)((function(){if(r)g.setFieldsValue({uid:null==n?void 0:n.uid,name:null==n?void 0:n.name,description:null==n?void 0:n.description,mobile:null==n?void 0:n.mobile,email:null==n?void 0:n.email,userType:null==n?void 0:n.userType,expiryDate:null==n?void 0:n.expiryDate,edition:null==n?void 0:n.edition,serverIps:null==n?void 0:n.serverIps,serverDomains:null==n?void 0:n.serverDomains,enabled:null==n?void 0:n.enabled,activatedAt:null==n?void 0:n.activatedAt,lastCheckedAt:null==n?void 0:n.lastCheckedAt}),k((null==n?void 0:n.edition)||h.dbF);else{var e=X()().add(30,"day").format("YYYY-MM-DD HH:mm:ss");g.setFieldsValue({mobile:null==x?void 0:x.mobile,email:null==x?void 0:x.email,userType:h.Bv_,edition:h.dbF,expiryDate:e}),k(h.dbF)}}),[r,n,g,x]),(0,$.jsx)($.Fragment,{children:(0,$.jsx)(V.Z,{title:f.formatMessage({id:"license.title",defaultMessage:"License"}),width:600,onClose:o,open:i,extra:(0,$.jsxs)(J.Z,{children:[(0,$.jsx)(T.ZP,{onClick:o,children:f.formatMessage({id:"cancel",defaultMessage:"Cancel"})}),(0,$.jsx)(T.ZP,{type:"primary",onClick:function(){return g.submit()},children:f.formatMessage({id:"submit",defaultMessage:"Submit"})})]}),children:(0,$.jsxs)(K.A,{form:g,name:"licenseForm",onFinish:function(){console.log("handleSubmit"),null!=x&&x.mobileVerified||null!=x&&x.emailVerified?g.validateFields().then((function(e){var t=s()({},e),a=s()(s()({},t),{},{orgUid:null==v?void 0:v.uid});console.log("submit",a),c(a)})):N.ZP.error(f.formatMessage({id:"license.verification.required",defaultMessage:"请先完成手机或邮箱验证后再创建License"}))},submitter:!1,children:[(0,$.jsx)(q.Z,{label:f.formatMessage({id:"name",defaultMessage:"Name"}),name:"name",rules:[{required:!0},{validator:function(e,t){return"string"==typeof t&&t.toLowerCase().includes("weiyu")?Promise.reject(new Error(f.formatMessage({id:"license.name.weiyu.forbidden",defaultMessage:"名称不能包含 weiyu"}))):Promise.resolve()}}]}),(0,$.jsx)(U.Z,{label:f.formatMessage({id:"description",defaultMessage:"Description"}),name:"description",placeholder:f.formatMessage({id:"license.description.placeholder",defaultMessage:"Optional, license usage description"})}),(0,$.jsx)(q.Z,{label:f.formatMessage({id:"mobile",defaultMessage:"Mobile"}),name:"mobile",disabled:!d}),(0,$.jsx)(q.Z,{label:f.formatMessage({id:"email",defaultMessage:"Email"}),name:"email",disabled:!d}),(0,$.jsx)(O.Z,{label:f.formatMessage({id:"userType",defaultMessage:"User Type"}),name:"userType",options:[{label:f.formatMessage({id:"license.user.type.free",defaultMessage:"Free"}),value:h.Bv_},{label:f.formatMessage({id:"license.user.type.paid",defaultMessage:"Paid"}),value:h.u0z,disabled:!d}],extra:(0,$.jsx)("a",{href:"https://www.weiyuai.cn/docs/zh-CN/docs/payment#%E8%81%94%E7%B3%BB%E6%96%B9%E5%BC%8F",target:"_blank",rel:"noopener noreferrer",style:{color:"#1677ff"},children:f.formatMessage({id:"license.userType.paid.tip",defaultMessage:"购买付费版请访问微语官网-版本与价格"})})}),(0,$.jsx)(z.Z,{label:f.formatMessage({id:"expiryDate",defaultMessage:"Expiry Date"}),name:"expiryDate",fieldProps:{format:"YYYY-MM-DD"},rules:[{required:!0,message:f.formatMessage({id:"license.expiryDate.required",defaultMessage:"Please select expiry date"})}],disabled:!d&&F!==h.dbF}),(0,$.jsx)(O.Z,{label:f.formatMessage({id:"edition",defaultMessage:"Edition"}),name:"edition",options:[{label:f.formatMessage({id:"license.edition.community",defaultMessage:"Community Edition"}),value:h.dbF},{label:f.formatMessage({id:"license.edition.enterprise",defaultMessage:"Enterprise Edition"}),value:h.hj_},{label:f.formatMessage({id:"license.edition.platform",defaultMessage:"Platform Edition"}),value:h.tmZ}],fieldProps:{onChange:function(e){if(k(e),!d&&(e===h.hj_||e===h.tmZ)){var t=X()().add(30,"day").format("YYYY-MM-DD HH:mm:ss");g.setFieldValue("expiryDate",t)}}}}),(0,$.jsx)(q.Z,{label:E(f.formatMessage({id:"serverIps",defaultMessage:"Authorized IPs"})),name:"serverIps",placeholder:f.formatMessage({id:"license.comma.separated",defaultMessage:"Comma separated"}),extra:f.formatMessage({id:"license.serverIps.format",defaultMessage:"Format: 192.168.1.1, 10.0.0.1, 2001:db8::1"}),rules:[{validator:(a=u()(l()().mark((function e(t,a){var r,s,n,i,d,o,u;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=S(a),s=S(g.getFieldValue("serverDomains")),0!==r.length||0!==s.length){e.next=4;break}return e.abrupt("return",Promise.reject(new Error(D)));case 4:if(0!==r.length){e.next=6;break}return e.abrupt("return",Promise.resolve());case 6:n=/^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/,i=/^([\da-fA-F]{1,4}:){7}[\da-fA-F]{1,4}$/,d=B()(r),e.prev=9,d.s();case 11:if((o=d.n()).done){e.next=17;break}if(u=o.value,n.test(u)||i.test(u)){e.next=15;break}return e.abrupt("return",Promise.reject(new Error(f.formatMessage({id:"license.serverIps.error",defaultMessage:"Please enter valid IP addresses, separated by commas"}))));case 15:e.next=11;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(9),d.e(e.t0);case 22:return e.prev=22,d.f(),e.finish(22);case 25:return e.abrupt("return",Promise.resolve());case 26:case"end":return e.stop()}}),e,null,[[9,19,22,25]])}))),function(e,t){return a.apply(this,arguments)})}]}),(0,$.jsx)(q.Z,{label:E(f.formatMessage({id:"serverDomains",defaultMessage:"Authorized Domains"})),name:"serverDomains",placeholder:f.formatMessage({id:"license.comma.separated",defaultMessage:"Comma separated"}),extra:f.formatMessage({id:"license.serverDomains.format",defaultMessage:"Format: example.com, sub.example.com:8080, *.example.com"}),rules:[{validator:(t=u()(l()().mark((function e(t,a){var r,s,n,i,d,o;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=S(a),s=S(g.getFieldValue("serverIps")),0!==r.length||0!==s.length){e.next=4;break}return e.abrupt("return",Promise.reject(new Error(D)));case 4:if(0!==r.length){e.next=6;break}return e.abrupt("return",Promise.resolve());case 6:n=/^((\*\.)?([A-Za-z0-9-]{1,63}\.)+[A-Za-z]{2,})(:\d{1,5})?$/,i=B()(r),e.prev=8,i.s();case 10:if((d=i.n()).done){e.next=16;break}if(o=d.value,n.test(o)){e.next=14;break}return e.abrupt("return",Promise.reject(new Error(f.formatMessage({id:"license.serverDomains.error",defaultMessage:"Please enter valid domains, separated by commas"}))));case 14:e.next=10;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(8),i.e(e.t0);case 21:return e.prev=21,i.f(),e.finish(21);case 24:return e.abrupt("return",Promise.resolve());case 25:case"end":return e.stop()}}),e,null,[[8,18,21,24]])}))),function(e,a){return t.apply(this,arguments)})}]}),(0,$.jsx)(R.Z,{label:f.formatMessage({id:"enabled",defaultMessage:"Enabled"}),name:"enabled",fieldProps:{checkedChildren:f.formatMessage({id:"license.enabled",defaultMessage:"Enabled"}),unCheckedChildren:f.formatMessage({id:"license.disabled",defaultMessage:"Disabled"})}})]})})})},Q=a(31661),W=a(26439),ee=a(42539),te=["current","pageSize"],ae=function(e){if(!e)return(0,$.jsx)(P.Z,{color:"default",children:"-"});var t=e.split(",").map((function(e){return e.trim()})).filter(Boolean);return 0===t.length?(0,$.jsx)(P.Z,{color:"default",children:"-"}):t.map((function(e){return(0,$.jsx)(P.Z,{color:"blue",style:{marginBottom:4},children:e},e)}))},re=function(e){var t=e.superUser,a=(0,M.useIntl)(),r=(0,L.useRef)(),n=(0,Q.Z)().translateString,d=(0,L.useState)(1),o=p()(d,2),c=(o[0],o[1]),m=(0,L.useState)(10),h=p()(m,2),v=(h[0],h[1]),b=(0,I.u)((function(e){return e.currentOrg})),j=(0,L.useState)(!1),k=p()(j,2),P=k[0],Y=k[1],B=(0,L.useState)({}),K=p()(B,2),q=K[0],U=K[1],O=(0,L.useState)(!1),z=p()(O,2),R=z[0],N=z[1],V=Z.Z.useModal(),J=p()(V,2),_=J[0],H=J[1],re=(0,L.useState)([]),se=p()(re,2),ne=se[0],ie=se[1],de=(0,L.useState)([]),le=p()(de,2),oe=(le[0],le[1]),ue=(0,L.useState)(0),ce=p()(ue,2),fe=(ce[0],ce[1]),me=(0,L.useState)({}),pe=p()(me,2),ge=(pe[0],pe[1]),he=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:(0,$.jsx)(M.FormattedMessage,{id:"name",defaultMessage:"Name"}),dataIndex:"name",copyable:!0,fixed:"left",width:150},{title:(0,$.jsx)(M.FormattedMessage,{id:"description",defaultMessage:"Description"}),dataIndex:"description",width:150,ellipsis:!0},{title:(0,$.jsx)(M.FormattedMessage,{id:"mobile",defaultMessage:"Mobile"}),dataIndex:"mobile",width:120},{title:(0,$.jsx)(M.FormattedMessage,{id:"email",defaultMessage:"Email"}),dataIndex:"email",width:180},{title:(0,$.jsx)(M.FormattedMessage,{id:"userType",defaultMessage:"User Type"}),dataIndex:"userType",hideInSearch:!0,width:120,valueEnum:{FREE:{text:(0,$.jsx)(M.FormattedMessage,{id:"license.user.type.free",defaultMessage:"Free"})},PAID:{text:(0,$.jsx)(M.FormattedMessage,{id:"license.user.type.paid",defaultMessage:"Paid"})}}},{title:(0,$.jsx)(M.FormattedMessage,{id:"expiryDate",defaultMessage:"Expiry Date"}),dataIndex:"expiryDate",hideInSearch:!0,width:120,render:function(e){return e?X()(e).format("YYYY-MM-DD"):""}},{title:(0,$.jsx)(M.FormattedMessage,{id:"edition",defaultMessage:"Edition"}),dataIndex:"edition",hideInSearch:!0,width:120,valueEnum:{COMMUNITY:{text:(0,$.jsx)(M.FormattedMessage,{id:"license.edition.community",defaultMessage:"Community Edition"})},ENTERPRISE:{text:(0,$.jsx)(M.FormattedMessage,{id:"license.edition.enterprise",defaultMessage:"Enterprise Edition"})},PLATFORM:{text:(0,$.jsx)(M.FormattedMessage,{id:"license.edition.platform",defaultMessage:"Platform Edition"})}}},{title:(0,$.jsx)(M.FormattedMessage,{id:"serverIps",defaultMessage:"Server IPs"}),dataIndex:"serverIps",hideInSearch:!0,width:180,render:function(e,t){return ae(t.serverIps)}},{title:(0,$.jsx)(M.FormattedMessage,{id:"serverDomains",defaultMessage:"Server Domains"}),dataIndex:"serverDomains",hideInSearch:!0,width:180,render:function(e,t){return ae(t.serverDomains)}},{title:(0,$.jsx)(M.FormattedMessage,{id:"licenseKey",defaultMessage:"License Key"}),dataIndex:"licenseKey",width:200,copyable:!0,ellipsis:!0}].concat(f()(t?[{title:(0,$.jsx)(M.FormattedMessage,{id:"encryptedLicenseKey",defaultMessage:"Encrypted License Key"}),dataIndex:"encryptedLicenseKey",width:200,copyable:!0,ellipsis:!0}]:[]),[{title:(0,$.jsx)(M.FormattedMessage,{id:"enabled",defaultMessage:"Enabled"}),dataIndex:"enabled",hideInSearch:!0,width:100,valueType:"select",valueEnum:{true:{text:"启用",status:"Success"},false:{text:"禁用",status:"Error"}}},{title:(0,$.jsx)(M.FormattedMessage,{id:"createdAt",defaultMessage:"Created At"}),dataIndex:"createdAt",hideInSearch:!0,width:180,valueType:"dateTime"},{title:(0,$.jsx)(M.FormattedMessage,{id:"updatedAt",defaultMessage:"Updated At"}),dataIndex:"updatedAt",hideInSearch:!0,width:180,valueType:"dateTime"}]),Me=[].concat(f()(he),[{title:a.formatMessage({id:"actions",defaultMessage:"Actions"}),valueType:"option",key:"option",fixed:"right",width:220,render:function(e,r,s,i){return[(0,$.jsx)("a",{onClick:function(){U(r),N(!0),Y(!0)},children:a.formatMessage({id:"edit",defaultMessage:"Edit"})},"editable"),(0,$.jsx)(C.Z,{title:a.formatMessage({id:"deleteTip"}),description:"".concat(a.formatMessage({id:"deleteAffirm",defaultMessage:"Delete"}),"【").concat(n(r.name),"】？"),onConfirm:function(){return xe(r)},okText:a.formatMessage({id:"ok"}),cancelText:a.formatMessage({id:"cancel"}),icon:(0,$.jsx)(E.Z,{style:{color:"red"}}),children:(0,$.jsx)(T.ZP,{type:"link",danger:!0,children:a.formatMessage({id:"delete",defaultMessage:"Delete"})})},"delete")].concat(f()(t?[(0,$.jsx)(T.ZP,{type:"link",onClick:function(){return we(r.encryptedLicenseKey)},children:"测试"},"test-decrypt")]:[]))}}]),xe=function(){var e=u()(l()().mark((function e(t){var s;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("deleteLicense:",t),e.next=3,F(t);case 3:s=e.sent,console.log("deleteLicense:",s),200===s.code?(g.yw.success(a.formatMessage({id:"delete.success",defaultMessage:"Delete success"})),r.current.reload()):g.yw.error(s.message);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ve=function(){var e=u()(l()().mark((function e(t){var a,s;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(t);case 2:a=e.sent,console.log("handleCreateLicense response:",a),200===a.code?(null===(s=r.current)||void 0===s||s.reload(),Y(!1)):g.yw.error(a.message);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ye=function(){var e=u()(l()().mark((function e(t){var a,s;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.uid=null==q?void 0:q.uid,e.next=3,w(t);case 3:a=e.sent,console.log("handleUpdateLicense response:",a),200===a.code?(null===(s=r.current)||void 0===s||s.reload(),Y(!1)):g.yw.error(a.message);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),be=function(){Y(!0),N(!1),U({})},we=function(e){try{var t=(0,W.K_)(e);_.info({title:"解密结果",content:(0,$.jsx)("div",{style:{wordBreak:"break-all"},children:(0,$.jsx)("pre",{children:JSON.stringify(t,null,2)})}),width:600})}catch(e){_.error({title:"解密失败",content:String(e)})}},je={selectedRowKeys:ne,onChange:function(e,t){ie(e),oe(t)}},Fe=function(){var e=u()(l()().mark((function e(a,r,n){var d,o,u,f,m;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=a.current,o=a.pageSize,u=i()(a,te),c(d),v(o),ge(u),f=s()({pageNumber:d-1,pageSize:o,orgUid:null==b?void 0:b.uid,superUser:t},u),e.next=7,x(f);case 7:return m=e.sent,ee.Z.debug("queryLicensesByOrg response:",null==m?void 0:m.data,f),200===m.code?fe(null==m?void 0:m.data.totalElements):g.yw.error(m.message),e.abrupt("return",{data:null==m?void 0:m.data.content,success:!0,total:null==m?void 0:m.data.totalElements});case 11:case"end":return e.stop()}}),e)})));return function(t,a,r){return e.apply(this,arguments)}}();return(0,$.jsxs)($.Fragment,{children:[P&&(0,$.jsx)(G,{isEdit:R,open:P,license:q,superUser:t,onClose:function(){Y(!1)},onSubmit:function(e){console.log("onDrawerSubmit:",e),R?ye(e):ve(e)}}),(0,$.jsx)(S.Z,{columns:Me,actionRef:r,cardBordered:!0,rowSelection:je,request:Fe,scroll:{x:1e3},rowKey:function(e){return e.uid||e.licenseKey||e.email||e.name},search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,onChange:function(e,t){c(e),v(t)}},dateFormatter:"string",headerTitle:"License列表",toolBarRender:function(){return[(0,$.jsx)(T.ZP,{type:"primary",icon:(0,$.jsx)(D.Z,{}),onClick:be,children:a.formatMessage({id:"create",defaultMessage:"Create"})},"create")]}}),(0,$.jsx)(A.Z,{message:"重要说明",description:"为防止微语系统被用于含有木马、病毒、色情、赌博、诈骗等违法违规业务，系统采用licenseKey机制进行授权管理。请妥善保管您的licenseKey，避免泄露或被盗用，确保系统安全使用。",type:"info",showIcon:!0,style:{marginTop:16}}),H]})}}}]);