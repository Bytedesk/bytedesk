"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[2255],{92053:function(e,t,n){n.d(t,{G9:function(){return b},J$:function(){return k},N6:function(){return M},VM:function(){return l},c8:function(){return d},gF:function(){return m},rg:function(){return p},sF:function(){return x}});var a=n(90819),r=n.n(a),s=n(89933),o=n.n(s),i=n(55735),u=n(41159);function l(){return c.apply(this,arguments)}function c(){return(c=o()(r()().mark((function e(){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/ping",{method:"GET",params:{client:i.bVn}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function d(){return f.apply(this,arguments)}function f(){return(f=o()(r()().mark((function e(){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/local-models",{method:"GET",params:{client:i.bVn}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(){return g.apply(this,arguments)}function g(){return(g=o()(r()().mark((function e(){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/models",{method:"GET",params:{client:i.bVn}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return h.apply(this,arguments)}function h(){return(h=o()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/library/models/"+t+"/details",{method:"GET",params:{client:i.bVn}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){return v.apply(this,arguments)}function v(){return(v=o()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/models/"+t+"/details",{method:"GET",params:{client:i.bVn}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function M(e){return y.apply(this,arguments)}function y(){return(y=o()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/models/pull",{method:"POST",params:{client:i.bVn},data:{model:t}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function b(e){return w.apply(this,arguments)}function w(){return(w=o()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/models/delete",{method:"POST",params:{client:i.bVn},data:{model:t}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function k(e){return j.apply(this,arguments)}function j(){return(j=o()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ollama4j/embedding-model/exists",{method:"GET",params:{client:i.bVn,model:t}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},76750:function(e,t,n){var a=n(55735),r=n(65461),s=n(41159);t.Z=function(){var e=(0,s.useIntl)();return{translateString:function(t){return null==t?t:t&&(null!=t&&t.startsWith(a.VoP)||null!=t&&t.startsWith("ROLE_"))?e.formatMessage({id:t,defaultMessage:t}):t},translateStringTranct:function(t){return null==t?t:null!=t&&t.startsWith(a.VoP)||null!=t&&t.startsWith("ROLE_")?(0,r.aS)(e.formatMessage({id:t,defaultMessage:t}),10):(0,r.aS)(t,10)}}}},80876:function(e,t,n){var a=n(45332),r=n.n(a),s=n(40612),o=n(55735),i=n(69169),u=n(4499),l=n(84881),c=n(41159),d=n(53530),f=n(44194),p=n(31549);t.Z=function(e){var t=e.open,n=e.onClose,a=e.onSubmit,g=(0,c.useIntl)(),m=i.A.useForm(),h=r()(m,1)[0],x=(0,s.u)((function(e){return e.currentOrg})),v=function(){console.log("handleSaveRobot"),h.validateFields().then((function(e){console.log("handleSaveRobot values:",e);var t={name:e.nickname,nickname:e.nickname,type:e.type,serviceSettings:{showQuickFaqs:!1,quickFaqs:[],showFaqs:!1,faqs:[],showGuessFaqs:!1,guessFaqs:[],showHotFaqs:!1,hotFaqs:[],showShortcutFaqs:!1,shortcutFaqs:[]},kbEnabled:!1,orgUid:null==x?void 0:x.uid};console.log("robotObject:",t),a(t),h.resetFields()})).catch((function(e){console.log("Form errors:",e)}))};return(0,f.useEffect)((function(){console.log("RobotForm useEffect"),t&&(h.resetFields(),h.setFieldsValue({type:o.f4h}))}),[t,h]),(0,p.jsx)("div",{children:(0,p.jsx)(d.Z,{title:g.formatMessage({id:"pages.robot.new",defaultMessage:"New"}),open:t,forceRender:!0,okText:g.formatMessage({id:"save",defaultMessage:"Save"}),onOk:v,onCancel:function(){h.resetFields(),n()},children:(0,p.jsxs)(i.A,{form:h,name:"basic",style:{maxWidth:400},submitter:!1,children:[(0,p.jsx)(u.Z,{label:g.formatMessage({id:"nickname",defaultMessage:"Nickname"}),name:"nickname",rules:[{required:!0,message:g.formatMessage({id:"nickname",defaultMessage:"Nickname"})}],fieldProps:{onPressEnter:function(){return v()}}}),(0,p.jsx)(l.Z,{label:g.formatMessage({id:"type",defaultMessage:"Type"}),name:["type"],options:[{label:g.formatMessage({id:o.f4h,defaultMessage:"Service"}),value:o.f4h}],rules:[{required:!0,message:g.formatMessage({id:"choose",defaultMessage:"Choose"})}],fieldProps:{placeholder:g.formatMessage({id:"choose",defaultMessage:"Choose"}),onChange:function(e){console.log("onTreeSelectChange:",e)},allowClear:!0}})]})})})}},41577:function(e,t,n){n.r(t),n.d(t,{default:function(){return yn}});var a=n(96865),r=n(75574),s=n(55735),o=n(95160),i=n(44194),u=n(8247),l=n(41159),c=n(84176),d=n.n(c),f=n(73193),p=n.n(f),g=n(86222),m=n.n(g),h=n(76711),x=n.n(h),v=n(90819),M=n.n(v),y=n(89933),b=n.n(y),w=n(45332),k=n.n(w),j=n(86803);function S(e){return Z.apply(this,arguments)}function Z(){return(Z=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/file/query/org",{method:"GET",params:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(e){return A.apply(this,arguments)}function A(){return(A=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/file/update",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(e){return I.apply(this,arguments)}function I(){return(I=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/file/delete",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function T(e){return F.apply(this,arguments)}function F(){return(F=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/file/delete/all",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var q=n(76750),E=n(6397),O=n(40612),P=n(51239),D=n(36310),R=n(73442),V=n(3849),Y=n(75365),L=n(80601),z=n(31549),B=function(e){var t=e.type,n=e.open,a=e.onClose,r=(0,q.Z)().translateString,s=(0,E.j)((function(e){return e.currentKbase})),o=(0,P.L)((function(e){return e.userInfo})),u=(0,O.u)((function(e){return e.currentOrg})),l=(0,i.useState)(""),c=k()(l,2),d=c[0],f=c[1],p=(0,i.useState)(!1),g=k()(p,2),m=g[0],h=g[1],x=function(){console.log("refresh"),h(!1);var e=(0,D.Cn)()+"?org="+encodeURIComponent(null==u?void 0:u.uid)+"&t="+encodeURIComponent(t)+"&sid="+encodeURIComponent(null==s?void 0:s.uid)+"&uid="+encodeURIComponent(null==o?void 0:o.uid)+"&nickname="+encodeURIComponent(null==o?void 0:o.nickname)+"&avatar="+encodeURIComponent(null==o?void 0:o.avatar)+"&navbar=0&"+(new Date).getTime();f(e)};(0,i.useEffect)((function(){x()}),[s]);return(0,z.jsx)(z.Fragment,{children:(0,z.jsxs)(R.Z,{title:r(null==s?void 0:s.name),onClose:function(){a&&a()},open:n,extra:(0,z.jsxs)(V.Z,{children:[(0,z.jsx)(Y.ZP,{onClick:function(){window.open(d)},children:"新窗口"}),(0,z.jsx)(Y.ZP,{onClick:function(){console.log("restart"),x()},type:"primary",children:"重新开始"})]}),styles:{body:{padding:0}},children:[(0,z.jsx)(L.Z,{spinning:!m,style:{position:"absolute",width:"100%",zIndex:1001},size:"large"}),(0,z.jsx)("iframe",{id:"chat-iframe",src:d,title:"demo",width:"100%",height:"100%",style:{border:0},"data-loaded":"true",onLoad:function(){h(!0),console.log("Iframe loaded successfully!")}})]})})},N=n(90838),Q=n(69114),H=n(71529),K=n(92110),W=n(10162),G=n(54881),_=n(58275),J=n(11090),$=n(2484),X=n(48524),ee=n(53530),te=n(32327),ne=n(29266),ae=n(61355),re=n(96485),se=n(28977),oe=n.n(se),ie=n(27650),ue=n(28425),le=n(32943),ce=n(72608),de=n(92053),fe=n(11490),pe="bge-m3:latest",ge=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n?ce.ZP.info("正在检查模型状态，请稍后再试"):t?e():(0,de.J$)().then((function(t){if(404===t.code)return console.log("API 返回 404，不影响操作，直接执行"),void e();var n=fe.A.getState().llmproviderConfigDefault.defaultEmbeddingModel||pe,a="请首先拉取Embedding向量模型".concat(n,"bge-m3:latest"===n?"，用于知识库向量检索":"，用于知识库向量检索。注意：当前配置的模型不是系统推荐的bge-m3:latest，可能会影响功能");ee.Z.warning({title:"嵌入式模型缺失",content:a,okText:"确定"})})).catch((function(t){console.error("重新检查模型时出错:",t),console.log("API 调用异常，不影响操作，直接执行"),e()}))},me=function(e){var t=e.onModelStatusChange,n=(0,l.useIntl)(),a=(0,i.useState)(!1),r=k()(a,2),s=r[0],o=r[1],u=(0,i.useState)(!1),c=k()(u,2),d=c[0],f=c[1],p=(0,i.useState)(!1),g=k()(p,2),m=(g[0],g[1],(0,fe.A)((function(e){return e.llmproviderConfigDefault.defaultEmbeddingModel}))||pe),h=(0,i.useState)(!1),x=k()(h,2),v=x[0],y=x[1],w=function(){var e=b()(M()().mark((function e(){var n,a;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,f(!0),null==t||t(!1),n="bge-m3:latest"===m,e.next=6,(0,de.J$)(m);case 6:a=e.sent,console.log("Embedding model check response:",a),200===a.code?(o(a.data),null==t||t(a.data),y(!n&&!1===a.data)):404===a.code?(o(!0),null==t||t(!0),y(!1),console.log("接口404，不影响使用，视为模型存在")):(o(!1),null==t||t(!1),y(!n)),e.next=18;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("检查嵌入式模型失败:",e.t0),o(!0),null==t||t(!0),y(!1),console.log("接口异常，不影响使用，视为模型存在");case 18:return e.prev=18,f(!1),e.finish(18);case 21:case"end":return e.stop()}}),e,null,[[0,11,18,21]])})));return function(){return e.apply(this,arguments)}}();return(0,i.useEffect)((function(){w()}),[]),d?(0,z.jsx)(le.Z,{type:"info",showIcon:!0,message:n.formatMessage({id:"embedding.model.checking",defaultMessage:"正在检查Embedding向量模型..."}),style:{marginBottom:16}}):s?v?(0,z.jsx)(le.Z,{type:"warning",showIcon:!0,message:(0,z.jsx)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:(0,z.jsx)("span",{children:"默认嵌入模型配置警告"})}),description:"当前配置的默认嵌入模型 ".concat(m," 不是系统推荐的 bge-m3:latest，可能会影响知识库向量检索功能，请检查配置或联系管理员"),style:{marginBottom:16}}):null:(0,z.jsx)(le.Z,{type:"warning",showIcon:!0,message:(0,z.jsx)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:(0,z.jsx)("span",{children:n.formatMessage({id:"embedding.model.missing.title",defaultMessage:"嵌入式模型缺失"})})}),description:n.formatMessage({id:"embedding.model.missing.content",defaultMessage:"请拉取Embedding向量模型".concat(m,"，用于知识库向量检索")}),style:{marginBottom:16}})},he=n(61353),xe=n(66916),ve=n(80876),Me=n(44781),ye=n(38775),be="CREATE_NEW_ROBOT",we=function(e){var t=e.visible,n=e.loading,a=e.robotList,r=e.selectedRobotUid,s=e.currentKbaseUid,o=e.onOk,i=e.onCancel,u=e.onChange,c=(0,l.useIntl)();return console.log("RobotSelectModal rendering with:",{robotList:a,selectedRobotUid:r,currentKbaseUid:s}),(0,z.jsx)(ee.Z,{title:c.formatMessage({id:"robot.select.title",defaultMessage:"选择机器人"}),open:t,onOk:o,onCancel:i,okText:c.formatMessage({id:"ok",defaultMessage:"确定"}),cancelText:c.formatMessage({id:"cancel",defaultMessage:"取消"}),okButtonProps:{disabled:!r},children:(0,z.jsx)(L.Z,{spinning:n,children:(0,z.jsxs)("div",{style:{marginBottom:16},children:[(0,z.jsx)("p",{children:c.formatMessage({id:"robot.select.desc",defaultMessage:"选择一个机器人并绑定到当前知识库"})}),(0,z.jsxs)(Me.Z,{style:{width:"100%"},placeholder:c.formatMessage({id:"robot.select.placeholder",defaultMessage:"请选择一个机器人"}),value:r,onChange:u,optionLabelProp:"label",children:[a.map((function(e){console.log("Robot ".concat(e.name||e.nickname,": kbUid=").concat(e.kbUid,", currentKbaseUid=").concat(s));var t=!!e.kbUid&&""!==e.kbUid.trim(),n=t&&e.kbUid===s,a=e.name||e.nickname||e.uid;return t&&(a="".concat(a,n?" (已绑定当前知识库)":" (已绑定其他知识库)")),(0,z.jsx)(Me.Z.Option,{value:e.uid,label:a,children:a},e.uid)})),a.length>0&&(0,z.jsx)(Me.Z.Option,{value:"divider",disabled:!0,children:(0,z.jsx)(ye.Z,{style:{margin:"4px 0"}})}),(0,z.jsx)(Me.Z.Option,{value:be,label:c.formatMessage({id:"robot.create.new",defaultMessage:"创建新机器人"}),children:(0,z.jsxs)("div",{style:{color:"#1890ff"},children:[(0,z.jsx)(W.Z,{})," ",c.formatMessage({id:"robot.create.new",defaultMessage:"创建新机器人"})]})})]})]})})})},ke=function(e){var t=e.currentKbase,n=e.currentOrg,a=e.embeddingModelExists,r=e.checkingEmbeddingModel,o=(0,l.useIntl)(),u=(0,i.useState)(!1),c=k()(u,2),d=c[0],f=c[1],g=(0,i.useState)(!1),m=k()(g,2),h=m[0],v=m[1],y=(0,i.useState)(!1),w=k()(y,2),S=w[0],Z=w[1],C=(0,i.useState)(),A=k()(C,2),U=(A[0],A[1]),I=(0,i.useState)([]),T=k()(I,2),F=T[0],q=T[1],E=(0,i.useState)(""),O=k()(E,2),P=O[0],D=O[1],R=function(){var e=b()(M()().mark((function e(a){var r,i,u,l;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Z(!0),e.prev=1,r={pageNumber:0,pageSize:100,kbEnabled:!0,kbUid:a?null==t?void 0:t.uid:"",categoryUid:"",level:s.whQ,type:s.f4h,orgUid:null==n?void 0:n.uid},console.log("Fetching robots with params:",r),e.next=6,(0,xe.p0)(r);case 6:if(i=e.sent,console.log("queryRobotsByOrg response:",i),200!==i.code){e.next=16;break}return u=i.data.content||[],l=u.map((function(e){return console.log("Processing robot: ".concat(e.name||e.nickname,", kbUid: ").concat(e.kbUid)),e})),q(l),a&&l.length>0&&U(l[0]),e.abrupt("return",l);case 16:return j.yw.error(i.message),e.abrupt("return",[]);case 18:e.next=25;break;case 20:return e.prev=20,e.t0=e.catch(1),console.error("获取机器人失败:",e.t0),j.yw.error(o.formatMessage({id:"fetch.robot.error",defaultMessage:"获取机器人失败"})),e.abrupt("return",[]);case 25:return e.prev=25,Z(!1),e.finish(25);case 28:case"end":return e.stop()}}),e,null,[[1,20,25,28]])})));return function(t){return e.apply(this,arguments)}}(),V=function(){var e=b()(M()().mark((function e(){var n,a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(P&&null!=t&&t.uid){e.next=3;break}return j.yw.error(o.formatMessage({id:"robot.select.required",defaultMessage:"请先选择一个机器人"})),e.abrupt("return",!1);case 3:return j.yw.loading(o.formatMessage({id:"updating",defaultMessage:"更新中..."})),n={uid:P,kbEnabled:!0,kbUid:null==t?void 0:t.uid},e.prev=5,e.next=8,(0,xe.Xd)(n);case 8:if(a=e.sent,console.log("updateRobotKbUid response:",a),200!==a.code){e.next=18;break}return j.yw.destroy(),j.yw.success(o.formatMessage({id:"update.success",defaultMessage:"更新成功"})),r=a.data,U(r),e.abrupt("return",!0);case 18:return j.yw.destroy(),j.yw.error(a.message),e.abrupt("return",!1);case 21:e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(5),j.yw.destroy(),j.yw.error(o.formatMessage({id:"update.failed",defaultMessage:"更新失败"})),console.error("更新机器人知识库失败:",e.t0),e.abrupt("return",!1);case 29:case"end":return e.stop()}}),e,null,[[5,23]])})));return function(){return e.apply(this,arguments)}}(),L=function(){var e=b()(M()().mark((function e(){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("handleChatKb"),a){e.next=4;break}return ee.Z.confirm({title:o.formatMessage({id:"warning",defaultMessage:"警告"}),content:o.formatMessage({id:"embedding.model.missing.warning",defaultMessage:"嵌入式模型未加载，可能会影响问答质量。是否继续？"}),okText:o.formatMessage({id:"ok",defaultMessage:"确定"}),cancelText:o.formatMessage({id:"cancel",defaultMessage:"取消"}),onOk:function(){var e=b()(M()().mark((function e(){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,B();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}),e.abrupt("return");case 4:if(!r){e.next=7;break}return j.yw.info("正在检查模型状态，请稍后再试"),e.abrupt("return");case 7:return e.next=9,B();case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),B=function(){var e=b()(M()().mark((function e(){var n,a;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return j.yw.error(o.formatMessage({id:"kb.select.required",defaultMessage:"请先选择一个知识库"})),e.abrupt("return");case 3:return j.yw.loading(o.formatMessage({id:"loading",defaultMessage:"加载中..."})),e.next=6,R(!0);case 6:if(n=e.sent,j.yw.destroy(),!(n.length>0)){e.next=12;break}n.length>1?(q(n),D(""),f(!0)):N(n[0]),e.next=21;break;case 12:return e.next=14,R(!1);case 14:if(a=e.sent,console.log("All robots without kbase filter:",a),0!==a.length){e.next=19;break}return j.yw.info(o.formatMessage({id:"robot.none",defaultMessage:"没有可用的机器人，请先创建机器人"})),e.abrupt("return");case 19:D(""),f(!0);case 21:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),N=function(e){var t;if(e&&e.uid){var a={chatConfig:{org:null==n?void 0:n.uid,t:s.xtN,sid:e.uid}};null===(t=window.bytedesk)||void 0===t||t.showChat(a)}else j.yw.error(o.formatMessage({id:"robot.invalid",defaultMessage:"无效的机器人"}))},Q=function(){var e=b()(M()().mark((function e(){var n;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(P){e.next=3;break}return j.yw.error(o.formatMessage({id:"robot.select.required",defaultMessage:"请先选择一个机器人"})),e.abrupt("return");case 3:if(null==(n=F.find((function(e){return e.uid===P})))||!n.kbUid||n.kbUid===(null==t?void 0:t.uid)){e.next=7;break}return ee.Z.confirm({title:o.formatMessage({id:"robot.already.bound",defaultMessage:"机器人已绑定知识库"}),content:o.formatMessage({id:"robot.rebind.confirm",defaultMessage:"该机器人已绑定其他知识库，是否更换绑定到当前知识库？"}),okText:o.formatMessage({id:"ok",defaultMessage:"确定"}),cancelText:o.formatMessage({id:"cancel",defaultMessage:"取消"}),onOk:function(){var e=b()(M()().mark((function e(){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,V();case 2:e.sent&&(f(!1),N(n));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}),e.abrupt("return");case 7:return e.next=9,V();case 9:e.sent&&(f(!1),n&&N(n));case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),H=function(){var e=b()(M()().mark((function e(n){var a,r,s,i;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,j.yw.loading(o.formatMessage({id:"creating",defaultMessage:"创建中..."})),console.log("Current Kbase info:",t),a=p()(p()({},n),{},{kbEnabled:!0,kbUid:null==t?void 0:t.uid}),console.log("Creating robot with data:",a),e.next=7,(0,xe.lg)(a);case 7:if(r=e.sent,console.log("Create robot response:",r),200!==r.code){e.next=29;break}if(j.yw.destroy(),j.yw.success(o.formatMessage({id:"create.success",defaultMessage:"创建成功"})),v(!1),s=r.data,console.log("New robot data:",s),null==s||!s.uid){e.next=23;break}D(s.uid),U(s),q((function(e){var t=[s].concat(x()(e));return console.log("Updated robot list:",t),t})),f(!1),N(s),e.next=27;break;case 23:return e.next=25,R(!1);case 25:i=e.sent,console.log("Fetched all robots after creation:",i);case 27:e.next=31;break;case 29:j.yw.destroy(),j.yw.error(r.message||o.formatMessage({id:"create.failed",defaultMessage:"创建失败"}));case 31:e.next=38;break;case 33:e.prev=33,e.t0=e.catch(0),j.yw.destroy(),j.yw.error(o.formatMessage({id:"create.error",defaultMessage:"创建过程发生错误"})),console.error("创建机器人错误:",e.t0);case 38:case"end":return e.stop()}}),e,null,[[0,33]])})));return function(t){return e.apply(this,arguments)}}();return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(Y.ZP,{icon:(0,z.jsx)(he.Z,{}),type:"primary",onClick:L,disabled:r,children:o.formatMessage({id:"chat.test"})}),(0,z.jsx)(we,{visible:d,loading:S,robotList:F,selectedRobotUid:P,currentKbaseUid:null==t?void 0:t.uid,onOk:Q,onCancel:function(){return f(!1)},onChange:function(e){e===be?(v(!0),D("")):D(e)}}),h&&(0,z.jsx)(ve.Z,{open:h,onClose:function(){return v(!1)},onSubmit:H})]})},je=n(69169),Se=n(4499),Ze=n(32350),Ce=function(e){var t=e.file,n=e.open,a=e.onClose,r=e.onSubmit,s=je.A.useForm(),o=k()(s,1)[0];(0,O.u)((function(e){return e.currentOrg}));return(0,i.useEffect)((function(){o.setFieldsValue({uid:null==t?void 0:t.uid,fileName:null==t?void 0:t.fileName,content:null==t?void 0:t.content})}),[t,o]),(0,z.jsx)(z.Fragment,{children:(0,z.jsx)(R.Z,{title:"编辑文件",width:600,onClose:a,open:n,children:(0,z.jsxs)(je.A,{form:o,name:"fileForm",onFinish:function(){console.log("handleSubmit"),o.validateFields().then((function(e){var n=p()(p()({},t),e);console.log("submit",n),r(n)}))},children:[(0,z.jsx)(Se.Z,{label:"文件名称",name:"fileName",rules:[{required:!0}]}),(0,z.jsx)(Ze.Z,{label:"文件内容",name:"content",rules:[{required:!0}]})]})})})},Ae=["current","pageSize"],Ue=function(){var e=(0,l.useIntl)(),t=((0,l.useNavigate)(),(0,i.useRef)()),n=(0,q.Z)().translateString,a=(0,i.useState)(1),r=k()(a,2),o=r[0],u=r[1],c=(0,i.useState)(10),f=k()(c,2),g=f[0],h=f[1],v=(0,O.u)((function(e){return e.currentOrg})),y=(0,E.j)((function(e){return e.currentKbase})),w=(0,N.v)((function(e){return e.currentCategory})),Z=(0,i.useState)(!1),A=k()(Z,2),I=A[0],F=A[1],P=(0,i.useState)(!1),R=k()(P,2),V=R[0],L=R[1],se=(0,i.useState)([]),le=k()(se,2),ce=le[0],de=le[1],fe=(0,i.useState)([]),pe=k()(fe,2),he=pe[0],xe=pe[1],ve=(0,i.useState)(!1),Me=k()(ve,2),ye=Me[0],be=Me[1],we=(0,i.useState)(!1),je=k()(we,2),Se=je[0],Ze=je[1],Ue=(0,i.useState)({}),Ie=k()(Ue,2),Te=Ie[0],Fe=Ie[1],qe=(0,i.useState)(0),Ee=k()(qe,2),Oe=Ee[0],Pe=Ee[1],De=ee.Z.useModal(),Re=k()(De,2),Ve=Re[0],Ye=Re[1],Le=(0,i.useState)(!1),ze=k()(Le,2),Be=ze[0],Ne=ze[1],Qe=(0,i.useState)(void 0),He=k()(Qe,2),Ke=He[0],We=He[1],Ge=function(){var n=b()(M()().mark((function n(a){return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,U(a);case 2:200===n.sent.code?(null==t||t.current.reload(),j.yw.success(e.formatMessage({id:"delete.success",defaultMessage:"Delete Success"}))):j.yw.error(e.formatMessage({id:"delete.error",defaultMessage:"Delete Error"}));case 4:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),_e=function(){var n=b()(M()().mark((function n(a){return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("handleFileDrawerSubmit",a),j.yw.success(e.formatMessage({id:"update.success",defaultMessage:"更新成功"})),Ne(!1),We(void 0),n.next=6,C(a);case 6:200===n.sent.code?(null==t||t.current.reload(),j.yw.success(e.formatMessage({id:"update.success",defaultMessage:"更新成功"}))):j.yw.error(e.formatMessage({id:"update.error",defaultMessage:"更新失败"}));case 8:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),Je=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:(0,z.jsx)(l.FormattedMessage,{id:"fileName",defaultMessage:"fileName"}),dataIndex:"fileName",ellipsis:!0,copyable:!0,fixed:"left",tooltip:e.formatMessage({id:"llm.file.fileName.tooltip"}),render:function(e,t,n,a){var r,s,o=null==t?void 0:t.fileName;null!=t&&null!==(r=t.fileName)&&void 0!==r&&r.includes("_")&&(o=null==t||null===(s=t.fileName)||void 0===s?void 0:s.split("_").slice(1).join("_"));return(0,z.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,z.jsx)("span",{style:{marginRight:4},children:o}),(0,z.jsx)(te.Z.Text,{copyable:{text:(null==t?void 0:t.fileName)||""}})]})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"fileUrl",defaultMessage:"File URL"}),dataIndex:"fileUrl",ellipsis:!0,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.file.fileUrl.tooltip"}),render:function(t,n){return n.fileUrl?(0,z.jsxs)("a",{href:n.fileUrl,target:"_blank",rel:"noopener noreferrer",children:[(0,z.jsx)(H.Z,{})," ",e.formatMessage({id:"view.file"})]}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"status",defaultMessage:"Status"}),dataIndex:"status",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"llm.file.status.tooltip"}),render:function(t,n){var a=n.elasticStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a&&(r="processing"),(0,z.jsx)(ne.Z,{color:r,children:e.formatMessage({id:"llm.status.".concat(a.toLowerCase())})})}}].concat(x()([]),[{title:(0,z.jsx)(l.FormattedMessage,{id:"tags",defaultMessage:"Tags"}),dataIndex:"tagList",hideInSearch:!0,tooltip:e.formatMessage({id:"llm.file.tags.tooltip"}),render:function(e,t){return t.tagList&&0!==t.tagList.length?(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(K.Z,{})," ",t.tagList.map((function(e){return(0,z.jsx)(ne.Z,{children:e},e)}))]}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"enabled",defaultMessage:"Enabled"}),dataIndex:"enabled",valueEnum:{true:{text:e.formatMessage({id:"enabled"}),status:"Success"},false:{text:e.formatMessage({id:"disabled"}),status:"Error"}},hideInSearch:!0,tooltip:e.formatMessage({id:"llm.file.enabled.tooltip"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"categoryUid",defaultMessage:"Category"}),dataIndex:"categoryUid",ellipsis:!0,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.file.category.tooltip"}),render:function(e,t){return t.categoryUid||"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"createdAt",defaultMessage:"createdAt"}),key:"createdAt",dataIndex:"createdAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.file.createdAt.tooltip"}),render:function(e,t){return oe()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,z.jsx)(l.FormattedMessage,{id:"updatedAt",defaultMessage:"updatedAt"}),key:"updatedAt",dataIndex:"updatedAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.file.updatedAt.tooltip"}),render:function(e,t){return t.updatedAt?oe()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss"):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"actions",defaultMessage:"Actions"}),key:"option",valueType:"option",width:120,fixed:"right",render:function(t,n){return[(0,z.jsx)(Y.ZP,{type:"link",onClick:function(){return function(e){We(e),Ne(!0)}(n)},children:e.formatMessage({id:"edit"})},"edit"),(0,z.jsx)(ae.Z,{title:e.formatMessage({id:"deleteTip"}),description:"".concat(e.formatMessage({id:"deleteAffirm"}),"【").concat(null==n?void 0:n.fileName,"】？"),onConfirm:function(){return Ge(n)},okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"}),children:(0,z.jsx)(Y.ZP,{type:"link",danger:!0,children:e.formatMessage({id:"delete"})})},"delete")]}}]),$e=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==he.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.delete.noselection",defaultMessage:"Please select items to delete"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"deleting",defaultMessage:"Deleting..."})),r=0,s=0,o=m()(he),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,U(u);case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.delete.success",defaultMessage:"Successfully deleted {count} items"},{count:r})):j.yw.warning(e.formatMessage({id:"batch.delete.partial",defaultMessage:"Deleted {success} items, failed to delete {fail} items"},{success:r,fail:s})),de([]),xe([]),null===(a=t.current)||void 0===a||a.reloadAndRest();case 36:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),Xe=function(){var e=b()(M()().mark((function e(t,n,a){var r,i;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("handleExportExcel",t,n,a),r=localStorage.getItem(s.LA8),i=p()({categoryUid:(null==w?void 0:w.uid)===s.zBg?"":null==w?void 0:w.uid,kbUid:null==y?void 0:y.uid,orgUid:(null==v?void 0:v.uid)||"",accessToken:r||"",exportType:t},Te),"current"===t?(i.pageNumber=o-1,i.pageSize=g):"all"===t?(i.pageNumber=0,i.pageSize=1e3):"range"===t&&void 0!==n&&void 0!==a&&(i.pageNumber=n,i.pageSize=a),window.open((0,D.kG)()+"/api/v1/llm/file/export?"+new URLSearchParams(Object.entries(i).reduce((function(e,t){var n=k()(t,2),a=n[0],r=n[1];return e[a]=String(r),e}),{})).toString());case 5:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),et=function(){var n=b()(M()().mark((function n(){var a,r,o;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==Oe){n.next=3;break}return j.yw.warning(e.formatMessage({id:"deleteAll.nodata",defaultMessage:"没有数据可删除"})),n.abrupt("return");case 3:return j.yw.loading(e.formatMessage({id:"deleting.all",defaultMessage:"正在删除所有数据..."})),n.prev=4,a={categoryUid:(null==w?void 0:w.uid)===s.zBg?"":null==w?void 0:w.uid,kbUid:null==y?void 0:y.uid,orgUid:null==v?void 0:v.uid},n.next=8,T(a);case 8:r=n.sent,console.log("handleDeleteAllConfirm response:",r,a),200===r.code?(j.yw.destroy(),j.yw.success(e.formatMessage({id:"deleteAll.success",defaultMessage:"成功删除所有数据"})),null===(o=t.current)||void 0===o||o.reloadAndRest()):(j.yw.destroy(),j.yw.error(r.message||e.formatMessage({id:"deleteAll.failed",defaultMessage:"删除失败"}))),n.next=18;break;case 13:n.prev=13,n.t0=n.catch(4),j.yw.destroy(),j.yw.error(e.formatMessage({id:"deleteAll.error",defaultMessage:"删除过程发生错误"})),console.error("删除全部数据错误:",n.t0);case 18:case"end":return n.stop()}}),n,null,[[4,13]])})));return function(){return n.apply(this,arguments)}}(),tt=function(e){for(var t=[],n=1e3,a=Math.ceil(e/n),r=function(){var a=s,r=s*n+1,o=Math.min((s+1)*n,e);t.push({key:"export-".concat(s),label:"".concat(r,"-").concat(o," (").concat(o-r+1,"条)"),onClick:function(){return Xe("range",a,n)}})},s=0;s<a;s++)r();return t};(0,i.useEffect)((function(){var e;null==t||null===(e=t.current)||void 0===e||e.reload()}),[y,w]),(0,i.useEffect)((function(){return Q.Z.on(s.YwV,(function(e){var n;null==t||null===(n=t.current)||void 0===n||n.reload()})),function(){Q.Z.off(s.YwV)}}),[]);var nt=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,ue.HK)(s.QPQ,null==v?void 0:v.uid,null==y?void 0:y.uid,s.whQ,{showLoading:!0,loadingMessage:e.formatMessage({id:"loading"}),errorMessage:e.formatMessage({id:"fetch.categories.error",defaultMessage:"Failed to fetch categories"})});case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(me,{onModelStatusChange:function(e){be(e),Ze(!1)}}),(0,z.jsx)(X.Z,{columns:Je,actionRef:t,cardBordered:!0,rowSelection:{selectedRowKeys:ce,onChange:function(e,t){de(e),xe(t)}},scroll:{x:1800},request:function(){var e=b()(M()().mark((function e(t,n,a){var r,o,i,l,c,f,g,m;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.current,o=t.pageSize,i=d()(t,Ae),u(r),h(o),Fe(i),l=void 0,c=void 0,n&&Object.keys(n).length>0&&(f=Object.keys(n)[0],l=f,c="ascend"===n[f]?"ascend":"descend"),g=p()(p()({pageNumber:r-1,pageSize:o,categoryUid:(null==w?void 0:w.uid)===s.zBg?"":null==w?void 0:w.uid,kbUid:null==y?void 0:y.uid,orgUid:null==v?void 0:v.uid},i),{},{sortBy:l,sortDirection:c}),e.next=10,S(g);case 10:return 200===(m=e.sent).code?(console.log("queryFilesByOrg response:",g,m),Pe(m.data.totalElements)):j.yw.error(m.message),e.abrupt("return",{data:m.data.content,success:!0,total:m.data.totalElements});case 13:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),rowKey:"uid",search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,onChange:function(e,t){u(e),h(t)}},dateFormatter:"string",headerTitle:n(null==y?void 0:y.name)+" - 文件上传列表",tooltip:"所上传内容会自动添加到 '拆分' 列表中",toolBarRender:function(){var t=[(0,z.jsx)(Y.ZP,{icon:(0,z.jsx)(W.Z,{}),type:"primary",onClick:function(){return ge((function(){return F(!0)}),ye,Se)},disabled:Se||!ye,children:e.formatMessage({id:"upload",defaultMessage:"File"})},"upload"),(0,z.jsx)(ke,{currentKbase:y,currentOrg:v,embeddingModelExists:ye,checkingEmbeddingModel:Se||!ye},"chat")],n=[];ce.length>0&&n.push({key:"batchDelete",icon:(0,z.jsx)(G.Z,{}),danger:!0,label:e.formatMessage({id:"batch.delete"})+" (".concat(ce.length,")"),onClick:function(){Ve.confirm({title:e.formatMessage({id:"batch.deleteTip"}),content:"".concat(e.formatMessage({id:"batch.deleteAffirm"})," ").concat(ce.length," ").concat(e.formatMessage({id:"items"}),"?"),onOk:$e,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}}),n.push({key:"deleteAll",icon:(0,z.jsx)(_.Z,{}),danger:!0,label:e.formatMessage({id:"deleteAll",defaultMessage:"删除所有"}),onClick:function(){Ve.confirm({title:e.formatMessage({id:"deleteAll.tip",defaultMessage:"删除确认"}),content:e.formatMessage({id:"deleteAll.confirm",defaultMessage:"确定要删除所有文件数据吗？此操作不可恢复!"}),onOk:et,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}});var a=[{key:"export-current",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return Xe("current")}}];return Oe>0&&(Oe<=1e3?a.push({key:"export-all",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(Oe,"条)"),onClick:function(){return Xe("all")}}):a.push({key:"export-range",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(Oe,"条)"),children:tt(Oe)})),t.push((0,z.jsx)(re.Z,{menu:{items:a},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:"primary",children:[e.formatMessage({id:"export.options",defaultMessage:"导出"}),(0,z.jsx)($.Z,{})]})},"exportDropdown")),n.length>0&&t.push((0,z.jsx)(re.Z,{menu:{items:n},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:ce.length>0?"primary":"default",danger:ce.length>0,children:[ce.length>0?e.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(ce.length,")"):e.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,z.jsx)($.Z,{})]})},"batchOperations")),t}}),I&&(0,z.jsx)(ie.Z,{type:s.n1c,acceptType:"*",isModalOpen:I,handleSubmit:function(e){F(!1),null==t||t.current.reload(),nt()},handleCancel:function(){F(!1),null==t||t.current.reload()}}),V&&(0,z.jsx)(B,{type:s.xtN,open:V,onClose:function(){return L(!1)}}),Be&&(0,z.jsx)(Ce,{file:Ke,open:Be,onClose:function(){Ne(!1),We(void 0)},onSubmit:_e}),Ye]})};function Ie(e){return Te.apply(this,arguments)}function Te(){return(Te=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/query/org",{method:"GET",params:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Fe(e){return qe.apply(this,arguments)}function qe(){return(qe=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/create",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ee(e){return Oe.apply(this,arguments)}function Oe(){return(Oe=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/update",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Pe(e){return De.apply(this,arguments)}function De(){return(De=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/delete",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Re(e){return Ve.apply(this,arguments)}function Ve(){return(Ve=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/deleteAll",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ye(e){return Le.apply(this,arguments)}function Le(){return(Le=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/updateIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ze(e){return Be.apply(this,arguments)}function Be(){return(Be=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/updateVectorIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ne(e){return Qe.apply(this,arguments)}function Qe(){return(Qe=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/updateAllIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function He(e){return Ke.apply(this,arguments)}function Ke(){return(Ke=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/updateAllVectorIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function We(e){return Ge.apply(this,arguments)}function Ge(){return(Ge=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/robot/agent/content/generate-faq",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _e(e){return Je.apply(this,arguments)}function Je(){return(Je=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/text/enable",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var $e=n(77274),Xe=n(15722),et=n(93689),tt=n(40439),nt=n(30617),at=n(61107),rt=n(88996),st=n(99885),ot=n(58087),it=n(55785),ut=n(84881),lt=n(9452),ct=function(e){var t=e.isEdit,n=e.text,a=e.open,r=e.onClose,s=e.onSubmit,o=je.A.useForm(),u=k()(o,1)[0],l=(0,i.useState)(""),c=k()(l,2),d=(c[0],c[1]),f=(0,O.u)((function(e){return e.currentOrg})),g=(0,N.v)((function(e){return e.categorySelectOptions})),m=(0,i.useState)(),h=k()(m,2),x=h[0],v=h[1],y=(0,E.j)((function(e){return e.currentKbase})),w=(0,i.useState)([]),S=k()(w,2),Z=S[0],C=S[1],A=(0,i.useState)(!1),U=k()(A,2),I=U[0],T=U[1],F=(0,i.useState)(new Set),q=k()(F,2),P=q[0],D=q[1],L=function(){var e=b()(M()().mark((function e(){var t,n,a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=u.getFieldValue("title"),n=u.getFieldValue("content"),t&&n){e.next=5;break}return j.yw.warning("请先填写标题和内容"),e.abrupt("return");case 5:return T(!0),e.prev=6,a={title:t,content:n,orgUid:null==f?void 0:f.uid},e.next=10,We(a);case 10:r=e.sent,console.log("生成常见问题返回:",r.data,a),200===r.code?(j.yw.success("常见问题生成成功"),C(r.data),D(new Set)):(C([]),j.yw.warning("生成常见问题失败，请稍后重试")),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(6),console.error("生成常见问题出错:",e.t0),j.yw.error("生成常见问题失败，请稍后重试");case 19:return e.prev=19,T(!1),e.finish(19);case 22:case"end":return e.stop()}}),e,null,[[6,15,19,22]])})));return function(){return e.apply(this,arguments)}}();(0,i.useEffect)((function(){if(t)u.setFieldsValue({uid:null==n?void 0:n.uid,title:null==n?void 0:n.title,content:null==n?void 0:n.content,categoryUid:n.categoryUid}),d((null==n?void 0:n.content)||"");else if(u.resetFields(),g&&g.length>0){var e=g[0].value;u.setFieldValue("categoryUid",e),v(e)}C([]),D(new Set)}),[t,n,u,g]);var B=function(){var e=b()(M()().mark((function e(t,n){var a,r,s;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!P.has(n)){e.next=4;break}return j.yw.info("该问题已保存"),e.abrupt("return");case 4:return a=p()(p()({},t),{},{categoryUid:x||u.getFieldValue("categoryUid"),kbUid:null==y?void 0:y.uid,orgUid:null==f?void 0:f.uid,type:"TEXT"}),j.yw.loading("正在保存常见问题..."),e.next=8,(0,st.kh)(a);case 8:200===(r=e.sent).code?((s=new Set(P)).add(n),D(s),j.yw.success("常见问题保存成功")):j.yw.error(r.message||"保存常见问题失败"),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("保存常见问题出错:",e.t0),j.yw.error("保存常见问题失败，请稍后重试");case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}();return(0,z.jsx)(z.Fragment,{children:(0,z.jsx)(R.Z,{title:t?"修改文本":"新建文本",onClose:r,open:a,width:650,extra:(0,z.jsxs)(V.Z,{children:[(0,z.jsx)(Y.ZP,{onClick:r,children:"取消"}),(0,z.jsx)(Y.ZP,{onClick:function(){console.log("handleSubmit"),u.validateFields().then((function(e){var t=p()(p()({},e),{},{categoryUid:x,kbUid:null==y?void 0:y.uid,orgUid:null==f?void 0:f.uid});console.log("submit",t),s(t)}))},type:"primary",children:"保存"}),(0,z.jsx)(Y.ZP,{onClick:L,type:"default",loading:I,icon:(0,z.jsx)(ot.Z,{}),children:"智能生成常见问题"})]}),children:(0,z.jsxs)(je.A,{form:u,submitter:{render:function(){return null}},children:[(0,z.jsx)(ut.Z,{label:"分类",name:"categoryUid",rules:[{required:!0,message:"请选择分类"}],options:g,fieldProps:{allowClear:!0,placeholder:"请选择分类",onChange:function(e){console.log("category selected ".concat(e)),v(e)}}}),(0,z.jsx)(Se.Z,{label:"标题",name:"title",rules:[{required:!0}]}),(0,z.jsx)(Ze.Z,{label:"内容",name:"content",rules:[{required:!0}]}),Z.length>0&&(0,z.jsxs)("div",{style:{marginTop:16},children:[(0,z.jsx)(te.Z.Title,{level:5,children:"常见问题列表"}),(0,z.jsx)(lt.Z,{bordered:!0,dataSource:Z,renderItem:function(e,t){return(0,z.jsx)(lt.Z.Item,{actions:[(0,z.jsx)(rt.Z,{title:P.has(t)?"已保存":"保存到常见问题库",children:(0,z.jsx)(Y.ZP,{type:P.has(t)?"default":"primary",icon:(0,z.jsx)(it.Z,{}),size:"small",disabled:P.has(t),onClick:function(){return B(e,t)},children:P.has(t)?"已保存":"保存"})},"save")],children:(0,z.jsx)(lt.Z.Item.Meta,{title:"".concat(t+1,". ").concat(null==e?void 0:e.question),description:null==e?void 0:e.answer})},t)}})]})]})})})},dt=["current","pageSize"],ft=function(){var e=(0,l.useIntl)(),t=(0,i.useRef)(),n=(0,q.Z)().translateString,a=(0,i.useState)(1),r=k()(a,2),o=r[0],u=r[1],c=(0,i.useState)(10),f=k()(c,2),g=f[0],h=f[1],x=(0,O.u)((function(e){return e.currentOrg})),v=(0,E.j)((function(e){return e.currentKbase})),y=(0,N.v)((function(e){return e.currentCategory})),w=(0,N.v)((function(e){return e.categorySelectOptions})),S=(0,i.useState)(!1),Z=k()(S,2),C=Z[0],A=Z[1],U=(0,i.useState)({}),I=k()(U,2),T=I[0],F=I[1],P=(0,i.useState)(!1),R=k()(P,2),V=R[0],L=R[1],B=ee.Z.useModal(),Q=k()(B,2),H=Q[0],K=Q[1],te=(0,i.useState)([]),ae=k()(te,2),se=ae[0],le=ae[1],ce=(0,i.useState)([]),de=k()(ce,2),fe=de[0],pe=de[1],ge=(0,i.useState)(!1),he=k()(ge,2),xe=he[0],ve=he[1],Me=(0,i.useState)(!1),ye=k()(Me,2),be=ye[0],we=ye[1],je=(0,i.useState)({}),Se=k()(je,2),Ze=Se[0],Ce=Se[1],Ae=(0,i.useState)(0),Ue=k()(Ae,2),Te=Ue[0],qe=Ue[1],Oe=(0,i.useState)(!1),De=k()(Oe,2),Ve=De[0],Le=De[1],Be=function(){var n=b()(M()().mark((function n(a){var r;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("deleteText:",a),n.next=3,Pe(a);case 3:r=n.sent,console.log("deleteMember:",r),200===r.code?(j.yw.success(e.formatMessage({id:"delete.success",defaultMessage:"Delete success"})),t.current.reload()):j.yw.error(r.message);case 6:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),Qe=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==fe.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.delete.noselection",defaultMessage:"Please select items to delete"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"deleting",defaultMessage:"Deleting..."})),r=0,s=0,o=m()(fe),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,Pe(u);case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.delete.success",defaultMessage:"Successfully deleted {count} items"},{count:r})):j.yw.warning(e.formatMessage({id:"batch.delete.partial",defaultMessage:"Deleted {success} items, failed to delete {fail} items"},{success:r,fail:s})),le([]),pe([]),null===(a=t.current)||void 0===a||a.reloadAndRest();case 36:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),Ke=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:(0,z.jsx)(l.FormattedMessage,{id:"title",defaultMessage:"Title"}),dataIndex:"title",copyable:!0,ellipsis:!0,fixed:"left",tooltip:e.formatMessage({id:"llm.text.title.tooltip",defaultMessage:"文档的标题"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"content",defaultMessage:"Content"}),dataIndex:"content",ellipsis:!0,search:!0,copyable:!0,tooltip:e.formatMessage({id:"llm.text.content.tooltip",defaultMessage:"文档的具体内容"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"status",defaultMessage:"Status"}),dataIndex:"status",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"llm.text.status.tooltip",defaultMessage:"文档索引处理状态"}),render:function(t,n){var a=n.elasticStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a&&(r="processing"),(0,z.jsx)(ne.Z,{color:r,children:e.formatMessage({id:"llm.status.".concat(a.toLowerCase())})})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"vectorStatus",defaultMessage:"Vector Status"}),dataIndex:"vectorStatus",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"llm.text.vectorStatus.tooltip",defaultMessage:"文档向量化处理状态"}),render:function(t,n){var a=n.vectorStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a?r="processing":"PROCESSING"===a&&(r="warning"),a?(0,z.jsx)(ne.Z,{color:r,icon:(0,z.jsx)($e.Z,{}),children:e.formatMessage({id:"llm.vectorStatus.".concat(a.toLowerCase())})||a}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"category",defaultMessage:"Category"}),dataIndex:"categoryUid",hideInSearch:!0,tooltip:e.formatMessage({id:"llm.text.category.tooltip",defaultMessage:"文档所属的分类"}),render:function(e,t){var n=w.find((function(e){return e.value===(null==t?void 0:t.categoryUid)}));return(0,z.jsx)(ne.Z,{children:null==n?void 0:n.label})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"createdAt",defaultMessage:"createdAt"}),key:"createdAt",dataIndex:"createdAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.text.createdAt.tooltip",defaultMessage:"文档创建的时间"}),render:function(e,t){return oe()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,z.jsx)(l.FormattedMessage,{id:"updatedAt",defaultMessage:"updatedAt"}),key:"updatedAt",dataIndex:"updatedAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.text.updatedAt.tooltip",defaultMessage:"文档最后更新的时间"}),render:function(e,t){return t.updatedAt?oe()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss"):"-"}}],We=[].concat(Ke,[{title:e.formatMessage({id:"actions",defaultMessage:"Actions"}),valueType:"option",key:"option",width:220,fixed:"right",render:function(t,n,a,r){return[(0,z.jsx)("a",{onClick:function(){F(n),L(!0),A(!0)},children:e.formatMessage({id:"edit",defaultMessage:"Edit"})},"editable"),(0,z.jsx)(Y.ZP,{type:"link",onClick:function(){return function(t){H.confirm({title:e.formatMessage({id:"deleteTip"}),icon:(0,z.jsx)(Xe.Z,{}),content:"".concat(e.formatMessage({id:"deleteAffirm",defaultMessage:"Delete"}),"【").concat(t.title,"】？"),onOk:function(){Be(t)},onCancel:function(){},okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}(n)},danger:!0,children:e.formatMessage({id:"delete",defaultMessage:"Delete"})},"delete"),(0,z.jsx)(re.Z,{menu:{items:[{key:"updateIndex",label:e.formatMessage({id:"update.index",defaultMessage:"更新索引"}),onClick:function(){return st(n)}},{key:"updateVectorIndex",label:e.formatMessage({id:"update.vector.index",defaultMessage:"更新向量索引"}),onClick:function(){return ot(n)}}]},placement:"bottomRight",children:(0,z.jsxs)(Y.ZP,{size:"small",type:"link",children:[e.formatMessage({id:"update.indexes",defaultMessage:"更新索引"}),(0,z.jsx)($.Z,{})]})},"indexOperations")]}}]);(0,i.useEffect)((function(){var e;null==t||null===(e=t.current)||void 0===e||e.reload()}),[v,y]);var Ge=function(){var e=b()(M()().mark((function e(n){var a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Fe(n);case 2:a=e.sent,console.log("handleCreateText response:",a),200===a.code?(null===(r=t.current)||void 0===r||r.reload(),A(!1)):j.yw.error(a.message);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Je=function(){var e=b()(M()().mark((function e(n){var a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.uid=null==T?void 0:T.uid,e.next=3,Ee(n);case 3:a=e.sent,console.log("handleUpdateText response:",a),200===a.code?(null===(r=t.current)||void 0===r||r.reload(),A(!1)):j.yw.error(a.message);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),st=function(){var n=b()(M()().mark((function n(a){var r,s;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),n.prev=1,n.next=4,Ye({uid:a.uid});case 4:r=n.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.index.success",defaultMessage:"索引更新成功"})),null===(s=t.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.index.failed",defaultMessage:"索引更新失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.index.error",defaultMessage:"更新索引过程发生错误"})),console.error("更新索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(e){return n.apply(this,arguments)}}(),ot=function(){var n=b()(M()().mark((function n(a){var r,s;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),n.prev=1,n.next=4,ze({uid:a.uid});case 4:r=n.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.vector.index.success",defaultMessage:"向量索引更新成功"})),null===(s=t.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.vector.index.failed",defaultMessage:"向量索引更新失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.vector.index.error",defaultMessage:"更新向量索引过程发生错误"})),console.error("更新向量索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(e){return n.apply(this,arguments)}}(),it=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==fe.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),r=0,s=0,o=m()(fe),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,Ye({uid:u.uid});case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的索引")})):j.yw.error(e.formatMessage({id:"batch.update.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的索引，").concat(s," 条记录更新失败")})),null===(a=t.current)||void 0===a||a.reload();case 34:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),ut=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==fe.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),r=0,s=0,o=m()(fe),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,ze({uid:u.uid});case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.vector.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的向量索引")})):j.yw.error(e.formatMessage({id:"batch.update.vector.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的向量索引，").concat(s," 条记录更新失败")})),null===(a=t.current)||void 0===a||a.reload();case 34:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),lt=function(){var n=b()(M()().mark((function n(){return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.index.confirm.title",defaultMessage:"更新全部索引确认"}),content:e.formatMessage({id:"updateAll.index.confirm.content",defaultMessage:"确定要更新所有记录的索引吗？此操作可能需要一些时间。"}),onOk:function(){var n=b()(M()().mark((function n(){var a,r;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.index",defaultMessage:"正在更新所有索引..."})),n.prev=1,n.next=4,Ne({kbUid:null==v?void 0:v.uid,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,orgUid:null==x?void 0:x.uid});case 4:a=n.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.index.success",defaultMessage:"所有索引更新请求已发送"})),null===(r=t.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.index.failed",defaultMessage:"所有索引更新请求失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.index.error",defaultMessage:"更新所有索引过程发生错误"})),console.error("更新所有索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(){return n.apply(this,arguments)}}()});case 1:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),ft=function(){var n=b()(M()().mark((function n(){return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.vector.index.confirm.title",defaultMessage:"更新全部向量索引确认"}),content:e.formatMessage({id:"updateAll.vector.index.confirm.content",defaultMessage:"确定要更新所有记录的向量索引吗？此操作可能需要一些时间。"}),onOk:function(){var n=b()(M()().mark((function n(){var a,r;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.vector.index",defaultMessage:"正在更新所有向量索引..."})),n.prev=1,n.next=4,He({kbUid:null==v?void 0:v.uid,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,orgUid:null==x?void 0:x.uid});case 4:a=n.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.vector.index.success",defaultMessage:"所有向量索引更新请求已发送"})),null===(r=t.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.vector.index.failed",defaultMessage:"所有向量索引更新请求失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.vector.index.error",defaultMessage:"更新所有向量索引过程发生错误"})),console.error("更新所有向量索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(){return n.apply(this,arguments)}}()});case 1:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),pt=function(){xe?be?j.yw.info("正在检查模型状态，请稍后再试"):(A(!0),L(!1),F({})):H.warning({title:"嵌入式模型缺失",content:"请首先拉取Embedding向量模型bge-m3:latest，用于知识库向量检索",okText:"确定"})},gt=function(){var n=b()(M()().mark((function n(){var a,r,o;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==Te){n.next=3;break}return j.yw.warning(e.formatMessage({id:"deleteAll.nodata",defaultMessage:"没有数据可删除"})),n.abrupt("return");case 3:return j.yw.loading(e.formatMessage({id:"deleting.all",defaultMessage:"正在删除所有数据..."})),n.prev=4,a={categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:null==x?void 0:x.uid},n.next=8,Re(a);case 8:r=n.sent,console.log("handleDeleteAllConfirm response:",r,a),200===r.code?(j.yw.destroy(),j.yw.success(e.formatMessage({id:"deleteAll.success",defaultMessage:"成功删除所有数据"})),null===(o=t.current)||void 0===o||o.reloadAndRest()):(j.yw.destroy(),j.yw.error(r.message||e.formatMessage({id:"deleteAll.failed",defaultMessage:"删除失败"}))),n.next=18;break;case 13:n.prev=13,n.t0=n.catch(4),j.yw.destroy(),j.yw.error(e.formatMessage({id:"deleteAll.error",defaultMessage:"删除过程发生错误"})),console.error("删除全部数据错误:",n.t0);case 18:case"end":return n.stop()}}),n,null,[[4,13]])})));return function(){return n.apply(this,arguments)}}(),mt=function(){var e=b()(M()().mark((function e(t,n,a){var r,i;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("handleExportExcel",t,n,a),r=localStorage.getItem(s.LA8),i=p()({categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:null==x?void 0:x.uid,accessToken:r||"",exportType:t},Ze),"current"===t?(i.pageNumber=String(o-1),i.pageSize=String(g)):"all"===t?(i.pageNumber="0",i.pageSize="1000"):"range"===t&&void 0!==n&&void 0!==a&&(i.pageNumber=String(n),i.pageSize=String(a)),window.open((0,D.kG)()+"/api/v1/llm/text/export?"+new URLSearchParams(i).toString());case 5:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),ht=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,ue.HK)(s.QPQ,null==x?void 0:x.uid,null==v?void 0:v.uid,s.whQ,{showLoading:!0,loadingMessage:e.formatMessage({id:"loading"}),errorMessage:e.formatMessage({id:"fetch.categories.error",defaultMessage:"Failed to fetch categories"})});case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),xt=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(xe){t.next=3;break}return H.confirm({title:e.formatMessage({id:"warning",defaultMessage:"警告"}),content:e.formatMessage({id:"embedding.model.missing.warning",defaultMessage:"嵌入式模型未加载，可能会影响向量检索质量。是否继续？"}),okText:e.formatMessage({id:"ok",defaultMessage:"确定"}),cancelText:e.formatMessage({id:"cancel",defaultMessage:"取消"}),onOk:function(){Le(!0)}}),t.abrupt("return");case 3:if(!be){t.next=6;break}return j.yw.info("正在检查模型状态，请稍后再试"),t.abrupt("return");case 6:Le(!0);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),vt={selectedRowKeys:se,onChange:function(e,t){le(e),pe(t)}},Mt=function(e){for(var t=[],n=1e3,a=Math.ceil(e/n),r=function(){var a=s,r=s*n+1,o=Math.min((s+1)*n,e);t.push({key:"export-".concat(s),label:"".concat(r,"-").concat(o," (").concat(o-r+1,"条)"),onClick:function(){return mt("range",a,n)}})},s=0;s<a;s++)r();return t},yt=function(){var n=b()(M()().mark((function n(a){var r,s,o,i,u,l;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==fe.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.noselection",defaultMessage:"请选择要处理的项目"})),n.abrupt("return");case 3:j.yw.loading(a?e.formatMessage({id:"enabling",defaultMessage:"正在启用..."}):e.formatMessage({id:"disabling",defaultMessage:"正在禁用..."})),s=0,o=0,i=m()(fe),n.prev=7,i.s();case 9:if((u=i.n()).done){n.next=23;break}return l=u.value,n.prev=11,n.next=14,_e({uid:l.uid,enabled:a});case 14:200===n.sent.code?s++:o++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),o++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),i.e(n.t1);case 28:return n.prev=28,i.f(),n.finish(28);case 31:j.yw.destroy(),0===o?j.yw.success(a?e.formatMessage({id:"batch.enable.success",defaultMessage:"成功启用 {count} 条记录"},{count:s}):e.formatMessage({id:"batch.disable.success",defaultMessage:"成功禁用 {count} 条记录"},{count:s})):j.yw.warning(a?e.formatMessage({id:"batch.enable.partial",defaultMessage:"启用了 {success} 条记录，{fail} 条记录启用失败"},{success:s,fail:o}):e.formatMessage({id:"batch.disable.partial",defaultMessage:"禁用了 {success} 条记录，{fail} 条记录禁用失败"},{success:s,fail:o})),le([]),pe([]),null===(r=t.current)||void 0===r||r.reloadAndRest();case 36:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(e){return n.apply(this,arguments)}}();return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(me,{onModelStatusChange:function(e){ve(e),we(!1)}}),(0,z.jsx)(X.Z,{columns:We,actionRef:t,cardBordered:!0,rowSelection:vt,scroll:{x:1500},sticky:!0,request:function(){var t=b()(M()().mark((function t(n,a,r){var o,i,l,c,f,g,m,b;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("request:",n,a,r),j.yw.loading(e.formatMessage({id:"loading",defaultMessage:"Loading"})),o=n.current,i=n.pageSize,l=d()(n,dt),u(o),h(i),Ce(l),c=void 0,f=void 0,a&&Object.keys(a).length>0&&(g=Object.keys(a)[0],c=g,f="ascend"===a[g]?"ascend":"descend"),m=p()(p()({pageNumber:o-1,pageSize:i,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:null==x?void 0:x.uid},l),{},{sortBy:c,sortDirection:f}),t.next=12,Ie(m);case 12:return b=t.sent,console.log("queryTextsByOrg response:",m,b),j.yw.destroy(),200===b.code?qe(b.data.totalElements):j.yw.error(b.message),t.abrupt("return",{data:b.data.content,success:!0,total:b.data.totalElements});case 17:case"end":return t.stop()}}),t)})));return function(e,n,a){return t.apply(this,arguments)}}(),editable:{type:"multiple"},rowKey:"uid",search:{labelWidth:"auto"},pagination:{pageSize:10,onChange:function(e,t){u(e),h(t)}},dateFormatter:"string",headerTitle:n(null==v?void 0:v.name)+" - 文本列表",tooltip:be?"正在检查嵌入式模型...":xe?"所添加文本内容会自动添加到 '拆分' 列表中 ":"请首先拉取Embedding向量模型bge-m3:latest",toolBarRender:function(){return function(){var t=[];(0,D.Ox)()||t.push((0,z.jsx)(Y.ZP,{icon:(0,z.jsx)(W.Z,{}),type:"primary",onClick:pt,disabled:be,children:e.formatMessage({id:"create"})},"create"),(0,z.jsx)(rt.Z,{title:e.formatMessage({id:"chat.test.tooltip",defaultMessage:"请确认上传内容状态为：处理成功"}),children:(0,z.jsx)(ke,{currentKbase:v,currentOrg:x,embeddingModelExists:xe,checkingEmbeddingModel:be})},"chat"));var n=[];se.length>0&&n.push({key:"batchDelete",icon:(0,z.jsx)(G.Z,{}),danger:!0,label:e.formatMessage({id:"batch.delete"})+" (".concat(se.length,")"),onClick:function(){ee.Z.confirm({title:e.formatMessage({id:"batch.deleteTip"}),content:"".concat(e.formatMessage({id:"batch.deleteAffirm"})," ").concat(se.length," ").concat(e.formatMessage({id:"items"}),"?"),onOk:Qe,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}},{key:"batchEnable",icon:(0,z.jsx)(et.Z,{}),label:e.formatMessage({id:"batch.enable",defaultMessage:"Enable"})+" (".concat(se.length,")"),onClick:function(){return yt(!0)}},{key:"batchDisable",icon:(0,z.jsx)(tt.Z,{}),label:e.formatMessage({id:"batch.disable",defaultMessage:"Disable"})+" (".concat(se.length,")"),onClick:function(){return yt(!1)}},{key:"batchUpdateIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.index",defaultMessage:"更新索引"})+" (".concat(se.length,")"),onClick:it},{key:"batchUpdateVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.vector.index",defaultMessage:"更新向量索引"})+" (".concat(se.length,")"),onClick:ut}),n.push({key:"deleteAll",icon:(0,z.jsx)(_.Z,{}),danger:!0,label:e.formatMessage({id:"deleteAll",defaultMessage:"删除所有"}),onClick:function(){ee.Z.confirm({title:e.formatMessage({id:"deleteAll.tip",defaultMessage:"删除确认"}),content:e.formatMessage({id:"deleteAll.confirm",defaultMessage:"确定要删除所有文本数据吗？此操作不可恢复!"}),onOk:gt,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}},{key:"updateAllIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.index",defaultMessage:"更新所有索引"}),onClick:lt},{key:"updateAllVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.vector.index",defaultMessage:"更新所有向量索引"}),onClick:ft});var a=[{key:"import",icon:(0,z.jsx)(nt.Z,{}),label:e.formatMessage({id:"import"}),onClick:xt,disabled:be},{key:"export-current",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return mt("current")}}];return Te>0&&(Te<=1e3?a.push({key:"export-all",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(Te,"条)"),onClick:function(){return mt("all")}}):a.push({key:"export-range",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(Te,"条)"),children:Mt(Te)})),a.push({key:"download",icon:(0,z.jsx)(at.Z,{}),label:e.formatMessage({id:"download.template",defaultMessage:"下载模板"}),onClick:function(){return(0,D.LG)()}}),t.push((0,z.jsx)(re.Z,{menu:{items:a},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:"primary",children:[e.formatMessage({id:"import.export",defaultMessage:"导入导出"}),(0,z.jsx)($.Z,{})]})},"importExport")),n.length>0&&t.push((0,z.jsx)(re.Z,{menu:{items:n},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:se.length>0?"primary":"default",danger:se.length>0,children:[se.length>0?e.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(se.length,")"):e.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,z.jsx)($.Z,{})]})},"batchOperations")),t}()}}),C&&(0,z.jsx)(ct,{isEdit:V,open:C,text:T,onClose:function(){A(!1)},onSubmit:function(e){console.log("onDrawerSubmit:",e),V?Je(e):Ge(e)}}),Ve&&(0,z.jsx)(ie.Z,{type:s.pBv,acceptType:".xlsx,.xls,.csv",isModalOpen:Ve,handleSubmit:function(e){console.log("handleUploadDragSubmit",e),Le(!1),null==t||t.current.reload(),ht()},handleCancel:function(){console.log("handleUploadDragCancel"),Le(!1),null==t||t.current.reload()}}),K]})};function pt(e){return gt.apply(this,arguments)}function gt(){return(gt=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/query/org",{method:"GET",params:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function mt(e){return ht.apply(this,arguments)}function ht(){return(ht=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/update",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function xt(e){return vt.apply(this,arguments)}function vt(){return(vt=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/delete",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Mt(e){return yt.apply(this,arguments)}function yt(){return(yt=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/delete/all",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function bt(e){return wt.apply(this,arguments)}function wt(){return(wt=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/updateIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function kt(e){return jt.apply(this,arguments)}function jt(){return(jt=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/updateVectorIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function St(e){return Zt.apply(this,arguments)}function Zt(){return(Zt=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/updateAllIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ct(e){return At.apply(this,arguments)}function At(){return(At=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/chunk/updateAllVectorIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ut(e){return It.apply(this,arguments)}function It(){return(It=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/robot/agent/content/generate-faq",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Tt=function(e){var t=e.isEdit,n=e.chunk,a=e.open,r=e.onClose,s=e.onSubmit,o=je.A.useForm(),u=k()(o,1)[0],c=(0,l.useIntl)(),d=(0,O.u)((function(e){return e.currentOrg})),f=(0,E.j)((function(e){return e.currentKbase})),g=(0,N.v)((function(e){return e.currentCategory})),m=(0,i.useState)([]),h=k()(m,2),x=h[0],v=h[1],y=(0,i.useState)(!1),w=k()(y,2),S=w[0],Z=w[1],C=(0,i.useState)(new Set),A=k()(C,2),U=A[0],I=A[1],T=function(){var e=b()(M()().mark((function e(){var t,n,a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=u.getFieldValue("name"),n=u.getFieldValue("content"),t&&n){e.next=5;break}return j.yw.warning("请先填写名称和内容"),e.abrupt("return");case 5:return Z(!0),e.prev=6,a={name:t,content:n,orgUid:null==d?void 0:d.uid},e.next=10,Ut(a);case 10:r=e.sent,console.log("生成常见问题返回:",r.data,a),200===r.code?(j.yw.success("常见问题生成成功"),v(r.data),I(new Set)):(v([]),j.yw.warning("生成常见问题失败，请稍后重试")),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(6),console.error("生成常见问题出错:",e.t0),j.yw.error("生成常见问题失败，请稍后重试");case 19:return e.prev=19,Z(!1),e.finish(19);case 22:case"end":return e.stop()}}),e,null,[[6,15,19,22]])})));return function(){return e.apply(this,arguments)}}(),F=function(){var e=b()(M()().mark((function e(t,n){var a,r,s;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!U.has(n)){e.next=4;break}return j.yw.info("该问题已保存"),e.abrupt("return");case 4:return a=p()(p()({},t),{},{categoryUid:null==g?void 0:g.uid,kbUid:null==f?void 0:f.uid,orgUid:null==d?void 0:d.uid,type:"TEXT"}),j.yw.loading("正在保存常见问题..."),e.next=8,(0,st.kh)(a);case 8:200===(r=e.sent).code?((s=new Set(U)).add(n),I(s),j.yw.success("常见问题保存成功")):j.yw.error(r.message||"保存常见问题失败"),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("保存常见问题出错:",e.t0),j.yw.error("保存常见问题失败，请稍后重试");case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}();return(0,i.useEffect)((function(){t&&n?u.setFieldsValue({uid:null==n?void 0:n.uid,name:null==n?void 0:n.name,content:null==n?void 0:n.content}):u.setFieldsValue({name:"",content:""}),v([]),I(new Set)}),[t,n,u]),(0,z.jsx)(R.Z,{title:"编辑拆分文档",onClose:r,open:a,width:600,extra:(0,z.jsxs)(V.Z,{children:[(0,z.jsx)(Y.ZP,{onClick:r,children:"取消"}),(0,z.jsx)(Y.ZP,{onClick:function(){u.validateFields().then((function(e){var t=p()(p()({},e),{},{orgUid:null==d?void 0:d.uid,kbUid:null==f?void 0:f.uid,categoryUid:null==g?void 0:g.uid});console.log("submit",t),s(t)}))},type:"primary",children:"保存"}),(0,z.jsx)(Y.ZP,{onClick:T,type:"default",loading:S,icon:(0,z.jsx)(ot.Z,{}),children:"智能生成常见问题"})]}),children:(0,z.jsxs)(je.A,{form:u,name:"chunkForm",submitter:!1,children:[(0,z.jsx)(Se.Z,{label:c.formatMessage({id:"name",defaultMessage:"Name"}),name:"name",rules:[{required:!0}]}),(0,z.jsx)(Ze.Z,{label:c.formatMessage({id:"content",defaultMessage:"Content"}),name:"content",rules:[{required:!0}],fieldProps:{rows:6}}),x.length>0&&(0,z.jsxs)("div",{style:{marginTop:16},children:[(0,z.jsx)(te.Z.Title,{level:5,children:"常见问题列表"}),(0,z.jsx)(lt.Z,{bordered:!0,dataSource:x,renderItem:function(e,t){return(0,z.jsx)(lt.Z.Item,{actions:[(0,z.jsx)(rt.Z,{title:U.has(t)?"已保存":"保存到常见问题库",children:(0,z.jsx)(Y.ZP,{type:U.has(t)?"default":"primary",icon:(0,z.jsx)(it.Z,{}),size:"small",disabled:U.has(t),onClick:function(){return F(e,t)},children:U.has(t)?"已保存":"保存"})},"save")],children:(0,z.jsx)(lt.Z.Item.Meta,{title:"".concat(t+1,". ").concat(null==e?void 0:e.question),description:null==e?void 0:e.answer})},t)}})]})]})})},Ft=["current","pageSize"],qt=function(){var e=(0,l.useIntl)(),t=(0,i.useRef)(),n=(0,q.Z)().translateString,a=(0,i.useState)(1),r=k()(a,2),o=r[0],u=r[1],c=(0,i.useState)(10),f=k()(c,2),g=f[0],h=f[1],x=(0,O.u)((function(e){return e.currentOrg})),v=(0,E.j)((function(e){return e.currentKbase})),y=(0,N.v)((function(e){return e.currentCategory})),w=(0,N.v)((function(e){return e.categorySelectOptions})),S=(0,i.useState)(!1),Z=k()(S,2),C=Z[0],A=Z[1],U=(0,i.useState)(!1),I=k()(U,2),T=I[0],F=I[1],P=(0,i.useState)(),R=k()(P,2),V=R[0],L=R[1],H=(0,i.useState)([]),K=k()(H,2),W=K[0],se=K[1],ie=(0,i.useState)([]),ue=k()(ie,2),le=ue[0],ce=ue[1],de=(0,i.useState)(!1),fe=k()(de,2),pe=fe[0],ge=fe[1],he=(0,i.useState)(!1),xe=k()(he,2),ve=xe[0],Me=xe[1],ye=(0,i.useState)({}),be=k()(ye,2),we=be[0],je=be[1],Se=(0,i.useState)(0),Ze=k()(Se,2),Ce=Ze[0],Ae=Ze[1],Ue=ee.Z.useModal(),Ie=k()(Ue,2),Te=Ie[0],Fe=Ie[1],qe=[{dataIndex:"index",valueType:"indexBorder",width:48,hideInSearch:!0,fixed:"left"},{title:(0,z.jsx)(l.FormattedMessage,{id:"name",defaultMessage:"Name"}),dataIndex:"name",ellipsis:!0,copyable:!0,fixed:"left",tooltip:e.formatMessage({id:"llm.chunk.name.tooltip",defaultMessage:"拆分后的内容块名称"}),render:function(e,t,n,a){var r,s,o=null==t?void 0:t.name;null!=t&&null!==(r=t.name)&&void 0!==r&&r.includes("_")&&(o=null==t||null===(s=t.name)||void 0===s?void 0:s.split("_").slice(1).join("_"));return(0,z.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,z.jsx)("span",{style:{marginRight:4},children:o}),(0,z.jsx)(te.Z.Text,{copyable:{text:(null==t?void 0:t.name)||""}})]})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"content",defaultMessage:"Content"}),dataIndex:"content",ellipsis:!0,tooltip:e.formatMessage({id:"llm.chunk.content.tooltip",defaultMessage:"拆分后的内容块具体内容"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"status",defaultMessage:"Status"}),dataIndex:"status",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"llm.chunk.status.tooltip",defaultMessage:"拆分内容的处理状态，主要用于全文检索"}),render:function(t,n){var a=n.elasticStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a&&(r="processing"),(0,z.jsx)(ne.Z,{color:r,children:e.formatMessage({id:"llm.status.".concat(a.toLowerCase())})})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"vectorStatus",defaultMessage:"Vector Status"}),dataIndex:"vectorStatus",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"llm.chunk.vectorStatus.tooltip",defaultMessage:"拆分内容的向量化处理状态，主要用于向量存储和检索"}),render:function(t,n){var a=n.vectorStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a?r="processing":"PROCESSING"===a&&(r="warning"),a?(0,z.jsx)(ne.Z,{color:r,icon:(0,z.jsx)($e.Z,{}),children:e.formatMessage({id:"llm.vectorStatus.".concat(a.toLowerCase())})||a}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"tags",defaultMessage:"Tags"}),dataIndex:"tagList",width:150,tooltip:e.formatMessage({id:"llm.chunk.tags.tooltip",defaultMessage:"拆分内容的标签，用于分类和搜索"}),render:function(e,t){return null!=t&&t.tagList&&0!==t.tagList.length?(0,z.jsx)(z.Fragment,{children:t.tagList.map((function(e){return(0,z.jsx)(ne.Z,{color:"blue",style:{marginBottom:4},children:e},e)}))}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"category",defaultMessage:"Category"}),dataIndex:"categoryUid",hideInSearch:!0,width:100,tooltip:e.formatMessage({id:"llm.chunk.category.tooltip",defaultMessage:"拆分内容所属的分类"}),render:function(e,t){var n=w.find((function(e){return e.value===(null==t?void 0:t.categoryUid)}));return(0,z.jsx)(ne.Z,{children:null==n?void 0:n.label})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"createdAt",defaultMessage:"createdAt"}),key:"createdAt",dataIndex:"createdAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.chunk.createdAt.tooltip",defaultMessage:"拆分内容创建的时间"}),render:function(e,t){return oe()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,z.jsx)(l.FormattedMessage,{id:"updatedAt",defaultMessage:"updatedAt"}),key:"updatedAt",dataIndex:"updatedAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"llm.chunk.updatedAt.tooltip",defaultMessage:"拆分内容最后更新的时间"}),render:function(e,t){return t.updatedAt?oe()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss"):"-"}}],Ee=function(){var n=b()(M()().mark((function n(a){var r;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log(a),n.next=3,xt(a);case 3:r=n.sent,console.log("delete response:",r),200===r.code?(null==t||t.current.reload(),j.yw.success(e.formatMessage({id:"delete.success",defaultMessage:"Delete Success"}))):j.yw.error(e.formatMessage({id:"delete.error",defaultMessage:"Delete Error"}));case 6:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),Oe=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==le.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.delete.noselection",defaultMessage:"Please select items to delete"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"deleting",defaultMessage:"Deleting..."})),r=0,s=0,o=m()(le),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,xt(u);case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.delete.success",defaultMessage:"Successfully deleted {count} items"},{count:r})):j.yw.warning(e.formatMessage({id:"batch.delete.partial",defaultMessage:"Deleted {success} items, failed to delete {fail} items"},{success:r,fail:s})),se([]),ce([]),null===(a=t.current)||void 0===a||a.reloadAndRest();case 36:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),Pe=function(){var n=b()(M()().mark((function n(a){var r,s;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,!V){n.next=7;break}return n.next=4,mt(p()(p()({},a),{},{uid:V.uid}));case 4:r=n.sent,n.next=7;break;case 7:200===r.code?(j.yw.success(e.formatMessage({id:V?"update.success":"add.success",defaultMessage:V?"Update Success":"Add Success"})),F(!1),null==t||null===(s=t.current)||void 0===s||s.reload()):j.yw.error(r.message),n.next=13;break;case 10:n.prev=10,n.t0=n.catch(0),j.yw.error(e.formatMessage({id:V?"update.error":"add.error",defaultMessage:V?"Update Error":"Add Error"}));case 13:case"end":return n.stop()}}),n,null,[[0,10]])})));return function(e){return n.apply(this,arguments)}}(),De=[].concat(qe,[{title:e.formatMessage({id:"actions",defaultMessage:"Actions"}),valueType:"option",key:"option",width:220,fixed:"right",render:function(t,n,a,r){return[(0,z.jsx)("a",{onClick:function(){return function(e){L(e),F(!0)}(n)},children:e.formatMessage({id:"edit",defaultMessage:"Edit"})},"edit"),(0,z.jsx)(ae.Z,{title:e.formatMessage({id:"deleteTip",defaultMessage:"Delete Tip"}),description:"".concat(e.formatMessage({id:"deleteAffirm",defaultMessage:"Delete"}),"【").concat(null==n?void 0:n.name,"】？"),onConfirm:function(){return Ee(n)},okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"}),children:(0,z.jsx)(Y.ZP,{size:"small",type:"link",danger:!0,children:e.formatMessage({id:"delete",defaultMessage:"Delete"})})},"delete"),(0,z.jsx)(re.Z,{menu:{items:[{key:"updateIndex",label:e.formatMessage({id:"update.index",defaultMessage:"更新索引"}),onClick:function(){return Re(n)}},{key:"updateVectorIndex",label:e.formatMessage({id:"update.vector.index",defaultMessage:"更新向量索引"}),onClick:function(){return Ve(n)}}]},placement:"bottomRight",children:(0,z.jsxs)(Y.ZP,{size:"small",type:"link",children:[e.formatMessage({id:"update.indexes",defaultMessage:"更新索引"}),(0,z.jsx)($.Z,{})]})},"indexOperations")]}}]),Re=function(){var n=b()(M()().mark((function n(a){var r,s;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),n.prev=1,n.next=4,bt({uid:a.uid});case 4:r=n.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.index.success",defaultMessage:"索引更新成功"})),null===(s=t.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.index.failed",defaultMessage:"索引更新失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.index.error",defaultMessage:"更新索引过程发生错误"})),console.error("更新索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(e){return n.apply(this,arguments)}}(),Ve=function(){var n=b()(M()().mark((function n(a){var r,s;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),n.prev=1,n.next=4,kt({uid:a.uid});case 4:r=n.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.vector.index.success",defaultMessage:"向量索引更新成功"})),null===(s=t.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.vector.index.failed",defaultMessage:"向量索引更新失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.vector.index.error",defaultMessage:"更新向量索引过程发生错误"})),console.error("更新向量索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(e){return n.apply(this,arguments)}}(),Ye=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==le.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),r=0,s=0,o=m()(le),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,bt({uid:u.uid});case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的索引")})):j.yw.error(e.formatMessage({id:"batch.update.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的索引，").concat(s," 条记录更新失败")})),null===(a=t.current)||void 0===a||a.reload();case 34:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),Le=function(){var n=b()(M()().mark((function n(){var a,r,s,o,i,u;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==le.length){n.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),n.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),r=0,s=0,o=m()(le),n.prev=7,o.s();case 9:if((i=o.n()).done){n.next=23;break}return u=i.value,n.prev=11,n.next=14,kt({uid:u.uid});case 14:200===n.sent.code?r++:s++,n.next=21;break;case 18:n.prev=18,n.t0=n.catch(11),s++;case 21:n.next=9;break;case 23:n.next=28;break;case 25:n.prev=25,n.t1=n.catch(7),o.e(n.t1);case 28:return n.prev=28,o.f(),n.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.vector.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的向量索引")})):j.yw.error(e.formatMessage({id:"batch.update.vector.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的向量索引，").concat(s," 条记录更新失败")})),null===(a=t.current)||void 0===a||a.reload();case 34:case"end":return n.stop()}}),n,null,[[7,25,28,31],[11,18]])})));return function(){return n.apply(this,arguments)}}(),ze=function(){var n=b()(M()().mark((function n(){return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.index.confirm.title",defaultMessage:"更新全部索引确认"}),content:e.formatMessage({id:"updateAll.index.confirm.content",defaultMessage:"确定要更新所有记录的索引吗？此操作可能需要一些时间。"}),onOk:function(){var n=b()(M()().mark((function n(){var a,r;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.index",defaultMessage:"正在更新所有索引..."})),n.prev=1,n.next=4,St({kbUid:null==v?void 0:v.uid,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,orgUid:null==x?void 0:x.uid});case 4:a=n.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.index.success",defaultMessage:"所有索引更新请求已发送"})),null===(r=t.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.index.failed",defaultMessage:"所有索引更新请求失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.index.error",defaultMessage:"更新所有索引过程发生错误"})),console.error("更新所有索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(){return n.apply(this,arguments)}}()});case 1:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),Be=function(){var n=b()(M()().mark((function n(){return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.vector.index.confirm.title",defaultMessage:"更新全部向量索引确认"}),content:e.formatMessage({id:"updateAll.vector.index.confirm.content",defaultMessage:"确定要更新所有记录的向量索引吗？此操作可能需要一些时间。"}),onOk:function(){var n=b()(M()().mark((function n(){var a,r;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.vector.index",defaultMessage:"正在更新所有向量索引..."})),n.prev=1,n.next=4,Ct({kbUid:null==v?void 0:v.uid,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,orgUid:null==x?void 0:x.uid});case 4:a=n.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.vector.index.success",defaultMessage:"所有向量索引更新请求已发送"})),null===(r=t.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.vector.index.failed",defaultMessage:"所有向量索引更新请求失败"})),n.next=14;break;case 9:n.prev=9,n.t0=n.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.vector.index.error",defaultMessage:"更新所有向量索引过程发生错误"})),console.error("更新所有向量索引错误:",n.t0);case 14:case"end":return n.stop()}}),n,null,[[1,9]])})));return function(){return n.apply(this,arguments)}}()});case 1:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();(0,i.useEffect)((function(){var e;null==t||null===(e=t.current)||void 0===e||e.reload()}),[v,y]),(0,i.useEffect)((function(){return Q.Z.on(s.YwV,(function(e){var n;console.log("EVENT_BUS_MQTT_NOTICE",e),null==t||null===(n=t.current)||void 0===n||n.reload()})),function(){Q.Z.off(s.YwV)}}),[]);var Ne=function(){var e=b()(M()().mark((function e(t,n,a){var r,i;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("handleExportExcel",t,n,a),r=localStorage.getItem(s.LA8),i=p()({categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:(null==x?void 0:x.uid)||"",accessToken:r||"",exportType:t},we),"current"===t?(i.pageNumber=o-1,i.pageSize=g):"all"===t?(i.pageNumber=0,i.pageSize=1e3):"range"===t&&void 0!==n&&void 0!==a&&(i.pageNumber=n,i.pageSize=a),window.open((0,D.kG)()+"/api/v1/llm/chunk/export?"+new URLSearchParams(Object.entries(i).reduce((function(e,t){var n=k()(t,2),a=n[0],r=n[1];return e[a]=String(r),e}),{})).toString());case 5:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),Qe=function(){var n=b()(M()().mark((function n(){var a,r,o;return M()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==Ce){n.next=3;break}return j.yw.warning(e.formatMessage({id:"deleteAll.nodata",defaultMessage:"没有数据可删除"})),n.abrupt("return");case 3:return j.yw.loading(e.formatMessage({id:"deleting.all",defaultMessage:"正在删除所有数据..."})),n.prev=4,a={categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:null==x?void 0:x.uid},n.next=8,Mt(a);case 8:r=n.sent,console.log("handleDeleteAllConfirm response:",r,a),200===r.code?(j.yw.destroy(),j.yw.success(e.formatMessage({id:"deleteAll.success",defaultMessage:"成功删除所有数据"})),null===(o=t.current)||void 0===o||o.reloadAndRest()):(j.yw.destroy(),j.yw.error(r.message||e.formatMessage({id:"deleteAll.failed",defaultMessage:"删除失败"}))),n.next=18;break;case 13:n.prev=13,n.t0=n.catch(4),j.yw.destroy(),j.yw.error(e.formatMessage({id:"deleteAll.error",defaultMessage:"删除过程发生错误"})),console.error("删除全部数据错误:",n.t0);case 18:case"end":return n.stop()}}),n,null,[[4,13]])})));return function(){return n.apply(this,arguments)}}(),He=function(e){for(var t=[],n=1e3,a=Math.ceil(e/n),r=function(){var a=s,r=s*n+1,o=Math.min((s+1)*n,e);t.push({key:"export-".concat(s),label:"".concat(r,"-").concat(o," (").concat(o-r+1,"条)"),onClick:function(){return Ne("range",a,n)}})},s=0;s<a;s++)r();return t};return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(me,{onModelStatusChange:function(e){ge(e),Me(!1)}}),(0,z.jsx)(X.Z,{columns:De,actionRef:t,cardBordered:!0,rowSelection:{selectedRowKeys:W,onChange:function(e,t){se(e),ce(t)}},scroll:{x:2e3},request:function(){var e=b()(M()().mark((function e(t,n,a){var r,o,i,l,c,f,g,m;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("request:",t,n,a),r=t.current,o=t.pageSize,i=d()(t,Ft),u(r),h(o),je(i),l=void 0,c=void 0,n&&Object.keys(n).length>0&&(f=Object.keys(n)[0],l=f,c="ascend"===n[f]?"ascend":"descend"),g=p()(p()({pageNumber:r-1,pageSize:o,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:null==x?void 0:x.uid},i),{},{sortBy:l,sortDirection:c}),e.next=11,pt(g);case 11:return m=e.sent,console.log("queryChunksByOrg response:",m,g),200===m.code?Ae(m.data.totalElements):j.yw.error(m.message),e.abrupt("return",{data:m.data.content,success:!0,total:m.data.totalElements});case 15:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),search:{labelWidth:"auto"},rowKey:"uid",pagination:{showQuickJumper:!0,onChange:function(e,t){u(e),h(t)}},dateFormatter:"string",headerTitle:n(null==v?void 0:v.name)+" - 系统自动拆分内容列表",tooltip:"用于向量检索和存储，如无必要，请不要随便修改",toolBarRender:function(){var t=[(0,z.jsx)(ke,{currentKbase:v,currentOrg:x,embeddingModelExists:pe,checkingEmbeddingModel:ve||!pe},"chat")],n=[];W.length>0&&n.push({key:"batchDelete",icon:(0,z.jsx)(G.Z,{}),danger:!0,label:e.formatMessage({id:"batch.delete"})+" (".concat(W.length,")"),onClick:function(){Te.confirm({title:e.formatMessage({id:"batch.deleteTip"}),content:"".concat(e.formatMessage({id:"batch.deleteAffirm"})," ").concat(W.length," ").concat(e.formatMessage({id:"items"}),"?"),onOk:Oe,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}},{key:"batchUpdateIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.index",defaultMessage:"更新索引"})+" (".concat(W.length,")"),onClick:Ye},{key:"batchUpdateVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.vector.index",defaultMessage:"更新向量索引"})+" (".concat(W.length,")"),onClick:Le}),n.push({key:"deleteAll",icon:(0,z.jsx)(_.Z,{}),danger:!0,label:e.formatMessage({id:"deleteAll",defaultMessage:"删除所有"}),onClick:function(){Te.confirm({title:e.formatMessage({id:"deleteAll.tip",defaultMessage:"删除确认"}),content:e.formatMessage({id:"deleteAll.confirm",defaultMessage:"确定要删除所有拆分数据吗？此操作不可恢复!"}),onOk:Qe,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}},{key:"updateAllIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.index",defaultMessage:"更新所有索引"}),onClick:ze},{key:"updateAllVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.vector.index",defaultMessage:"更新所有向量索引"}),onClick:Be});var a=[{key:"export-current",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return Ne("current")}}];return Ce>0&&(Ce<=1e3?a.push({key:"export-all",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(Ce,"条)"),onClick:function(){return Ne("all")}}):a.push({key:"export-range",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(Ce,"条)"),children:He(Ce)})),t.push((0,z.jsx)(re.Z,{menu:{items:a},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:"primary",children:[e.formatMessage({id:"export.options",defaultMessage:"导出"}),(0,z.jsx)($.Z,{})]})},"exportDropdown")),n.length>0&&t.push((0,z.jsx)(re.Z,{menu:{items:n},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:W.length>0?"primary":"default",danger:W.length>0,children:[W.length>0?e.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(W.length,")"):e.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,z.jsx)($.Z,{})]})},"batchOperations")),t}}),C&&(0,z.jsx)(B,{type:s.xtN,open:C,onClose:function(){return A(!1)}}),(0,z.jsx)(Tt,{isEdit:!!V,chunk:V,open:T,onClose:function(){return F(!1)},onSubmit:Pe}),Fe]})},Et=n(98036),Ot=n(62577),Pt=n(39755),Dt=n(79907),Rt=n(65895),Vt=n(44190),Yt=n(48708),Lt=n(30348),zt=n(20045),Bt=n(62673),Nt=n(52288),Qt=n(65461),Ht=n(51990),Kt=["key"],Wt=function(e){var t=e.isEdit,n=e.faq,a=e.open,r=e.onClose,o=e.onSubmit,u=je.A.useForm(),l=k()(u,1)[0],c=((0,q.Z)().translateString,(0,i.useState)("")),f=k()(c,2),g=f[0],m=f[1],h=(0,i.useState)(""),v=k()(h,2),y=v[0],w=v[1],S=(0,i.useState)(""),Z=k()(S,2),C=Z[0],A=Z[1],U=(0,O.u)((function(e){return e.currentOrg})),I=(0,E.j)((function(e){return e.currentKbase})),T=(0,N.v)((function(e){return e.categorySelectOptions})),F=(0,N.v)((function(e){return e.currentCategory})),P=(0,i.useState)(),L=k()(P,2),B=(L[0],L[1]),Q=(0,i.useState)([]),H=k()(Q,2),K=H[0],G=H[1],_=(0,i.useState)(!1),J=k()(_,2),$=J[0],X=J[1],te=(0,i.useState)(""),ae=k()(te,2),re=ae[0],se=ae[1],ie=(0,i.useRef)(null),ue=(0,i.useState)([]),le=k()(ue,2),ce=(le[0],le[1]),de=(0,i.useState)([]),fe=k()(de,2),pe=fe[0],ge=fe[1],me=(0,i.useState)(!0),he=k()(me,2),xe=he[0],ve=he[1],Me=(0,i.useState)("permanent"),be=k()(Me,2),we=be[0],ke=be[1],Ce=(0,i.useState)([]),Ae=k()(Ce,2),Ue=Ae[0],Ie=Ae[1],Te=(0,i.useState)(!1),Fe=k()(Te,2),qe=(Fe[0],Fe[1],(0,i.useState)([])),Ee=k()(qe,2),Oe=Ee[0],Pe=Ee[1],De=(0,i.useState)([]),Re=k()(De,2),Ve=Re[0],Ye=Re[1],Le=(0,i.useState)(!1),ze=k()(Le,2),Be=ze[0],Ne=ze[1],Qe=(0,i.useState)(""),He=k()(Qe,2),Ke=He[0],We=He[1],Ge=(0,i.useState)(""),_e=k()(Ge,2),Je=_e[0],$e=_e[1],Xe=(0,i.useState)([]),et=k()(Xe,2),tt=et[0],nt=et[1],at=(0,i.useState)([]),it=k()(at,2),lt=it[0],ct=it[1],dt=(0,i.useState)(!1),ft=k()(dt,2),pt=ft[0],gt=ft[1];(0,i.useEffect)((function(){var e=function(){var e=b()(M()().mark((function e(){var t,a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,j.yw.loading("正在加载常见问题列表..."),t={pageNumber:0,pageSize:100,categoryUid:(null==F?void 0:F.uid)===s.zBg?"":null==F?void 0:F.uid,kbUid:null==I?void 0:I.uid,orgUid:null==U?void 0:U.uid},e.next=5,(0,st.pf)(t);case 5:a=e.sent,console.log("获取FAQ列表响应:",t,a),j.yw.destroy(),200===a.code?(r=a.data.content.map((function(e){return{label:e.question,value:e.uid}})),ge(r.filter((function(e){return e.value!==(null==n?void 0:n.uid)})))):j.yw.error(a.message||"加载常见问题失败"),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(0),j.yw.destroy(),j.yw.error("加载常见问题列表失败"),console.error("获取FAQ列表出错:",e.t0);case 16:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}();a&&e()}),[a,null==I?void 0:I.uid,null==U?void 0:U.uid,null==F?void 0:F.uid,null==n?void 0:n.uid]),(0,i.useEffect)((function(){if(t){var e,a,r,s,o,i=Array.isArray(null==n?void 0:n.similarQuestions)?n.similarQuestions.map((function(e){return"string"==typeof e?e:String(e)})).filter((function(e){return""!==e.trim()})):[];if(l.setFieldsValue({question:null==n?void 0:n.question,similarQuestions:i,answer:null==n?void 0:n.answer,categoryUid:null==n?void 0:n.categoryUid,kbUid:null==I?void 0:I.uid,answerList:(null==n?void 0:n.answerList)||[],enabled:!1!==(null==n?void 0:n.enabled),relatedFaqUids:(null==n||null===(e=n.relatedFaqs)||void 0===e?void 0:e.map((function(e){return e.uid})))||[],dateType:"permanent",dateRange:null!=n&&n.startDate&&null!=n&&n.endDate?[oe()(n.startDate),oe()(n.endDate)]:void 0}),m((null==n?void 0:n.answer)||""),w((null==n?void 0:n.answerHtml)||""),A((null==n?void 0:n.answerMarkdown)||""),G((null==n||null===(a=n.tagList)||void 0===a?void 0:a.filter((function(e){return e&&""!==e.trim()})))||[]),ce((null==n||null===(r=n.relatedFaqs)||void 0===r?void 0:r.map((function(e){return e.uid})))||[]),ve(!1!==(null==n?void 0:n.enabled)),Ie(i),null!=n&&null!==(s=n.images)&&void 0!==s&&s.length&&n.images.some((function(e){return e&&""!==e.trim()}))){var u=n.images.filter((function(e){return e&&""!==e.trim()})),c=u.map((function(e,t){return{uid:"-".concat(t+1),name:"image_".concat(t+1,".jpg"),status:"done",url:e,thumbUrl:e}}));Pe(c),Ye(u)}else Pe([]),Ye([]);if(null!=n&&null!==(o=n.attachments)&&void 0!==o&&o.length&&n.attachments.some((function(e){return e&&""!==e.trim()}))){var d=n.attachments.filter((function(e){return e&&""!==e.trim()})),f=d.map((function(e,t){var n=e.substring(e.lastIndexOf("/")+1);return{uid:"-".concat(t+1),name:n||"attachment_".concat(t+1),status:"done",url:e}}));nt(f),ct(d)}else nt([]),ct([])}else{var p=T.length>0?T[0].value:"";l.setFieldsValue({question:"",similarQuestions:[],answer:"",categoryUid:p,kbUid:null==I?void 0:I.uid,answerList:[],enabled:!0,relatedFaqUids:[],dateType:"permanent",dateRange:void 0,autoSyncLlmQa:!1,llmQaKbUid:""}),p&&B(p),m(""),w(""),A(""),G([]),ce([]),ve(!0),Ie([]),Pe([]),Ye([]),nt([]),ct([])}}),[n,a,T]),(0,i.useEffect)((function(){var e;$&&(null===(e=ie.current)||void 0===e||e.focus())}),[$]);var mt=function(){re&&-1===K.indexOf(re)&&G([].concat(x()(K),[re])),X(!1),se("")},ht=function(){var e=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:We(t.url||t.thumbUrl),Ne(!0),$e(t.name||t.url.substring(t.url.lastIndexOf("/")+1));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),xt=(0,z.jsx)(Y.ZP,{icon:(0,z.jsx)(W.Z,{}),children:"上传图片"}),vt={name:"file",accept:"image/*",action:(0,D.M$)(),headers:{Authorization:"Bearer "+localStorage.getItem(s.LA8)},listType:"picture-card",fileList:Oe,onPreview:ht,onChange:function(e){var t=x()(e.fileList);if("done"===e.file.status)if(200===e.file.response.code){var n=e.file.response.data.fileUrl;Ye((function(e){return[].concat(x()(e),[n])})),j.yw.success("上传 ".concat(e.file.name," 成功"))}else j.yw.error("上传 ".concat(e.file.name," 失败: ").concat(e.file.response.message));else"error"===e.file.status&&j.yw.error("上传 ".concat(e.file.name," 失败"));t=t.map((function(e){return e.response&&200===e.response.code?p()(p()({},e),{},{url:e.response.data.fileUrl,thumbUrl:e.response.data.fileUrl}):e})),Pe(t)},data:function(e){return{file:e,fileName:oe()(new Date).format("YYYYMMDDHHmmss")+"_"+e.name,fileType:e.type,isAvatar:"false",kbType:s.IrL,categoryUid:l.getFieldValue("categoryUid")||"",kbUid:(null==I?void 0:I.uid)||"",client:s.bVn}},onRemove:function(e){return e.url&&Ye((function(t){return t.filter((function(t){return t!==e.url}))})),!0}},Mt={name:"file",action:(0,D.M$)(),headers:{Authorization:"Bearer "+localStorage.getItem(s.LA8)},fileList:tt,onChange:function(e){var t=x()(e.fileList);if("done"===e.file.status)if(200===e.file.response.code){var n=e.file.response.data.fileUrl;ct((function(e){return[].concat(x()(e),[n])})),j.yw.success("上传 ".concat(e.file.name," 成功"))}else j.yw.error("上传 ".concat(e.file.name," 失败: ").concat(e.file.response.message));else"error"===e.file.status&&j.yw.error("上传 ".concat(e.file.name," 失败"));t=t.map((function(e){return e.response&&200===e.response.code?p()(p()({},e),{},{url:e.response.data.fileUrl}):e})),nt(t)},data:function(e){return{file:e,fileName:oe()(new Date).format("YYYYMMDDHHmmss")+"_"+e.name,fileType:e.type,isAvatar:"false",kbType:s.IrL,categoryUid:l.getFieldValue("categoryUid")||"",kbUid:(null==I?void 0:I.uid)||"",client:s.bVn}},onRemove:function(e){return e.url&&ct((function(t){return t.filter((function(t){return t!==e.url}))})),!0}},yt=function(){var e=b()(M()().mark((function e(){var t,n,a,r,s,o,i;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,D.OJ)()){e.next=3;break}return j.yw.error("生成相似问法功能仅在企业版和平台版可用"),e.abrupt("return");case 3:if((t=l.getFieldValue("question"))&&""!==t.trim()){e.next=7;break}return j.yw.error("请先输入问题后再生成相似问法"),e.abrupt("return");case 7:return e.prev=7,gt(!0),j.yw.loading("正在智能生成相似问法..."),n={question:t,orgUid:null==U?void 0:U.uid},e.next=13,(0,st.YQ)(n);case 13:a=e.sent,console.log("生成相似问法响应:",n,a),j.yw.destroy(),200===a.code?(r=a.data,console.log("生成的相似问法:",r),s=r.similarQuestions.filter((function(e){return e&&""!==e.trim()})),o=Ue.filter((function(e){return e&&""!==e.trim()})),i=x()(o),s.forEach((function(e){i.includes(e)||i.push(e)})),Ie(i),l.setFieldValue("similarQuestions",i),j.yw.success("已成功生成 ".concat(s.length," 条相似问法"))):j.yw.error(a.message||"生成相似问法失败"),e.next=24;break;case 19:e.prev=19,e.t0=e.catch(7),console.error("生成相似问法出错:",e.t0),j.yw.destroy(),j.yw.error("生成相似问法失败");case 24:return e.prev=24,gt(!1),e.finish(24);case 27:case"end":return e.stop()}}),e,null,[[7,19,24,27]])})));return function(){return e.apply(this,arguments)}}();return(0,z.jsx)(z.Fragment,{children:(0,z.jsx)(R.Z,{title:t?"修改常见问题":"新建常见问题",width:650,onClose:r,open:a,extra:(0,z.jsxs)(V.Z,{children:[(0,z.jsx)(Y.ZP,{onClick:r,children:"取消"}),(0,z.jsx)(Y.ZP,{onClick:function(){var e=Ue.map((function(e){return null==e?void 0:e.trim()})).filter((function(e){return e&&""!==e}));l.setFieldValue("similarQuestions",e),l.validateFields().then((function(e){var t,a;if(console.log("handleSubmit values:",e),"permanent"===e.dateType)t=oe()().format("YYYY-MM-DDTHH:mm:ss"),a=oe()().add(100,"years").format("YYYY-MM-DDTHH:mm:ss");else{var r=e.dateRange;t=null!=r&&r[0]?r[0].format("YYYY-MM-DDTHH:mm:ss"):void 0,a=null!=r&&r[1]?r[1].format("YYYY-MM-DDTHH:mm:ss"):void 0}var i=Ue.map((function(e){return null==e?void 0:e.trim()})).filter((function(e){return e&&""!==e})),u=Ve.filter((function(e){return e&&""!==e.trim()})),l=lt.filter((function(e){return e&&""!==e.trim()})),c=K.filter((function(e){return e&&""!==e.trim()})),d=p()(p()(p()({},n),e),{},{type:s.PYi,kbUid:null==I?void 0:I.uid,orgUid:null==U?void 0:U.uid,answer:g,answerHtml:y,answerMarkdown:C,similarQuestions:i,answerList:e.answerList||[],tagList:c,relatedFaqUids:e.relatedFaqUids||[],startDate:t,endDate:a,images:u,attachments:l});o(d)})).catch((function(e){console.log("Form errors:",e),j.yw.error("请检查表单填写")}))},type:"primary",children:"保存"})]}),children:(0,z.jsxs)(je.A,{form:l,submitter:{render:function(){return null}},children:[(0,z.jsx)(ut.Z,{label:"分类",name:"categoryUid",rules:[{required:!0,message:"请选择分类"}],options:T,fieldProps:{allowClear:!0,placeholder:"请选择分类",onChange:function(e){console.log("category selected ".concat(e)),B(e)}}}),(0,z.jsx)(Se.Z,{label:"问题",name:"question",rules:[{required:!0,message:"请输入问题"}]}),(0,z.jsx)(Ot.u,{name:"similarQuestions",label:(0,z.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"},children:[(0,z.jsx)("span",{children:"相似问法"}),(0,z.jsxs)(rt.Z,{title:"可在AI助手-》提示词 中搜索名称为：faq_similar_questions 的提示词，修改大模型和编辑提示词",children:["                ",(0,z.jsx)(rt.Z,{title:"可在AI助手-》提示词 中搜索名称为：faq_similar_questions 的提示词，修改大模型和编辑提示词",children:(0,z.jsx)(Y.ZP,{type:"primary",icon:(0,z.jsx)(ot.Z,{}),onClick:yt,loading:pt,size:"small",children:"智能生成"})})]})]}),creatorButtonProps:{creatorButtonText:"添加相似问法",icon:(0,z.jsx)(W.Z,{}),type:"dashed",block:!0,onClick:function(){var e=[].concat(x()(Ue),[""]);Ie(e),l.setFieldValue("similarQuestions",e)}},copyIconProps:!1,min:0,style:{width:"100%"},initialValue:[],onAfterAdd:function(e,t,n){var a=l.getFieldValue("similarQuestions")||[],r=Array.isArray(a)?a.map((function(e){return"string"==typeof e?e:""})):x()(Ue);Ie(r)},onAfterRemove:function(e,t){var n=l.getFieldValue("similarQuestions")||[],a=Array.isArray(n)?n.map((function(e){return"string"==typeof e?e:""})):[];Ie(a)},actionRender:function(e,t,n){return[(0,z.jsx)(Y.ZP,{type:"link",danger:!0,onClick:function(){var n=e.name,a=x()(Ue);a.splice(n,1),Ie(a),t.remove(e.name)},children:"删除"},"delete")]},children:function(e,t,n){var a=e.key,r=d()(e,Kt);return(0,z.jsx)(Se.Z,p()(p()({},r),{},{placeholder:"请输入相似问法",rules:[{required:!0,message:"请输入相似问法"}],width:"xl",fieldProps:{maxLength:500,autoComplete:"off",value:Ue[t]||"",onChange:function(e){var n=x()(Ue);n[t]=e.target.value,Ie(n),l.setFieldValue(["similarQuestions",t],e.target.value)}}}),a)}}),(0,z.jsx)(je.A.Item,{name:"answer",label:"文本答案",children:(0,z.jsx)(Ht.Z,{defaultValue:g,toolbarKeys:(0,Qt.eD)(),style:{height:"200px",width:"600px"},maxLength:16383,onChange:function(e,t,n){m(n),w(e),A(t)}})}),(0,z.jsxs)(je.A.Item,{label:"图片",tooltip:"可以上传多张图片作为回复内容",children:[(0,z.jsx)(Lt.Z,p()(p()({},vt),{},{children:xt})),(0,z.jsx)(ee.Z,{open:Be,title:Je,footer:null,onCancel:function(){return Ne(!1)},children:(0,z.jsx)(zt.Z,{alt:"预览图片",style:{width:"100%"},src:Ke})})]}),(0,z.jsx)(je.A.Item,{label:"附件",tooltip:"可以上传多个附件作为回复内容",children:(0,z.jsx)(Lt.Z,p()(p()({},Mt),{},{children:(0,z.jsx)(Y.ZP,{icon:(0,z.jsx)(W.Z,{}),children:"上传附件"})}))}),(0,z.jsxs)(ye.Z,{orientation:"left",children:["扩展答案列表",(0,z.jsx)(Y.ZP,{type:"link",onClick:function(){window.open("https://www.weiyuai.cn/docs/zh-CN/docs/manual/admin/kbase/viplevel")},children:"使用说明"})]}),(0,z.jsx)(Ot.u,{name:"answerList",creatorButtonProps:{creatorButtonText:"添加答案",icon:(0,z.jsx)(W.Z,{}),type:"dashed",block:!0},itemRender:function(e,t){var n=e.listDom,a=e.action,r=t.index;return(0,z.jsx)(Bt.Z,{size:"small",style:{marginBottom:16},extra:a,children:n},r)},initialValue:[],copyIconProps:!1,itemContainerRender:function(e){return(0,z.jsx)("div",{children:e})},children:(0,z.jsxs)(Pt.UW,{children:[(0,z.jsx)(Dt.Z,{name:"vipLevel",label:"VIP等级",rules:[{required:!0,message:"请输入VIP等级"}],placeholder:"输入VIP等级",min:1}),(0,z.jsx)(Ze.Z,{name:"answer",label:"答案内容",rules:[{required:!0,message:"请输入答案内容"}],placeholder:"输入答案内容",fieldProps:{rows:3}})]})}),(0,z.jsx)(ut.Z,{name:"relatedFaqUids",label:"相关问题",mode:"multiple",options:pe,fieldProps:{placeholder:"请选择相关问题"}}),(0,z.jsx)(je.A.Item,{label:"标签",children:(0,z.jsxs)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:[K.map((function(e){return(0,z.jsx)(ne.Z,{closable:!0,onClose:function(){return t=e,n=K.filter((function(e){return e!==t})),void G(n);var t,n},children:e},e)})),$?(0,z.jsx)(Nt.Z,{ref:ie,type:"text",size:"small",style:{width:78},value:re,onChange:function(e){se(e.target.value)},onBlur:mt,onPressEnter:mt}):(0,z.jsxs)(ne.Z,{onClick:function(){X(!0)},style:{borderStyle:"dashed",cursor:"pointer"},children:[(0,z.jsx)(W.Z,{})," 新标签"]})]})}),(0,z.jsx)(Rt.Z.Group,{name:"dateType",label:"有效期设置",options:[{label:"永久有效",value:"permanent"},{label:"自定义日期",value:"custom"}],fieldProps:{onChange:function(e){ke(e.target.value),"permanent"===e.target.value&&l.setFieldValue("dateRange",void 0)},value:we}}),"custom"===we&&(0,z.jsx)(Vt.Z,{name:"dateRange",label:"有效日期",rules:[{required:"custom"===we,message:"请选择有效日期范围"}],fieldProps:{style:{width:"100%"}}}),(0,z.jsx)(Yt.Z,{name:"enabled",label:"是否启用",fieldProps:{checked:xe,onChange:function(e){ve(e)}}})]})})})},Gt=["current","pageSize"],_t=function(){var e=(0,l.useIntl)(),t=(0,q.Z)().translateString,n=(0,i.useRef)(),a=(0,i.useState)(!0),r=k()(a,2),o=r[0],u=r[1],c=(0,i.useState)(),f=k()(c,2),g=f[0],h=f[1],x=(0,i.useState)(!1),v=k()(x,2),y=v[0],w=v[1],S=(0,i.useState)(1),Z=k()(S,2),C=Z[0],A=Z[1],U=(0,i.useState)(10),I=k()(U,2),T=I[0],F=I[1],P=(0,O.u)((function(e){return e.currentOrg})),R=(0,E.j)((function(e){return e.currentKbase})),V=(0,N.v)((function(e){return e.currentCategory})),L=(0,N.v)((function(e){return e.categorySelectOptions})),B=(0,i.useState)(!1),Q=k()(B,2),H=Q[0],K=Q[1],te=(0,i.useState)([]),se=k()(te,2),le=se[0],ce=se[1],de=(0,i.useState)([]),fe=k()(de,2),pe=fe[0],ge=fe[1],he=(0,i.useState)(0),xe=k()(he,2),ve=xe[0],Me=xe[1],ye=(0,i.useState)(!1),be=k()(ye,2),we=be[0],je=be[1],Se=(0,i.useState)(!1),Ze=k()(Se,2),Ce=Ze[0],Ae=Ze[1],Ue=(0,i.useState)({}),Ie=k()(Ue,2),Te=Ie[0],Fe=Ie[1],qe=function(){var t=b()(M()().mark((function t(a){var r;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log(a),t.next=3,(0,st.Yg)(a);case 3:r=t.sent,console.log("delete response:",r),200===r.code?(null==n||n.current.reload(),j.yw.success(e.formatMessage({id:"delete.success",defaultMessage:"Delete Success"}))):j.yw.error(e.formatMessage({id:"delete.error",defaultMessage:"Delete Error"}));case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Ee=function(){var t=b()(M()().mark((function t(){var a,r,s,o,i,u;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==pe.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.delete.noselection",defaultMessage:"Please select items to delete"})),t.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"deleting",defaultMessage:"Deleting..."})),r=0,s=0,o=m()(pe),t.prev=7,o.s();case 9:if((i=o.n()).done){t.next=23;break}return u=i.value,t.prev=11,t.next=14,(0,st.Yg)(u);case 14:200===t.sent.code?r++:s++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),s++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),o.e(t.t1);case 28:return t.prev=28,o.f(),t.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.delete.success",defaultMessage:"Successfully deleted {count} items"},{count:r})):j.yw.warning(e.formatMessage({id:"batch.delete.partial",defaultMessage:"Deleted {success} items, failed to delete {fail} items"},{success:r,fail:s})),ce([]),ge([]),null===(a=n.current)||void 0===a||a.reloadAndRest();case 36:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(){return t.apply(this,arguments)}}(),Oe=function(){var t=b()(M()().mark((function t(a){var r,s,o,i,u,l;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==pe.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.noselection",defaultMessage:"Please select items to process"})),t.abrupt("return");case 3:j.yw.loading(a?e.formatMessage({id:"enabling",defaultMessage:"Enabling..."}):e.formatMessage({id:"disabling",defaultMessage:"Disabling..."})),s=0,o=0,i=m()(pe),t.prev=7,i.s();case 9:if((u=i.n()).done){t.next=23;break}return l=u.value,t.prev=11,t.next=14,(0,st.kv)({uid:l.uid,enabled:a});case 14:200===t.sent.code?s++:o++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),o++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),i.e(t.t1);case 28:return t.prev=28,i.f(),t.finish(28);case 31:j.yw.destroy(),0===o?j.yw.success(a?e.formatMessage({id:"batch.enable.success",defaultMessage:"Successfully enabled {count} items"},{count:s}):e.formatMessage({id:"batch.disable.success",defaultMessage:"Successfully disabled {count} items"},{count:s})):j.yw.warning(a?e.formatMessage({id:"batch.enable.partial",defaultMessage:"Enabled {success} items, failed to enable {fail} items"},{success:s,fail:o}):e.formatMessage({id:"batch.disable.partial",defaultMessage:"Disabled {success} items, failed to disable {fail} items"},{success:s,fail:o})),ce([]),ge([]),null===(r=n.current)||void 0===r||r.reloadAndRest();case 36:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(e){return t.apply(this,arguments)}}(),Pe=function(){var t=b()(M()().mark((function t(){var a,r,o;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==ve){t.next=3;break}return j.yw.warning(e.formatMessage({id:"deleteAll.nodata",defaultMessage:"没有数据可删除"})),t.abrupt("return");case 3:return j.yw.loading(e.formatMessage({id:"deleting.all",defaultMessage:"正在删除所有数据..."})),t.prev=4,a={categoryUid:(null==V?void 0:V.uid)===s.zBg?"":null==V?void 0:V.uid,kbUid:null==R?void 0:R.uid,orgUid:null==P?void 0:P.uid},t.next=8,(0,st.QB)(a);case 8:200===(r=t.sent).code?(j.yw.destroy(),j.yw.success(e.formatMessage({id:"deleteAll.success",defaultMessage:"成功删除所有数据"})),null===(o=n.current)||void 0===o||o.reloadAndRest()):(j.yw.destroy(),j.yw.error(r.message||e.formatMessage({id:"deleteAll.failed",defaultMessage:"删除失败"}))),t.next=17;break;case 12:t.prev=12,t.t0=t.catch(4),j.yw.destroy(),j.yw.error(e.formatMessage({id:"deleteAll.error",defaultMessage:"删除过程发生错误"})),console.error("删除全部数据错误:",t.t0);case 17:case"end":return t.stop()}}),t,null,[[4,12]])})));return function(){return t.apply(this,arguments)}}(),De=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.question"}),dataIndex:"question",copyable:!0,fixed:"left",width:100,ellipsis:!0,search:!0,tooltip:e.formatMessage({id:"faq.question.tooltip",defaultMessage:"常见问题的问题内容"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.similar.questions",defaultMessage:"相似问法"}),dataIndex:"similarQuestions",width:200,ellipsis:!0,search:!1,tooltip:e.formatMessage({id:"faq.similar.questions.tooltip",defaultMessage:"表达相同意思的其他问法"}),render:function(t,n){if(!n.similarQuestions||0===n.similarQuestions.length||1===n.similarQuestions.length&&""===n.similarQuestions[0])return"-";var a=n.similarQuestions.length>3,r=n.similarQuestions.slice(0,3),s=(0,z.jsx)("div",{style:{maxWidth:300,maxHeight:300,overflow:"auto"},children:n.similarQuestions.map((function(e,t){return(0,z.jsxs)("div",{style:{marginBottom:8},children:[(0,z.jsx)(ne.Z,{color:"blue",style:{marginRight:4},children:t+1}),e]},t)}))}),o=(0,z.jsxs)("div",{children:[r.map((function(e,t){return(0,z.jsx)(ne.Z,{color:"blue",style:{marginBottom:4},children:e},t)})),a&&(0,z.jsxs)(ne.Z,{color:"orange",children:["+",n.similarQuestions.length-3]})]});return(0,z.jsx)(Et.Z,{content:s,title:e.formatMessage({id:"faq.similar.questions",defaultMessage:"所有相似问法"}),placement:"right",trigger:"hover",children:o})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.answer"}),dataIndex:"answer",width:200,ellipsis:!0,search:!0,tooltip:e.formatMessage({id:"faq.answer.tooltip",defaultMessage:"常见问题的回答内容"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"status",defaultMessage:"Status"}),dataIndex:"status",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"faq.status.tooltip",defaultMessage:"问题处理状态"}),render:function(t,n){var a=n.elasticStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a&&(r="processing"),(0,z.jsx)(ne.Z,{color:r,children:e.formatMessage({id:"llm.status.".concat(a.toLowerCase())})})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"vectorStatus",defaultMessage:"Vector Status"}),dataIndex:"vectorStatus",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"faq.vectorStatus.tooltip",defaultMessage:"向量化处理状态"}),render:function(t,n){var a=n.vectorStatus||"",r="";return"SUCCESS"===a?r="success":"ERROR"===a?r="error":"NEW"===a?r="processing":"PROCESSING"===a&&(r="warning"),a?(0,z.jsx)(ne.Z,{color:r,icon:(0,z.jsx)($e.Z,{}),children:e.formatMessage({id:"llm.vectorStatus.".concat(a.toLowerCase())})||a}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.clickCount"}),dataIndex:"clickCount",width:100,hideInSearch:!0,sorter:!0,tooltip:e.formatMessage({id:"faq.clickCount.tooltip",defaultMessage:"问题被点击的次数"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.upCount"}),dataIndex:"upCount",width:100,hideInSearch:!0,sorter:!0,tooltip:e.formatMessage({id:"faq.upCount.tooltip",defaultMessage:"问题被点赞的次数"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.downCount"}),dataIndex:"downCount",width:100,hideInSearch:!0,sorter:!0,tooltip:e.formatMessage({id:"faq.downCount.tooltip",defaultMessage:"问题被踩的次数"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"category"}),dataIndex:"categoryUid",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"faq.category.tooltip",defaultMessage:"问题所属的分类"}),render:function(e,t){var n=L.find((function(e){return e.value===(null==t?void 0:t.categoryUid)}));return(0,z.jsx)(ne.Z,{color:"blue",children:(null==n?void 0:n.label)||"-"})},filters:L.map((function(e){return{text:e.label,value:e.value}})),filterMode:"tree"},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.tags",defaultMessage:"标签"}),dataIndex:"tagList",width:150,hideInSearch:!0,tooltip:e.formatMessage({id:"faq.tags.tooltip",defaultMessage:"用于分类和搜索的标签"}),render:function(e,t){if(!t.tagList||0===t.tagList.length)return"-";var n=t.tagList.length>3,a=t.tagList.slice(0,3);return(0,z.jsxs)("div",{children:[a.map((function(e,t){return(0,z.jsx)(ne.Z,{color:"green",style:{marginBottom:4},children:e},t)})),n&&(0,z.jsxs)(ne.Z,{color:"orange",children:["+",t.tagList.length-3]})]})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.isValid"}),dataIndex:"enabled",width:100,hideInSearch:!0,tooltip:e.formatMessage({id:"faq.isValid.tooltip",defaultMessage:"问题是否有效可用"}),valueEnum:{true:{text:"有效",status:"Success"},false:{text:"无效",status:"Error"}}},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.startDate"}),dataIndex:"startDate",width:160,valueType:"dateTime",hideInSearch:!0,tooltip:e.formatMessage({id:"faq.startDate.tooltip",defaultMessage:"问题生效的开始时间"}),render:function(e,t){return t.startDate?oe()(t.startDate).format("YYYY-MM-DD HH:mm:ss"):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"faq.endDate"}),dataIndex:"endDate",width:160,valueType:"dateTime",hideInSearch:!0,tooltip:e.formatMessage({id:"faq.endDate.tooltip",defaultMessage:"问题失效的结束时间"}),render:function(e,t){return t.endDate?oe()(t.endDate).format("YYYY-MM-DD HH:mm:ss"):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"createdAt",defaultMessage:"createdAt"}),key:"createdAt",dataIndex:"createdAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"faq.createdAt.tooltip",defaultMessage:"问题创建的时间"}),render:function(e,t){return oe()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,z.jsx)(l.FormattedMessage,{id:"updatedAt",defaultMessage:"updatedAt"}),key:"updatedAt",dataIndex:"updatedAt",sorter:!0,width:200,hideInSearch:!0,tooltip:e.formatMessage({id:"faq.updatedAt.tooltip",defaultMessage:"问题最后更新的时间"}),render:function(e,t){return t.updatedAt?oe()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss"):"-"}},{title:e.formatMessage({id:"actions"}),valueType:"option",key:"option",width:220,fixed:"right",render:function(t,n,a,r){return[(0,z.jsx)("a",{onClick:function(){!function(e){console.log("showEditDrawer",e),h(e),u(!0),w(!0)}(n)},children:e.formatMessage({id:"edit"})},"editable"),(0,z.jsx)(ae.Z,{title:e.formatMessage({id:"deleteTip"}),description:"".concat(e.formatMessage({id:"deleteAffirm"}),"【").concat(null==n?void 0:n.question,"】？"),onConfirm:function(){return qe(n)},okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"}),children:(0,z.jsx)(Y.ZP,{size:"small",type:"link",danger:!0,children:e.formatMessage({id:"delete"})})},"delete"),(0,z.jsx)(re.Z,{menu:{items:[{key:"updateIndex",label:e.formatMessage({id:"update.index",defaultMessage:"更新索引"}),onClick:function(){return Re(n)}},{key:"updateVectorIndex",label:e.formatMessage({id:"update.vector.index",defaultMessage:"更新向量索引"}),onClick:function(){return Ve(n)}}]},placement:"bottomRight",children:(0,z.jsx)(rt.Z,{title:e.formatMessage({id:"update.indexes",defaultMessage:"更新索引"}),children:(0,z.jsxs)(Y.ZP,{size:"small",type:"link",children:[e.formatMessage({id:"update.indexes",defaultMessage:"更新索引"}),(0,z.jsx)($.Z,{})]})})},"indexOperations")]}}],Re=function(){var t=b()(M()().mark((function t(a){var r,s;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),t.prev=1,t.next=4,(0,st.RF)({uid:a.uid});case 4:r=t.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.index.success",defaultMessage:"索引更新成功"})),null===(s=n.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.index.failed",defaultMessage:"索引更新失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.index.error",defaultMessage:"更新索引过程发生错误"})),console.error("更新索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(e){return t.apply(this,arguments)}}(),Ve=function(){var t=b()(M()().mark((function t(a){var r,s;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),t.prev=1,t.next=4,(0,st.YO)({uid:a.uid});case 4:r=t.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.vector.index.success",defaultMessage:"向量索引更新成功"})),null===(s=n.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.vector.index.failed",defaultMessage:"向量索引更新失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.vector.index.error",defaultMessage:"更新向量索引过程发生错误"})),console.error("更新向量索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(e){return t.apply(this,arguments)}}(),Ye=function(){we?Ce?j.yw.info("正在检查模型状态，请稍后再试"):(h(void 0),u(!1),w(!0)):ee.Z.confirm({title:e.formatMessage({id:"warning",defaultMessage:"警告"}),content:e.formatMessage({id:"embedding.model.missing.warning",defaultMessage:"嵌入式模型未加载，可能会影响问答质量。是否继续？"}),okText:e.formatMessage({id:"ok",defaultMessage:"确定"}),cancelText:e.formatMessage({id:"cancel",defaultMessage:"取消"}),onOk:function(){h(void 0),u(!1),w(!0)}})},Le=function(){var t=b()(M()().mark((function t(a){var r,s;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("handleSubmitDrawer",a),o?j.yw.loading(e.formatMessage({id:"updating"})):j.yw.loading(e.formatMessage({id:"creating"})),!o){t.next=8;break}return t.next=5,(0,st.y)(a);case 5:t.t0=t.sent,t.next=11;break;case 8:return t.next=10,(0,st.kh)(a);case 10:t.t0=t.sent;case 11:r=t.t0,console.log("createFaq response:",a,r),200===r.code?(j.yw.destroy(),j.yw.success(e.formatMessage({id:"create.success",defaultMessage:"create success"})),w(!1),null===(s=n.current)||void 0===s||s.reloadAndRest()):(j.yw.destroy(),j.yw.error(r.message));case 14:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),ze=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(we){t.next=3;break}return ee.Z.confirm({title:e.formatMessage({id:"warning",defaultMessage:"警告"}),content:e.formatMessage({id:"embedding.model.missing.warning",defaultMessage:"嵌入式模型未加载，可能会影响问答质量。是否继续？"}),okText:e.formatMessage({id:"ok",defaultMessage:"确定"}),cancelText:e.formatMessage({id:"cancel",defaultMessage:"取消"}),onOk:function(){K(!0)}}),t.abrupt("return");case 3:if(!Ce){t.next=6;break}return j.yw.info("正在检查模型状态，请稍后再试"),t.abrupt("return");case 6:K(!0);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();(0,i.useEffect)((function(){var e;null===(e=n.current)||void 0===e||e.reloadAndRest()}),[R,V]);var Be=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,ue.HK)(s.QPQ,null==P?void 0:P.uid,null==R?void 0:R.uid,s.whQ,{showLoading:!0,loadingMessage:e.formatMessage({id:"loading"}),errorMessage:e.formatMessage({id:"fetch.categories.error",defaultMessage:"Failed to fetch categories"})});case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),Ne=function(){var t=b()(M()().mark((function t(){var a,r,s,o,i,u;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==pe.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),t.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),r=0,s=0,o=m()(pe),t.prev=7,o.s();case 9:if((i=o.n()).done){t.next=23;break}return u=i.value,t.prev=11,t.next=14,(0,st.RF)({uid:u.uid});case 14:200===t.sent.code?r++:s++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),s++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),o.e(t.t1);case 28:return t.prev=28,o.f(),t.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的索引")})):j.yw.error(e.formatMessage({id:"batch.update.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的索引，").concat(s," 条记录更新失败")})),null===(a=n.current)||void 0===a||a.reload();case 34:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(){return t.apply(this,arguments)}}(),Qe=function(){var t=b()(M()().mark((function t(){var a,r,s,o,i,u;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==pe.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),t.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),r=0,s=0,o=m()(pe),t.prev=7,o.s();case 9:if((i=o.n()).done){t.next=23;break}return u=i.value,t.prev=11,t.next=14,(0,st.YO)({uid:u.uid});case 14:200===t.sent.code?r++:s++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),s++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),o.e(t.t1);case 28:return t.prev=28,o.f(),t.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.vector.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的向量索引")})):j.yw.error(e.formatMessage({id:"batch.update.vector.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的向量索引，").concat(s," 条记录更新失败")})),null===(a=n.current)||void 0===a||a.reload();case 34:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(){return t.apply(this,arguments)}}(),He=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.index.confirm.title",defaultMessage:"更新全部索引确认"}),content:e.formatMessage({id:"updateAll.index.confirm.content",defaultMessage:"确定要更新所有记录的索引吗？此操作可能需要一些时间。"}),onOk:function(){var t=b()(M()().mark((function t(){var a,r;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.index",defaultMessage:"正在更新所有索引..."})),t.prev=1,t.next=4,(0,st.L0)({kbUid:null==R?void 0:R.uid,categoryUid:(null==V?void 0:V.uid)===s.zBg?"":null==V?void 0:V.uid,orgUid:null==P?void 0:P.uid});case 4:a=t.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.index.success",defaultMessage:"所有索引更新请求已发送"})),null===(r=n.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.index.failed",defaultMessage:"所有索引更新请求失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.index.error",defaultMessage:"更新所有索引过程发生错误"})),console.error("更新所有索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(){return t.apply(this,arguments)}}()});case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),Ke=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.vector.index.confirm.title",defaultMessage:"更新全部向量索引确认"}),content:e.formatMessage({id:"updateAll.vector.index.confirm.content",defaultMessage:"确定要更新所有记录的向量索引吗？此操作可能需要一些时间。"}),onOk:function(){var t=b()(M()().mark((function t(){var a,r;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.vector.index",defaultMessage:"正在更新所有向量索引..."})),t.prev=1,t.next=4,(0,st.Bv)({kbUid:null==R?void 0:R.uid,categoryUid:(null==V?void 0:V.uid)===s.zBg?"":null==V?void 0:V.uid,orgUid:null==P?void 0:P.uid});case 4:a=t.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.vector.index.success",defaultMessage:"所有向量索引更新请求已发送"})),null===(r=n.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.vector.index.failed",defaultMessage:"所有向量索引更新请求失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.vector.index.error",defaultMessage:"更新所有向量索引过程发生错误"})),console.error("更新所有向量索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(){return t.apply(this,arguments)}}()});case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),We=function(){var e=b()(M()().mark((function e(t,n,a){var r,o;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("handleExportExcel",t,n,a),r=localStorage.getItem(s.LA8),o=p()({categoryUid:(null==V?void 0:V.uid)===s.zBg?"":null==V?void 0:V.uid,kbUid:null==R?void 0:R.uid,orgUid:(null==P?void 0:P.uid)||"",accessToken:r||"",exportType:t},Te),"current"===t?(o.pageNumber=String(C-1),o.pageSize=String(T)):"all"===t?(o.pageNumber="0",o.pageSize="1000"):"range"===t&&void 0!==n&&void 0!==a&&(o.pageNumber=String(n),o.pageSize=String(a)),window.open((0,D.kG)()+"/api/v1/faq/export?"+new URLSearchParams(o).toString());case 5:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),Ge={selectedRowKeys:le,onChange:function(e,t){ce(e),ge(t)}},_e=function(){var t=b()(M()().mark((function t(n,a,r){var o,i,u,l,c,f,g,m;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("request:",n,a,r),j.yw.loading(e.formatMessage({id:"loading",defaultMessage:"Loading"})),o=n.current,i=n.pageSize,u=d()(n,Gt),A(o),F(i),Fe(u),l=void 0,c=void 0,a&&Object.keys(a).length>0&&(f=Object.keys(a)[0],l=f,c="ascend"===a[f]?"ascend":"descend"),g=p()(p()({pageNumber:o-1,pageSize:i,categoryUid:(null==V?void 0:V.uid)===s.zBg?"":null==V?void 0:V.uid,kbUid:null==R?void 0:R.uid,orgUid:null==P?void 0:P.uid},u),{},{sortBy:l,sortDirection:c}),t.next=12,(0,st.pf)(g);case 12:return m=t.sent,console.log("queryFaqsByOrg response:",g,m),j.yw.destroy(),200===m.code?Me(m.data.totalElements):j.yw.error(m.message),t.abrupt("return",{data:m.data.content,success:!0,total:m.data.totalElements});case 17:case"end":return t.stop()}}),t)})));return function(e,n,a){return t.apply(this,arguments)}}(),Je=function(e){for(var t=[],n=1e3,a=Math.ceil(e/n),r=function(){var a=s,r=s*n+1,o=Math.min((s+1)*n,e);t.push({key:"export-".concat(s),label:"".concat(r,"-").concat(o," (").concat(o-r+1,"条)"),onClick:function(){return We("range",a,n)}})},s=0;s<a;s++)r();return t};return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(me,{onModelStatusChange:function(e){je(e),Ae(!1)}}),(0,z.jsx)(X.Z,{columns:De,actionRef:n,cardBordered:!0,rowSelection:Ge,request:_e,scroll:{x:2300},rowKey:"uid",search:{labelWidth:"auto"},pagination:{pageSize:10,onChange:function(e,t){A(e),F(t)}},dateFormatter:"string",headerTitle:t(null==R?void 0:R.name)+" - 常见问题",tooltip:Ce?"正在检查嵌入式模型...":we?"所添加FAQ内容会自动添加到 '拆分' 列表中 ":"请首先拉取Embedding向量模型bge-m3:latest",toolBarRender:function(){return function(){var t=[];(0,D.Ox)()||t.push((0,z.jsx)(Y.ZP,{icon:(0,z.jsx)(W.Z,{}),type:"primary",onClick:Ye,disabled:Ce,children:e.formatMessage({id:"create"})},"create"),(0,z.jsx)(rt.Z,{title:e.formatMessage({id:"chat.test.tooltip",defaultMessage:"请确认上传内容状态为：处理成功"}),children:(0,z.jsx)(ke,{currentKbase:R,currentOrg:P,embeddingModelExists:we,checkingEmbeddingModel:Ce})},"chat"));var n=[];le.length>0&&n.push({key:"batchDelete",icon:(0,z.jsx)(G.Z,{}),danger:!0,label:e.formatMessage({id:"batch.delete"})+" (".concat(le.length,")"),onClick:function(){ee.Z.confirm({title:e.formatMessage({id:"batch.deleteTip"}),content:"".concat(e.formatMessage({id:"batch.deleteAffirm"})," ").concat(le.length," ").concat(e.formatMessage({id:"items"}),"?"),onOk:Ee,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}},{key:"batchEnable",icon:(0,z.jsx)(et.Z,{}),label:e.formatMessage({id:"batch.enable",defaultMessage:"Enable"})+" (".concat(le.length,")"),onClick:function(){return Oe(!0)}},{key:"batchDisable",icon:(0,z.jsx)(tt.Z,{}),label:e.formatMessage({id:"batch.disable",defaultMessage:"Disable"})+" (".concat(le.length,")"),onClick:function(){return Oe(!1)}},{key:"batchUpdateIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.index",defaultMessage:"更新索引"})+" (".concat(le.length,")"),onClick:Ne},{key:"batchUpdateVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.vector.index",defaultMessage:"更新向量索引"})+" (".concat(le.length,")"),onClick:Qe}),n.push({key:"deleteAll",icon:(0,z.jsx)(_.Z,{}),danger:!0,label:e.formatMessage({id:"deleteAll",defaultMessage:"删除所有"}),onClick:function(){ee.Z.confirm({title:e.formatMessage({id:"deleteAll.tip",defaultMessage:"删除确认"}),content:e.formatMessage({id:"deleteAll.confirm",defaultMessage:"确定要删除所有问答对数据吗？此操作不可恢复!"}),onOk:Pe,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"})})}},{key:"updateAllIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.index",defaultMessage:"更新所有索引"}),onClick:He},{key:"updateAllVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.vector.index",defaultMessage:"更新所有向量索引"}),onClick:Ke});var a=[{key:"import",icon:(0,z.jsx)(nt.Z,{}),label:e.formatMessage({id:"import"}),onClick:ze,disabled:Ce},{key:"export-current",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return We("current")}}];return ve>0&&(ve<=1e3?a.push({key:"export-all",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(ve,"条)"),onClick:function(){return We("all")}}):a.push({key:"export-range",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(ve,"条)"),children:Je(ve)})),a.push({key:"download",icon:(0,z.jsx)(at.Z,{}),label:e.formatMessage({id:"download.template"}),onClick:function(){return(0,D.IY)()}}),t.push((0,z.jsx)(re.Z,{menu:{items:a},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:"primary",children:[e.formatMessage({id:"import.export",defaultMessage:"导入导出"}),(0,z.jsx)($.Z,{})]})},"importExport")),n.length>0&&t.push((0,z.jsx)(re.Z,{menu:{items:n},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:le.length>0?"primary":"default",danger:le.length>0,children:[le.length>0?e.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(le.length,")"):e.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,z.jsx)($.Z,{})]})},"batchOperations")),t}()}}),(0,z.jsx)(Wt,{isEdit:o,open:y,faq:g,onClose:function(){return w(!1)},onSubmit:Le}),H&&(0,z.jsx)(ie.Z,{type:s.hqx,acceptType:".xlsx,.xls,.csv",isModalOpen:H,handleSubmit:function(e){console.log("handleUploadDragSubmit",e),K(!1),null==n||n.current.reload(),Be()},handleCancel:function(){console.log("handleUploadDragCancel"),K(!1),null==n||n.current.reload()}})]})};function Jt(e){return $t.apply(this,arguments)}function $t(){return($t=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/query/org",{method:"GET",params:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Xt(e){return en.apply(this,arguments)}function en(){return(en=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/create",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function tn(e){return nn.apply(this,arguments)}function nn(){return(nn=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/update",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function an(e){return rn.apply(this,arguments)}function rn(){return(rn=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/delete",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function sn(e){return on.apply(this,arguments)}function on(){return(on=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/updateIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function un(e){return ln.apply(this,arguments)}function ln(){return(ln=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/updateVectorIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function cn(e){return dn.apply(this,arguments)}function dn(){return(dn=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/updateAllIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function fn(e){return pn.apply(this,arguments)}function pn(){return(pn=b()(M()().mark((function e(t){return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/llm/webpage/updateAllVectorIndex",{method:"POST",data:p()(p()({},t),{},{client:s.bVn})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var gn=function(e){var t=e.isEdit,n=e.webpage,a=e.open,r=e.onClose,s=e.onSubmit,o=je.A.useForm(),u=k()(o,1)[0],l=(0,E.j)((function(e){return e.currentKbase})),c=(0,O.u)((function(e){return e.currentOrg})),d=(0,i.useState)(!1),f=k()(d,2),g=f[0],m=f[1],h=(0,i.useState)(""),x=k()(h,2),v=(x[0],x[1]),y=function(){var e=b()(M()().mark((function e(){var t,n,a;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,m(!0),e.next=4,u.validateFields();case 4:t=e.sent,!(n=t.url)||n.startsWith("http://")||n.startsWith("https://")||(n="https://".concat(n)),a=p()(p()({},t),{},{url:n,kbUid:null==l?void 0:l.uid,orgUid:null==c?void 0:c.uid}),console.log("submit",a),s(a),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("表单校验失败:",e.t0),ce.ZP.error("请检查表单填写是否正确");case 16:return e.prev=16,m(!1),e.finish(16);case 19:case"end":return e.stop()}}),e,null,[[0,12,16,19]])})));return function(){return e.apply(this,arguments)}}();return(0,i.useEffect)((function(){t?u.setFieldsValue({uid:null==n?void 0:n.uid,title:null==n?void 0:n.title,url:null==n?void 0:n.url,description:null==n?void 0:n.description}):u.setFieldsValue({title:"",url:"",content:""})}),[t,n,u]),(0,z.jsx)(z.Fragment,{children:(0,z.jsx)(R.Z,{title:t?"编辑网页":"添加网页",onClose:r,open:a,width:600,extra:(0,z.jsxs)(V.Z,{children:[(0,z.jsx)(Y.ZP,{onClick:r,children:"取消"}),(0,z.jsx)(Y.ZP,{type:"primary",onClick:y,loading:g,children:"提交"})]}),footer:null,children:(0,z.jsxs)(je.A,{form:u,name:"webpageForm",submitter:!1,children:[(0,z.jsx)(Se.Z,{label:"名称",name:"title",rules:[{required:!0,message:"请输入网页名称"}],placeholder:"请输入网页名称"}),(0,z.jsx)(Se.Z,{label:"URL",name:"url",rules:[{required:!0,message:"请输入网页地址"},{pattern:/^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([/\w .-]*)*\/?$/,message:"请输入有效的网址"}],placeholder:"请输入网址，例如：www.example.com",fieldProps:{addonAfter:(0,z.jsx)(Y.ZP,{type:"link",onClick:function(){var e=u.getFieldValue("url");if(e){var t=e;e.startsWith("http://")||e.startsWith("https://")||(t="https://".concat(e)),v(t),window.open(t,"_blank")}else ce.ZP.warning("请输入网址")},children:"预览"})},tooltip:"支持 http 或 https 开头的网址"}),(0,z.jsx)(Ze.Z,{label:"描述",name:"description",placeholder:"请输入网页描述",fieldProps:{maxLength:500,showCount:!0}})]})})})},mn=["current","pageSize"],hn=function(){var e=(0,l.useIntl)(),t=(0,q.Z)().translateString,n=(0,i.useRef)(),a=(0,i.useState)(1),r=k()(a,2),o=r[0],u=r[1],c=(0,i.useState)(10),f=k()(c,2),g=f[0],h=f[1],x=(0,O.u)((function(e){return e.currentOrg})),v=(0,E.j)((function(e){return e.currentKbase})),y=(0,N.v)((function(e){return e.currentCategory})),w=(0,N.v)((function(e){return e.categorySelectOptions})),S=(0,i.useState)(!1),Z=k()(S,2),C=Z[0],A=Z[1],U=(0,i.useState)({}),I=k()(U,2),T=I[0],F=I[1],P=(0,i.useState)(!1),R=k()(P,2),V=R[0],L=R[1],B=ee.Z.useModal(),Q=k()(B,2),H=(Q[0],Q[1]),K=(0,i.useState)(!1),_=k()(K,2),se=_[0],ie=_[1],ue=(0,i.useState)(!1),le=k()(ue,2),ce=le[0],de=le[1],fe=(0,i.useState)({}),pe=k()(fe,2),he=pe[0],xe=pe[1],ve=(0,i.useState)(0),Me=k()(ve,2),ye=Me[0],be=Me[1],we=(0,i.useState)([]),je=k()(we,2),Se=je[0],Ze=je[1],Ce=(0,i.useState)([]),Ae=k()(Ce,2),Ue=Ae[0],Ie=Ae[1],Te=function(){var t=b()(M()().mark((function t(a){var r,s;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),t.prev=1,t.next=4,sn({uid:a.uid});case 4:r=t.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.index.success",defaultMessage:"索引更新已触发"})),null===(s=n.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.index.failed",defaultMessage:"索引更新失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.index.error",defaultMessage:"更新索引过程发生错误"})),console.error("更新索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(e){return t.apply(this,arguments)}}(),Fe=function(){var t=b()(M()().mark((function t(a){var r,s;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),t.prev=1,t.next=4,un({uid:a.uid});case 4:r=t.sent,j.yw.destroy(),200===r.code?(j.yw.success(e.formatMessage({id:"update.vector.index.success",defaultMessage:"向量索引更新已触发"})),null===(s=n.current)||void 0===s||s.reload()):j.yw.error(r.message||e.formatMessage({id:"update.vector.index.failed",defaultMessage:"向量索引更新失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.vector.index.error",defaultMessage:"更新向量索引过程发生错误"})),console.error("更新向量索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(e){return t.apply(this,arguments)}}(),qe=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:(0,z.jsx)(l.FormattedMessage,{id:"name",defaultMessage:"Name"}),dataIndex:"title",copyable:!0,tooltip:e.formatMessage({id:"webpage.name.tooltip",defaultMessage:"网页的名称或标识"}),width:200,fixed:"left",render:function(e,t){return(0,z.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,z.jsx)("span",{style:{marginRight:4},children:null==t?void 0:t.title}),(0,z.jsx)(te.Z.Text,{copyable:{text:(null==t?void 0:t.title)||""}})]})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"url",defaultMessage:"Url"}),dataIndex:"url",hideInSearch:!0,copyable:!0,width:250,tooltip:e.formatMessage({id:"webpage.url.tooltip",defaultMessage:"网页的URL地址，用于爬取内容"}),render:function(e,t){return(0,z.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,z.jsx)("span",{style:{marginRight:4},children:null==t?void 0:t.url}),(0,z.jsx)(te.Z.Text,{copyable:{text:(null==t?void 0:t.url)||""}})]})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"status",defaultMessage:"Status"}),dataIndex:"status",hideInSearch:!0,width:120,tooltip:e.formatMessage({id:"webpage.status.tooltip",defaultMessage:"网页索引状态"}),render:function(t,n){var a=n.elasticStatus||"",r="";return"SUCCESS"===a.toUpperCase()?r="success":"ERROR"===a.toUpperCase()||"FAILED"===a.toUpperCase()?r="error":"NEW"===a.toUpperCase()||"PENDING"===a.toUpperCase()?r="default":"PROCESSING"===a.toUpperCase()&&(r="processing"),(0,z.jsx)(ne.Z,{color:r,children:e.formatMessage({id:"llm.status.".concat(a.toLowerCase()),defaultMessage:a})})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"vectorStatus",defaultMessage:"Vector Status"}),dataIndex:"vectorStatus",hideInSearch:!0,width:150,tooltip:e.formatMessage({id:"webpage.vectorStatus.tooltip",defaultMessage:"网页内容向量化状态"}),render:function(t,n){var a=n.vectorStatus||"",r="";return"SUCCESS"===a.toUpperCase()?r="success":"ERROR"===a.toUpperCase()||"FAILED"===a.toUpperCase()?r="error":"NEW"===a.toUpperCase()||"PENDING"===a.toUpperCase()?r="default":"PROCESSING"===a.toUpperCase()&&(r="warning"),a?(0,z.jsx)(ne.Z,{color:r,icon:(0,z.jsx)($e.Z,{}),children:e.formatMessage({id:"llm.vectorStatus.".concat(a.toLowerCase()),defaultMessage:a})}):"-"}},{title:(0,z.jsx)(l.FormattedMessage,{id:"description",defaultMessage:"Description"}),dataIndex:"description",hideInSearch:!0,ellipsis:!0,width:200,tooltip:e.formatMessage({id:"webpage.description.tooltip",defaultMessage:"网页的简要描述信息"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"tags",defaultMessage:"Tags"}),dataIndex:"tagList",hideInSearch:!0,width:150,tooltip:e.formatMessage({id:"webpage.tags.tooltip",defaultMessage:"网页的标签列表"}),render:function(e,t){if(!t.tagList||0===t.tagList.length)return"-";var n=t.tagList.length>3,a=t.tagList.slice(0,3);return(0,z.jsxs)("div",{children:[a.map((function(e,t){return(0,z.jsx)(ne.Z,{color:"green",style:{marginBottom:4},children:e},t)})),n&&(0,z.jsxs)(ne.Z,{color:"orange",children:["+",t.tagList.length-3]})]})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"content",defaultMessage:"Content"}),dataIndex:"content",hideInSearch:!0,ellipsis:!0,width:300,tooltip:e.formatMessage({id:"webpage.content.tooltip",defaultMessage:"爬取的网页内容摘要"})},{title:(0,z.jsx)(l.FormattedMessage,{id:"category",defaultMessage:"Category"}),dataIndex:"categoryUid",hideInSearch:!0,width:100,tooltip:e.formatMessage({id:"webpage.category.tooltip",defaultMessage:"网页内容所属的分类类型"}),render:function(e,t){var n=w.find((function(e){return e.value===(null==t?void 0:t.categoryUid)}));return(0,z.jsx)(ne.Z,{children:null==n?void 0:n.label})}},{title:(0,z.jsx)(l.FormattedMessage,{id:"createdAt",defaultMessage:"createdAt"}),key:"createdAt",dataIndex:"createdAt",sorter:!0,hideInSearch:!0,width:180,tooltip:e.formatMessage({id:"webpage.createdAt.tooltip",defaultMessage:"网页记录创建的时间"}),render:function(e,t,n,a){return oe()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,z.jsx)(l.FormattedMessage,{id:"updatedAt",defaultMessage:"updatedAt"}),key:"updatedAt",dataIndex:"updatedAt",sorter:!0,hideInSearch:!0,width:180,tooltip:e.formatMessage({id:"webpage.updatedAt.tooltip",defaultMessage:"网页记录更新的时间"}),render:function(e,t){return t.updatedAt?oe()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss"):"-"}}],Ee=[].concat(qe,[{title:e.formatMessage({id:"actions",defaultMessage:"Actions"}),valueType:"option",key:"option",width:220,fixed:"right",render:function(t,n,a,r){return[(0,z.jsx)("a",{onClick:function(){F(n),L(!0),A(!0)},children:e.formatMessage({id:"edit",defaultMessage:"Edit"})},"editable"),(0,z.jsx)(ae.Z,{title:e.formatMessage({id:"deleteTip"}),description:"".concat(e.formatMessage({id:"deleteAffirm",defaultMessage:"Delete"}),"【").concat(n.title,"】？"),onConfirm:function(){return Oe(n)},okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"}),icon:(0,z.jsx)(Xe.Z,{style:{color:"red"}}),children:(0,z.jsx)(Y.ZP,{type:"link",danger:!0,children:e.formatMessage({id:"delete",defaultMessage:"Delete"})},"delete")},"delete"),(0,z.jsx)(re.Z,{menu:{items:[{key:"updateIndex",label:e.formatMessage({id:"update.index",defaultMessage:"更新索引"}),onClick:function(){return Te(n)}},{key:"updateVectorIndex",label:e.formatMessage({id:"update.vector.index",defaultMessage:"更新向量索引"}),onClick:function(){return Fe(n)}}]},placement:"bottomRight",children:(0,z.jsx)(rt.Z,{title:e.formatMessage({id:"update.indexes",defaultMessage:"更新索引"}),children:(0,z.jsxs)(Y.ZP,{size:"small",type:"link",children:[e.formatMessage({id:"update.indexes",defaultMessage:"更新索引"}),(0,z.jsx)($.Z,{})]})})},"indexOperations")]}}]);(0,i.useEffect)((function(){var e;null==n||null===(e=n.current)||void 0===e||e.reload()}),[v,y]);var Oe=function(){var t=b()(M()().mark((function t(a){var r;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,an(a);case 2:200===(r=t.sent).code?(j.yw.success(e.formatMessage({id:"delete.success",defaultMessage:"Delete success"})),n.current.reload()):j.yw.error(r.message);case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Pe=function(){var e=b()(M()().mark((function e(t){var a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Xt(t);case 2:200===(a=e.sent).code?(null===(r=n.current)||void 0===r||r.reload(),A(!1)):j.yw.error(a.message);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),De=function(){var e=b()(M()().mark((function e(t){var a,r;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.uid=null==T?void 0:T.uid,e.next=3,tn(t);case 3:200===(a=e.sent).code?(null===(r=n.current)||void 0===r||r.reload(),A(!1)):j.yw.error(a.message);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Re=function(){se?ce?j.yw.info("正在检查模型状态，请稍后再试"):(A(!0),L(!1),F({})):ee.Z.warning({title:"嵌入式模型缺失",content:"请首先拉取Embedding向量模型bge-m3:latest，用于知识库向量检索",okText:"确定"})},Ve=function(){var t=b()(M()().mark((function t(){var a,r,s,o,i,u;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==Ue.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.delete.noselection",defaultMessage:"请选择要删除的项目"})),t.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"deleting",defaultMessage:"正在删除..."})),r=0,s=0,o=m()(Ue),t.prev=7,o.s();case 9:if((i=o.n()).done){t.next=23;break}return u=i.value,t.prev=11,t.next=14,an(u);case 14:200===t.sent.code?r++:s++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),s++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),o.e(t.t1);case 28:return t.prev=28,o.f(),t.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.delete.success",defaultMessage:"成功删除 {count} 项"},{count:r})):j.yw.warning(e.formatMessage({id:"batch.delete.partial",defaultMessage:"删除了 {success} 项，但有 {fail} 项删除失败"},{success:r,fail:s})),Ze([]),Ie([]),null===(a=n.current)||void 0===a||a.reloadAndRest();case 36:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(){return t.apply(this,arguments)}}(),Ye=function(){var t=b()(M()().mark((function t(){var a,r,s,o,i,u;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==Ue.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),t.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.index",defaultMessage:"正在更新索引..."})),r=0,s=0,o=m()(Ue),t.prev=7,o.s();case 9:if((i=o.n()).done){t.next=23;break}return u=i.value,t.prev=11,t.next=14,sn({uid:u.uid});case 14:200===t.sent.code?r++:s++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),s++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),o.e(t.t1);case 28:return t.prev=28,o.f(),t.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的索引")})):j.yw.error(e.formatMessage({id:"batch.update.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的索引，").concat(s," 条记录更新失败")})),null===(a=n.current)||void 0===a||a.reload();case 34:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(){return t.apply(this,arguments)}}(),Le=function(){var t=b()(M()().mark((function t(){var a,r,s,o,i,u;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==Ue.length){t.next=3;break}return j.yw.warning(e.formatMessage({id:"batch.update.noselection",defaultMessage:"请选择要更新的项目"})),t.abrupt("return");case 3:j.yw.loading(e.formatMessage({id:"updating.vector.index",defaultMessage:"正在更新向量索引..."})),r=0,s=0,o=m()(Ue),t.prev=7,o.s();case 9:if((i=o.n()).done){t.next=23;break}return u=i.value,t.prev=11,t.next=14,un({uid:u.uid});case 14:200===t.sent.code?r++:s++,t.next=21;break;case 18:t.prev=18,t.t0=t.catch(11),s++;case 21:t.next=9;break;case 23:t.next=28;break;case 25:t.prev=25,t.t1=t.catch(7),o.e(t.t1);case 28:return t.prev=28,o.f(),t.finish(28);case 31:j.yw.destroy(),0===s?j.yw.success(e.formatMessage({id:"batch.update.vector.index.success"},{defaultMessage:"成功更新 ".concat(r," 条记录的向量索引")})):j.yw.error(e.formatMessage({id:"batch.update.vector.index.partial"},{defaultMessage:"更新了 ".concat(r," 条记录的向量索引，").concat(s," 条记录更新失败")})),null===(a=n.current)||void 0===a||a.reload();case 34:case"end":return t.stop()}}),t,null,[[7,25,28,31],[11,18]])})));return function(){return t.apply(this,arguments)}}(),ze=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.index.confirm.title",defaultMessage:"更新全部索引确认"}),content:e.formatMessage({id:"updateAll.index.confirm.content",defaultMessage:"确定要更新所有记录的索引吗？此操作可能需要一些时间。"}),onOk:function(){var t=b()(M()().mark((function t(){var a,r;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.index",defaultMessage:"正在更新所有索引..."})),t.prev=1,t.next=4,cn({kbUid:null==v?void 0:v.uid,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,orgUid:null==x?void 0:x.uid});case 4:a=t.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.index.success",defaultMessage:"所有索引更新请求已发送"})),null===(r=n.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.index.failed",defaultMessage:"所有索引更新请求失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.index.error",defaultMessage:"更新所有索引过程发生错误"})),console.error("更新所有索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(){return t.apply(this,arguments)}}()});case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),Be=function(){var t=b()(M()().mark((function t(){return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:ee.Z.confirm({title:e.formatMessage({id:"updateAll.vector.index.confirm.title",defaultMessage:"更新全部向量索引确认"}),content:e.formatMessage({id:"updateAll.vector.index.confirm.content",defaultMessage:"确定要更新所有记录的向量索引吗？此操作可能需要一些时间。"}),onOk:function(){var t=b()(M()().mark((function t(){var a,r;return M()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return j.yw.loading(e.formatMessage({id:"updating.all.vector.index",defaultMessage:"正在更新所有向量索引..."})),t.prev=1,t.next=4,fn({kbUid:null==v?void 0:v.uid,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,orgUid:null==x?void 0:x.uid});case 4:a=t.sent,j.yw.destroy(),200===a.code?(j.yw.success(e.formatMessage({id:"update.all.vector.index.success",defaultMessage:"所有向量索引更新请求已发送"})),null===(r=n.current)||void 0===r||r.reload()):j.yw.error(a.message||e.formatMessage({id:"update.all.vector.index.failed",defaultMessage:"所有向量索引更新请求失败"})),t.next=14;break;case 9:t.prev=9,t.t0=t.catch(1),j.yw.destroy(),j.yw.error(e.formatMessage({id:"update.all.vector.index.error",defaultMessage:"更新所有向量索引过程发生错误"})),console.error("更新所有向量索引错误:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[1,9]])})));return function(){return t.apply(this,arguments)}}()});case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),Ne=function(){var e=b()(M()().mark((function e(t,n,a){var r,i;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=localStorage.getItem(s.LA8),i=p()({categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:(null==x?void 0:x.uid)||"",accessToken:r||"",exportType:t},he),"current"===t?(i.pageNumber=o-1,i.pageSize=g):"all"===t?(i.pageNumber=0,i.pageSize=1e3):"range"===t&&void 0!==n&&void 0!==a&&(i.pageNumber=n,i.pageSize=a),window.open((0,D.kG)()+"/api/v1/webpage/export?"+new URLSearchParams(Object.entries(i).reduce((function(e,t){var n=k()(t,2),a=n[0],r=n[1];return e[a]=String(r),e}),{})).toString());case 4:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),Qe=function(e){for(var t=[],n=1e3,a=Math.ceil(e/n),r=function(){var a=s,r=s*n+1,o=Math.min((s+1)*n,e);t.push({key:"export-".concat(s),label:"".concat(r,"-").concat(o," (").concat(o-r+1,"条)"),onClick:function(){return Ne("range",a,n)}})},s=0;s<a;s++)r();return t};return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(me,{onModelStatusChange:function(e){ie(e),de(!1)}}),(0,z.jsx)(X.Z,{columns:Ee,actionRef:n,cardBordered:!0,scroll:{x:2200},rowSelection:{selectedRowKeys:Se,onChange:function(e,t){Ze(e),Ie(t)}},request:function(){var e=b()(M()().mark((function e(t,n,a){var r,o,i,l,c,f,g,m;return M()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.current,o=t.pageSize,i=d()(t,mn),u(r),h(o),xe(i),l=void 0,c=void 0,n&&Object.keys(n).length>0&&(f=Object.keys(n)[0],l=f,c="ascend"===n[f]?"ascend":"descend"),g=p()(p()({pageNumber:r-1,pageSize:o,categoryUid:(null==y?void 0:y.uid)===s.zBg?"":null==y?void 0:y.uid,kbUid:null==v?void 0:v.uid,orgUid:null==x?void 0:x.uid},i),{},{sortBy:l,sortDirection:c}),e.next=10,Jt(g);case 10:return m=e.sent,console.log("queryWebpagesByOrg: ",m),200===m.code?be(m.data.totalElements):j.yw.error(m.message),e.abrupt("return",{data:m.data.content,success:!0,total:m.data.totalElements});case 14:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),editable:{type:"multiple"},rowKey:"uid",search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,onChange:function(e,t){u(e),h(t)}},dateFormatter:"string",headerTitle:t(null==v?void 0:v.name)+" - 网页爬虫",tooltip:ce?"正在检查嵌入式模型...":se?"添加网页后会自动爬取内容并添加到知识库":"请首先拉取Embedding向量模型bge-m3:latest",toolBarRender:function(){var t=[(0,z.jsx)(Y.ZP,{type:"primary",icon:(0,z.jsx)(W.Z,{}),onClick:function(){return ge(Re,se,ce)},disabled:ce||!se,children:e.formatMessage({id:"create",defaultMessage:"Create"})},"create"),(0,z.jsx)(ke,{currentKbase:v,currentOrg:x,embeddingModelExists:se,checkingEmbeddingModel:ce||!se},"chat")],n=[];Se.length>0&&n.push({key:"batchDelete",icon:(0,z.jsx)(G.Z,{}),danger:!0,label:e.formatMessage({id:"batch.delete",defaultMessage:"批量删除"})+" (".concat(Se.length,")"),onClick:function(){}},{key:"batchUpdateIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.index",defaultMessage:"更新索引"})+" (".concat(Se.length,")"),onClick:Ye},{key:"batchUpdateVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"batch.update.vector.index",defaultMessage:"更新向量索引"})+" (".concat(Se.length,")"),onClick:Le}),n.push({key:"updateAllIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.index",defaultMessage:"更新所有索引"}),onClick:ze},{key:"updateAllVectorIndex",icon:(0,z.jsx)($e.Z,{}),label:e.formatMessage({id:"updateAll.vector.index",defaultMessage:"更新所有向量索引"}),onClick:Be});var a=[{key:"export-current",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return Ne("current")}}];return ye>0&&(ye<=1e3?a.push({key:"export-all",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(ye,"条)"),onClick:function(){return Ne("all")}}):a.push({key:"export-range",icon:(0,z.jsx)(J.Z,{}),label:e.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(ye,"条)"),children:Qe(ye)})),t.push((0,z.jsx)(re.Z,{menu:{items:a},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:"primary",icon:(0,z.jsx)(J.Z,{}),children:[e.formatMessage({id:"export.options",defaultMessage:"导出"}),(0,z.jsx)($.Z,{})]})},"exportDropdown")),n.length>0&&t.push((0,z.jsx)(ae.Z,{title:e.formatMessage({id:"batch.deleteTip",defaultMessage:"批量删除确认"}),description:"".concat(e.formatMessage({id:"batch.deleteAffirm",defaultMessage:"确定要删除"})," ").concat(Se.length," ").concat(e.formatMessage({id:"items",defaultMessage:"项"}),"?"),onConfirm:Ve,okText:e.formatMessage({id:"ok"}),cancelText:e.formatMessage({id:"cancel"}),icon:(0,z.jsx)(Xe.Z,{style:{color:"red"}}),disabled:0===Se.length,children:(0,z.jsx)(re.Z,{menu:{items:n},placement:"bottom",children:(0,z.jsxs)(Y.ZP,{type:Se.length>0?"primary":"default",danger:Se.length>0,children:[Se.length>0?e.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(Se.length,")"):e.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,z.jsx)($.Z,{})]})},"batchOperations")},"batchDeleteConfirm")),t}}),C&&(0,z.jsx)(gn,{isEdit:V,open:C,webpage:T,onClose:function(){A(!1)},onSubmit:function(e){V?De(e):Pe(e)}}),H]})};var xn=function(){var e=(0,l.useIntl)(),t=(0,i.useMemo)((function(){var t=[{key:"faq",label:e.formatMessage({id:"pages.robot.kb.faq",defaultMessage:"Q&A"}),children:(0,z.jsx)(_t,{})}];return(0,D.Ox)()||t.push({key:"text",label:e.formatMessage({id:"pages.robot.kb.text",defaultMessage:"Text"}),children:(0,z.jsx)(ft,{})},{key:"file",label:e.formatMessage({id:"pages.robot.kb.file",defaultMessage:"File"}),children:(0,z.jsx)(Ue,{})},{key:"split",label:e.formatMessage({id:"pages.robot.kb.split",defaultMessage:"Split"}),children:(0,z.jsx)(qt,{})},{key:"webpage",label:e.formatMessage({id:"pages.robot.kb.webpage",defaultMessage:"Webpage Crawling"}),children:(0,z.jsx)(hn,{})}),t}),[e]);return(0,z.jsx)(z.Fragment,{children:(0,z.jsx)(u.Z,{items:t})})},vn=r.Z.Sider,Mn=r.Z.Content,yn=function(){var e=(0,a.Z)(),t=e.leftSiderWidth,n=e.leftSiderStyle,i=e.contentStyle;return(0,z.jsx)("div",{children:(0,z.jsxs)(r.Z,{children:[(0,z.jsx)(vn,{width:t,style:n,children:(0,z.jsx)(o.Z,{type:s.QPQ})}),(0,z.jsx)(r.Z,{children:(0,z.jsx)(Mn,{style:i,children:(0,z.jsx)(xn,{})})})]})})}}}]);