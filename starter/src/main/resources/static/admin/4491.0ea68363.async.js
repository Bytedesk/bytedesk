"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[4491],{27366:function(e,t,n){n.d(t,{If:function(){return h},dF:function(){return c},j4:function(){return g},v$:function(){return m}});var r=n(90819),i=n.n(r),a=n(73193),o=n.n(a),s=n(89933),l=n.n(s),u=n(27353),d=n(2290);function c(e){return f.apply(this,arguments)}function f(){return(f=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/department/query/org",{method:"GET",params:o()(o()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return(p=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/department/create",{method:"POST",data:o()(o()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return v.apply(this,arguments)}function v(){return(v=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/department/update",{method:"POST",data:o()(o()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return k.apply(this,arguments)}function k(){return(k=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/department/delete",{method:"POST",data:o()(o()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},60016:function(e,t,n){n.d(t,{Bg:function(){return c},Ch:function(){return g},Gv:function(){return y},bD:function(){return m},mE:function(){return M},nQ:function(){return w},nU:function(){return h},oX:function(){return U}});var r=n(90819),i=n.n(r),a=n(73193),o=n.n(a),s=n(89933),l=n.n(s),u=n(2290),d=n(27353);function c(e){return f.apply(this,arguments)}function f(){return(f=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/query/org",{method:"GET",params:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return(p=l()(i()().mark((function e(t){var n,r,a;return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.orgUid,r=t.workgroupUid,a=t.type,e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/orgs/".concat(n,"/workgroups/").concat(r),{method:"GET",params:{channel:d.XtJ,type:a}}));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return v.apply(this,arguments)}function v(){return(v=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/publish",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return k.apply(this,arguments)}function k(){return(k=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/delete",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(e){return x.apply(this,arguments)}function x(){return(x=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/create",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function M(e){return b.apply(this,arguments)}function b(){return(b=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/update",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e,t){return S.apply(this,arguments)}function S(){return(S=l()(i()().mark((function e(t,n){var r,a;return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.uid,a=t.orgUid,e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/".concat(r,"/orgs/").concat(a,"/bindings"),{method:"POST",data:o()(o()({},n),{},{channel:d.XtJ})}));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(e){return j.apply(this,arguments)}function j(){return(j=l()(i()().mark((function e(t){return i()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/ticket/settings/bindings",{method:"GET",params:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},90938:function(e,t,n){var r=n(96775);t.Z=function(){var e=(0,r.Z)().isDarkMode;return{leftSiderStyle:{borderRight:e?"1px solid #333":"1px solid #ccc",background:e?"#141414":"#f5f5f5",height:"100vh",overflow:"auto"},leftSiderWidth:250,headerStyle:{background:e?"#141414":"#fff"},rightSiderStyle:{borderLeft:e?"1px solid #333":"1px solid #ccc",background:e?"#141414":"#f5f5f5"},contentStyle:{minHeight:120,background:e?"#141414":"#f5f5f5",height:"100vh",overflow:"auto",padding:10}}}},64533:function(e,t,n){n.d(t,{Z:function(){return ue}});var r=n(84176),i=n.n(r),a=n(10154),o=n.n(a),s=n(76711),l=n.n(s),u=n(73193),d=n.n(u),c=n(86222),f=n.n(c),m=n(90819),p=n.n(m),g=n(89933),v=n.n(g),h=n(45332),k=n.n(h),y=n(50884),x=n(25155),M=n(28520),b=n(7603),w=n(6823),S=n(21002),U=n(27353),j=n(28031),F=n(80503),Z=n(91768),C=n(77601),E=n(2290),q=n(35746),D=n(56668),I=n(90883),T=n(38623),B=n(70937),N=n(96596),P=n.n(N),A=n(44194),z=n(19058),L=n(46206),O=n(34053),R=n(97765),V=n(97588),_=n(67186),W=n(17455),J=n(83788),X=n(54227),G=n(22014),H=n(59350),Y=n(27366),Q=n(8369),K=n(60016),$=n(89957),ee=n.n($),te=n(31549),ne=function(e){var t=e.fields,n=void 0===t?[]:t,r=e.fieldNamePrefix,i=void 0===r?"dynamicField_":r,a=e.translate,o=(0,E.useIntl)(),s=function(e){if(!e)return"";try{return a&&a(e)||e}catch(t){return console.error("translate field text failed:",t),e}};return null!=n&&n.length?(0,te.jsx)(te.Fragment,{children:n.map((function(e,t){var n,r,a,l=function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}(e,t),u="".concat(i).concat(l),d=(null==e?void 0:e.label)||(null==e?void 0:e.title)||"Field ".concat(t+1),c=s(d)||d,f=function(e,t){switch(e){case"text":switch(t){case"email":return o.formatMessage({id:"ticket.form.placeholder.email",defaultMessage:"请输入邮箱地址"});case"tel":return o.formatMessage({id:"ticket.form.placeholder.tel",defaultMessage:"请输入电话号码"});case"textarea":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入文本内容"});case"date":return o.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"datetime-local":return o.formatMessage({id:"ticket.form.placeholder.datetime",defaultMessage:"请选择日期时间"});default:return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}case"input":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"});case"textarea":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入多行文本"});case"select":return o.formatMessage({id:"ticket.form.placeholder.select",defaultMessage:"请选择"});case"datePicker":return o.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"timePicker":return o.formatMessage({id:"ticket.form.placeholder.time",defaultMessage:"请选择时间"});default:return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}}(null==e?void 0:e.type,null==e||null===(n=e.props)||void 0===n?void 0:n.type),m=null!=e&&e.required?[{required:!0,message:o.formatMessage({id:"ticket.form.required",defaultMessage:"{label}是必填项"},{label:c})}]:void 0;if("textarea"===(null==e?void 0:e.type)||"textarea"===(null==e||null===(r=e.props)||void 0===r?void 0:r.component))return(0,te.jsx)(J.Z,{name:u,label:c,placeholder:f,rules:m},u);if("select"===(null==e?void 0:e.type)||"select"===(null==e||null===(a=e.props)||void 0===a?void 0:a.component)||"select"===(null==e?void 0:e.component)){var p,g,v,h=(null!==(p=null!==(g=null==e?void 0:e.options)&&void 0!==g?g:null==e||null===(v=e.props)||void 0===v?void 0:v.options)&&void 0!==p?p:[]).map((function(e,t){return"string"==typeof e?{label:s(e)||e,value:e}:"object"===ee()(e)?{label:s(e.label||e.value||e.text||"")||e.label||e.value||e.text||"",value:null!==(n=null!==(r=null!==(i=null!==(a=e.value)&&void 0!==a?a:e.key)&&void 0!==i?i:e.label)&&void 0!==r?r:e.text)&&void 0!==n?n:"".concat(t)}:{label:String(e),value:e};var n,r,i,a}));return(0,te.jsx)(W.Z,{name:u,label:c,placeholder:f,options:h,rules:m},u)}return(0,te.jsx)(_.Z,{name:u,label:c,placeholder:f,rules:m},u)}))}):null},re=function(e){var t,n=e.open,r=e.isEdit,i=void 0!==r&&r,a=e.currentTicket,o=e.onSuccess,s=e.onCancel,u=V.A.useForm(),c=k()(u,1)[0],f=(0,E.useIntl)(),m=(0,S.Z)(),g=m.translateString,h=(m.translateStringTranct,(0,M.u)((function(e){return e.currentOrg}))),b=(0,A.useState)([]),j=k()(b,2),F=j[0],Z=j[1],C=(0,A.useState)([]),q=k()(C,2),D=q[0],T=q[1],B=(0,A.useState)({uid:"",nickname:""}),N=k()(B,2),P=N[0],$=N[1],ee=(0,A.useState)(!1),re=k()(ee,2),ie=re[0],ae=re[1],oe=(0,A.useState)([]),se=k()(oe,2),le=se[0],ue=se[1],de=(0,A.useState)([]),ce=k()(de,2),fe=ce[0],me=ce[1],pe=(0,A.useRef)([]),ge=(0,A.useRef)(),ve=(0,A.useState)(!1),he=k()(ve,2),ke=(he[0],he[1]),ye=(0,A.useState)(),xe=k()(ye,2),Me=xe[0],be=xe[1],we=(0,A.useMemo)((function(){return"ticketSettingsSelection_".concat((null==h?void 0:h.uid)||"default")}),[null==h?void 0:h.uid]),Se=(0,A.useMemo)((function(){return Me?fe.find((function(e){return e.uid===Me})):void 0}),[fe,Me]),Ue=Boolean(null==Se?void 0:Se.customFormEnabled),je=(0,A.useMemo)((function(){var e;if(!Ue)return[];var t=null==Se||null===(e=Se.form)||void 0===e?void 0:e.schema;if(!t)return[];try{var n=JSON.parse(t);if(Array.isArray(n))return n;if(Array.isArray(null==n?void 0:n.schema))return n.schema;if(Array.isArray(null==n?void 0:n.fields))return n.fields;if(Array.isArray(null==n?void 0:n.content))return n.content}catch(e){console.error("ticket form schema parse error",e)}return[]}),[Ue,null==Se||null===(t=Se.form)||void 0===t?void 0:t.schema]),Fe=(0,A.useCallback)((function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}),[]);(0,A.useEffect)((function(){pe.current=fe}),[fe]),(0,A.useEffect)((function(){var e,t,n,r,a,o=ge.current,s=null==Se?void 0:Se.uid;ge.current=s;var l=null!==(e=null==Se?void 0:Se.categorySettings)&&void 0!==e?e:null==Se?void 0:Se.draftCategorySettings;if(null==l||null===(t=l.items)||void 0===t||!t.length)return Z([]),void(i||c.setFieldsValue({categoryUid:void 0}));var u=l.items.filter((function(e){return Boolean(null==e?void 0:e.uid)&&!1!==(null==e?void 0:e.enabled)})).sort((function(e,t){var n,r;return(null!==(n=e.orderIndex)&&void 0!==n?n:0)-(null!==(r=t.orderIndex)&&void 0!==r?r:0)}));if(!u.length)return Z([]),void(i||c.setFieldsValue({categoryUid:void 0}));if(Z(u),!i){var d=c.getFieldValue("categoryUid");if(s!==o||!d||!u.some((function(e){return e.uid===d}))){var f=(null===(n=u.find((function(e){return e.uid===l.defaultCategoryUid})))||void 0===n?void 0:n.uid)||(null===(r=u.find((function(e){return e.defaultCategory})))||void 0===r?void 0:r.uid)||(null===(a=u[0])||void 0===a?void 0:a.uid);c.setFieldsValue({categoryUid:f||void 0})}}}),[Se,i,c,n]);var Ze=(0,A.useCallback)((function(e){var t,n;null!=e&&null!==(t=e.process)&&void 0!==t&&t.uid?c.setFieldsValue({processEntityUid:e.process.uid}):c.setFieldsValue({processEntityUid:void 0}),null!=e&&e.customFormEnabled&&null!=e&&null!==(n=e.form)&&void 0!==n&&n.uid?c.setFieldsValue({formEntityUid:e.form.uid}):c.setFieldsValue({formEntityUid:void 0})}),[c]),Ce=(0,A.useCallback)((function(e,t){var n=e||void 0,r=null!=t?t:pe.current;be(n),c.setFieldsValue({ticketSettingsUid:n}),n?localStorage.setItem(we,n):localStorage.removeItem(we);var i=r.find((function(e){return e.uid===n}));Ze(i)}),[c,we,Ze]),Ee=(0,A.useCallback)(v()(p()().mark((function e(){var t,n,r,o,s,l,u,d,c,m;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=h&&h.uid){e.next=4;break}return me([]),Ce(void 0,[]),e.abrupt("return");case 4:return ke(!0),e.prev=5,r={orgUid:h.uid,pageNumber:0,pageSize:200},e.next=9,(0,K.Bg)(r);case 9:o=e.sent,R.Z.debug("queryTicketSettingsByOrg response:",null==o?void 0:o.data,r),s=null!==(t=null==o||null===(n=o.data)||void 0===n?void 0:n.content)&&void 0!==t?t:[],me(s),i&&null!=a&&a.ticketSettingsUid&&s.some((function(e){return e.uid===a.ticketSettingsUid}))?l=a.ticketSettingsUid:(u=localStorage.getItem(we),l=u&&s.some((function(e){return e.uid===u}))?u:null!==(d=null===(c=s.find((function(e){return e.isDefault})))||void 0===c?void 0:c.uid)&&void 0!==d?d:null===(m=s[0])||void 0===m?void 0:m.uid),R.Z.debug("Selected ticket settings UID:",l),Ce(l,s),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),console.error("Fetch ticket settings error:",e.t0),y.yw.error(f.formatMessage({id:"ticket.settings.load.error",defaultMessage:"获取工单设置失败"}));case 22:return e.prev=22,ke(!1),e.finish(22);case 25:case"end":return e.stop()}}),e,null,[[5,18,22,25]])}))),[null==h?void 0:h.uid,f,i,null==a?void 0:a.ticketSettingsUid,Ce,we]),qe=(0,w.H)((function(e){return{departmentResult:e.departmentResult,setDepartmentResult:e.setDepartmentResult}})),De=qe.departmentResult,Ie=qe.setDepartmentResult,Te=(0,A.useCallback)(function(){var e=v()(p()().mark((function e(t,n){var r,i,a,o,s,l,u,m;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i={pageNumber:0,pageSize:100,orgUid:null==h?void 0:h.uid,deptUid:t},e.next=4,(0,Q.z_)(i);case 4:a=e.sent,R.Z.debug("queryMembersByOrg response:",null==a?void 0:a.data,i),200===(null==a?void 0:a.code)&&null!=a&&null!==(r=a.data)&&void 0!==r&&r.content&&(o=null==a?void 0:a.data.content,T(o),n?(s=o.find((function(e){return e.userUid===n||e.uid===n})),s?(u=(null==s?void 0:s.userUid)||(null==s?void 0:s.uid),m=(null==s?void 0:s.nickname)||(null==s||null===(l=s.user)||void 0===l?void 0:l.nickname)||"",c.setFieldsValue({assigneeUid:u}),$(d()(d()({},s),{},{uid:u,nickname:m}))):(c.setFieldsValue({assigneeUid:void 0}),$({uid:"",nickname:""}))):(c.setFieldsValue({assigneeUid:void 0}),$({uid:"",nickname:""}))),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch members error:",e.t0),y.yw.error(f.formatMessage({id:"ticket.member.load.error",defaultMessage:"加载成员失败"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}(),[null==h?void 0:h.uid,c,f]),Be=(0,A.useMemo)((function(){var e,t=null==P?void 0:P.uid,n=(null==P?void 0:P.nickname)||(null==P||null===(e=P.user)||void 0===e?void 0:e.nickname)||"",r=D.map((function(e){var n,r=e.userUid||e.uid,i=e.nickname||(null===(n=e.user)||void 0===n?void 0:n.nickname)||e.userUid||e.uid;return{label:t&&r===t?"".concat(i,"（当前）"):i,value:r}}));return t?r.some((function(e){return e.value===t}))?r:[{label:"".concat(n||t,"（当前）"),value:t}].concat(l()(r)):r}),[D,P]),Ne=(0,A.useCallback)((function(e){var t=c.getFieldValue("assigneeUid");e===U.zBg?Te("",t):Te(e,t)}),[Te,c]);(0,A.useEffect)((function(){if(i&&a){var e,t,n,r,o,s={description:a.description,status:a.status,priority:a.priority,threadUid:null==a?void 0:a.threadUid,departmentUid:null==a?void 0:a.departmentUid,categoryUid:null==a?void 0:a.categoryUid,assigneeUid:null===(e=a.assignee)||void 0===e?void 0:e.uid,uploadUids:null===(t=a.attachments)||void 0===t?void 0:t.map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})),processEntityUid:null==a?void 0:a.processEntityUid,ticketSettingsUid:null==a?void 0:a.ticketSettingsUid,formEntityUid:null==a?void 0:a.formEntityUid};if(a.schema)try{var l=JSON.parse(a.schema);if(l.formUid&&l.formData){var u="ticketFormSelection_".concat((null==h?void 0:h.uid)||"default");localStorage.setItem(u,l.formUid),Object.entries(l.formData).forEach((function(e){var t=k()(e,2),n=t[0],r=t[1];s["dynamicField_".concat(n)]=r}))}}catch(e){console.error("解析工单表单数据失败:",e)}if(c.setFieldsValue(s),ue(null!==(n=null===(r=a.attachments)||void 0===r?void 0:r.map((function(e){return e.upload})))&&void 0!==n?n:[]),$(a.assignee||{uid:"",nickname:""}),a.departmentUid)Te(a.departmentUid,null===(o=a.assignee)||void 0===o?void 0:o.uid)}else{var d=localStorage.getItem("ticketDraft");d&&c.setFieldsValue({description:d}),c.setFieldsValue({status:U.sM_,priority:U.GMZ,departmentUid:U.zBg,categoryUid:void 0}),$({uid:"",nickname:""}),Ne(U.zBg),ue([])}}),[n,i,a,null==h?void 0:h.uid,Te,Ne]);var Pe=function e(t,n){var r,i=t.name||"",a="";a=i.startsWith(U.VoP)?f.formatMessage({id:i,defaultMessage:i}):i;var o=null!==(r=null==t?void 0:t.memberCount)&&void 0!==r?r:0;if(a="".concat(a," (").concat(o>=0?o:0,")"),n.title=a,n.key=t.uid,n.value=t.uid,t.children){n.children=[];for(var s=0;s<t.children.length;s++){var l={title:"",key:"",children:[]};e(t.children[s],l),n.children.push(l)}}},Ae=(0,A.useMemo)((function(){for(var e,t,n=[],r=null!==(e=null==De||null===(t=De.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],i=0;i<r.length;i++)if(r[i].uid!==U.zBg&&"i18n.DEPT_ALL"!==r[i].uid){var a={title:"",key:"",children:[]};Pe(r[i],a),n.push(a)}return n}),[De,f]),ze=(0,A.useMemo)((function(){var e,t,n=f.formatMessage({id:"ticket.form.department.all",defaultMessage:"全部部门"}),r=null!==(e=null==De||null===(t=De.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],i=0;return r.forEach((function(e){var t;null!=e&&e.uid&&e.uid!==U.zBg&&"i18n.DEPT_ALL"!==e.uid&&(i+=null!==(t=null==e?void 0:e.memberCount)&&void 0!==t?t:0)})),[{title:"".concat(n," (").concat(i,")"),key:U.zBg,value:U.zBg}].concat(l()(Ae))}),[Ae,f,De]),Le=function(){var e=v()(p()().mark((function e(){var t,n;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={pageNumber:0,pageSize:100,orgUid:null==h?void 0:h.uid},e.next=4,(0,Y.dF)(t);case 4:n=e.sent,R.Z.debug("queryDepartmentsByOrg response:",null==n?void 0:n.data,t),200===(null==n?void 0:n.code)?Ie(n):y.yw.error(null==n?void 0:n.message),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch departments error:",e.t0),y.yw.error(f.formatMessage({id:"ticket.department.load.error"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}();(0,A.useEffect)((function(){n&&(Le(),Ee())}),[n,Ee]);var Oe=function(){var e=v()(p()().mark((function e(){var t,n,r,s,u,m,g,v,k,M,b,w;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.validateFields();case 3:if(u=e.sent,y.yw.loading(f.formatMessage({id:"ticket.submitting"}),0),u.threadUid,m=Boolean(Ue&&(null==Se||null===(t=Se.form)||void 0===t?void 0:t.uid)),g=m?new Set(je.map((function(e,t){return"dynamicField_".concat(Fe(e,t))}))):new Set,v={},Object.keys(u).forEach((function(e){if(e.startsWith("dynamicField_")){if(m&&g.has(e)){var t=e.replace("dynamicField_","");v[t]=u[e]}delete u[e]}})),k=null,m&&null!=Se&&null!==(n=Se.form)&&void 0!==n&&n.uid&&(k={formUid:Se.form.uid,formName:Se.form.name,formSchema:Se.form.schema,formData:v}),(M=d()(d()({},u),{},{departmentUid:u.departmentUid===U.zBg?"":u.departmentUid,orgUid:null==h?void 0:h.uid,assignee:{uid:null==P?void 0:P.uid,nickname:null==P?void 0:P.nickname,type:U.Tls},uploadUids:(null==le?void 0:le.length)>0?l()(new Set(le.map((function(e){return e.uid})))):[],schema:k?JSON.stringify(k):void 0})).ticketSettingsUid=i&&null!=a&&a.ticketSettingsUid?a.ticketSettingsUid:u.ticketSettingsUid||Me,m&&!M.formEntityUid&&null!=Se&&null!==(r=Se.form)&&void 0!==r&&r.uid&&(M.formEntityUid=Se.form.uid),!M.processEntityUid&&null!=Se&&null!==(s=Se.process)&&void 0!==s&&s.uid&&(M.processEntityUid=Se.process.uid),!i||!a){e.next=25;break}return M.uid=a.uid,e.next=20,(0,x.O)(M);case 20:b=e.sent,R.Z.debug("updateTicket response",null==b?void 0:b.data,M),200===(null==b?void 0:b.code)?(y.yw.destroy(),y.yw.success(f.formatMessage({id:"ticket.update.success"})),o()):(y.yw.destroy(),y.yw.error(f.formatMessage({id:"ticket.update.failed"}))),e.next=30;break;case 25:return e.next=27,(0,x.ax)(M);case 27:w=e.sent,R.Z.debug("createTicket response",null==w?void 0:w.data,M),200===(null==w?void 0:w.code)?(y.yw.destroy(),y.yw.success(f.formatMessage({id:"ticket.create.success"})),o()):(y.yw.destroy(),y.yw.error(f.formatMessage({id:"ticket.create.failed"})));case 30:e.next=37;break;case 32:e.prev=32,e.t0=e.catch(0),y.yw.destroy(),console.error("Submit ticket error:",e.t0),y.yw.error(f.formatMessage({id:"ticket.submit.error"}));case 37:return e.prev=37,localStorage.removeItem("ticketDraft"),e.finish(37);case 40:case"end":return e.stop()}}),e,null,[[0,32,37,40]])})));return function(){return e.apply(this,arguments)}}(),Re=function(e){R.Z.debug("handleDelete",e),ue((function(t){return t.filter((function(t){return t.uid!==e}))}))};return(0,te.jsx)(z.Z,{title:f.formatMessage({id:i?"ticket.edit.title":"ticket.create.title",defaultMessage:i?"编辑工单":"创建工单"}),width:600,open:n,onClose:s,extra:(0,te.jsxs)(L.Z,{children:[(0,te.jsx)(I.ZP,{onClick:s,children:f.formatMessage({id:"common.cancel"})}),(0,te.jsx)(I.ZP,{type:"primary",onClick:Oe,children:f.formatMessage({id:"common.confirm"})})]}),children:(0,te.jsxs)(V.A,{form:c,submitter:!1,children:[(0,te.jsx)(_.Z,{name:"ticketSettingsUid",hidden:!0,rules:i||0===fe.length?[]:[{required:!0,message:f.formatMessage({id:"ticket.form.ticketSettings.required",defaultMessage:"请选择工单设置"})}]}),Ue&&je.length>0?(0,te.jsx)(ne,{fields:je,fieldNamePrefix:"dynamicField_",translate:g}):null,(0,te.jsx)(_.Z,{name:"processEntityUid",hidden:!0}),(0,te.jsx)(_.Z,{name:"formEntityUid",hidden:!0}),F.length>0?(0,te.jsx)(W.Z,{name:"categoryUid",label:f.formatMessage({id:"ticket.form.category"}),rules:[{required:!0,message:f.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],options:F.map((function(e){return{label:g(e.name||"")||e.name||e.uid,value:e.uid}})),placeholder:f.formatMessage({id:"ticket.form.category.placeholder"})}):null,(0,te.jsx)(J.Z,{name:"description",label:f.formatMessage({id:"ticket.form.description"}),rules:[{required:!0}],fieldProps:{onBlur:function(){R.Z.debug("handleDescriptionBlur",c.getFieldsValue());var e=c.getFieldValue("description");localStorage.setItem("ticketDraft",e)}}}),(0,te.jsx)(W.Z,{name:"priority",label:f.formatMessage({id:"ticket.form.priority"}),options:[{label:f.formatMessage({id:"ticket.priority.lowest"}),value:U.JTO},{label:f.formatMessage({id:"ticket.priority.low"}),value:U.sbT},{label:f.formatMessage({id:"ticket.priority.medium"}),value:U.GMZ},{label:f.formatMessage({id:"ticket.priority.high"}),value:U.Bt2},{label:f.formatMessage({id:"ticket.priority.urgent"}),value:U._Xr},{label:f.formatMessage({id:"ticket.priority.critical"}),value:U.Lx6}],rules:[{required:!0}]}),(0,te.jsx)(V.A.Item,{name:"departmentUid",label:f.formatMessage({id:"ticket.form.department",defaultMessage:"所属部门"}),children:(0,te.jsx)(O.Z,{style:{width:"100%"},treeData:ze,showSearch:!0,treeDefaultExpandAll:!1,popupMatchSelectWidth:!1,placeholder:f.formatMessage({id:"ticket.form.department.placeholder",defaultMessage:"请选择内部部门"}),onChange:function(e){return Ne(e||U.zBg)},allowClear:!1})}),(0,te.jsx)(W.Z,{name:"assigneeUid",label:f.formatMessage({id:"ticket.form.assignee"}),options:Be,placeholder:f.formatMessage({id:"ticket.form.assignee.placeholder"}),fieldProps:{onChange:function(e){var t,n=D.find((function(t){return(t.userUid||t.uid)===e})),r=(null==n?void 0:n.nickname)||(null==n||null===(t=n.user)||void 0===t?void 0:t.nickname)||"";$(e?{uid:e,nickname:r}:{uid:"",nickname:""})}},disabled:0===D.length}),ie&&(0,te.jsx)(X.Z,{type:U.hcJ,isModalOpen:ie,attachments:null==a?void 0:a.attachments,handleSubmit:function(e){var t;R.Z.debug("handleSubmit",e);var n=e||[];if(i&&null!=a&&null!==(t=a.attachments)&&void 0!==t&&t.length){var r=new Set((a.attachments||[]).map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})).filter((function(e){return Boolean(e)}))),o=n.filter((function(e){return!r.has(e.uid)}));ue(o)}else ue(n);ae(!1)},handleCancel:function(){ae(!1)}}),(0,te.jsx)("div",{style:{marginTop:"16px",marginBottom:"16px",maxHeight:"200px",overflowY:"auto"},children:(0,te.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"12px"},children:le.map((function(e){return(0,te.jsx)(H.Z,{file:e,onDelete:Re},e.uid)}))})}),(0,te.jsx)(I.ZP,{icon:(0,te.jsx)(G.Z,{}),onClick:function(){return ae(!0)},children:f.formatMessage({id:"ticket.form.upload.button"})})]})})},ie=n(42701),ae=function(e){var t=e.open,n=e.isEdit,r=void 0!==n&&n,i=e.currentTicket,a=e.onSuccess,o=e.onCancel,s=V.A.useForm(),u=k()(s,1)[0],c=(0,E.useIntl)(),f=(0,S.Z)(),m=f.translateString,g=f.translateStringTranct,h=(0,M.u)((function(e){return e.currentOrg})),b=((0,A.useMemo)((function(){var e=c.formatMessage({id:"ticket.form.thread.none",defaultMessage:"不关联会话"});return[{label:e,value:"",dataSearch:e.toLowerCase()}]}),[c,m]),(0,A.useCallback)((function(e){return null!=e&&e.content&&g()||c.formatMessage({id:"ticket.form.thread.preview.empty",defaultMessage:"暂无最近消息"})}),[c,g]),(0,A.useCallback)((function(e){var t,n=(null==e||null===(t=e.user)||void 0===t?void 0:t.avatar)||"";if(n.startsWith("http")||n.startsWith("data:"))return n}),[]),(0,A.useCallback)((function(e){if(!e||0===e.length)return null;var t=e.filter((function(e){return!!e}));return t.length?(0,te.jsx)("span",{className:"ticket-thread-option__tags",children:t.map((function(e){return(0,te.jsx)(T.Z,{color:"blue",className:"ticket-thread-option__tag",children:e.length>12?"".concat(e.slice(0,12),"..."):e},e)}))}):null}),[]),(0,A.useState)([])),j=k()(b,2),F=j[0],Z=j[1],C=(0,A.useState)([]),q=k()(C,2),D=q[0],B=q[1],N=(0,A.useState)({uid:"",nickname:""}),P=k()(N,2),$=P[0],ee=P[1],re=(0,A.useState)(!1),ae=k()(re,2),oe=ae[0],se=ae[1],le=(0,A.useState)([]),ue=k()(le,2),de=ue[0],ce=ue[1],fe=(0,A.useState)([]),me=k()(fe,2),pe=me[0],ge=me[1],ve=(0,A.useRef)([]),he=(0,A.useRef)(),ke=(0,A.useState)(!1),ye=k()(ke,2),xe=(ye[0],ye[1]),Me=(0,A.useState)(),be=k()(Me,2),we=be[0],Se=be[1],Ue=(0,A.useMemo)((function(){return"ticketSettingsSelection_".concat((null==h?void 0:h.uid)||"default")}),[null==h?void 0:h.uid]),je=(0,A.useMemo)((function(){return we?pe.find((function(e){return e.uid===we})):void 0}),[pe,we]),Fe=Boolean(null==je?void 0:je.customFormEnabled),Ze=(0,A.useMemo)((function(){var e;return null!==(e=null==je?void 0:je.form)&&void 0!==e?e:null==je?void 0:je.draftForm}),[je]),Ce=(0,A.useMemo)((function(){var e,t,n,r,i,a,o,s,l,u=null!==(e=null==je?void 0:je.basicSettings)&&void 0!==e?e:null==je?void 0:je.draftBasicSettings;return{showContactName:null===(t=null==u?void 0:u.showContactName)||void 0===t||t,requireContactName:null===(n=null==u?void 0:u.requireContactName)||void 0===n||n,showEmail:null===(r=null==u?void 0:u.showEmail)||void 0===r||r,requireEmail:null!==(i=null==u?void 0:u.requireEmail)&&void 0!==i&&i,showPhone:null===(a=null==u?void 0:u.showPhone)||void 0===a||a,requirePhone:null===(o=null==u?void 0:u.requirePhone)||void 0===o||o,showWechat:null!==(s=null==u?void 0:u.showWechat)&&void 0!==s&&s,requireWechat:null!==(l=null==u?void 0:u.requireWechat)&&void 0!==l&&l}}),[je]),Ee=(0,A.useMemo)((function(){if(!Fe||null==Ze||!Ze.schema)return[];try{var e=JSON.parse(Ze.schema);if(Array.isArray(e))return e;if(Array.isArray(null==e?void 0:e.schema))return e.schema;if(Array.isArray(null==e?void 0:e.fields))return e.fields;if(Array.isArray(null==e?void 0:e.content))return e.content}catch(e){console.error("ticket form schema parse error",e)}return[]}),[Fe,null==Ze?void 0:Ze.schema]),qe=(0,A.useCallback)((function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}),[]);(0,A.useEffect)((function(){ve.current=pe}),[pe]),(0,A.useEffect)((function(){var e,t,n,i,a,o=he.current,s=null==je?void 0:je.uid;he.current=s;var l=null!==(e=null==je?void 0:je.categorySettings)&&void 0!==e?e:null==je?void 0:je.draftCategorySettings;if(null==l||null===(t=l.items)||void 0===t||!t.length)return Z([]),void(r||u.setFieldsValue({categoryUid:void 0}));var d=l.items.filter((function(e){return Boolean(null==e?void 0:e.uid)&&!1!==(null==e?void 0:e.enabled)})).sort((function(e,t){var n,r;return(null!==(n=e.orderIndex)&&void 0!==n?n:0)-(null!==(r=t.orderIndex)&&void 0!==r?r:0)}));if(!d.length)return Z([]),void(r||u.setFieldsValue({categoryUid:void 0}));if(Z(d),!r){var c=u.getFieldValue("categoryUid");if(s!==o||!c||!d.some((function(e){return e.uid===c}))){var f=(null===(n=d.find((function(e){return e.uid===l.defaultCategoryUid})))||void 0===n?void 0:n.uid)||(null===(i=d.find((function(e){return e.defaultCategory})))||void 0===i?void 0:i.uid)||(null===(a=d[0])||void 0===a?void 0:a.uid);u.setFieldsValue({categoryUid:f||void 0})}}}),[je,r,u,t]);var De=(0,A.useCallback)((function(e){var t,n;null!=e&&null!==(t=e.process)&&void 0!==t&&t.uid?u.setFieldsValue({processEntityUid:e.process.uid}):u.setFieldsValue({processEntityUid:void 0});var r=null!==(n=null==e?void 0:e.form)&&void 0!==n?n:null==e?void 0:e.draftForm;null!=e&&e.customFormEnabled&&null!=r&&r.uid?u.setFieldsValue({formEntityUid:r.uid}):u.setFieldsValue({formEntityUid:void 0})}),[u]),Ie=(0,A.useCallback)((function(e,t){var n=e||void 0,r=null!=t?t:ve.current;Se(n),u.setFieldsValue({ticketSettingsUid:n}),n?localStorage.setItem(Ue,n):localStorage.removeItem(Ue);var i=r.find((function(e){return e.uid===n}));De(i)}),[u,Ue,De]),Te=(0,A.useCallback)(v()(p()().mark((function e(){var t,n,a,o,s,l,u,d,f,m;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=h&&h.uid){e.next=4;break}return ge([]),Ie(void 0,[]),e.abrupt("return");case 4:return xe(!0),e.prev=5,a={orgUid:h.uid,pageNumber:0,pageSize:200},e.next=9,(0,K.Bg)(a);case 9:o=e.sent,R.Z.debug("queryTicketSettingsByOrg response:",null==o?void 0:o.data,a),s=null!==(t=null==o||null===(n=o.data)||void 0===n?void 0:n.content)&&void 0!==t?t:[],ge(s),r&&null!=i&&i.ticketSettingsUid&&s.some((function(e){return e.uid===i.ticketSettingsUid}))?l=i.ticketSettingsUid:(u=localStorage.getItem(Ue),l=u&&s.some((function(e){return e.uid===u}))?u:null!==(d=null===(f=s.find((function(e){return e.isDefault})))||void 0===f?void 0:f.uid)&&void 0!==d?d:null===(m=s[0])||void 0===m?void 0:m.uid),R.Z.debug("Selected ticket settings UID:",l),Ie(l,s),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),console.error("Fetch ticket settings error:",e.t0),y.yw.error(c.formatMessage({id:"ticket.settings.load.error",defaultMessage:"获取工单设置失败"}));case 22:return e.prev=22,xe(!1),e.finish(22);case 25:case"end":return e.stop()}}),e,null,[[5,18,22,25]])}))),[null==h?void 0:h.uid,c,r,null==i?void 0:i.ticketSettingsUid,Ie,Ue]),Be=(0,w.H)((function(e){return{departmentResult:e.departmentResult,setDepartmentResult:e.setDepartmentResult}})),Ne=Be.departmentResult,Pe=Be.setDepartmentResult,Ae=(0,A.useCallback)(function(){var e=v()(p()().mark((function e(t,n){var r,i,a,o,s,l,f,m;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i={pageNumber:0,pageSize:100,orgUid:null==h?void 0:h.uid,deptUid:t},e.next=4,(0,Q.z_)(i);case 4:a=e.sent,R.Z.debug("queryMembersByOrg response:",null==a?void 0:a.data,i),200===(null==a?void 0:a.code)&&null!=a&&null!==(r=a.data)&&void 0!==r&&r.content&&(o=null==a?void 0:a.data.content,B(o),n?(s=o.find((function(e){return e.userUid===n||e.uid===n})),s?(f=(null==s?void 0:s.userUid)||(null==s?void 0:s.uid),m=(null==s?void 0:s.nickname)||(null==s||null===(l=s.user)||void 0===l?void 0:l.nickname)||"",u.setFieldsValue({assigneeUid:f}),ee(d()(d()({},s),{},{uid:f,nickname:m}))):(u.setFieldsValue({assigneeUid:void 0}),ee({uid:"",nickname:""}))):(u.setFieldsValue({assigneeUid:void 0}),ee({uid:"",nickname:""}))),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch members error:",e.t0),y.yw.error(c.formatMessage({id:"ticket.member.load.error",defaultMessage:"加载成员失败"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}(),[null==h?void 0:h.uid,u,c]),ze=(0,A.useMemo)((function(){var e,t=null==$?void 0:$.uid,n=(null==$?void 0:$.nickname)||(null==$||null===(e=$.user)||void 0===e?void 0:e.nickname)||"",r=D.map((function(e){var n,r=e.userUid||e.uid,i=e.nickname||(null===(n=e.user)||void 0===n?void 0:n.nickname)||e.userUid||e.uid;return{label:t&&r===t?"".concat(i,"（当前）"):i,value:r}}));return t?r.some((function(e){return e.value===t}))?r:[{label:"".concat(n||t,"（当前）"),value:t}].concat(l()(r)):r}),[D,$]),Le=(0,A.useCallback)((function(e){var t=u.getFieldValue("assigneeUid");e===U.zBg?Ae("",t):Ae(e,t)}),[Ae,u]);(0,A.useEffect)((function(){if(r&&i){var e,t,n,a,o,s={description:i.description,status:i.status,priority:i.priority,threadUid:null==i?void 0:i.threadUid,departmentUid:null==i?void 0:i.departmentUid,categoryUid:null==i?void 0:i.categoryUid,assigneeUid:null===(e=i.assignee)||void 0===e?void 0:e.uid,contactName:null==i?void 0:i.contactName,email:null==i?void 0:i.email,phone:null==i?void 0:i.phone,wechat:null==i?void 0:i.wechat,uploadUids:null===(t=i.attachments)||void 0===t?void 0:t.map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})),processEntityUid:null==i?void 0:i.processEntityUid,ticketSettingsUid:null==i?void 0:i.ticketSettingsUid,formEntityUid:null==i?void 0:i.formEntityUid};if(i.schema)try{var l=JSON.parse(i.schema);if(l.formUid&&l.formData){var d="ticketFormSelection_".concat((null==h?void 0:h.uid)||"default");localStorage.setItem(d,l.formUid),Object.entries(l.formData).forEach((function(e){var t=k()(e,2),n=t[0],r=t[1];s["dynamicField_".concat(n)]=r}))}}catch(e){console.error("解析工单表单数据失败:",e)}if(u.setFieldsValue(s),ce(null!==(n=null===(a=i.attachments)||void 0===a?void 0:a.map((function(e){return e.upload})))&&void 0!==n?n:[]),ee(i.assignee||{uid:"",nickname:""}),i.departmentUid)Ae(i.departmentUid,null===(o=i.assignee)||void 0===o?void 0:o.uid)}else{var c=localStorage.getItem("ticketDraft");c&&u.setFieldsValue({description:c}),u.setFieldsValue({status:U.sM_,priority:U.GMZ,departmentUid:U.zBg,categoryUid:void 0}),ee({uid:"",nickname:""}),Le(U.zBg),ce([])}}),[t,r,i,null==h?void 0:h.uid,Ae,Le]);var Oe=function e(t,n){var r,i=t.name||"",a="";a=i.startsWith(U.VoP)?c.formatMessage({id:i,defaultMessage:i}):i;var o=null!==(r=null==t?void 0:t.memberCount)&&void 0!==r?r:0;if(a="".concat(a," (").concat(o>=0?o:0,")"),n.title=a,n.key=t.uid,n.value=t.uid,t.children){n.children=[];for(var s=0;s<t.children.length;s++){var l={title:"",key:"",children:[]};e(t.children[s],l),n.children.push(l)}}},Re=(0,A.useMemo)((function(){for(var e,t,n=[],r=null!==(e=null==Ne||null===(t=Ne.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],i=0;i<r.length;i++)if(r[i].uid!==U.zBg&&"i18n.DEPT_ALL"!==r[i].uid){var a={title:"",key:"",children:[]};Oe(r[i],a),n.push(a)}return n}),[Ne,c]),Ve=(0,A.useMemo)((function(){var e,t,n=c.formatMessage({id:"ticket.form.department.all",defaultMessage:"全部部门"}),r=null!==(e=null==Ne||null===(t=Ne.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],i=0;return r.forEach((function(e){var t;null!=e&&e.uid&&e.uid!==U.zBg&&"i18n.DEPT_ALL"!==e.uid&&(i+=null!==(t=null==e?void 0:e.memberCount)&&void 0!==t?t:0)})),[{title:"".concat(n," (").concat(i,")"),key:U.zBg,value:U.zBg}].concat(l()(Re))}),[Re,c,Ne]),_e=function(){var e=v()(p()().mark((function e(){var t,n;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={pageNumber:0,pageSize:100,orgUid:null==h?void 0:h.uid},e.next=4,(0,Y.dF)(t);case 4:n=e.sent,R.Z.debug("queryDepartmentsByOrg response:",null==n?void 0:n.data,t),200===(null==n?void 0:n.code)?Pe(n):y.yw.error(null==n?void 0:n.message),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch departments error:",e.t0),y.yw.error(c.formatMessage({id:"ticket.department.load.error"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}();(0,A.useEffect)((function(){t&&(_e(),Te())}),[t,Te]);var We=function(){var e=v()(p()().mark((function e(){var t,n,o,s,f,m,g,v,k,M,b,w,S;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.validateFields();case 3:if(m=e.sent,y.yw.loading(c.formatMessage({id:"ticket.submitting"}),0),m.threadUid,g=Boolean(Fe&&(null==Ze?void 0:Ze.uid)),v=g?new Set(Ee.map((function(e,t){return"dynamicField_".concat(qe(e,t))}))):new Set,k={},Object.keys(m).forEach((function(e){if(e.startsWith("dynamicField_")){if(g&&v.has(e)){var t=e.replace("dynamicField_","");k[t]=m[e]}delete m[e]}})),M=null,g&&null!=Ze&&Ze.uid&&(M={formUid:Ze.uid,formName:Ze.name,formSchema:Ze.schema,formData:k}),(b=d()(d()({},m),{},{departmentUid:m.departmentUid===U.zBg?"":m.departmentUid,orgUid:null==h?void 0:h.uid,contactName:(null===(t=m.contactName)||void 0===t?void 0:t.trim())||"",email:(null===(n=m.email)||void 0===n?void 0:n.trim())||"",phone:(null===(o=m.phone)||void 0===o?void 0:o.trim())||"",wechat:(null===(s=m.wechat)||void 0===s?void 0:s.trim())||"",assignee:{uid:null==$?void 0:$.uid,nickname:null==$?void 0:$.nickname,type:U.Tls},uploadUids:(null==de?void 0:de.length)>0?l()(new Set(de.map((function(e){return e.uid})))):[],schema:M?JSON.stringify(M):void 0})).ticketSettingsUid=r&&null!=i&&i.ticketSettingsUid?i.ticketSettingsUid:m.ticketSettingsUid||we,g&&!b.formEntityUid&&null!=Ze&&Ze.uid&&(b.formEntityUid=Ze.uid),!b.processEntityUid&&null!=je&&null!==(f=je.process)&&void 0!==f&&f.uid&&(b.processEntityUid=je.process.uid),!r||!i){e.next=25;break}return b.uid=i.uid,e.next=20,(0,x.O)(b);case 20:w=e.sent,R.Z.debug("updateTicket response",null==w?void 0:w.data,b),200===(null==w?void 0:w.code)?(y.yw.destroy(),y.yw.success(c.formatMessage({id:"ticket.update.success"})),a()):(y.yw.destroy(),y.yw.error(c.formatMessage({id:"ticket.update.failed"}))),e.next=30;break;case 25:return e.next=27,(0,x.ax)(b);case 27:S=e.sent,R.Z.debug("createTicket response",null==S?void 0:S.data,b),200===(null==S?void 0:S.code)?(y.yw.destroy(),y.yw.success(c.formatMessage({id:"ticket.create.success"})),a()):(y.yw.destroy(),y.yw.error(c.formatMessage({id:"ticket.create.failed"})));case 30:e.next=37;break;case 32:e.prev=32,e.t0=e.catch(0),y.yw.destroy(),console.error("Submit ticket error:",e.t0),y.yw.error(c.formatMessage({id:"ticket.submit.error"}));case 37:return e.prev=37,localStorage.removeItem("ticketDraft"),e.finish(37);case 40:case"end":return e.stop()}}),e,null,[[0,32,37,40]])})));return function(){return e.apply(this,arguments)}}(),Je=function(e){R.Z.debug("handleDelete",e),ce((function(t){return t.filter((function(t){return t.uid!==e}))}))};return(0,te.jsx)(z.Z,{title:c.formatMessage({id:r?"ticket.edit.title":"ticket.create.title",defaultMessage:r?"编辑工单":"创建工单"}),width:600,open:t,onClose:o,extra:(0,te.jsxs)(L.Z,{children:[(0,te.jsx)(I.ZP,{onClick:o,children:c.formatMessage({id:"common.cancel"})}),(0,te.jsx)(I.ZP,{type:"primary",onClick:We,children:c.formatMessage({id:"common.confirm"})})]}),children:(0,te.jsxs)(V.A,{form:u,submitter:!1,children:[(0,te.jsx)(_.Z,{name:"ticketSettingsUid",hidden:!0,rules:r||0===pe.length?[]:[{required:!0,message:c.formatMessage({id:"ticket.form.ticketSettings.required",defaultMessage:"请选择工单设置"})}]}),Fe&&Ee.length>0?(0,te.jsx)(ne,{fields:Ee,fieldNamePrefix:"dynamicField_",translate:m}):null,(0,te.jsx)(_.Z,{name:"processEntityUid",hidden:!0}),(0,te.jsx)(_.Z,{name:"formEntityUid",hidden:!0}),F.length>0?(0,te.jsx)(W.Z,{name:"categoryUid",label:c.formatMessage({id:"ticket.form.category"}),rules:[{required:!0,message:c.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],options:F.map((function(e){return{label:m(e.name||"")||e.name||e.uid,value:e.uid}})),placeholder:c.formatMessage({id:"ticket.form.category.placeholder"})}):null,F.length>0&&(0,te.jsx)(W.Z,{name:"categoryUid",label:c.formatMessage({id:"ticket.form.category",defaultMessage:"工单分类"}),options:F.map((function(e){return{label:m(e.name||""),value:e.uid}})),rules:[{required:!0,message:c.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],placeholder:c.formatMessage({id:"ticket.form.category.placeholder",defaultMessage:"请选择工单分类"})}),(0,te.jsx)(J.Z,{name:"description",label:c.formatMessage({id:"ticket.form.description"}),rules:[{required:!0}],fieldProps:{onBlur:function(){R.Z.debug("handleDescriptionBlur",u.getFieldsValue());var e=u.getFieldValue("description");localStorage.setItem("ticketDraft",e)},rows:6}}),Ce.showContactName&&(0,te.jsx)(_.Z,{name:"contactName",label:c.formatMessage({id:"ticket.form.contactName",defaultMessage:"联系人姓名"}),rules:[{required:Ce.requireContactName,message:c.formatMessage({id:"ticket.form.contactName.required",defaultMessage:"请输入联系人姓名"})},{max:50,message:c.formatMessage({id:"ticket.form.contactName.maxlength",defaultMessage:"姓名不能超过50个字符"})}],placeholder:c.formatMessage({id:"ticket.form.contactName.placeholder",defaultMessage:"请输入联系人姓名"})}),Ce.showEmail&&(0,te.jsx)(_.Z,{name:"email",label:c.formatMessage({id:"ticket.form.email",defaultMessage:"邮箱"}),rules:[{required:Ce.requireEmail,message:c.formatMessage({id:"ticket.form.email.required",defaultMessage:"请输入邮箱地址"})},{type:"email",message:c.formatMessage({id:"ticket.form.email.invalid",defaultMessage:"请输入有效的邮箱地址"})}],placeholder:c.formatMessage({id:"ticket.form.email.placeholder",defaultMessage:"请输入邮箱地址"})}),Ce.showPhone&&(0,te.jsx)(_.Z,{name:"phone",label:c.formatMessage({id:"ticket.form.phone",defaultMessage:"电话"}),rules:[{required:Ce.requirePhone,message:c.formatMessage({id:"ticket.form.phone.required",defaultMessage:"请输入电话号码"})},{pattern:/^1[3-9]\d{9}$/,message:c.formatMessage({id:"ticket.form.phone.invalid",defaultMessage:"请输入有效的手机号码"})}],placeholder:c.formatMessage({id:"ticket.form.phone.placeholder",defaultMessage:"请输入电话号码"})}),Ce.showWechat&&(0,te.jsx)(_.Z,{name:"wechat",label:c.formatMessage({id:"ticket.form.wechat",defaultMessage:"微信"}),rules:[{required:Ce.requireWechat,message:c.formatMessage({id:"ticket.form.wechat.required",defaultMessage:"请输入微信号"})},{max:50,message:c.formatMessage({id:"ticket.form.wechat.maxlength",defaultMessage:"微信号不能超过50个字符"})}],placeholder:c.formatMessage({id:"ticket.form.wechat.placeholder",defaultMessage:"请输入微信号"})}),(0,te.jsx)(W.Z,{name:"priority",label:c.formatMessage({id:"ticket.form.priority"}),options:[{label:c.formatMessage({id:"ticket.priority.lowest"}),value:U.JTO},{label:c.formatMessage({id:"ticket.priority.low"}),value:U.sbT},{label:c.formatMessage({id:"ticket.priority.medium"}),value:U.GMZ},{label:c.formatMessage({id:"ticket.priority.high"}),value:U.Bt2},{label:c.formatMessage({id:"ticket.priority.urgent"}),value:U._Xr},{label:c.formatMessage({id:"ticket.priority.critical"}),value:U.Lx6}],rules:[{required:!0}]}),(0,te.jsx)(V.A.Item,{name:"departmentUid",label:c.formatMessage({id:"ticket.form.department",defaultMessage:"所属部门"}),children:(0,te.jsx)(O.Z,{style:{width:"100%"},treeData:Ve,showSearch:!0,treeDefaultExpandAll:!1,popupMatchSelectWidth:!1,placeholder:c.formatMessage({id:"ticket.form.department.placeholder",defaultMessage:"请选择内部部门"}),onChange:function(e){return Le(e||U.zBg)},allowClear:!1})}),(0,te.jsx)(W.Z,{name:"assigneeUid",label:c.formatMessage({id:"ticket.form.assignee"}),options:ze,placeholder:c.formatMessage({id:"ticket.form.assignee.placeholder"}),fieldProps:{onChange:function(e){var t,n=D.find((function(t){return(t.userUid||t.uid)===e})),r=(null==n?void 0:n.nickname)||(null==n||null===(t=n.user)||void 0===t?void 0:t.nickname)||"";ee(e?{uid:e,nickname:r}:{uid:"",nickname:""})}},disabled:0===D.length}),oe&&(0,te.jsx)(X.Z,{type:U.hcJ,isModalOpen:oe,attachments:null==i?void 0:i.attachments,handleSubmit:function(e){var t;R.Z.debug("handleSubmit",e);var n=e||[];if(r&&null!=i&&null!==(t=i.attachments)&&void 0!==t&&t.length){var a=new Set((i.attachments||[]).map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})).filter((function(e){return Boolean(e)}))),o=n.filter((function(e){return!a.has(e.uid)}));ce(o)}else ce(n);se(!1)},handleCancel:function(){se(!1)}}),(0,te.jsx)("div",{style:{marginTop:"16px",marginBottom:"16px",maxHeight:"200px",overflowY:"auto"},children:(0,te.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"12px"},children:de.map((function(e){return(0,te.jsx)(H.Z,{file:e,onDelete:Je},e.uid)}))})}),Fe&&Ee.length>0&&(0,te.jsxs)("div",{style:{marginTop:16,marginBottom:16},children:[(0,te.jsx)("div",{style:{fontSize:14,fontWeight:500,marginBottom:12},children:c.formatMessage({id:"ticket.form.customFields",defaultMessage:"自定义字段"})}),Ee.map((function(e,t){var n,r=qe(e,t),i="dynamicField_".concat(r),a=m((null==e?void 0:e.label)||(null==e?void 0:e.title)||(null==e?void 0:e.name)||r),o=(null==e?void 0:e.type)||(null==e?void 0:e.componentType)||"text",s=null!==(n=null==e?void 0:e.required)&&void 0!==n&&n,l=m((null==e?void 0:e.placeholder)||"请输入".concat(a));if("textarea"===o)return(0,te.jsx)(J.Z,{name:i,label:a,rules:[{required:s,message:"请输入".concat(a)}],placeholder:l,fieldProps:{rows:4}},i);if("select"===o||"dropdown"===o){var u=(null==e?void 0:e.options)||(null==e?void 0:e.choices)||[];return(0,te.jsx)(W.Z,{name:i,label:a,rules:[{required:s,message:"请选择".concat(a)}],placeholder:l,options:u.map((function(e){return{label:m((null==e?void 0:e.label)||(null==e?void 0:e.text)||e),value:(null==e?void 0:e.value)||e}}))},i)}return"number"===o?(0,te.jsx)(ie.Z,{name:i,label:a,rules:[{required:s,message:"请输入".concat(a)}],placeholder:l},i):(0,te.jsx)(_.Z,{name:i,label:a,rules:[{required:s,message:"请输入".concat(a)}],placeholder:l},i)}))]}),(0,te.jsx)(I.ZP,{icon:(0,te.jsx)(G.Z,{}),onClick:function(){return se(!0)},children:c.formatMessage({id:"ticket.form.upload.button"})})]})})},oe=n(61476),se=n(6008),le=["current","pageSize"],ue=function(e){var t,n=e.ticketType,r=e.superUser,a=void 0!==r&&r,s=(0,E.useIntl)(),u=(0,A.useRef)(),c=(0,A.useState)(1),m=k()(c,2),g=m[0],h=m[1],N=(0,A.useState)(10),z=k()(N,2),L=z[0],O=z[1],V=(0,M.u)((function(e){return e.currentOrg})),_=(0,S.Z)().translateString,W=(0,b.v)((function(e){return e.currentCategory})),J=(0,b.v)((function(e){return e.categoryResult})),X=(0,w.H)((function(e){return e.departmentResult})),G=(0,A.useState)(!1),H=k()(G,2),Y=H[0],Q=H[1],K=(0,A.useState)(!1),$=k()(K,2),ee=$[0],ne=$[1],ie=(0,A.useState)(),ue=k()(ie,2),de=ue[0],ce=ue[1],fe=(0,A.useState)(!1),me=k()(fe,2),pe=me[0],ge=me[1],ve=q.Z.useModal(),he=k()(ve,2),ke=he[0],ye=he[1],xe=(0,A.useState)(!1),Me=k()(xe,2),be=Me[0],we=Me[1],Se=(0,A.useState)([]),Ue=k()(Se,2),je=Ue[0],Fe=Ue[1],Ze=(0,A.useState)([]),Ce=k()(Ze,2),Ee=Ce[0],qe=Ce[1],De=(0,A.useState)({}),Ie=k()(De,2),Te=Ie[0],Be=Ie[1],Ne=(0,A.useState)(0),Pe=k()(Ne,2),Ae=Pe[0],ze=Pe[1],Le=(0,A.useMemo)((function(){var e,t=new Map;return function e(n){null!=n&&n.length&&n.forEach((function(n){var r;null!=n&&n.uid&&(t.set(n.uid,n),null!==(r=n.children)&&void 0!==r&&r.length&&e(n.children))}))}(null==J||null===(e=J.data)||void 0===e?void 0:e.content),t}),[J]),Oe=(0,A.useMemo)((function(){var e,t=new Map;return function e(n){null!=n&&n.length&&n.forEach((function(n){var r;null!=n&&n.uid&&(t.set(n.uid,n),null!==(r=n.children)&&void 0!==r&&r.length&&e(n.children))}))}(null==X||null===(e=X.data)||void 0===e?void 0:e.content),t}),[X]);(0,A.useEffect)((function(){var e;null===(e=u.current)||void 0===e||e.reload()}),[null==W?void 0:W.uid,n]);var Re=function(){var e=v()(p()().mark((function e(t){var n,r;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,x.M4)(t.uid);case 2:200===(n=e.sent).code?(y.yw.success(s.formatMessage({id:"delete.success",defaultMessage:"删除成功"})),null===(r=u.current)||void 0===r||r.reload()):y.yw.error(n.message);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Ve=function(){var e=v()(p()().mark((function e(){var t,n,r,i,a,o;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==Ee.length){e.next=3;break}return y.yw.warning(s.formatMessage({id:"batch.delete.noselection",defaultMessage:"请选择要删除的项目"})),e.abrupt("return");case 3:y.yw.loading(s.formatMessage({id:"deleting",defaultMessage:"正在删除..."})),n=0,r=0,i=f()(Ee),e.prev=7,i.s();case 9:if((a=i.n()).done){e.next=23;break}return o=a.value,e.prev=11,e.next=14,(0,x.M4)(o.uid);case 14:200===e.sent.code?n++:r++,e.next=21;break;case 18:e.prev=18,e.t0=e.catch(11),r++;case 21:e.next=9;break;case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(7),i.e(e.t1);case 28:return e.prev=28,i.f(),e.finish(28);case 31:y.yw.destroy(),0===r?y.yw.success(s.formatMessage({id:"batch.delete.success",defaultMessage:"成功删除 {count} 条记录"},{count:n})):y.yw.warning(s.formatMessage({id:"batch.delete.partial",defaultMessage:"成功删除 {success} 条记录，失败 {fail} 条"},{success:n,fail:r})),Fe([]),qe([]),null===(t=u.current)||void 0===t||t.reloadAndRest();case 36:case"end":return e.stop()}}),e,null,[[7,25,28,31],[11,18]])})));return function(){return e.apply(this,arguments)}}(),_e=function(){var e=v()(p()().mark((function e(t,r,i){var o,s;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=localStorage.getItem(U.LA8),s=d()(d()({categoryUid:(null==W?void 0:W.uid)===U.zBg?"":null==W?void 0:W.uid,orgUid:(null==V?void 0:V.uid)||"",accessToken:o||"",exportType:t,type:n},a?{superUser:"true"}:{}),Te),"current"===t?(s.pageNumber=String(g-1),s.pageSize=String(L)):"all"===t?(s.pageNumber="0",s.pageSize="1000"):"range"===t&&void 0!==r&&void 0!==i&&(s.pageNumber=String(r),s.pageSize=String(i)),window.open((0,oe.kG)()+"/api/v1/ticket/export?"+new URLSearchParams(s).toString());case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),We=function(e){for(var t=[],n=1e3,r=Math.ceil(e/n),i=function(){var r=a,i=a*n+1,o=Math.min((a+1)*n,e);t.push({key:"export-".concat(a),label:"".concat(i,"-").concat(o," (").concat(o-i+1,"条)"),onClick:function(){return _e("range",r,n)}})},a=0;a<r;a++)i();return t},Je={selectedRowKeys:je,onChange:function(e,t){Fe(e),qe(t)}},Xe=function(){Q(!1),ne(!1),ce(void 0),ge(!1)},Ge=function(){var e;null===(e=u.current)||void 0===e||e.reload(),Xe()},He=n===U.dCh,Ye=!He,Qe=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left",align:"center"},{title:s.formatMessage({id:"ticket.number",defaultMessage:"工单编号"}),dataIndex:"ticketNumber",key:"ticketNumber",width:150,copyable:!0},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.description"}),dataIndex:"description",ellipsis:!0,tooltip:s.formatMessage({id:"ticket.description.tooltip"})},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status"}),dataIndex:"status",tooltip:s.formatMessage({id:"ticket.status.tooltip"}),valueType:"select",valueEnum:(t={},o()(o()(o()(o()(o()(o()(o()(o()(o()(o()(t,U.sM_,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.sM_.toLowerCase())}),status:"Processing"}),U.Yux,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.Yux.toLowerCase())}),status:"Processing"}),U.sFW,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.sFW.toLowerCase())}),status:"Processing"}),U.W66,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.W66.toLowerCase())}),status:"Warning"}),U.z1,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.z1.toLowerCase())}),status:"Processing"}),U.yZA,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.yZA.toLowerCase())}),status:"Processing"}),U.pIN,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.pIN.toLowerCase())}),status:"Warning"}),U.XrC,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.XrC.toLowerCase())}),status:"Warning"}),U.L1h,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.L1h.toLowerCase())}),status:"Processing"}),U.yib,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.yib.toLowerCase())}),status:"Warning"}),o()(o()(o()(o()(o()(o()(t,U.hwr,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.hwr.toLowerCase())}),status:"Success"}),U.AzB,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.AzB.toLowerCase())}),status:"Warning"}),U.frw,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.frw.toLowerCase())}),status:"Default"}),U.xw4,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.xw4.toLowerCase())}),status:"Error"}),U.qQU,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.qQU.toLowerCase())}),status:"Success"}),U.GJZ,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(U.GJZ.toLowerCase())}),status:"Error"})),render:function(e,t){var n;if(null==t||!t.status)return(0,te.jsx)(T.Z,{color:"default",children:s.formatMessage({id:"ticket.status.unset",defaultMessage:"未设置状态"})});var r=(n={},o()(o()(o()(o()(o()(o()(o()(o()(o()(o()(n,U.sM_,"blue"),U.Yux,"geekblue"),U.sFW,"cyan"),U.W66,"magenta"),U.z1,"processing"),U.yZA,"lime"),U.pIN,"warning"),U.XrC,"orange"),U.L1h,"cyan"),U.yib,"volcano"),o()(o()(o()(o()(o()(o()(n,U.hwr,"success"),U.AzB,"purple"),U.frw,"default"),U.xw4,"error"),U.qQU,"green"),U.GJZ,"red"));return(0,te.jsx)(T.Z,{color:r[null==t?void 0:t.status],children:(0,te.jsx)(E.FormattedMessage,{id:"ticket.status.".concat(((null==t?void 0:t.status)||"").toLowerCase())})})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority"}),dataIndex:"priority",tooltip:s.formatMessage({id:"ticket.priority.tooltip"}),valueType:"select",valueEnum:o()(o()(o()(o()(o()(o()({},U.JTO,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(U.JTO.toLowerCase())}),status:"Default"}),U.sbT,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(U.sbT.toLowerCase())}),status:"Processing"}),U.GMZ,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(U.GMZ.toLowerCase())}),status:"Warning"}),U.Bt2,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(U.Bt2.toLowerCase())}),status:"Warning"}),U._Xr,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(U._Xr.toLowerCase())}),status:"Error"}),U.Lx6,{text:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(U.Lx6.toLowerCase())}),status:"Error"}),render:function(e,t){var n=o()(o()(o()(o()(o()(o()({},U.JTO,"default"),U.sbT,"blue"),U.GMZ,"orange"),U.Bt2,"volcano"),U._Xr,"red"),U.Lx6,"purple");return(0,te.jsx)(T.Z,{color:n[null==t?void 0:t.priority],children:(0,te.jsx)(E.FormattedMessage,{id:"ticket.priority.".concat(((null==t?void 0:t.priority)||"").toLowerCase())})})}}].concat(l()(He?[{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.level",defaultMessage:"工单级别"}),dataIndex:"level",key:"level",valueType:"select",valueEnum:o()(o()({},U.Hxq,{text:s.formatMessage({id:"ticket.level.platform",defaultMessage:"平台工单"})}),U.whQ,{text:s.formatMessage({id:"ticket.level.org",defaultMessage:"组织工单"})}),width:120,tooltip:s.formatMessage({id:"ticket.level.tooltip",defaultMessage:"外部工单的级别：平台工单 / 组织工单"}),render:function(e,t){var n=(null==t?void 0:t.level)===U.Hxq;return(0,te.jsx)(T.Z,{color:n?"gold":"blue",children:n?s.formatMessage({id:"ticket.level.platform",defaultMessage:"平台工单"}):s.formatMessage({id:"ticket.level.org",defaultMessage:"组织工单"})})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.contactName",defaultMessage:"联系人"}),dataIndex:"contactName",key:"contactName",hideInSearch:!0,width:120,copyable:!0,tooltip:s.formatMessage({id:"ticket.contactName.tooltip",defaultMessage:"联系人姓名"}),renderText:function(e,t){return t.contactName||""},render:function(e,t){return t.contactName?e:(0,te.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.phone",defaultMessage:"电话"}),dataIndex:"phone",key:"phone",hideInSearch:!0,width:130,copyable:!0,tooltip:s.formatMessage({id:"ticket.phone.tooltip",defaultMessage:"联系电话"}),renderText:function(e,t){return t.phone||""},render:function(e,t){return t.phone?e:(0,te.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.email",defaultMessage:"邮箱"}),dataIndex:"email",key:"email",hideInSearch:!0,width:180,ellipsis:!0,copyable:!0,tooltip:s.formatMessage({id:"ticket.email.tooltip",defaultMessage:"联系邮箱"}),renderText:function(e,t){return t.email||""},render:function(e,t){return t.email?e:(0,te.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.wechat",defaultMessage:"微信"}),dataIndex:"wechat",key:"wechat",hideInSearch:!0,width:130,copyable:!0,tooltip:s.formatMessage({id:"ticket.wechat.tooltip",defaultMessage:"联系微信"}),renderText:function(e,t){return t.wechat||""},render:function(e,t){return t.wechat?e:(0,te.jsx)("span",{style:{color:"#999"},children:"-"})}}]:[]),[{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.category"}),dataIndex:"categoryUid",key:"categoryUid",hideInSearch:!0,width:180,tooltip:s.formatMessage({id:"ticket.category.tooltip",defaultMessage:"工单所属分类"}),render:function(e,t){if(!t.categoryUid)return(0,te.jsx)(T.Z,{color:"default",children:s.formatMessage({id:"ticket.category.unset",defaultMessage:"未设置分类"})});var n=Le.get(t.categoryUid);return n?(0,te.jsx)(T.Z,{color:"green",children:_(n.name)||n.name||n.uid}):(0,te.jsx)(T.Z,{color:"default",children:s.formatMessage({id:"ticket.category.missing",defaultMessage:"未知分类"})})}}],l()(Ye?[{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.department",defaultMessage:"所属部门"}),dataIndex:"departmentUid",key:"departmentUid",hideInSearch:!0,width:200,tooltip:s.formatMessage({id:"ticket.department.tooltip",defaultMessage:"工单所属部门"}),render:function(e,t){if(!t.departmentUid)return(0,te.jsx)(T.Z,{color:"default",children:s.formatMessage({id:"ticket.department.unset",defaultMessage:"未设置部门"})});var n=Oe.get(t.departmentUid);if(!n)return(0,te.jsx)(T.Z,{color:"default",children:s.formatMessage({id:"ticket.department.missing",defaultMessage:"未知部门"})});var r=_(n.name||n.name)||n.name||n.name||n.uid;return(0,te.jsx)(T.Z,{color:"purple",children:r})}}]:[]),[{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.assignee"}),dataIndex:"assignee",hideInSearch:!0,tooltip:s.formatMessage({id:"ticket.assignee.tooltip"}),render:function(e,t,n,r){var i;return(0,te.jsx)(T.Z,{color:"blue",children:null==t||null===(i=t.assignee)||void 0===i?void 0:i.nickname})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.reporter"}),dataIndex:"reporter",hideInSearch:!0,tooltip:s.formatMessage({id:"ticket.reporter.tooltip"}),render:function(e,t,n,r){var i;return(0,te.jsx)(T.Z,{color:"red",children:null==t||null===(i=t.reporter)||void 0===i?void 0:i.nickname})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"ticket.schema"}),dataIndex:"schema",hideInSearch:!0,ellipsis:!0,width:300,tooltip:s.formatMessage({id:"ticket.schema.tooltip"}),render:function(e,t){if(!t.schema)return(0,te.jsx)("span",{style:{color:"#999"},children:"-"});try{var n=JSON.parse(t.schema);if(n.formData&&Object.keys(n.formData).length>0){var r=Object.entries(n.formData).filter((function(e){var t=k()(e,2),n=(t[0],t[1]);return null!=n&&""!==n})).map((function(e){var t,r=k()(e,2),i=r[0],a=r[1],o=(null===(t=n.fieldLabels)||void 0===t?void 0:t[i])||i,s=String(a);return"".concat(o,": ").concat(s.length>20?s.substring(0,20)+"...":s)}));return 0===r.length?(0,te.jsx)("span",{style:{color:"#999"},children:"-"}):(0,te.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",maxHeight:"60px",overflow:"hidden"},children:r.map((function(e,t){return(0,te.jsx)(T.Z,{color:"geekblue",style:{fontSize:"11px",padding:"1px 4px"},children:e},t)}))})}}catch(e){console.error("解析 schema 数据失败:",e)}return(0,te.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,te.jsx)(E.FormattedMessage,{id:"createdAt"}),dataIndex:"createdAt",valueType:"dateTime",hideInSearch:!0,sorter:!0,tooltip:s.formatMessage({id:"ticket.createdAt.tooltip"}),render:function(e,t,n,r){return P()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,te.jsx)(E.FormattedMessage,{id:"updatedAt"}),dataIndex:"updatedAt",valueType:"dateTime",hideInSearch:!0,sorter:!0,tooltip:s.formatMessage({id:"ticket.updatedAt.tooltip"}),render:function(e,t,n,r){return P()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,te.jsx)(E.FormattedMessage,{id:"action"}),key:"option",dataIndex:"option",hideInSearch:!0,width:200,fixed:"right",tooltip:s.formatMessage({id:"ticket.action.tooltip"}),render:function(e,t){return(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(I.ZP,{type:"link",onClick:function(){return ce(e=t),ge(!0),void("INTERNAL"===e.type?Q(!0):ne(!0));var e},children:(0,te.jsx)(E.FormattedMessage,{id:"ticket.action.edit"})}),(0,te.jsx)(I.ZP,{type:"link",onClick:function(){return ce(t),void we(!0)},children:(0,te.jsx)(E.FormattedMessage,{id:"ticket.action.view"})}),(0,te.jsx)(B.Z,{title:s.formatMessage({id:"deleteTip"}),description:"".concat(s.formatMessage({id:"deleteAffirm"}),"【").concat(t.description,"】？"),onConfirm:function(){return Re(t)},okText:s.formatMessage({id:"ok"}),cancelText:s.formatMessage({id:"cancel"}),children:(0,te.jsx)(I.ZP,{type:"link",children:(0,te.jsx)(E.FormattedMessage,{id:"ticket.action.delete"})})})]})}}]);return(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(C.Z,{columns:Qe,actionRef:u,cardBordered:!0,rowSelection:Je,scroll:{x:2800},request:function(){var e=v()(p()().mark((function e(t,r,o){var s,l,u,c,f,m,g,v;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.current,l=t.pageSize,u=i()(t,le),h(s),O(l),Be(d()(d()({},u),{},{type:n})),c=void 0,f=void 0,r&&Object.keys(r).length>0&&(m=Object.keys(r)[0],c=m,f="ascend"===r[m]?"ascend":"descend"),g=d()(d()(d()(d()({pageNumber:s-1,pageSize:l,orgUid:null==V?void 0:V.uid,type:n},a&&{superUser:a}),(null==W?void 0:W.uid)!==U.zBg&&{categoryUid:null==W?void 0:W.uid}),u),{},{sortBy:c,sortDirection:f}),e.next=10,(0,x.AQ)(g);case 10:return v=e.sent,R.Z.debug("queryTicketsByOrgUid response:",v,g),200===v.code?ze(null==v?void 0:v.data.totalElements):y.yw.error(v.message),e.abrupt("return",{data:null==v?void 0:v.data.content,success:!0,total:null==v?void 0:v.data.totalElements});case 14:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),editable:{type:"multiple"},rowKey:"uid",search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,onChange:function(e,t){h(e),t&&O(t)}},dateFormatter:"string",headerTitle:s.formatMessage({id:"ticket.list"}),toolBarRender:function(){var e=[],t=[{key:"export-current",icon:(0,te.jsx)(j.Z,{}),label:s.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return _e("current")}}];Ae>0&&(Ae<=1e3?t.push({key:"export-all",icon:(0,te.jsx)(j.Z,{}),label:s.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(Ae,"条)"),onClick:function(){return _e("all")}}):t.push({key:"export-range",icon:(0,te.jsx)(j.Z,{}),label:s.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(Ae,"条)"),children:We(Ae)})),e.push((0,te.jsx)(D.Z,{menu:{items:t},placement:"bottom",children:(0,te.jsxs)(I.ZP,{type:"primary",icon:(0,te.jsx)(j.Z,{}),children:[s.formatMessage({id:"import.export",defaultMessage:"导出"}),(0,te.jsx)(F.Z,{})]})},"importExport"));var n=[];return je.length>0&&n.push({key:"batchDelete",icon:(0,te.jsx)(Z.Z,{}),danger:!0,label:s.formatMessage({id:"batch.delete"})+" (".concat(je.length,")"),onClick:function(){ke.confirm({title:s.formatMessage({id:"batch.deleteTip"}),content:"".concat(s.formatMessage({id:"batch.deleteAffirm"})," ").concat(je.length," ").concat(s.formatMessage({id:"items"}),"?"),onOk:Ve,okText:s.formatMessage({id:"ok"}),cancelText:s.formatMessage({id:"cancel"})})}}),n.length>0&&e.push((0,te.jsx)(D.Z,{menu:{items:n},placement:"bottom",children:(0,te.jsxs)(I.ZP,{type:je.length>0?"primary":"default",danger:je.length>0,children:[je.length>0?s.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(je.length,")"):s.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,te.jsx)(F.Z,{})]})},"batchOperations")),e}}),Y&&(0,te.jsx)(re,{open:Y,isEdit:pe,currentTicket:de,onCancel:Xe,onSuccess:Ge}),ee&&(0,te.jsx)(ae,{open:ee,isEdit:pe,currentTicket:de,onCancel:Xe,onSuccess:Ge}),be&&(0,te.jsx)(se.Z,{open:be,ticket:de,onClose:function(){return we(!1)}}),ye]})}},6823:function(e,t,n){n.d(t,{H:function(){return m}});var r=n(86222),i=n.n(r),a=n(76711),o=n.n(a),s=n(73193),l=n.n(s),u=n(27353),d=n(26557),c=n(26407),f=n(20744),m=(0,d.Ue)()((0,c.mW)((0,c.tJ)((0,f.n)((function(e,t){return{departmentResult:{data:{content:[]}},currentDepartment:{uid:u.zBg,nickname:u.zBg},insertDepartment:function(t){e((function(e){var n=e.departmentResult.data.content;if(t.parentUid){var r=n.find((function(e){return e.uid===t.parentUid}));r&&(r.children||(r.children=[]),r.children.push(t))}else n.push(t)}))},upgradeDepartment:function(t){e((function(e){var n=e.departmentResult.data.content,r=n.findIndex((function(e){return e.uid===t.uid}));-1!==r?n[r]=t:n.forEach((function(e){if(e.children){var n=e.children.findIndex((function(e){return e.uid===t.uid}));-1!==n&&(e.children[n]=t)}}))}))},setDepartmentResult:function(n){var r,i={uid:u.zBg,name:u.zBg};(e({departmentResult:l()(l()({},n),{},{data:{content:[i].concat(o()(n.data.content))}})}),""===t().currentDepartment.uid)&&((null===(r=n.data)||void 0===r||null===(r=r.content)||void 0===r?void 0:r.length)>0&&e({currentDepartment:n.data.content[0]}))},setCurrentDepartment:function(n){var r=t().departmentResult.data.content,i=r.findIndex((function(e){return e.uid===n.uid}));if(-1!==i){var a=[].concat(o()(r.slice(0,i)),[n],o()(r.slice(i+1))),s=l()(l()({},t().departmentResult),{},{data:{content:a}});e({departmentResult:s,currentDepartment:n})}else console.warn("Department with the specified uid not found."),e({currentDepartment:n})},removeDepartment:function(n){e((function(e){var t=e.departmentResult.data.content;e.departmentResult.data.content=function e(t,n){return t.filter((function(t){return t.uid!==n&&(t.children&&(t.children=e(t.children,n)),!0)}))}(t,n)})),t().currentDepartment.uid===n&&e({currentDepartment:{uid:""}})},setCurrentDepUid:function(n){var r,a,o=null===(r=t().departmentResult)||void 0===r||null===(r=r.data)||void 0===r||null===(r=r.content)||void 0===r?void 0:r.find((function(e){return e.uid===n}));if(o)e({currentDepartment:o});else{!function t(r){var a,o=i()(r);try{for(o.s();!(a=o.n()).done;){var s=a.value;if(s.uid===n)return void e({currentDepartment:s});s.children&&s.children.length>0&&t(s.children)}}catch(e){o.e(e)}finally{o.f()}}((null===(a=t().departmentResult)||void 0===a||null===(a=a.data)||void 0===a?void 0:a.content)||[])}},deleteDepartmentCache:function(){return e({},!0)}}})),{name:u.xY_})))}}]);