"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[4234],{13916:function(e,t,r){r.d(t,{If:function(){return h},dF:function(){return c},j4:function(){return g},v$:function(){return m}});var n=r(90819),a=r.n(n),i=r(73193),o=r.n(i),s=r(89933),l=r.n(s),d=r(94976),u=r(4628);function c(e){return f.apply(this,arguments)}function f(){return(f=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/query/org",{method:"GET",params:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return(p=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/create",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return v.apply(this,arguments)}function v(){return(v=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/update",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return k.apply(this,arguments)}function k(){return(k=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/department/delete",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},30606:function(e,t,r){r.d(t,{D$:function(){return m},EP:function(){return h},hS:function(){return g},z_:function(){return c}});var n=r(90819),a=r.n(n),i=r(73193),o=r.n(i),s=r(89933),l=r.n(s),d=r(94976),u=r(4628);function c(e){return f.apply(this,arguments)}function f(){return(f=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/member/query/org",{method:"GET",params:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return(p=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/member/create",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return v.apply(this,arguments)}function v(){return(v=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/member/update",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return k.apply(this,arguments)}function k(){return(k=l()(a()().mark((function e(t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,u.request)("/api/v1/member/delete",{method:"POST",data:o()(o()({},t),{},{channel:d.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},44234:function(e,t,r){r.d(t,{Z:function(){return ye}});var n=r(84176),a=r.n(n),i=r(10154),o=r.n(i),s=r(76711),l=r.n(s),d=r(73193),u=r.n(d),c=r(86222),f=r.n(c),m=r(90819),p=r.n(m),g=r(89933),v=r.n(g),h=r(45332),k=r.n(h),x=r(43388),y=r(27961),M=r(74171),b=r(1715),w=r(36846),j=r(88722),S=r(94976),U=r(11090),F=r(2484),Z=r(54881),C=r(44565),N=r(4628),E=r(27729),I=r(28508),_=r(69533),q=r(90581),D=r(43275),T=r(96596),B=r.n(T),z=r(44194),L=r(10532),A=r(28582),P=r(30857),R=r(30310),O=r(95321),W=r(67242),V=r(99036),J=r(86702),X=r(59005),H=r(60241),Y=r(54974),G=r(85660),Q=r(36099),$=r(59908),K=r(94129),ee=r(13916),te=r(30606),re=r(54038),ne=r(89957),ae=r.n(ne),ie=r(31549),oe=function(e){var t=e.fields,r=void 0===t?[]:t,n=e.fieldNamePrefix,a=void 0===n?"dynamicField_":n,i=e.translate,o=(0,N.useIntl)(),s=function(e){if(!e)return"";try{return i&&i(e)||e}catch(t){return console.error("translate field text failed:",t),e}};return null!=r&&r.length?(0,ie.jsx)(ie.Fragment,{children:r.map((function(e,t){var r,n,i,l=function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}(e,t),d="".concat(a).concat(l),u=(null==e?void 0:e.label)||(null==e?void 0:e.title)||"Field ".concat(t+1),c=s(u)||u,f=function(e,t){switch(e){case"text":switch(t){case"email":return o.formatMessage({id:"ticket.form.placeholder.email",defaultMessage:"请输入邮箱地址"});case"tel":return o.formatMessage({id:"ticket.form.placeholder.tel",defaultMessage:"请输入电话号码"});case"textarea":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入文本内容"});case"date":return o.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"datetime-local":return o.formatMessage({id:"ticket.form.placeholder.datetime",defaultMessage:"请选择日期时间"});default:return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}case"input":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"});case"textarea":return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入多行文本"});case"select":return o.formatMessage({id:"ticket.form.placeholder.select",defaultMessage:"请选择"});case"datePicker":return o.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"timePicker":return o.formatMessage({id:"ticket.form.placeholder.time",defaultMessage:"请选择时间"});default:return o.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}}(null==e?void 0:e.type,null==e||null===(r=e.props)||void 0===r?void 0:r.type),m=null!=e&&e.required?[{required:!0,message:o.formatMessage({id:"ticket.form.required",defaultMessage:"{label}是必填项"},{label:c})}]:void 0;if("textarea"===(null==e?void 0:e.type)||"textarea"===(null==e||null===(n=e.props)||void 0===n?void 0:n.component))return(0,ie.jsx)(H.Z,{name:d,label:c,placeholder:f,rules:m},d);if("select"===(null==e?void 0:e.type)||"select"===(null==e||null===(i=e.props)||void 0===i?void 0:i.component)||"select"===(null==e?void 0:e.component)){var p,g,v,h=(null!==(p=null!==(g=null==e?void 0:e.options)&&void 0!==g?g:null==e||null===(v=e.props)||void 0===v?void 0:v.options)&&void 0!==p?p:[]).map((function(e,t){return"string"==typeof e?{label:s(e)||e,value:e}:"object"===ae()(e)?{label:s(e.label||e.value||e.text||"")||e.label||e.value||e.text||"",value:null!==(r=null!==(n=null!==(a=null!==(i=e.value)&&void 0!==i?i:e.key)&&void 0!==a?a:e.label)&&void 0!==n?n:e.text)&&void 0!==r?r:"".concat(t)}:{label:String(e),value:e};var r,n,a,i}));return(0,ie.jsx)(X.Z,{name:d,label:c,placeholder:f,options:h,rules:m},d)}return(0,ie.jsx)(J.Z,{name:d,label:c,placeholder:f,rules:m},d)}))}):null},se={"star-1":"#FFB800","star-2":"#FF4D4F","star-3":"#52C41A","star-4":"#1890FF"},le=function(e){var t,r=e.open,n=e.isEdit,a=void 0!==n&&n,i=e.currentTicket,o=e.onSuccess,s=e.onCancel,d=V.A.useForm(),c=k()(d,1)[0],f=(0,N.useIntl)(),m=(0,j.Z)(),g=m.translateString,h=m.translateStringTranct,b=(0,M.u)((function(e){return e.currentOrg})),U=(0,z.useMemo)((function(){var e=f.formatMessage({id:"ticket.form.thread.none",defaultMessage:"不关联会话"});return[{label:e,value:"",dataSearch:e.toLowerCase()}]}),[f,g]),F=(0,z.useCallback)((function(e){return null!=e&&e.content&&h()||f.formatMessage({id:"ticket.form.thread.preview.empty",defaultMessage:"暂无最近消息"})}),[f,h]),Z=(0,z.useCallback)((function(e){var t,r=(null==e||null===(t=e.user)||void 0===t?void 0:t.avatar)||"";if(r.startsWith("http")||r.startsWith("data:"))return r}),[]),C=(0,z.useCallback)((function(e){if(!e||0===e.length)return null;var t=e.filter((function(e){return!!e}));return t.length?(0,ie.jsx)("span",{className:"ticket-thread-option__tags",children:t.map((function(e){return(0,ie.jsx)(q.Z,{color:"blue",className:"ticket-thread-option__tag",children:e.length>12?"".concat(e.slice(0,12),"..."):e},e)}))}):null}),[]),E=(0,z.useCallback)((function(e){var t,r,n=e;if(null==n||!n.thread)return(0,ie.jsx)("div",{className:"ticket-thread-option ticket-thread-option--empty",children:null==n?void 0:n.label});var a=n.thread,i=a.star?"star-".concat(a.star):void 0,o=i?se[i]:void 0,s=g((null==a||null===(t=a.user)||void 0===t?void 0:t.nickname)||"")||a.uid,l=F(a),d=Z(a),u=(s||a.uid||"").toString().slice(0,1).toUpperCase(),c=null!==(r=null==a?void 0:a.unreadCount)&&void 0!==r?r:0,f=C(a.tagList),m=a.mute||!!f;return(0,ie.jsxs)("div",{className:"ticket-thread-option",style:o?{borderLeftColor:o,background:"".concat(o,"12")}:void 0,children:[(0,ie.jsx)("div",{className:"ticket-thread-option__avatar",children:(0,ie.jsx)(L.Z,{count:c||0,size:"small",children:(0,ie.jsx)(A.Z,{shape:"square",size:40,src:d,children:u})})}),(0,ie.jsxs)("div",{className:"ticket-thread-option__content",children:[(0,ie.jsx)("div",{className:"ticket-thread-option__top",children:(0,ie.jsxs)("span",{className:"ticket-thread-option__title",children:[a.top?(0,ie.jsx)(G.Z,{}):null,s]})}),m?(0,ie.jsxs)("div",{className:"ticket-thread-option__meta",children:[a.mute?(0,ie.jsx)(Q.Z,{className:"ticket-thread-option__mute"}):null,f]}):null,(0,ie.jsx)("div",{className:"ticket-thread-option__preview",children:l})]})]})}),[Z,F,C,g]),I=(0,z.useState)([]),D=k()(I,2),T=D[0],B=D[1],ne=(0,z.useState)([]),ae=k()(ne,2),le=ae[0],de=ae[1],ue=(0,z.useState)({uid:"",nickname:""}),ce=k()(ue,2),fe=ce[0],me=ce[1],pe=(0,z.useState)(!1),ge=k()(pe,2),ve=ge[0],he=ge[1],ke=(0,z.useState)([]),xe=k()(ke,2),ye=xe[0],Me=xe[1],be=(0,z.useState)([]),we=k()(be,2),je=we[0],Se=we[1],Ue=(0,z.useRef)([]),Fe=(0,z.useRef)(),Ze=(0,z.useState)(!1),Ce=k()(Ze,2),Ne=(Ce[0],Ce[1]),Ee=(0,z.useState)(),Ie=k()(Ee,2),_e=Ie[0],qe=Ie[1],De=(0,z.useMemo)((function(){return"ticketSettingsSelection_".concat((null==b?void 0:b.uid)||"default")}),[null==b?void 0:b.uid]),Te=(0,z.useMemo)((function(){return _e?je.find((function(e){return e.uid===_e})):void 0}),[je,_e]),Be=Boolean(null==Te?void 0:Te.customFormEnabled),ze=(0,z.useMemo)((function(){var e;if(!Be)return[];var t=null==Te||null===(e=Te.form)||void 0===e?void 0:e.schema;if(!t)return[];try{var r=JSON.parse(t);if(Array.isArray(r))return r;if(Array.isArray(null==r?void 0:r.schema))return r.schema;if(Array.isArray(null==r?void 0:r.fields))return r.fields;if(Array.isArray(null==r?void 0:r.content))return r.content}catch(e){console.error("ticket form schema parse error",e)}return[]}),[Be,null==Te||null===(t=Te.form)||void 0===t?void 0:t.schema]),Le=(0,z.useCallback)((function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}),[]);(0,z.useEffect)((function(){Ue.current=je}),[je]),(0,z.useEffect)((function(){var e,t,r,n,i,o=Fe.current,s=null==Te?void 0:Te.uid;Fe.current=s;var l=null!==(e=null==Te?void 0:Te.categorySettings)&&void 0!==e?e:null==Te?void 0:Te.draftCategorySettings;if(null==l||null===(t=l.items)||void 0===t||!t.length)return B([]),void(a||c.setFieldsValue({categoryUid:void 0}));var d=l.items.filter((function(e){return Boolean(null==e?void 0:e.uid)&&!1!==(null==e?void 0:e.enabled)})).sort((function(e,t){var r,n;return(null!==(r=e.orderIndex)&&void 0!==r?r:0)-(null!==(n=t.orderIndex)&&void 0!==n?n:0)}));if(!d.length)return B([]),void(a||c.setFieldsValue({categoryUid:void 0}));if(B(d),!a){var u=c.getFieldValue("categoryUid");if(s!==o||!u||!d.some((function(e){return e.uid===u}))){var f=(null===(r=d.find((function(e){return e.uid===l.defaultCategoryUid})))||void 0===r?void 0:r.uid)||(null===(n=d.find((function(e){return e.defaultCategory})))||void 0===n?void 0:n.uid)||(null===(i=d[0])||void 0===i?void 0:i.uid);c.setFieldsValue({categoryUid:f||void 0})}}}),[Te,a,c,r]);var Ae=(0,z.useCallback)((function(e){var t,r;null!=e&&null!==(t=e.process)&&void 0!==t&&t.uid?c.setFieldsValue({processEntityUid:e.process.uid}):c.setFieldsValue({processEntityUid:void 0}),null!=e&&e.customFormEnabled&&null!=e&&null!==(r=e.form)&&void 0!==r&&r.uid?c.setFieldsValue({formEntityUid:e.form.uid}):c.setFieldsValue({formEntityUid:void 0})}),[c]),Pe=(0,z.useCallback)((function(e,t){var r=e||void 0,n=null!=t?t:Ue.current;qe(r),c.setFieldsValue({ticketSettingsUid:r}),r?localStorage.setItem(De,r):localStorage.removeItem(De);var a=n.find((function(e){return e.uid===r}));Ae(a)}),[c,De,Ae]),Re=(0,z.useCallback)(v()(p()().mark((function e(){var t,r,n,o,s,l,d,u,c,m;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=b&&b.uid){e.next=4;break}return Se([]),Pe(void 0,[]),e.abrupt("return");case 4:return Ne(!0),e.prev=5,n={orgUid:b.uid,pageNumber:0,pageSize:200},e.next=9,(0,re.Bg)(n);case 9:o=e.sent,W.Z.debug("queryTicketSettingsByOrg response:",null==o?void 0:o.data,n),s=null!==(t=null==o||null===(r=o.data)||void 0===r?void 0:r.content)&&void 0!==t?t:[],Se(s),a&&null!=i&&i.ticketSettingsUid&&s.some((function(e){return e.uid===i.ticketSettingsUid}))?l=i.ticketSettingsUid:(d=localStorage.getItem(De),l=d&&s.some((function(e){return e.uid===d}))?d:null!==(u=null===(c=s.find((function(e){return e.isDefault})))||void 0===c?void 0:c.uid)&&void 0!==u?u:null===(m=s[0])||void 0===m?void 0:m.uid),W.Z.debug("Selected ticket settings UID:",l),Pe(l,s),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),console.error("Fetch ticket settings error:",e.t0),x.yw.error(f.formatMessage({id:"ticket.settings.load.error",defaultMessage:"获取工单设置失败"}));case 22:return e.prev=22,Ne(!1),e.finish(22);case 25:case"end":return e.stop()}}),e,null,[[5,18,22,25]])}))),[null==b?void 0:b.uid,f,a,null==i?void 0:i.ticketSettingsUid,Pe,De]),Oe=(0,w.H)((function(e){return{departmentResult:e.departmentResult,setDepartmentResult:e.setDepartmentResult}})),We=Oe.departmentResult,Ve=Oe.setDepartmentResult,Je=(0,z.useCallback)(function(){var e=v()(p()().mark((function e(t,r){var n,a,i,o,s;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a={pageNumber:0,pageSize:100,orgUid:null==b?void 0:b.uid,deptUid:t},e.next=4,(0,te.z_)(a);case 4:i=e.sent,W.Z.debug("queryMembersByOrg response:",null==i?void 0:i.data,a),200===(null==i?void 0:i.code)&&null!=i&&null!==(n=i.data)&&void 0!==n&&n.content&&(o=null==i?void 0:i.data.content,de(o),r?(s=o.find((function(e){return e.uid===r})),c.setFieldsValue({assigneeUid:r}),me(s||{uid:r,nickname:(null==s?void 0:s.nickname)||""})):(c.setFieldsValue({assigneeUid:void 0}),me({uid:"",nickname:""}))),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch members error:",e.t0),x.yw.error(f.formatMessage({id:"ticket.member.load.error",defaultMessage:"加载成员失败"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,r){return e.apply(this,arguments)}}(),[null==b?void 0:b.uid,c,f]),Xe=(0,z.useCallback)((function(e){e===S.zBg?Je(""):Je(e)}),[Je]);(0,z.useEffect)((function(){if(a&&i){var e,t,r,n,o,s={description:i.description,status:i.status,priority:i.priority,threadUid:null==i?void 0:i.threadUid,departmentUid:null==i?void 0:i.departmentUid,categoryUid:null==i?void 0:i.categoryUid,assigneeUid:null===(e=i.assignee)||void 0===e?void 0:e.uid,uploadUids:null===(t=i.attachments)||void 0===t?void 0:t.map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})),processEntityUid:null==i?void 0:i.processEntityUid,ticketSettingsUid:null==i?void 0:i.ticketSettingsUid,formEntityUid:null==i?void 0:i.formEntityUid};if(i.schema)try{var l=JSON.parse(i.schema);if(l.formUid&&l.formData){var d="ticketFormSelection_".concat((null==b?void 0:b.uid)||"default");localStorage.setItem(d,l.formUid),Object.entries(l.formData).forEach((function(e){var t=k()(e,2),r=t[0],n=t[1];s["dynamicField_".concat(r)]=n}))}}catch(e){console.error("解析工单表单数据失败:",e)}if(c.setFieldsValue(s),Me(null!==(r=null===(n=i.attachments)||void 0===n?void 0:n.map((function(e){return e.upload})))&&void 0!==r?r:[]),me(i.assignee||{uid:"",nickname:""}),i.departmentUid)Je(i.departmentUid,null===(o=i.assignee)||void 0===o?void 0:o.uid)}else{var u=localStorage.getItem("ticketDraft");u&&c.setFieldsValue({description:u}),c.setFieldsValue({status:S.sM_,priority:S.GMZ,departmentUid:S.zBg,categoryUid:void 0}),me({uid:"",nickname:""}),Xe(S.zBg),Me([])}}),[r,a,i,null==b?void 0:b.uid,Je,Xe]);var He=function e(t,r){if(t.name.startsWith(S.VoP)?r.title=f.formatMessage({id:t.name,defaultMessage:t.name}):r.title=t.name,r.key=t.uid,r.value=t.uid,t.children){r.children=[];for(var n=0;n<t.children.length;n++){var a={title:"",key:"",children:[]};e(t.children[n],a),r.children.push(a)}}},Ye=(0,z.useMemo)((function(){for(var e,t,r=[],n=null!==(e=null==We||null===(t=We.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],a=0;a<n.length;a++)if(n[a].uid!==S.zBg&&"i18n.DEPT_ALL"!==n[a].uid){var i={title:"",key:"",children:[]};He(n[a],i),r.push(i)}return r}),[We]),Ge=(0,z.useMemo)((function(){return[{title:f.formatMessage({id:"ticket.form.department.all",defaultMessage:"全部部门"}),key:S.zBg,value:S.zBg}].concat(l()(Ye))}),[Ye,f]),Qe=function(){var e=v()(p()().mark((function e(){var t,r;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={pageNumber:0,pageSize:100,orgUid:null==b?void 0:b.uid},e.next=4,(0,ee.dF)(t);case 4:r=e.sent,W.Z.debug("queryDepartmentsByOrg response:",null==r?void 0:r.data,t),200===(null==r?void 0:r.code)?Ve(r):x.yw.error(null==r?void 0:r.message),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch departments error:",e.t0),x.yw.error(f.formatMessage({id:"ticket.department.load.error"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}();(0,z.useEffect)((function(){r&&(Qe(),Re())}),[r,Re]);var $e=function(){var e=v()(p()().mark((function e(){var t,r,n,s,d,m,g,v,h,k,M,w;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.validateFields();case 3:if(d=e.sent,x.yw.loading(f.formatMessage({id:"ticket.submitting"}),0),d.threadUid,m=Boolean(Be&&(null==Te||null===(t=Te.form)||void 0===t?void 0:t.uid)),g=m?new Set(ze.map((function(e,t){return"dynamicField_".concat(Le(e,t))}))):new Set,v={},Object.keys(d).forEach((function(e){if(e.startsWith("dynamicField_")){if(m&&g.has(e)){var t=e.replace("dynamicField_","");v[t]=d[e]}delete d[e]}})),h=null,m&&null!=Te&&null!==(r=Te.form)&&void 0!==r&&r.uid&&(h={formUid:Te.form.uid,formName:Te.form.name,formSchema:Te.form.schema,formData:v}),(k=u()(u()({},d),{},{departmentUid:d.departmentUid===S.zBg?"":d.departmentUid,orgUid:null==b?void 0:b.uid,assignee:{uid:null==fe?void 0:fe.uid,nickname:null==fe?void 0:fe.nickname,type:S.Tls},uploadUids:(null==ye?void 0:ye.length)>0?l()(new Set(ye.map((function(e){return e.uid})))):[],schema:h?JSON.stringify(h):void 0})).ticketSettingsUid=a&&null!=i&&i.ticketSettingsUid?i.ticketSettingsUid:d.ticketSettingsUid||_e,m&&!k.formEntityUid&&null!=Te&&null!==(n=Te.form)&&void 0!==n&&n.uid&&(k.formEntityUid=Te.form.uid),!k.processEntityUid&&null!=Te&&null!==(s=Te.process)&&void 0!==s&&s.uid&&(k.processEntityUid=Te.process.uid),!a||!i){e.next=25;break}return k.uid=i.uid,e.next=20,(0,y.O)(k);case 20:M=e.sent,W.Z.debug("updateTicket response",null==M?void 0:M.data,k),200===(null==M?void 0:M.code)?(x.yw.destroy(),x.yw.success(f.formatMessage({id:"ticket.update.success"})),o()):(x.yw.destroy(),x.yw.error(f.formatMessage({id:"ticket.update.failed"}))),e.next=30;break;case 25:return e.next=27,(0,y.ax)(k);case 27:w=e.sent,W.Z.debug("createTicket response",null==w?void 0:w.data,k),200===(null==w?void 0:w.code)?(x.yw.destroy(),x.yw.success(f.formatMessage({id:"ticket.create.success"})),o()):(x.yw.destroy(),x.yw.error(f.formatMessage({id:"ticket.create.failed"})));case 30:e.next=37;break;case 32:e.prev=32,e.t0=e.catch(0),x.yw.destroy(),console.error("Submit ticket error:",e.t0),x.yw.error(f.formatMessage({id:"ticket.submit.error"}));case 37:return e.prev=37,localStorage.removeItem("ticketDraft"),e.finish(37);case 40:case"end":return e.stop()}}),e,null,[[0,32,37,40]])})));return function(){return e.apply(this,arguments)}}(),Ke=function(e){W.Z.debug("handleDelete",e),Me((function(t){return t.filter((function(t){return t.uid!==e}))}))};return(0,ie.jsx)(P.Z,{title:f.formatMessage({id:a?"ticket.edit.title":"ticket.create.title",defaultMessage:a?"编辑工单":"创建工单"}),width:600,open:r,onClose:s,extra:(0,ie.jsxs)(R.Z,{children:[(0,ie.jsx)(_.ZP,{onClick:s,children:f.formatMessage({id:"common.cancel"})}),(0,ie.jsx)(_.ZP,{type:"primary",onClick:$e,children:f.formatMessage({id:"common.confirm"})})]}),children:(0,ie.jsxs)(V.A,{form:c,submitter:!1,children:[(0,ie.jsx)(J.Z,{name:"ticketSettingsUid",hidden:!0,rules:a||0===je.length?[]:[{required:!0,message:f.formatMessage({id:"ticket.form.ticketSettings.required",defaultMessage:"请选择工单设置"})}]}),Be&&ze.length>0?(0,ie.jsx)(oe,{fields:ze,fieldNamePrefix:"dynamicField_",translate:g}):null,(0,ie.jsx)(J.Z,{name:"processEntityUid",hidden:!0}),(0,ie.jsx)(J.Z,{name:"formEntityUid",hidden:!0}),T.length>0?(0,ie.jsx)(X.Z,{name:"categoryUid",label:f.formatMessage({id:"ticket.form.category"}),rules:[{required:!0,message:f.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],options:T.map((function(e){return{label:g(e.name||"")||e.name||e.uid,value:e.uid}})),placeholder:f.formatMessage({id:"ticket.form.category.placeholder"})}):null,(0,ie.jsx)(H.Z,{name:"description",label:f.formatMessage({id:"ticket.form.description"}),rules:[{required:!0}],fieldProps:{onBlur:function(){W.Z.debug("handleDescriptionBlur",c.getFieldsValue());var e=c.getFieldValue("description");localStorage.setItem("ticketDraft",e)}}}),(0,ie.jsx)(X.Z,{name:"priority",label:f.formatMessage({id:"ticket.form.priority"}),options:[{label:f.formatMessage({id:"ticket.priority.lowest"}),value:S.JTO},{label:f.formatMessage({id:"ticket.priority.low"}),value:S.sbT},{label:f.formatMessage({id:"ticket.priority.medium"}),value:S.GMZ},{label:f.formatMessage({id:"ticket.priority.high"}),value:S.Bt2},{label:f.formatMessage({id:"ticket.priority.urgent"}),value:S._Xr},{label:f.formatMessage({id:"ticket.priority.critical"}),value:S.Lx6}],rules:[{required:!0}]}),(0,ie.jsx)(V.A.Item,{name:"departmentUid",label:f.formatMessage({id:"ticket.form.department",defaultMessage:"所属部门"}),children:(0,ie.jsx)(O.Z,{style:{width:"100%"},treeData:Ge,showSearch:!0,treeDefaultExpandAll:!1,popupMatchSelectWidth:!1,placeholder:f.formatMessage({id:"ticket.form.department.placeholder",defaultMessage:"请选择内部部门"}),onChange:function(e){return Xe(e||S.zBg)},allowClear:!1})}),(0,ie.jsx)(X.Z,{name:"assigneeUid",label:f.formatMessage({id:"ticket.form.assignee"}),options:le.map((function(e){var t;return{label:e.nickname||(null===(t=e.user)||void 0===t?void 0:t.nickname),value:e.uid}})),placeholder:f.formatMessage({id:"ticket.form.assignee.placeholder"}),fieldProps:{onChange:function(e){var t=le.find((function(t){return t.uid===e}));me(t||{uid:"",nickname:""})}},disabled:0===le.length}),(0,ie.jsx)(X.Z,{name:"threadUid",label:f.formatMessage({id:"ticket.form.thread"}),options:U,fieldProps:{showSearch:!0,popupMatchSelectWidth:!1,optionLabelProp:"label",classNames:{popup:{root:"ticket-thread-select-dropdown"}},optionRender:function(e){return E(e)},filterOption:function(e,t){var r=t,n=e.toLowerCase();return((null==r?void 0:r.dataSearch)||"").includes(n)}},placeholder:f.formatMessage({id:"ticket.form.thread.placeholder"})}),ve&&(0,ie.jsx)(Y.Z,{type:S.hcJ,isModalOpen:ve,attachments:null==i?void 0:i.attachments,handleSubmit:function(e){var t;W.Z.debug("handleSubmit",e);var r=e||[];if(a&&null!=i&&null!==(t=i.attachments)&&void 0!==t&&t.length){var n=new Set((i.attachments||[]).map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})).filter((function(e){return Boolean(e)}))),o=r.filter((function(e){return!n.has(e.uid)}));Me(o)}else Me(r);he(!1)},handleCancel:function(){he(!1)}}),(0,ie.jsx)("div",{style:{marginTop:"16px",marginBottom:"16px",maxHeight:"200px",overflowY:"auto"},children:(0,ie.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"12px"},children:ye.map((function(e){return(0,ie.jsx)(K.Z,{file:e,onDelete:Ke},e.uid)}))})}),(0,ie.jsx)(_.ZP,{icon:(0,ie.jsx)($.Z,{}),onClick:function(){return he(!0)},children:f.formatMessage({id:"ticket.form.upload.button"})})]})})},de=r(48058),ue={"star-1":"#FFB800","star-2":"#FF4D4F","star-3":"#52C41A","star-4":"#1890FF"},ce=function(e){var t=e.open,r=e.isEdit,n=void 0!==r&&r,a=e.currentTicket,i=e.onSuccess,o=e.onCancel,s=V.A.useForm(),d=k()(s,1)[0],c=(0,N.useIntl)(),f=(0,j.Z)(),m=f.translateString,g=f.translateStringTranct,h=(0,M.u)((function(e){return e.currentOrg})),b=(0,z.useMemo)((function(){var e=c.formatMessage({id:"ticket.form.thread.none",defaultMessage:"不关联会话"});return[{label:e,value:"",dataSearch:e.toLowerCase()}]}),[c,m]),U=(0,z.useCallback)((function(e){return null!=e&&e.content&&g()||c.formatMessage({id:"ticket.form.thread.preview.empty",defaultMessage:"暂无最近消息"})}),[c,g]),F=(0,z.useCallback)((function(e){var t,r=(null==e||null===(t=e.user)||void 0===t?void 0:t.avatar)||"";if(r.startsWith("http")||r.startsWith("data:"))return r}),[]),Z=(0,z.useCallback)((function(e){if(!e||0===e.length)return null;var t=e.filter((function(e){return!!e}));return t.length?(0,ie.jsx)("span",{className:"ticket-thread-option__tags",children:t.map((function(e){return(0,ie.jsx)(q.Z,{color:"blue",className:"ticket-thread-option__tag",children:e.length>12?"".concat(e.slice(0,12),"..."):e},e)}))}):null}),[]),C=(0,z.useCallback)((function(e){var t,r,n=e;if(null==n||!n.thread)return(0,ie.jsx)("div",{className:"ticket-thread-option ticket-thread-option--empty",children:null==n?void 0:n.label});var a=n.thread,i=a.star?"star-".concat(a.star):void 0,o=i?ue[i]:void 0,s=m((null==a||null===(t=a.user)||void 0===t?void 0:t.nickname)||"")||a.uid,l=U(a),d=F(a),u=(s||a.uid||"").toString().slice(0,1).toUpperCase(),c=null!==(r=null==a?void 0:a.unreadCount)&&void 0!==r?r:0,f=Z(a.tagList),p=a.mute||!!f;return(0,ie.jsxs)("div",{className:"ticket-thread-option",style:o?{borderLeftColor:o,background:"".concat(o,"12")}:void 0,children:[(0,ie.jsx)("div",{className:"ticket-thread-option__avatar",children:(0,ie.jsx)(L.Z,{count:c||0,size:"small",children:(0,ie.jsx)(A.Z,{shape:"square",size:40,src:d,children:u})})}),(0,ie.jsxs)("div",{className:"ticket-thread-option__content",children:[(0,ie.jsx)("div",{className:"ticket-thread-option__top",children:(0,ie.jsxs)("span",{className:"ticket-thread-option__title",children:[a.top?(0,ie.jsx)(G.Z,{}):null,s]})}),p?(0,ie.jsxs)("div",{className:"ticket-thread-option__meta",children:[a.mute?(0,ie.jsx)(Q.Z,{className:"ticket-thread-option__mute"}):null,f]}):null,(0,ie.jsx)("div",{className:"ticket-thread-option__preview",children:l})]})]})}),[F,U,Z,m]),E=(0,z.useState)([]),I=k()(E,2),D=I[0],T=I[1],B=(0,z.useState)([]),ne=k()(B,2),ae=ne[0],se=ne[1],le=(0,z.useState)({uid:"",nickname:""}),ce=k()(le,2),fe=ce[0],me=ce[1],pe=(0,z.useState)(!1),ge=k()(pe,2),ve=ge[0],he=ge[1],ke=(0,z.useState)([]),xe=k()(ke,2),ye=xe[0],Me=xe[1],be=(0,z.useState)([]),we=k()(be,2),je=we[0],Se=we[1],Ue=(0,z.useRef)([]),Fe=(0,z.useRef)(),Ze=(0,z.useState)(!1),Ce=k()(Ze,2),Ne=(Ce[0],Ce[1]),Ee=(0,z.useState)(),Ie=k()(Ee,2),_e=Ie[0],qe=Ie[1],De=(0,z.useMemo)((function(){return"ticketSettingsSelection_".concat((null==h?void 0:h.uid)||"default")}),[null==h?void 0:h.uid]),Te=(0,z.useMemo)((function(){return _e?je.find((function(e){return e.uid===_e})):void 0}),[je,_e]),Be=Boolean(null==Te?void 0:Te.customFormEnabled),ze=(0,z.useMemo)((function(){var e;return null!==(e=null==Te?void 0:Te.form)&&void 0!==e?e:null==Te?void 0:Te.draftForm}),[Te]),Le=(0,z.useMemo)((function(){var e,t,r,n,a,i,o,s,l,d=null!==(e=null==Te?void 0:Te.basicSettings)&&void 0!==e?e:null==Te?void 0:Te.draftBasicSettings;return{showContactName:null===(t=null==d?void 0:d.showContactName)||void 0===t||t,requireContactName:null===(r=null==d?void 0:d.requireContactName)||void 0===r||r,showEmail:null===(n=null==d?void 0:d.showEmail)||void 0===n||n,requireEmail:null!==(a=null==d?void 0:d.requireEmail)&&void 0!==a&&a,showPhone:null===(i=null==d?void 0:d.showPhone)||void 0===i||i,requirePhone:null===(o=null==d?void 0:d.requirePhone)||void 0===o||o,showWechat:null!==(s=null==d?void 0:d.showWechat)&&void 0!==s&&s,requireWechat:null!==(l=null==d?void 0:d.requireWechat)&&void 0!==l&&l}}),[Te]),Ae=(0,z.useMemo)((function(){if(!Be||null==ze||!ze.schema)return[];try{var e=JSON.parse(ze.schema);if(Array.isArray(e))return e;if(Array.isArray(null==e?void 0:e.schema))return e.schema;if(Array.isArray(null==e?void 0:e.fields))return e.fields;if(Array.isArray(null==e?void 0:e.content))return e.content}catch(e){console.error("ticket form schema parse error",e)}return[]}),[Be,null==ze?void 0:ze.schema]),Pe=(0,z.useCallback)((function(e,t){return(null==e?void 0:e.id)||(null==e?void 0:e.fieldId)||(null==e?void 0:e.key)||(null==e?void 0:e.name)||"field-".concat(t)}),[]);(0,z.useEffect)((function(){Ue.current=je}),[je]),(0,z.useEffect)((function(){var e,t,r,a,i,o=Fe.current,s=null==Te?void 0:Te.uid;Fe.current=s;var l=null!==(e=null==Te?void 0:Te.categorySettings)&&void 0!==e?e:null==Te?void 0:Te.draftCategorySettings;if(null==l||null===(t=l.items)||void 0===t||!t.length)return T([]),void(n||d.setFieldsValue({categoryUid:void 0}));var u=l.items.filter((function(e){return Boolean(null==e?void 0:e.uid)&&!1!==(null==e?void 0:e.enabled)})).sort((function(e,t){var r,n;return(null!==(r=e.orderIndex)&&void 0!==r?r:0)-(null!==(n=t.orderIndex)&&void 0!==n?n:0)}));if(!u.length)return T([]),void(n||d.setFieldsValue({categoryUid:void 0}));if(T(u),!n){var c=d.getFieldValue("categoryUid");if(s!==o||!c||!u.some((function(e){return e.uid===c}))){var f=(null===(r=u.find((function(e){return e.uid===l.defaultCategoryUid})))||void 0===r?void 0:r.uid)||(null===(a=u.find((function(e){return e.defaultCategory})))||void 0===a?void 0:a.uid)||(null===(i=u[0])||void 0===i?void 0:i.uid);d.setFieldsValue({categoryUid:f||void 0})}}}),[Te,n,d,t]);var Re=(0,z.useCallback)((function(e){var t,r;null!=e&&null!==(t=e.process)&&void 0!==t&&t.uid?d.setFieldsValue({processEntityUid:e.process.uid}):d.setFieldsValue({processEntityUid:void 0});var n=null!==(r=null==e?void 0:e.form)&&void 0!==r?r:null==e?void 0:e.draftForm;null!=e&&e.customFormEnabled&&null!=n&&n.uid?d.setFieldsValue({formEntityUid:n.uid}):d.setFieldsValue({formEntityUid:void 0})}),[d]),Oe=(0,z.useCallback)((function(e,t){var r=e||void 0,n=null!=t?t:Ue.current;qe(r),d.setFieldsValue({ticketSettingsUid:r}),r?localStorage.setItem(De,r):localStorage.removeItem(De);var a=n.find((function(e){return e.uid===r}));Re(a)}),[d,De,Re]),We=(0,z.useCallback)(v()(p()().mark((function e(){var t,r,i,o,s,l,d,u,f,m;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=h&&h.uid){e.next=4;break}return Se([]),Oe(void 0,[]),e.abrupt("return");case 4:return Ne(!0),e.prev=5,i={orgUid:h.uid,pageNumber:0,pageSize:200},e.next=9,(0,re.Bg)(i);case 9:o=e.sent,W.Z.debug("queryTicketSettingsByOrg response:",null==o?void 0:o.data,i),s=null!==(t=null==o||null===(r=o.data)||void 0===r?void 0:r.content)&&void 0!==t?t:[],Se(s),n&&null!=a&&a.ticketSettingsUid&&s.some((function(e){return e.uid===a.ticketSettingsUid}))?l=a.ticketSettingsUid:(d=localStorage.getItem(De),l=d&&s.some((function(e){return e.uid===d}))?d:null!==(u=null===(f=s.find((function(e){return e.isDefault})))||void 0===f?void 0:f.uid)&&void 0!==u?u:null===(m=s[0])||void 0===m?void 0:m.uid),W.Z.debug("Selected ticket settings UID:",l),Oe(l,s),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),console.error("Fetch ticket settings error:",e.t0),x.yw.error(c.formatMessage({id:"ticket.settings.load.error",defaultMessage:"获取工单设置失败"}));case 22:return e.prev=22,Ne(!1),e.finish(22);case 25:case"end":return e.stop()}}),e,null,[[5,18,22,25]])}))),[null==h?void 0:h.uid,c,n,null==a?void 0:a.ticketSettingsUid,Oe,De]),Ve=(0,w.H)((function(e){return{departmentResult:e.departmentResult,setDepartmentResult:e.setDepartmentResult}})),Je=Ve.departmentResult,Xe=Ve.setDepartmentResult,He=(0,z.useCallback)(function(){var e=v()(p()().mark((function e(t,r){var n,a,i,o,s;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a={pageNumber:0,pageSize:100,orgUid:null==h?void 0:h.uid,deptUid:t},e.next=4,(0,te.z_)(a);case 4:i=e.sent,W.Z.debug("queryMembersByOrg response:",null==i?void 0:i.data,a),200===(null==i?void 0:i.code)&&null!=i&&null!==(n=i.data)&&void 0!==n&&n.content&&(o=null==i?void 0:i.data.content,se(o),r?(s=o.find((function(e){return e.uid===r})),d.setFieldsValue({assigneeUid:r}),me(s||{uid:r,nickname:(null==s?void 0:s.nickname)||""})):(d.setFieldsValue({assigneeUid:void 0}),me({uid:"",nickname:""}))),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch members error:",e.t0),x.yw.error(c.formatMessage({id:"ticket.member.load.error",defaultMessage:"加载成员失败"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,r){return e.apply(this,arguments)}}(),[null==h?void 0:h.uid,d,c]),Ye=(0,z.useCallback)((function(e){e===S.zBg?He(""):He(e)}),[He]);(0,z.useEffect)((function(){if(n&&a){var e,t,r,i,o,s={description:a.description,status:a.status,priority:a.priority,threadUid:null==a?void 0:a.threadUid,departmentUid:null==a?void 0:a.departmentUid,categoryUid:null==a?void 0:a.categoryUid,assigneeUid:null===(e=a.assignee)||void 0===e?void 0:e.uid,contactName:null==a?void 0:a.contactName,email:null==a?void 0:a.email,phone:null==a?void 0:a.phone,wechat:null==a?void 0:a.wechat,uploadUids:null===(t=a.attachments)||void 0===t?void 0:t.map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})),processEntityUid:null==a?void 0:a.processEntityUid,ticketSettingsUid:null==a?void 0:a.ticketSettingsUid,formEntityUid:null==a?void 0:a.formEntityUid};if(a.schema)try{var l=JSON.parse(a.schema);if(l.formUid&&l.formData){var u="ticketFormSelection_".concat((null==h?void 0:h.uid)||"default");localStorage.setItem(u,l.formUid),Object.entries(l.formData).forEach((function(e){var t=k()(e,2),r=t[0],n=t[1];s["dynamicField_".concat(r)]=n}))}}catch(e){console.error("解析工单表单数据失败:",e)}if(d.setFieldsValue(s),Me(null!==(r=null===(i=a.attachments)||void 0===i?void 0:i.map((function(e){return e.upload})))&&void 0!==r?r:[]),me(a.assignee||{uid:"",nickname:""}),a.departmentUid)He(a.departmentUid,null===(o=a.assignee)||void 0===o?void 0:o.uid)}else{var c=localStorage.getItem("ticketDraft");c&&d.setFieldsValue({description:c}),d.setFieldsValue({status:S.sM_,priority:S.GMZ,departmentUid:S.zBg,categoryUid:void 0}),me({uid:"",nickname:""}),Ye(S.zBg),Me([])}}),[t,n,a,null==h?void 0:h.uid,He,Ye]);var Ge=function e(t,r){if(t.name.startsWith(S.VoP)?r.title=c.formatMessage({id:t.name,defaultMessage:t.name}):r.title=t.name,r.key=t.uid,r.value=t.uid,t.children){r.children=[];for(var n=0;n<t.children.length;n++){var a={title:"",key:"",children:[]};e(t.children[n],a),r.children.push(a)}}},Qe=(0,z.useMemo)((function(){for(var e,t,r=[],n=null!==(e=null==Je||null===(t=Je.data)||void 0===t?void 0:t.content)&&void 0!==e?e:[],a=0;a<n.length;a++)if(n[a].uid!==S.zBg&&"i18n.DEPT_ALL"!==n[a].uid){var i={title:"",key:"",children:[]};Ge(n[a],i),r.push(i)}return r}),[Je]),$e=(0,z.useMemo)((function(){return[{title:c.formatMessage({id:"ticket.form.department.all",defaultMessage:"全部部门"}),key:S.zBg,value:S.zBg}].concat(l()(Qe))}),[Qe,c]),Ke=function(){var e=v()(p()().mark((function e(){var t,r;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={pageNumber:0,pageSize:100,orgUid:null==h?void 0:h.uid},e.next=4,(0,ee.dF)(t);case 4:r=e.sent,W.Z.debug("queryDepartmentsByOrg response:",null==r?void 0:r.data,t),200===(null==r?void 0:r.code)?Xe(r):x.yw.error(null==r?void 0:r.message),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error("Fetch departments error:",e.t0),x.yw.error(c.formatMessage({id:"ticket.department.load.error"}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}();(0,z.useEffect)((function(){t&&(Ke(),We())}),[t,We]);var et=function(){var e=v()(p()().mark((function e(){var t,r,o,s,f,m,g,v,k,M,b,w,j;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,d.validateFields();case 3:if(m=e.sent,x.yw.loading(c.formatMessage({id:"ticket.submitting"}),0),m.threadUid,g=Boolean(Be&&(null==ze?void 0:ze.uid)),v=g?new Set(Ae.map((function(e,t){return"dynamicField_".concat(Pe(e,t))}))):new Set,k={},Object.keys(m).forEach((function(e){if(e.startsWith("dynamicField_")){if(g&&v.has(e)){var t=e.replace("dynamicField_","");k[t]=m[e]}delete m[e]}})),M=null,g&&null!=ze&&ze.uid&&(M={formUid:ze.uid,formName:ze.name,formSchema:ze.schema,formData:k}),(b=u()(u()({},m),{},{departmentUid:m.departmentUid===S.zBg?"":m.departmentUid,orgUid:null==h?void 0:h.uid,contactName:(null===(t=m.contactName)||void 0===t?void 0:t.trim())||"",email:(null===(r=m.email)||void 0===r?void 0:r.trim())||"",phone:(null===(o=m.phone)||void 0===o?void 0:o.trim())||"",wechat:(null===(s=m.wechat)||void 0===s?void 0:s.trim())||"",assignee:{uid:null==fe?void 0:fe.uid,nickname:null==fe?void 0:fe.nickname,type:S.Tls},uploadUids:(null==ye?void 0:ye.length)>0?l()(new Set(ye.map((function(e){return e.uid})))):[],schema:M?JSON.stringify(M):void 0})).ticketSettingsUid=n&&null!=a&&a.ticketSettingsUid?a.ticketSettingsUid:m.ticketSettingsUid||_e,g&&!b.formEntityUid&&null!=ze&&ze.uid&&(b.formEntityUid=ze.uid),!b.processEntityUid&&null!=Te&&null!==(f=Te.process)&&void 0!==f&&f.uid&&(b.processEntityUid=Te.process.uid),!n||!a){e.next=25;break}return b.uid=a.uid,e.next=20,(0,y.O)(b);case 20:w=e.sent,W.Z.debug("updateTicket response",null==w?void 0:w.data,b),200===(null==w?void 0:w.code)?(x.yw.destroy(),x.yw.success(c.formatMessage({id:"ticket.update.success"})),i()):(x.yw.destroy(),x.yw.error(c.formatMessage({id:"ticket.update.failed"}))),e.next=30;break;case 25:return e.next=27,(0,y.ax)(b);case 27:j=e.sent,W.Z.debug("createTicket response",null==j?void 0:j.data,b),200===(null==j?void 0:j.code)?(x.yw.destroy(),x.yw.success(c.formatMessage({id:"ticket.create.success"})),i()):(x.yw.destroy(),x.yw.error(c.formatMessage({id:"ticket.create.failed"})));case 30:e.next=37;break;case 32:e.prev=32,e.t0=e.catch(0),x.yw.destroy(),console.error("Submit ticket error:",e.t0),x.yw.error(c.formatMessage({id:"ticket.submit.error"}));case 37:return e.prev=37,localStorage.removeItem("ticketDraft"),e.finish(37);case 40:case"end":return e.stop()}}),e,null,[[0,32,37,40]])})));return function(){return e.apply(this,arguments)}}(),tt=function(e){W.Z.debug("handleDelete",e),Me((function(t){return t.filter((function(t){return t.uid!==e}))}))};return(0,ie.jsx)(P.Z,{title:c.formatMessage({id:n?"ticket.edit.title":"ticket.create.title",defaultMessage:n?"编辑工单":"创建工单"}),width:600,open:t,onClose:o,extra:(0,ie.jsxs)(R.Z,{children:[(0,ie.jsx)(_.ZP,{onClick:o,children:c.formatMessage({id:"common.cancel"})}),(0,ie.jsx)(_.ZP,{type:"primary",onClick:et,children:c.formatMessage({id:"common.confirm"})})]}),children:(0,ie.jsxs)(V.A,{form:d,submitter:!1,children:[(0,ie.jsx)(J.Z,{name:"ticketSettingsUid",hidden:!0,rules:n||0===je.length?[]:[{required:!0,message:c.formatMessage({id:"ticket.form.ticketSettings.required",defaultMessage:"请选择工单设置"})}]}),Be&&Ae.length>0?(0,ie.jsx)(oe,{fields:Ae,fieldNamePrefix:"dynamicField_",translate:m}):null,(0,ie.jsx)(J.Z,{name:"processEntityUid",hidden:!0}),(0,ie.jsx)(J.Z,{name:"formEntityUid",hidden:!0}),D.length>0?(0,ie.jsx)(X.Z,{name:"categoryUid",label:c.formatMessage({id:"ticket.form.category"}),rules:[{required:!0,message:c.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],options:D.map((function(e){return{label:m(e.name||"")||e.name||e.uid,value:e.uid}})),placeholder:c.formatMessage({id:"ticket.form.category.placeholder"})}):null,D.length>0&&(0,ie.jsx)(X.Z,{name:"categoryUid",label:c.formatMessage({id:"ticket.form.category",defaultMessage:"工单分类"}),options:D.map((function(e){return{label:m(e.name||""),value:e.uid}})),rules:[{required:!0,message:c.formatMessage({id:"ticket.form.category.required",defaultMessage:"请选择工单分类"})}],placeholder:c.formatMessage({id:"ticket.form.category.placeholder",defaultMessage:"请选择工单分类"})}),(0,ie.jsx)(H.Z,{name:"description",label:c.formatMessage({id:"ticket.form.description"}),rules:[{required:!0}],fieldProps:{onBlur:function(){W.Z.debug("handleDescriptionBlur",d.getFieldsValue());var e=d.getFieldValue("description");localStorage.setItem("ticketDraft",e)},rows:6}}),Le.showContactName&&(0,ie.jsx)(J.Z,{name:"contactName",label:c.formatMessage({id:"ticket.form.contactName",defaultMessage:"联系人姓名"}),rules:[{required:Le.requireContactName,message:c.formatMessage({id:"ticket.form.contactName.required",defaultMessage:"请输入联系人姓名"})},{max:50,message:c.formatMessage({id:"ticket.form.contactName.maxlength",defaultMessage:"姓名不能超过50个字符"})}],placeholder:c.formatMessage({id:"ticket.form.contactName.placeholder",defaultMessage:"请输入联系人姓名"})}),Le.showEmail&&(0,ie.jsx)(J.Z,{name:"email",label:c.formatMessage({id:"ticket.form.email",defaultMessage:"邮箱"}),rules:[{required:Le.requireEmail,message:c.formatMessage({id:"ticket.form.email.required",defaultMessage:"请输入邮箱地址"})},{type:"email",message:c.formatMessage({id:"ticket.form.email.invalid",defaultMessage:"请输入有效的邮箱地址"})}],placeholder:c.formatMessage({id:"ticket.form.email.placeholder",defaultMessage:"请输入邮箱地址"})}),Le.showPhone&&(0,ie.jsx)(J.Z,{name:"phone",label:c.formatMessage({id:"ticket.form.phone",defaultMessage:"电话"}),rules:[{required:Le.requirePhone,message:c.formatMessage({id:"ticket.form.phone.required",defaultMessage:"请输入电话号码"})},{pattern:/^1[3-9]\d{9}$/,message:c.formatMessage({id:"ticket.form.phone.invalid",defaultMessage:"请输入有效的手机号码"})}],placeholder:c.formatMessage({id:"ticket.form.phone.placeholder",defaultMessage:"请输入电话号码"})}),Le.showWechat&&(0,ie.jsx)(J.Z,{name:"wechat",label:c.formatMessage({id:"ticket.form.wechat",defaultMessage:"微信"}),rules:[{required:Le.requireWechat,message:c.formatMessage({id:"ticket.form.wechat.required",defaultMessage:"请输入微信号"})},{max:50,message:c.formatMessage({id:"ticket.form.wechat.maxlength",defaultMessage:"微信号不能超过50个字符"})}],placeholder:c.formatMessage({id:"ticket.form.wechat.placeholder",defaultMessage:"请输入微信号"})}),(0,ie.jsx)(X.Z,{name:"priority",label:c.formatMessage({id:"ticket.form.priority"}),options:[{label:c.formatMessage({id:"ticket.priority.lowest"}),value:S.JTO},{label:c.formatMessage({id:"ticket.priority.low"}),value:S.sbT},{label:c.formatMessage({id:"ticket.priority.medium"}),value:S.GMZ},{label:c.formatMessage({id:"ticket.priority.high"}),value:S.Bt2},{label:c.formatMessage({id:"ticket.priority.urgent"}),value:S._Xr},{label:c.formatMessage({id:"ticket.priority.critical"}),value:S.Lx6}],rules:[{required:!0}]}),(0,ie.jsx)(V.A.Item,{name:"departmentUid",label:c.formatMessage({id:"ticket.form.department",defaultMessage:"所属部门"}),children:(0,ie.jsx)(O.Z,{style:{width:"100%"},treeData:$e,showSearch:!0,treeDefaultExpandAll:!1,popupMatchSelectWidth:!1,placeholder:c.formatMessage({id:"ticket.form.department.placeholder",defaultMessage:"请选择内部部门"}),onChange:function(e){return Ye(e||S.zBg)},allowClear:!1})}),(0,ie.jsx)(X.Z,{name:"assigneeUid",label:c.formatMessage({id:"ticket.form.assignee"}),options:ae.map((function(e){var t;return{label:e.nickname||(null===(t=e.user)||void 0===t?void 0:t.nickname),value:e.uid}})),placeholder:c.formatMessage({id:"ticket.form.assignee.placeholder"}),fieldProps:{onChange:function(e){var t=ae.find((function(t){return t.uid===e}));me(t||{uid:"",nickname:""})}},disabled:0===ae.length}),(0,ie.jsx)(X.Z,{name:"threadUid",label:c.formatMessage({id:"ticket.form.thread"}),options:b,fieldProps:{showSearch:!0,popupMatchSelectWidth:!1,optionLabelProp:"label",classNames:{popup:{root:"ticket-thread-select-dropdown"}},optionRender:function(e){return C(e)},filterOption:function(e,t){var r=t,n=e.toLowerCase();return((null==r?void 0:r.dataSearch)||"").includes(n)}},placeholder:c.formatMessage({id:"ticket.form.thread.placeholder"})}),ve&&(0,ie.jsx)(Y.Z,{type:S.hcJ,isModalOpen:ve,attachments:null==a?void 0:a.attachments,handleSubmit:function(e){var t;W.Z.debug("handleSubmit",e);var r=e||[];if(n&&null!=a&&null!==(t=a.attachments)&&void 0!==t&&t.length){var i=new Set((a.attachments||[]).map((function(e){var t;return null===(t=e.upload)||void 0===t?void 0:t.uid})).filter((function(e){return Boolean(e)}))),o=r.filter((function(e){return!i.has(e.uid)}));Me(o)}else Me(r);he(!1)},handleCancel:function(){he(!1)}}),(0,ie.jsx)("div",{style:{marginTop:"16px",marginBottom:"16px",maxHeight:"200px",overflowY:"auto"},children:(0,ie.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"12px"},children:ye.map((function(e){return(0,ie.jsx)(K.Z,{file:e,onDelete:tt},e.uid)}))})}),Be&&Ae.length>0&&(0,ie.jsxs)("div",{style:{marginTop:16,marginBottom:16},children:[(0,ie.jsx)("div",{style:{fontSize:14,fontWeight:500,marginBottom:12},children:c.formatMessage({id:"ticket.form.customFields",defaultMessage:"自定义字段"})}),Ae.map((function(e,t){var r,n=Pe(e,t),a="dynamicField_".concat(n),i=m((null==e?void 0:e.label)||(null==e?void 0:e.title)||(null==e?void 0:e.name)||n),o=(null==e?void 0:e.type)||(null==e?void 0:e.componentType)||"text",s=null!==(r=null==e?void 0:e.required)&&void 0!==r&&r,l=m((null==e?void 0:e.placeholder)||"请输入".concat(i));if("textarea"===o)return(0,ie.jsx)(H.Z,{name:a,label:i,rules:[{required:s,message:"请输入".concat(i)}],placeholder:l,fieldProps:{rows:4}},a);if("select"===o||"dropdown"===o){var d=(null==e?void 0:e.options)||(null==e?void 0:e.choices)||[];return(0,ie.jsx)(X.Z,{name:a,label:i,rules:[{required:s,message:"请选择".concat(i)}],placeholder:l,options:d.map((function(e){return{label:m((null==e?void 0:e.label)||(null==e?void 0:e.text)||e),value:(null==e?void 0:e.value)||e}}))},a)}return"number"===o?(0,ie.jsx)(de.Z,{name:a,label:i,rules:[{required:s,message:"请输入".concat(i)}],placeholder:l},a):(0,ie.jsx)(J.Z,{name:a,label:i,rules:[{required:s,message:"请输入".concat(i)}],placeholder:l},a)}))]}),(0,ie.jsx)(_.ZP,{icon:(0,ie.jsx)($.Z,{}),onClick:function(){return he(!0)},children:c.formatMessage({id:"ticket.form.upload.button"})})]})})},fe=r(58620),me=r(1774),pe=r(93953),ge=r(27060),ve=r(96955),he=function(e){var t=e.ticket,r=e.isThreadTicket,n=void 0!==r&&r,a=(0,M.u)((function(e){return e.currentOrg})),i=(0,z.useState)([]),o=k()(i,2),s=o[0],l=o[1],d=(0,z.useState)(!1),u=k()(d,2),c=u[0],f=u[1],m=(0,N.useIntl)();console.log("currentTicket",t,c);var g=(0,me.Z)(),h=g.memberResult,b=g.setMemberResult,w=function(){var e=v()(p()().mark((function e(){var r,n;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,f(!0),r={pageNumber:0,pageSize:100,uid:null==t?void 0:t.uid},e.next=7,(0,y.EH)(r);case 7:n=e.sent,console.log("queryTicketHistoryActivity response:",null==n?void 0:n.data),200===n.code?l((null==n?void 0:n.data)||[]):(console.log("queryTicketHistoryActivity error:",null==n?void 0:n.data),x.yw.error(n.message)),f(!1),e.next=18;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("Fetch ticket history error:",e.t0),x.yw.error("获取工单历史记录失败"),f(!1);case 18:case"end":return e.stop()}}),e,null,[[2,13]])})));return function(){return e.apply(this,arguments)}}(),j=function(){var e=v()(p()().mark((function e(){var t,r;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return x.yw.loading("loading"),t={pageNumber:0,pageSize:100,orgUid:null==a?void 0:a.uid},e.next=4,(0,te.z_)(t);case 4:200===(r=e.sent).code?(x.yw.destroy(),b(r)):x.yw.destroy();case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,z.useEffect)((function(){n||(w(),j())}),[t]);var U=function(e){if(!e)return"-";var t=h.data.content.find((function(t){return t.uid===e}));return(null==t?void 0:t.nickname)||""};return(0,ie.jsx)(ie.Fragment,{children:(0,ie.jsxs)(pe.Z,{spinning:c,children:[(0,ie.jsx)("p",{style:{fontSize:"16px",fontWeight:"bold",textAlign:"center"},children:"活动历史"}),(0,ie.jsx)(ge.Z,{direction:"vertical",size:"small",current:s.length-1,style:{padding:"16px"},items:s.map((function(e,t){var r,n;return{title:(n=null==e?void 0:e.activityName,(n?n===S.sM_||n===S.Yux||n===S.sFW||n===S.W66||n===S.z1||n===S.yZA||n===S.pIN||n===S.XrC||n===S.L1h||n===S.yib||n===S.hwr||n===S.AzB||n===S.frw||n===S.xw4||n===S.qQU||n===S.GJZ?m.formatMessage({id:"ticket.status.".concat((n||"").toLowerCase())}):n:"")||"活动"),description:(0,ie.jsxs)("div",{children:[(null==e?void 0:e.assignee)&&(0,ie.jsxs)("div",{children:["处理人: ",U(null==e?void 0:e.assignee)||(null==e?void 0:e.assignee)]}),(0,ie.jsxs)("div",{children:["处理时间: ",(null===(r=e.startTime)||void 0===r?void 0:r.toLocaleString())||"-"]})]}),status:t===s.length-1?"process":"finish"}}))}),0===s.length&&(0,ie.jsx)(ve.Z,{description:"请选择工单查看流转过程"})]})})},ke=function(e){var t=e.open,r=e.ticket,n=e.onClose;return(0,ie.jsx)(ie.Fragment,{children:(0,ie.jsx)(P.Z,{open:t,onClose:function(){n()},title:"工单详情",children:(0,ie.jsx)(he,{ticket:r,isThreadTicket:!1})})})},xe=["current","pageSize"],ye=function(e){var t,r=e.ticketType,n=e.superUser,i=void 0!==n&&n,s=(0,N.useIntl)(),d=(0,z.useRef)(),c=(0,z.useState)(1),m=k()(c,2),g=m[0],h=m[1],T=(0,z.useState)(10),L=k()(T,2),A=L[0],P=L[1],R=(0,M.u)((function(e){return e.currentOrg})),O=(0,j.Z)().translateString,V=(0,b.v)((function(e){return e.currentCategory})),J=(0,b.v)((function(e){return e.categoryResult})),X=(0,w.H)((function(e){return e.departmentResult})),H=(0,z.useState)(!1),Y=k()(H,2),G=Y[0],Q=Y[1],$=(0,z.useState)(!1),K=k()($,2),ee=K[0],te=K[1],re=(0,z.useState)(),ne=k()(re,2),ae=ne[0],oe=ne[1],se=(0,z.useState)(!1),de=k()(se,2),ue=de[0],me=de[1],pe=E.Z.useModal(),ge=k()(pe,2),ve=ge[0],he=ge[1],ye=(0,z.useState)(!1),Me=k()(ye,2),be=Me[0],we=Me[1],je=(0,z.useState)([]),Se=k()(je,2),Ue=Se[0],Fe=Se[1],Ze=(0,z.useState)([]),Ce=k()(Ze,2),Ne=Ce[0],Ee=Ce[1],Ie=(0,z.useState)({}),_e=k()(Ie,2),qe=_e[0],De=_e[1],Te=(0,z.useState)(0),Be=k()(Te,2),ze=Be[0],Le=Be[1],Ae=(0,z.useMemo)((function(){var e,t=new Map;return function e(r){null!=r&&r.length&&r.forEach((function(r){var n;null!=r&&r.uid&&(t.set(r.uid,r),null!==(n=r.children)&&void 0!==n&&n.length&&e(r.children))}))}(null==J||null===(e=J.data)||void 0===e?void 0:e.content),t}),[J]),Pe=(0,z.useMemo)((function(){var e,t=new Map;return function e(r){null!=r&&r.length&&r.forEach((function(r){var n;null!=r&&r.uid&&(t.set(r.uid,r),null!==(n=r.children)&&void 0!==n&&n.length&&e(r.children))}))}(null==X||null===(e=X.data)||void 0===e?void 0:e.content),t}),[X]);(0,z.useEffect)((function(){var e;null===(e=d.current)||void 0===e||e.reload()}),[null==V?void 0:V.uid,r]);var Re=function(){var e=v()(p()().mark((function e(t){var r,n;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,y.M4)(t.uid);case 2:200===(r=e.sent).code?(x.yw.success(s.formatMessage({id:"delete.success",defaultMessage:"删除成功"})),null===(n=d.current)||void 0===n||n.reload()):x.yw.error(r.message);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Oe=function(){var e=v()(p()().mark((function e(){var t,r,n,a,i,o;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==Ne.length){e.next=3;break}return x.yw.warning(s.formatMessage({id:"batch.delete.noselection",defaultMessage:"请选择要删除的项目"})),e.abrupt("return");case 3:x.yw.loading(s.formatMessage({id:"deleting",defaultMessage:"正在删除..."})),r=0,n=0,a=f()(Ne),e.prev=7,a.s();case 9:if((i=a.n()).done){e.next=23;break}return o=i.value,e.prev=11,e.next=14,(0,y.M4)(o.uid);case 14:200===e.sent.code?r++:n++,e.next=21;break;case 18:e.prev=18,e.t0=e.catch(11),n++;case 21:e.next=9;break;case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(7),a.e(e.t1);case 28:return e.prev=28,a.f(),e.finish(28);case 31:x.yw.destroy(),0===n?x.yw.success(s.formatMessage({id:"batch.delete.success",defaultMessage:"成功删除 {count} 条记录"},{count:r})):x.yw.warning(s.formatMessage({id:"batch.delete.partial",defaultMessage:"成功删除 {success} 条记录，失败 {fail} 条"},{success:r,fail:n})),Fe([]),Ee([]),null===(t=d.current)||void 0===t||t.reloadAndRest();case 36:case"end":return e.stop()}}),e,null,[[7,25,28,31],[11,18]])})));return function(){return e.apply(this,arguments)}}(),We=function(){var e=v()(p()().mark((function e(t,n,a){var o,s;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=localStorage.getItem(S.LA8),s=u()(u()({categoryUid:(null==V?void 0:V.uid)===S.zBg?"":null==V?void 0:V.uid,orgUid:(null==R?void 0:R.uid)||"",accessToken:o||"",exportType:t,type:r},i?{superUser:"true"}:{}),qe),"current"===t?(s.pageNumber=String(g-1),s.pageSize=String(A)):"all"===t?(s.pageNumber="0",s.pageSize="1000"):"range"===t&&void 0!==n&&void 0!==a&&(s.pageNumber=String(n),s.pageSize=String(a)),window.open((0,fe.kG)()+"/api/v1/ticket/export?"+new URLSearchParams(s).toString());case 4:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),Ve=function(e){for(var t=[],r=1e3,n=Math.ceil(e/r),a=function(){var n=i,a=i*r+1,o=Math.min((i+1)*r,e);t.push({key:"export-".concat(i),label:"".concat(a,"-").concat(o," (").concat(o-a+1,"条)"),onClick:function(){return We("range",n,r)}})},i=0;i<n;i++)a();return t},Je={selectedRowKeys:Ue,onChange:function(e,t){Fe(e),Ee(t)}},Xe=function(){Q(!1),te(!1),oe(void 0),me(!1)},He=function(){var e;null===(e=d.current)||void 0===e||e.reload(),Xe()},Ye=r===S.dCh,Ge=!Ye,Qe=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left",align:"center"},{title:s.formatMessage({id:"ticket.number",defaultMessage:"工单编号"}),dataIndex:"ticketNumber",key:"ticketNumber",width:150},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.description"}),dataIndex:"description",ellipsis:!0,tooltip:s.formatMessage({id:"ticket.description.tooltip"})},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status"}),dataIndex:"status",tooltip:s.formatMessage({id:"ticket.status.tooltip"}),valueType:"select",valueEnum:(t={},o()(o()(o()(o()(o()(o()(o()(o()(o()(o()(t,S.sM_,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.sM_.toLowerCase())}),status:"Processing"}),S.Yux,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.Yux.toLowerCase())}),status:"Processing"}),S.sFW,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.sFW.toLowerCase())}),status:"Processing"}),S.W66,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.W66.toLowerCase())}),status:"Warning"}),S.z1,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.z1.toLowerCase())}),status:"Processing"}),S.yZA,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.yZA.toLowerCase())}),status:"Processing"}),S.pIN,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.pIN.toLowerCase())}),status:"Warning"}),S.XrC,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.XrC.toLowerCase())}),status:"Warning"}),S.L1h,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.L1h.toLowerCase())}),status:"Processing"}),S.yib,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.yib.toLowerCase())}),status:"Warning"}),o()(o()(o()(o()(o()(o()(t,S.hwr,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.hwr.toLowerCase())}),status:"Success"}),S.AzB,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.AzB.toLowerCase())}),status:"Warning"}),S.frw,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.frw.toLowerCase())}),status:"Default"}),S.xw4,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.xw4.toLowerCase())}),status:"Error"}),S.qQU,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.qQU.toLowerCase())}),status:"Success"}),S.GJZ,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(S.GJZ.toLowerCase())}),status:"Error"})),render:function(e,t){var r;if(null==t||!t.status)return(0,ie.jsx)(q.Z,{color:"default",children:s.formatMessage({id:"ticket.status.unset",defaultMessage:"未设置状态"})});var n=(r={},o()(o()(o()(o()(o()(o()(o()(o()(o()(o()(r,S.sM_,"blue"),S.Yux,"geekblue"),S.sFW,"cyan"),S.W66,"magenta"),S.z1,"processing"),S.yZA,"lime"),S.pIN,"warning"),S.XrC,"orange"),S.L1h,"cyan"),S.yib,"volcano"),o()(o()(o()(o()(o()(o()(r,S.hwr,"success"),S.AzB,"purple"),S.frw,"default"),S.xw4,"error"),S.qQU,"green"),S.GJZ,"red"));return(0,ie.jsx)(q.Z,{color:n[null==t?void 0:t.status],children:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.status.".concat(((null==t?void 0:t.status)||"").toLowerCase())})})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority"}),dataIndex:"priority",tooltip:s.formatMessage({id:"ticket.priority.tooltip"}),valueType:"select",valueEnum:o()(o()(o()(o()(o()(o()({},S.JTO,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(S.JTO.toLowerCase())}),status:"Default"}),S.sbT,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(S.sbT.toLowerCase())}),status:"Processing"}),S.GMZ,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(S.GMZ.toLowerCase())}),status:"Warning"}),S.Bt2,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(S.Bt2.toLowerCase())}),status:"Warning"}),S._Xr,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(S._Xr.toLowerCase())}),status:"Error"}),S.Lx6,{text:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(S.Lx6.toLowerCase())}),status:"Error"}),render:function(e,t){var r=o()(o()(o()(o()(o()(o()({},S.JTO,"default"),S.sbT,"blue"),S.GMZ,"orange"),S.Bt2,"volcano"),S._Xr,"red"),S.Lx6,"purple");return(0,ie.jsx)(q.Z,{color:r[null==t?void 0:t.priority],children:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.priority.".concat(((null==t?void 0:t.priority)||"").toLowerCase())})})}}].concat(l()(Ye?[{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.level",defaultMessage:"工单级别"}),dataIndex:"level",key:"level",hideInSearch:!0,width:120,tooltip:s.formatMessage({id:"ticket.level.tooltip",defaultMessage:"外部工单的级别：平台工单 / 组织工单"}),render:function(e,t){var r=(null==t?void 0:t.level)===S.Hxq;return(0,ie.jsx)(q.Z,{color:r?"gold":"blue",children:r?s.formatMessage({id:"ticket.level.platform",defaultMessage:"平台工单"}):s.formatMessage({id:"ticket.level.org",defaultMessage:"组织工单"})})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.contactName",defaultMessage:"联系人"}),dataIndex:"contactName",key:"contactName",hideInSearch:!0,width:120,tooltip:s.formatMessage({id:"ticket.contactName.tooltip",defaultMessage:"联系人姓名"}),render:function(e,t){return t.contactName?(0,ie.jsx)("span",{children:t.contactName}):(0,ie.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.phone",defaultMessage:"电话"}),dataIndex:"phone",key:"phone",hideInSearch:!0,width:130,tooltip:s.formatMessage({id:"ticket.phone.tooltip",defaultMessage:"联系电话"}),render:function(e,t){return t.phone?(0,ie.jsx)("span",{children:t.phone}):(0,ie.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.email",defaultMessage:"邮箱"}),dataIndex:"email",key:"email",hideInSearch:!0,width:180,ellipsis:!0,tooltip:s.formatMessage({id:"ticket.email.tooltip",defaultMessage:"联系邮箱"}),render:function(e,t){return t.email?(0,ie.jsx)("span",{children:t.email}):(0,ie.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.wechat",defaultMessage:"微信"}),dataIndex:"wechat",key:"wechat",hideInSearch:!0,width:130,tooltip:s.formatMessage({id:"ticket.wechat.tooltip",defaultMessage:"联系微信"}),render:function(e,t){return t.wechat?(0,ie.jsx)("span",{children:t.wechat}):(0,ie.jsx)("span",{style:{color:"#999"},children:"-"})}}]:[]),[{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.category"}),dataIndex:"categoryUid",key:"categoryUid",hideInSearch:!0,width:180,tooltip:s.formatMessage({id:"ticket.category.tooltip",defaultMessage:"工单所属分类"}),render:function(e,t){if(!t.categoryUid)return(0,ie.jsx)(q.Z,{color:"default",children:s.formatMessage({id:"ticket.category.unset",defaultMessage:"未设置分类"})});var r=Ae.get(t.categoryUid);return r?(0,ie.jsx)(q.Z,{color:"green",children:O(r.name)||r.name||r.uid}):(0,ie.jsx)(q.Z,{color:"default",children:s.formatMessage({id:"ticket.category.missing",defaultMessage:"未知分类"})})}}],l()(Ge?[{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.department",defaultMessage:"所属部门"}),dataIndex:"departmentUid",key:"departmentUid",hideInSearch:!0,width:200,tooltip:s.formatMessage({id:"ticket.department.tooltip",defaultMessage:"工单所属部门"}),render:function(e,t){if(!t.departmentUid)return(0,ie.jsx)(q.Z,{color:"default",children:s.formatMessage({id:"ticket.department.unset",defaultMessage:"未设置部门"})});var r=Pe.get(t.departmentUid);if(!r)return(0,ie.jsx)(q.Z,{color:"default",children:s.formatMessage({id:"ticket.department.missing",defaultMessage:"未知部门"})});var n=O(r.name||r.name)||r.name||r.name||r.uid;return(0,ie.jsx)(q.Z,{color:"purple",children:n})}}]:[]),[{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.assignee"}),dataIndex:"assignee",hideInSearch:!0,tooltip:s.formatMessage({id:"ticket.assignee.tooltip"}),render:function(e,t,r,n){var a;return(0,ie.jsx)(q.Z,{color:"blue",children:null==t||null===(a=t.assignee)||void 0===a?void 0:a.nickname})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.reporter"}),dataIndex:"reporter",hideInSearch:!0,tooltip:s.formatMessage({id:"ticket.reporter.tooltip"}),render:function(e,t,r,n){var a;return(0,ie.jsx)(q.Z,{color:"red",children:null==t||null===(a=t.reporter)||void 0===a?void 0:a.nickname})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.schema"}),dataIndex:"schema",hideInSearch:!0,ellipsis:!0,width:300,tooltip:s.formatMessage({id:"ticket.schema.tooltip"}),render:function(e,t){if(!t.schema)return(0,ie.jsx)("span",{style:{color:"#999"},children:"-"});try{var r=JSON.parse(t.schema);if(r.formData&&Object.keys(r.formData).length>0){var n=Object.entries(r.formData).filter((function(e){var t=k()(e,2),r=(t[0],t[1]);return null!=r&&""!==r})).map((function(e){var t,n=k()(e,2),a=n[0],i=n[1],o=(null===(t=r.fieldLabels)||void 0===t?void 0:t[a])||a,s=String(i);return"".concat(o,": ").concat(s.length>20?s.substring(0,20)+"...":s)}));return 0===n.length?(0,ie.jsx)("span",{style:{color:"#999"},children:"-"}):(0,ie.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",maxHeight:"60px",overflow:"hidden"},children:n.map((function(e,t){return(0,ie.jsx)(q.Z,{color:"geekblue",style:{fontSize:"11px",padding:"1px 4px"},children:e},t)}))})}}catch(e){console.error("解析 schema 数据失败:",e)}return(0,ie.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"createdAt"}),dataIndex:"createdAt",valueType:"dateTime",hideInSearch:!0,sorter:!0,tooltip:s.formatMessage({id:"ticket.createdAt.tooltip"}),render:function(e,t,r,n){return B()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"updatedAt"}),dataIndex:"updatedAt",valueType:"dateTime",hideInSearch:!0,sorter:!0,tooltip:s.formatMessage({id:"ticket.updatedAt.tooltip"}),render:function(e,t,r,n){return B()(t.updatedAt).format("YYYY-MM-DD HH:mm:ss")}},{title:(0,ie.jsx)(N.FormattedMessage,{id:"action"}),key:"option",dataIndex:"option",hideInSearch:!0,width:200,fixed:"right",tooltip:s.formatMessage({id:"ticket.action.tooltip"}),render:function(e,t){return(0,ie.jsxs)(ie.Fragment,{children:[(0,ie.jsx)(_.ZP,{type:"link",onClick:function(){return oe(e=t),me(!0),void("INTERNAL"===e.type?Q(!0):te(!0));var e},children:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.action.edit"})}),(0,ie.jsx)(_.ZP,{type:"link",onClick:function(){return oe(t),void we(!0)},children:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.action.view"})}),(0,ie.jsx)(D.Z,{title:s.formatMessage({id:"deleteTip"}),description:"".concat(s.formatMessage({id:"deleteAffirm"}),"【").concat(t.description,"】？"),onConfirm:function(){return Re(t)},okText:s.formatMessage({id:"ok"}),cancelText:s.formatMessage({id:"cancel"}),children:(0,ie.jsx)(_.ZP,{type:"link",children:(0,ie.jsx)(N.FormattedMessage,{id:"ticket.action.delete"})})})]})}}]);return(0,ie.jsxs)(ie.Fragment,{children:[(0,ie.jsx)(C.Z,{columns:Qe,actionRef:d,cardBordered:!0,rowSelection:Je,scroll:{x:2800},request:function(){var e=v()(p()().mark((function e(t,n,o){var s,l,d,c,f,m,g,v;return p()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.current,l=t.pageSize,d=a()(t,xe),h(s),P(l),De(u()(u()({},d),{},{type:r})),c=void 0,f=void 0,n&&Object.keys(n).length>0&&(m=Object.keys(n)[0],c=m,f="ascend"===n[m]?"ascend":"descend"),g=u()(u()(u()(u()({pageNumber:s-1,pageSize:l,orgUid:null==R?void 0:R.uid,type:r},i&&{superUser:i}),(null==V?void 0:V.uid)!==S.zBg&&{categoryUid:null==V?void 0:V.uid}),d),{},{sortBy:c,sortDirection:f}),e.next=10,(0,y.N2)(g);case 10:return v=e.sent,W.Z.debug("queryTicketsByOrgUid response:",v,g),200===v.code?Le(null==v?void 0:v.data.totalElements):x.yw.error(v.message),e.abrupt("return",{data:null==v?void 0:v.data.content,success:!0,total:null==v?void 0:v.data.totalElements});case 14:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),editable:{type:"multiple"},rowKey:"uid",search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,onChange:function(e,t){h(e),t&&P(t)}},dateFormatter:"string",headerTitle:s.formatMessage({id:"ticket.list"}),toolBarRender:function(){var e=[],t=[{key:"export-current",icon:(0,ie.jsx)(U.Z,{}),label:s.formatMessage({id:"export.current",defaultMessage:"导出当前页"}),onClick:function(){return We("current")}}];ze>0&&(ze<=1e3?t.push({key:"export-all",icon:(0,ie.jsx)(U.Z,{}),label:s.formatMessage({id:"export.all",defaultMessage:"导出全部"})+" (".concat(ze,"条)"),onClick:function(){return We("all")}}):t.push({key:"export-range",icon:(0,ie.jsx)(U.Z,{}),label:s.formatMessage({id:"export.range",defaultMessage:"分段导出"})+" (".concat(ze,"条)"),children:Ve(ze)})),e.push((0,ie.jsx)(I.Z,{menu:{items:t},placement:"bottom",children:(0,ie.jsxs)(_.ZP,{type:"primary",icon:(0,ie.jsx)(U.Z,{}),children:[s.formatMessage({id:"import.export",defaultMessage:"导出"}),(0,ie.jsx)(F.Z,{})]})},"importExport"));var r=[];return Ue.length>0&&r.push({key:"batchDelete",icon:(0,ie.jsx)(Z.Z,{}),danger:!0,label:s.formatMessage({id:"batch.delete"})+" (".concat(Ue.length,")"),onClick:function(){ve.confirm({title:s.formatMessage({id:"batch.deleteTip"}),content:"".concat(s.formatMessage({id:"batch.deleteAffirm"})," ").concat(Ue.length," ").concat(s.formatMessage({id:"items"}),"?"),onOk:Oe,okText:s.formatMessage({id:"ok"}),cancelText:s.formatMessage({id:"cancel"})})}}),r.length>0&&e.push((0,ie.jsx)(I.Z,{menu:{items:r},placement:"bottom",children:(0,ie.jsxs)(_.ZP,{type:Ue.length>0?"primary":"default",danger:Ue.length>0,children:[Ue.length>0?s.formatMessage({id:"batch.operations",defaultMessage:"批量操作"})+" (".concat(Ue.length,")"):s.formatMessage({id:"more.operations",defaultMessage:"更多操作"}),(0,ie.jsx)(F.Z,{})]})},"batchOperations")),e}}),G&&(0,ie.jsx)(le,{open:G,isEdit:ue,currentTicket:ae,onCancel:Xe,onSuccess:He}),ee&&(0,ie.jsx)(ce,{open:ee,isEdit:ue,currentTicket:ae,onCancel:Xe,onSuccess:He}),be&&(0,ie.jsx)(ke,{open:be,ticket:ae,onClose:function(){return we(!1)}}),he]})}},36846:function(e,t,r){r.d(t,{H:function(){return m}});var n=r(86222),a=r.n(n),i=r(76711),o=r.n(i),s=r(73193),l=r.n(s),d=r(94976),u=r(26557),c=r(26407),f=r(20744),m=(0,u.Ue)()((0,c.mW)((0,c.tJ)((0,f.n)((function(e,t){return{departmentResult:{data:{content:[]}},currentDepartment:{uid:d.zBg,nickname:d.zBg},insertDepartment:function(t){e((function(e){var r=e.departmentResult.data.content;if(t.parentUid){var n=r.find((function(e){return e.uid===t.parentUid}));n&&(n.children||(n.children=[]),n.children.push(t))}else r.push(t)}))},upgradeDepartment:function(t){e((function(e){var r=e.departmentResult.data.content,n=r.findIndex((function(e){return e.uid===t.uid}));-1!==n?r[n]=t:r.forEach((function(e){if(e.children){var r=e.children.findIndex((function(e){return e.uid===t.uid}));-1!==r&&(e.children[r]=t)}}))}))},setDepartmentResult:function(r){var n,a={uid:d.zBg,name:d.zBg};(e({departmentResult:l()(l()({},r),{},{data:{content:[a].concat(o()(r.data.content))}})}),""===t().currentDepartment.uid)&&((null===(n=r.data)||void 0===n||null===(n=n.content)||void 0===n?void 0:n.length)>0&&e({currentDepartment:r.data.content[0]}))},setCurrentDepartment:function(r){var n=t().departmentResult.data.content,a=n.findIndex((function(e){return e.uid===r.uid}));if(-1!==a){var i=[].concat(o()(n.slice(0,a)),[r],o()(n.slice(a+1))),s=l()(l()({},t().departmentResult),{},{data:{content:i}});e({departmentResult:s,currentDepartment:r})}else console.warn("Department with the specified uid not found."),e({currentDepartment:r})},removeDepartment:function(r){e((function(e){var t=e.departmentResult.data.content;e.departmentResult.data.content=function e(t,r){return t.filter((function(t){return t.uid!==r&&(t.children&&(t.children=e(t.children,r)),!0)}))}(t,r)})),t().currentDepartment.uid===r&&e({currentDepartment:{uid:""}})},setCurrentDepUid:function(r){var n,i,o=null===(n=t().departmentResult)||void 0===n||null===(n=n.data)||void 0===n||null===(n=n.content)||void 0===n?void 0:n.find((function(e){return e.uid===r}));if(o)e({currentDepartment:o});else{!function t(n){var i,o=a()(n);try{for(o.s();!(i=o.n()).done;){var s=i.value;if(s.uid===r)return void e({currentDepartment:s});s.children&&s.children.length>0&&t(s.children)}}catch(e){o.e(e)}finally{o.f()}}((null===(i=t().departmentResult)||void 0===i||null===(i=i.data)||void 0===i?void 0:i.content)||[])}},deleteDepartmentCache:function(){return e({},!0)}}})),{name:d.xY_})))},1774:function(e,t,r){r.d(t,{Z:function(){return s}});var n=r(94976),a=r(26557),i=r(26407),o=r(20744),s=(0,a.Ue)()((0,i.mW)((0,i.tJ)((0,o.n)((function(e,t){return{memberResult:{data:{content:[],totalElements:0}},insertMember:function(t){e((function(e){e.memberResult.data.content.unshift(t)}))},updateMember:function(t){e((function(e){var r=e.memberResult.data.content,n=r.findIndex((function(e){return e.uid===t.uid}));-1!==n?r[n]=t:console.warn("Member with uid ".concat(t.uid," not found."))}))},deleteMember:function(t){e((function(e){var r=e.memberResult.data.content,n=r.findIndex((function(e){return e.uid===t.uid}));-1!==n?r.splice(n,1):console.warn("Member with uid ".concat(t.uid," not found."))}))},setMemberResult:function(t){e({memberResult:t})},deleteMemberCache:function(){return e({},!0)}}})),{name:n.PQL})))}}]);