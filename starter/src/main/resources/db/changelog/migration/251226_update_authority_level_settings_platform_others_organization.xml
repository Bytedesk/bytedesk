<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="251226-update-authority-level-settings-platform-others-organization" author="githubcopilot">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="bytedesk_core_authority" />
        </preConditions>
        <comment>
            Align authority.level_type with new rule:
            - SETTINGS_* authorities => PLATFORM
            - all other authorities => ORGANIZATION
        </comment>
        <sql>
            UPDATE bytedesk_core_authority
            SET level_type = 'PLATFORM'
            WHERE is_deleted = 0
              AND authority_value IS NOT NULL
                            AND authority_value &lt;&gt; ''
              AND authority_value LIKE 'SETTINGS_%'
                            AND (level_type IS NULL OR level_type &lt;&gt; 'PLATFORM');

            UPDATE bytedesk_core_authority
            SET level_type = 'ORGANIZATION'
            WHERE is_deleted = 0
              AND authority_value IS NOT NULL
                            AND authority_value &lt;&gt; ''
              AND authority_value NOT LIKE 'SETTINGS_%'
                            AND (level_type IS NULL OR level_type &lt;&gt; 'ORGANIZATION');
        </sql>
        <rollback>
            <comment>No rollback - align to canonical authority levels</comment>
        </rollback>
    </changeSet>

</databaseChangeLog>
