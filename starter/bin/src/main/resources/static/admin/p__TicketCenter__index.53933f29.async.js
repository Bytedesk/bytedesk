"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[9107],{51718:function(e,t,a){a.d(t,{Bg:function(){return d},Ch:function(){return g},Gv:function(){return M},L3:function(){return U},bD:function(){return p},mE:function(){return b},nQ:function(){return w},nU:function(){return k},oX:function(){return Z}});var r=a(90819),n=a.n(r),s=a(73193),i=a.n(s),o=a(89933),c=a.n(o),l=a(19736),u=a(6844);function d(e){return f.apply(this,arguments)}function f(){return(f=c()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/query/org",{method:"GET",params:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e){return m.apply(this,arguments)}function m(){return(m=c()(n()().mark((function e(t){var a,r,s;return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.orgUid,r=t.workgroupUid,s=t.type,e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/orgs/".concat(a,"/workgroups/").concat(r),{method:"GET",params:{channel:u.XtJ,type:s}}));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return h.apply(this,arguments)}function h(){return(h=c()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/publish",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function k(e){return v.apply(this,arguments)}function v(){return(v=c()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/delete",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function M(e){return x.apply(this,arguments)}function x(){return(x=c()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/create",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function b(e){return y.apply(this,arguments)}function y(){return(y=c()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/update",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e,t){return j.apply(this,arguments)}function j(){return(j=c()(n()().mark((function e(t,a){var r,s;return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.uid,s=t.orgUid,e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/".concat(r,"/orgs/").concat(s,"/bindings"),{method:"POST",data:i()(i()({},a),{},{channel:u.XtJ})}));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e){return S.apply(this,arguments)}function S(){return(S=c()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/bindings",{method:"GET",params:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(e,t){return E.apply(this,arguments)}function E(){return(E=c()(n()().mark((function e(t,a){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,l.request)("/api/v1/ticket/settings/orgs/".concat(t,"/workgroups/").concat(a,"/categories"),{method:"GET",params:{channel:u.XtJ}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},42779:function(e,t,a){a.r(t),a.d(t,{default:function(){return we}});var r=a(90819),n=a.n(r),s=a(89933),i=a.n(s),o=a(45332),c=a.n(o),l=a(83388),u=a(66810),d=a(3925),f=a(93755),p=a(44194),m=a(19736),g=a(6323),h=a(86307),k=a(34232),v=a(10270),M=a(2805),x=a(13215),b=(a(20131),a(9470)),y=a(65819),w=a(73193),j=a.n(w),Z=a(6844);function S(){return U.apply(this,arguments)}function U(){return(U=i()(n()().mark((function e(){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,m.request)("/api/v1/settings/platform/ticket-center",{method:"GET",params:{channel:Z.XtJ}}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var E=a(36125),C=a(26710),P=a(83910),N={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 10112 0 56 56 0 10-112 0zm0 284a56 56 0 10112 0 56 56 0 10-112 0zm0 284a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"unordered-list",theme:"outlined"},I=a(54183),q=function(e,t){return p.createElement(I.Z,(0,P.Z)({},e,{ref:t,icon:N}))};var D=p.forwardRef(q),F=a(10162),T=a(76711),A=a.n(T),R=a(61689),B=a(9428),O=a(29589),_=a(74491),z=a(30064),K=a(13847),G=a(68263),J=a(86684),L=a(93527),X=a(51718),V=a(56573),H=a(67728),W=a(58867),Q=a(93189),$=a(51891),Y=a(12792),ee=a(48907),te=a(48769),ae=a(86503),re=a(37326),ne=a(8327),se=a(78372),ie=a(87373),oe=a(41080),ce=a(65513),le=a(28523),ue=(a(77586),a(31549)),de=te.Z.TextArea,fe=ae.ZP.Group,pe=re.Z.Group;var me=function(e){var t=e.forms,a=void 0===t?[]:t,r=e.selectedFormUid,s=e.onFormSelect,o=e.onFormSubmit,l=e.loading,u=void 0!==l&&l,f=e.renderMode,g=void 0===f?"full":f,h=e.fieldNamePrefix,k=void 0===h?"":h,v=(0,p.useState)([]),M=c()(v,2),x=M[0],b=M[1],y=(0,p.useState)(null),w=c()(y,2),Z=w[0],S=w[1],U=W.Z.useForm(),E=c()(U,1)[0],C=(0,m.useIntl)(),P=function(e){try{var t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("解析表单schema失败:",e),[]}};(0,p.useEffect)((function(){if(r&&a.length>0){var e=a.find((function(e){return e.uid===r}));if(e)if(S(e),e.schema){var t=P(e.schema);b(t)}else b([])}else S(null),b([])}),[r,a]);var N=function(e){var t,a=function(e,t){switch(e){case"text":switch(t){case"email":return C.formatMessage({id:"ticket.form.placeholder.email",defaultMessage:"请输入邮箱地址"});case"tel":return C.formatMessage({id:"ticket.form.placeholder.tel",defaultMessage:"请输入电话号码"});case"textarea":return C.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入文本内容"});case"date":return C.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"datetime-local":return C.formatMessage({id:"ticket.form.placeholder.datetime",defaultMessage:"请选择日期时间"});default:return C.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}case"input":return C.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"});case"textarea":return C.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入多行文本"});case"select":return C.formatMessage({id:"ticket.form.placeholder.select",defaultMessage:"请选择"});case"datePicker":return C.formatMessage({id:"ticket.form.placeholder.date",defaultMessage:"请选择日期"});case"timePicker":return C.formatMessage({id:"ticket.form.placeholder.time",defaultMessage:"请选择时间"});default:return C.formatMessage({id:"ticket.form.placeholder.text",defaultMessage:"请输入"})}}(e.type,null===(t=e.props)||void 0===t?void 0:t.type);return function(e){var t=e.type,a=e.props,r=void 0===a?{}:a,n=e.options,s=e.placeholder,i=e.isDarkMode,o=void 0!==i&&i;if(!t)return null;var c=t.toLowerCase(),l=o?{backgroundColor:"#141414",borderColor:"#434343",color:"#fff"}:{},u=o?{backgroundColor:"#141414"}:{};switch(c){case"text":switch(r.type||"text"){case"email":return(0,ue.jsx)(te.Z,{type:"email",placeholder:s||"请输入邮箱地址",style:l});case"tel":return(0,ue.jsx)(te.Z,{type:"tel",placeholder:s||"请输入电话号码",style:l});case"textarea":return(0,ue.jsx)(de,{rows:r.rows||4,placeholder:s||"请输入文本内容",style:l});case"date":return(0,ue.jsx)(ne.ZP,{locale:le.Z,children:(0,ue.jsx)(se.default,{style:j()({width:"100%"},l),placeholder:s||"请选择日期"})});case"datetime-local":return(0,ue.jsx)(ne.ZP,{locale:le.Z,children:(0,ue.jsx)(se.default,{showTime:!0,style:j()({width:"100%"},l),placeholder:s||"请选择日期时间"})});case"file":return(0,ue.jsx)(ie.Z,{accept:r.accept,children:(0,ue.jsx)(d.ZP,{style:o?{backgroundColor:"#1f1f1f",borderColor:"#434343",color:"#fff"}:{},children:"点击上传文件"})});default:return(0,ue.jsx)(te.Z,{placeholder:s||"请输入",style:l})}case"input":return(0,ue.jsx)(te.Z,{placeholder:s||"请输入",style:l});case"textarea":return(0,ue.jsx)(de,{rows:4,placeholder:s||"请输入多行文本",style:l});case"select":return(0,ue.jsx)(O.Z,{style:j()({width:"100%"},u),placeholder:s||"请选择",classNames:o?{popup:{root:"dark-mode-select"}}:void 0,options:Array.isArray(n)?n.map((function(e,t){return{label:e,value:e,key:"".concat(e,"-").concat(t)}})):[{label:"选项1",value:"1",key:"option-1"},{label:"选项2",value:"2",key:"option-2"}]});case"radio":return(0,ue.jsx)(fe,{style:o?{color:"#fff"}:{},children:(Array.isArray(n)?n:["选项1","选项2"]).map((function(e,t){return(0,ue.jsx)(ae.ZP,{value:e,style:o?{color:"#fff"}:{},children:e},"".concat(e,"-").concat(t))}))});case"checkbox":return(0,ue.jsx)(pe,{style:o?{color:"#fff"}:{},options:Array.isArray(n)?n.map((function(e,t){return{label:e,value:e,key:"".concat(e,"-").concat(t),style:o?{color:"#fff"}:{}}})):[{label:"选项1",value:"1",key:"option-1",style:o?{color:"#fff"}:{}},{label:"选项2",value:"2",key:"option-2",style:o?{color:"#fff"}:{}}]});case"datepicker":return(0,ue.jsx)(ne.ZP,{locale:le.Z,children:(0,ue.jsx)(se.default,{style:j()({width:"100%"},l),placeholder:s||"请选择日期",classNames:o?{popup:{root:"dark-mode-picker"}}:void 0})});case"timepicker":return(0,ue.jsx)(ne.ZP,{locale:le.Z,children:(0,ue.jsx)(oe.Z,{style:j()({width:"100%"},l),placeholder:s||"请选择时间",classNames:o?{popup:{root:"dark-mode-picker"}}:void 0})});case"switch":return(0,ue.jsx)(ce.Z,{checkedChildren:"开",unCheckedChildren:"关"});case"upload":return(0,ue.jsx)(ie.Z,{accept:r.accept,children:(0,ue.jsx)(d.ZP,{style:o?{backgroundColor:"#1f1f1f",borderColor:"#434343",color:"#fff"}:{},children:"点击上传"})});default:return console.log("Unknown component type:",t),(0,ue.jsxs)("div",{children:["未知组件类型: ",t]})}}({type:e.type,props:e.props,options:e.options,placeholder:a,isDarkMode:!1})},I=function(){var e=i()(n()().mark((function e(t){return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!o){e.next=6;break}return e.next=4,o(t);case 4:Q.ZP.success(C.formatMessage({id:"ticket.form.submit.success",defaultMessage:"表单提交成功"})),E.resetFields();case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("表单提交失败:",e.t0),Q.ZP.error(C.formatMessage({id:"ticket.form.submit.error",defaultMessage:"表单提交失败"}));case 12:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}();if("fields-only"===g){if(!r||!a.length)return null;var q=a.find((function(e){return e.uid===r}));if(!q||!q.schema)return null;var D=P(q.schema);return D.length?(0,ue.jsx)(ue.Fragment,{children:D.map((function(e,t){return(0,ue.jsx)(W.Z.Item,{name:"".concat(k).concat(e.id||"field-".concat(t)),label:e.label,rules:[{required:e.required,message:C.formatMessage({id:"ticket.form.required",defaultMessage:"{label}是必填项"},{label:e.label})}],children:N(e)},e.id||"field-".concat(t))}))}):null}return 0===a.length?(0,ue.jsx)($.Z,{title:C.formatMessage({id:"ticket.form.title",defaultMessage:"工单表单"}),children:(0,ue.jsx)(Y.Z,{description:C.formatMessage({id:"ticket.form.empty",defaultMessage:"暂无可用的工单表单"})})}):(0,ue.jsxs)($.Z,{title:C.formatMessage({id:"ticket.form.title",defaultMessage:"工单表单"}),children:[(0,ue.jsx)(O.Z,{style:{width:"100%",marginBottom:16},placeholder:C.formatMessage({id:"ticket.form.select.placeholder",defaultMessage:"请选择工单表单"}),value:r,onChange:function(e){s&&s(e)},options:a.map((function(e){return{label:e.name,value:e.uid,disabled:"PUBLISHED"!==e.status}}))}),Z&&(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(ee.Z,{orientation:"left",children:Z.name}),Z.description&&(0,ue.jsx)("p",{style:{color:"#666",marginBottom:16},children:Z.description}),x.length>0?(0,ue.jsxs)(W.Z,{form:E,layout:"vertical",onFinish:I,style:{maxWidth:"100%"},children:[Z&&x.length?(0,ue.jsx)(ue.Fragment,{children:x.map((function(e,t){return(0,ue.jsx)(W.Z.Item,{name:"".concat(k).concat(e.id||"field-".concat(t)),label:e.label,rules:[{required:e.required,message:C.formatMessage({id:"ticket.form.required",defaultMessage:"{label}是必填项"},{label:e.label})}],children:N(e)},e.id||"field-".concat(t))}))}):null,(0,ue.jsx)(W.Z.Item,{children:(0,ue.jsx)(d.ZP,{type:"primary",htmlType:"submit",loading:u,block:!0,children:C.formatMessage({id:"ticket.form.submit",defaultMessage:"提交表单"})})})]}):(0,ue.jsx)(Y.Z,{description:C.formatMessage({id:"ticket.form.fields.empty",defaultMessage:"该表单暂无字段配置"})})]})]})},ge=a(44679),he=a(59908),ke=a(34718),ve=a(69456),Me=function(e){return e?e.trim().replace(/\s+/g," ").slice(0,100):""},xe=function(e){var t=e.visible,a=e.onClose,r=e.orgUid,s=e.workgroupUid,o=(0,m.useIntl)(),l=(0,ge.Z)().translateString,u=z.A.useForm(),g=c()(u,1)[0],h=(0,p.useState)(!1),k=c()(h,2),v=k[0],M=k[1],x=(0,m.useModel)("@@initialState").initialState,b=(null!=x?x:{}).userInfo,w=(0,p.useMemo)((function(){return r||"df_org_uid"}),[r]),j=(0,p.useMemo)((function(){return s||""}),[s]),S=(0,p.useMemo)((function(){return"ticketFormSelection_".concat(w||"default")}),[w]),U=(0,p.useState)([]),C=c()(U,2),P=C[0],N=C[1],I=(0,p.useState)(""),q=c()(I,2),D=q[0],F=q[1],T=(0,p.useState)([]),W=c()(T,2),Q=W[0],$=W[1],Y=(0,p.useState)(!1),ee=c()(Y,2),te=ee[0],ae=ee[1],re=(0,p.useState)([]),ne=c()(re,2),se=ne[0],ie=ne[1],oe=(0,p.useState)(!1),ce=c()(oe,2),le=ce[0],de=(ce[1],(0,p.useState)([])),fe=c()(de,2),pe=fe[0],xe=fe[1],be=(0,p.useState)(!1),ye=c()(be,2),we=ye[0],je=ye[1],Ze=(0,p.useState)(!1),Se=c()(Ze,2),Ue=Se[0],Ee=Se[1],Ce=(0,p.useState)([]),Pe=c()(Ce,2),Ne=Pe[0],Ie=Pe[1],qe=(0,p.useMemo)((function(){return{contactName:(null==b?void 0:b.nickname)||(null==b?void 0:b.username)||"",email:(null==b?void 0:b.email)||"",phone:(null==b?void 0:b.mobile)||""}}),[b]),De=(0,p.useMemo)((function(){return[{label:o.formatMessage({id:"ticket.priority.lowest",defaultMessage:"最低"}),value:Z.JTO},{label:o.formatMessage({id:"ticket.priority.low",defaultMessage:"较低"}),value:Z.sbT},{label:o.formatMessage({id:"ticket.priority.medium",defaultMessage:"普通"}),value:Z.GMZ},{label:o.formatMessage({id:"ticket.priority.high",defaultMessage:"较高"}),value:Z.Bt2},{label:o.formatMessage({id:"ticket.priority.urgent",defaultMessage:"紧急"}),value:Z._Xr},{label:o.formatMessage({id:"ticket.priority.critical",defaultMessage:"最高"}),value:Z.Lx6}]}),[o]);(0,p.useEffect)((function(){E.Z.debug("TicketDrawer props orgUid:",r),E.Z.debug("TicketDrawer final orgUid:",w),E.Z.debug("TicketDrawer final workgroupUid:",j)}),[r,w,j]);var Fe=(0,p.useCallback)(function(){var e=i()(n()().mark((function e(t){var a,r,s;return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(w){e.next=3;break}return xe([]),e.abrupt("return");case 3:return je(!0),e.prev=4,r={pageNumber:0,pageSize:100,orgUid:w,deptUid:t&&t!==Z.zBg?t:void 0},e.next=8,(0,H.z_)(r);case 8:s=e.sent,E.Z.debug("工单可选成员列表:",null==s?void 0:s.data,r),200===(null==s?void 0:s.code)&&null!=s&&null!==(a=s.data)&&void 0!==a&&a.content?xe(s.data.content):xe([]),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(4),console.error("加载工单成员失败:",e.t0),xe([]);case 17:return e.prev=17,je(!1),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[4,13,17,20]])})));return function(t){return e.apply(this,arguments)}}(),[w]),Te=function(e){e&&Ie((function(t){return t.filter((function(t){return t.uid!==e}))}))},Ae=function(){return"undefined"==typeof window?"":localStorage.getItem(S)||""},Re=function(e){"undefined"!=typeof window&&(e?localStorage.setItem(S,e):localStorage.removeItem(S))};(0,p.useEffect)((function(){if(t){var e=Ae();e&&e!==D&&F(e)}}),[t,S,D]),(0,p.useEffect)((function(){if(t){g.setFieldsValue({status:Z.sM_,priority:Z.GMZ,departmentUid:Z.zBg,assigneeUid:void 0});var e=localStorage.getItem("admin_ticketDraft");e&&g.setFieldValue("description",e)}}),[t,g]),(0,p.useEffect)((function(){t&&Fe(Z.zBg)}),[t,Fe]),(0,p.useEffect)((function(){if(t){var e=g.getFieldsValue(["contactName","email","phone"]),a={};!e.contactName&&qe.contactName&&(a.contactName=qe.contactName),!e.email&&qe.email&&(a.email=qe.email),!e.phone&&qe.phone&&(a.phone=qe.phone),Object.keys(a).length>0&&g.setFieldsValue(a)}}),[t,qe,g]),(0,p.useEffect)((function(){if(t&&w&&0===P.length){var e=function(){var e=i()(n()().mark((function e(){var t,a,r,s,i,o;return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a={orgUid:w,type:Z.wE_,status:Z.eiy,pageNumber:0,pageSize:100},e.next=4,(0,V.xg)(a);case 4:if(r=e.sent,E.Z.debug("工单表单列表:",null==r?void 0:r.data,a),200!==(null==r?void 0:r.code)||null==r||null===(t=r.data)||void 0===t||!t.content){e.next=16;break}if(s=null==r?void 0:r.data.content.filter((function(e){return"PUBLISHED"===e.status})),N(s),s.length){e.next=13;break}return F(""),Re(""),e.abrupt("return");case 13:i=Ae(),i&&s.some((function(e){return e.uid===i}))?F(i):1===s.length?(o=s[0].uid||"",F(o),Re(o)):(F(""),Re(""));case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(0),console.error("加载工单表单列表失败:",e.t0);case 21:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(){return e.apply(this,arguments)}}();e()}}),[t,w,P.length,S]),(0,p.useEffect)((function(){if(t){if(!w||!j)return E.Z.warn("TicketDrawer missing orgUid or workgroupUid, skip fetching categories"),$([]),void g.setFieldValue("categoryUid",void 0);var e=!1,a=function(){var t=i()(n()().mark((function t(){var a,r,s;return n()().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return ae(!0),t.prev=1,t.next=4,(0,X.L3)(w,j);case 4:a=t.sent,E.Z.debug("工单分类列表:",null==a?void 0:a.data,w,j),!e&&200===(null==a?void 0:a.code)&&null!=a&&a.data&&(r=(null==a?void 0:a.data.categories)||[],s=r.map((function(e){return{label:l(e.name),value:e.uid}})),$(s)),t.next=13;break;case 9:t.prev=9,t.t0=t.catch(1),console.error("加载工单分类列表失败:",t.t0),e||$([]);case 13:return t.prev=13,e||ae(!1),t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[1,9,13,16]])})));return function(){return t.apply(this,arguments)}}();return a(),function(){e=!0}}}),[t,w,j,g]);var Be=function(e){try{var t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("解析表单schema失败:",e),[]}},Oe=function(){var e=i()(n()().mark((function e(t){var r,s,i,c,l,u,d,p,m,h,k,v,x,y,S,U;return n()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(w){e.next=3;break}return L.yw.error(o.formatMessage({id:"ticket.create.org.missing",defaultMessage:"缺少组织信息，无法创建工单"})),e.abrupt("return",!1);case 3:if(j){e.next=6;break}return L.yw.error(o.formatMessage({id:"ticket.create.workgroup.missing",defaultMessage:"缺少工作组信息，无法创建工单"})),e.abrupt("return",!1);case 6:return e.prev=6,M(!0),c=t.description||"",l=Me(c),u=t.priority||Z.GMZ,d=t.departmentUid&&t.departmentUid!==Z.zBg?t.departmentUid:void 0,p=t.assigneeUid||void 0,m=Array.from(new Set((Ne||[]).map((function(e){return null==e?void 0:e.uid})).filter((function(e){return Boolean(e)})))),h={},k={},v=P.find((function(e){return e.uid===D})),x=null!=v&&v.schema?Be(v.schema):[],Object.keys(t).forEach((function(e){if(e.startsWith("dynamicField_")){var a=e.replace("dynamicField_",""),r=x.find((function(e){return e.id===a}));r&&(h[a]=t[e],k[a]=r.label)}})),y=null,Object.keys(h).length>0&&D&&(y={formUid:D,formName:(null==v?void 0:v.name)||"表单",formData:h,fieldLabels:k}),S={description:c,summary:l,priority:u,status:Z.sM_,level:Z.Hxq,orgUid:w,workgroupUid:j,departmentUid:d,assigneeUid:p,contactName:(null===(r=t.contactName)||void 0===r?void 0:r.trim())||"",email:(null===(s=t.email)||void 0===s?void 0:s.trim())||"",phone:(null===(i=t.phone)||void 0===i?void 0:i.trim())||"",reporter:null==b?void 0:b.uid,categoryUid:t.categoryUid||void 0,uploadUids:m.length?m:void 0,schema:y?JSON.stringify(y):void 0},e.next=24,(0,f.ax)(S);case 24:if(U=e.sent,E.Z.debug("Create ticket response:",U,S),200!==(null==U?void 0:U.code)){e.next=38;break}return L.yw.success(o.formatMessage({id:"ticket.create.success",defaultMessage:"工单创建成功"})),g.resetFields(),localStorage.removeItem("admin_ticketDraft"),N([]),F(""),ie([]),xe([]),Ie([]),Ee(!1),a(!0),e.abrupt("return",!0);case 38:return L.yw.error((null==U?void 0:U.message)||o.formatMessage({id:"ticket.create.failed",defaultMessage:"工单创建失败"})),e.abrupt("return",!1);case 42:return e.prev=42,e.t0=e.catch(6),console.error("Create ticket failed:",e.t0),L.yw.error(o.formatMessage({id:"ticket.create.failed",defaultMessage:"工单创建失败"})),e.abrupt("return",!1);case 47:return e.prev=47,M(!1),e.finish(47);case 50:case"end":return e.stop()}}),e,null,[[6,42,47,50]])})));return function(t){return e.apply(this,arguments)}}(),_e=function(){g.resetFields(),N([]),F(""),$([]),ie([]),xe([]),Ie([]),Ee(!1),a()};return(0,ue.jsxs)(R.Z,{title:o.formatMessage({id:"ticket.create.title",defaultMessage:"创建工单"}),placement:"right",onClose:_e,open:t,width:500,extra:(0,ue.jsxs)(B.Z,{children:[P.length>0?(0,ue.jsx)(O.Z,{style:{width:150},placeholder:o.formatMessage({id:"ticket.form.select.placeholder",defaultMessage:"选择表单"}),value:D,onChange:function(e){F(e),Re(e)},options:[{label:o.formatMessage({id:"ticket.form.none",defaultMessage:"无表单"}),value:""}].concat(A()(P.map((function(e){return{label:e.name,value:e.uid,disabled:"PUBLISHED"!==e.status}}))))}):(0,ue.jsx)(d.ZP,{type:"link",onClick:function(){return window.open((0,y.P1)(),"_blank")},children:o.formatMessage({id:"ticket.form.create",defaultMessage:"添加表单"})}),(0,ue.jsx)(d.ZP,{onClick:_e,children:o.formatMessage({id:"common.cancel",defaultMessage:"取消"})}),(0,ue.jsx)(d.ZP,{type:"primary",onClick:function(){return g.submit()},loading:v,children:o.formatMessage({id:"common.confirm",defaultMessage:"确认"})})]}),children:[(0,ue.jsxs)(z.A,{form:g,layout:"vertical",submitter:{render:!1},onFinish:Oe,initialValues:{status:Z.sM_,priority:Z.GMZ,departmentUid:Z.zBg},children:[(0,ue.jsx)(K.Z,{name:"description",label:o.formatMessage({id:"ticket.description",defaultMessage:"问题描述"}),placeholder:o.formatMessage({id:"ticket.description.placeholder",defaultMessage:"请详细描述您遇到的问题，以便我们更好地为您服务..."}),fieldProps:{rows:6,onBlur:function(){var e=g.getFieldValue("description");e&&localStorage.setItem("admin_ticketDraft",e)}},rules:[{required:!0,message:o.formatMessage({id:"ticket.description.required",defaultMessage:"请输入问题描述"})},{max:2e3,message:o.formatMessage({id:"ticket.description.maxlength",defaultMessage:"描述不能超过2000个字符"})}]}),(0,ue.jsx)(G.Z,{name:"categoryUid",label:o.formatMessage({id:"ticket.category",defaultMessage:"问题分类"}),placeholder:o.formatMessage({id:"ticket.category.placeholder",defaultMessage:"请选择问题分类"}),options:Q,rules:[{required:Q.length>0,message:o.formatMessage({id:"ticket.category.required",defaultMessage:"请选择问题分类"})}],fieldProps:{loading:te,showSearch:!0,optionFilterProp:"label",disabled:0===Q.length}}),(0,ue.jsx)(me,{forms:P,selectedFormUid:D,renderMode:"fields-only",fieldNamePrefix:"dynamicField_"}),(0,ue.jsx)(G.Z,{name:"priority",label:o.formatMessage({id:"ticket.priority",defaultMessage:"优先级"}),placeholder:o.formatMessage({id:"ticket.priority.placeholder",defaultMessage:"请选择优先级"}),options:De,rules:[{required:!0,message:o.formatMessage({id:"ticket.priority.required",defaultMessage:"请选择优先级"})}]}),(0,ue.jsx)(z.A.Item,{name:"departmentUid",label:o.formatMessage({id:"ticket.department",defaultMessage:"所属部门"}),rules:[{required:se.length>0,message:o.formatMessage({id:"ticket.department.required",defaultMessage:"请选择部门"})}],children:(0,ue.jsx)(_.Z,{treeData:se,treeDefaultExpandAll:!0,placeholder:o.formatMessage({id:"ticket.department.placeholder",defaultMessage:"请选择部门"}),disabled:!se.length||le,showSearch:!0,filterTreeNode:function(e,t){return((null==t?void 0:t.title)||"").toLowerCase().includes(e.toLowerCase())},allowClear:!1,onChange:function(e){return function(e){var t=e||Z.zBg;g.setFieldValue("assigneeUid",void 0),Fe(t)}(e)},style:{width:"100%"}})}),(0,ue.jsx)(G.Z,{name:"assigneeUid",label:o.formatMessage({id:"ticket.assignee",defaultMessage:"指派成员"}),placeholder:o.formatMessage({id:"ticket.assignee.placeholder",defaultMessage:"请选择处理成员"}),options:pe.filter((function(e){return!!e.uid})).map((function(e){var t;return{label:e.nickname||(null===(t=e.user)||void 0===t?void 0:t.nickname)||e.uid,value:e.uid}})),fieldProps:{showSearch:!0,optionFilterProp:"label",loading:we,disabled:0===pe.length}}),(0,ue.jsxs)(z.A.Item,{label:o.formatMessage({id:"ticket.attachments",defaultMessage:"附件"}),children:[(0,ue.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:12,marginBottom:12},children:Ne.filter((function(e){return!(null==e||!e.uid)})).map((function(e){return(0,ue.jsx)(ve.Z,{file:e,onDelete:Te},e.uid)}))}),(0,ue.jsx)(d.ZP,{icon:(0,ue.jsx)(he.Z,{}),onClick:function(){return Ee(!0)},children:o.formatMessage({id:"ticket.attachment.upload",defaultMessage:"上传附件"})})]}),(0,ue.jsx)(J.Z,{name:"contactName",label:o.formatMessage({id:"ticket.contact.name",defaultMessage:"称呼"}),rules:[{required:!0,message:o.formatMessage({id:"ticket.contact.name.required",defaultMessage:"请输入称呼"})}],placeholder:o.formatMessage({id:"ticket.contact.name.placeholder",defaultMessage:"请输入您的称呼"})}),(0,ue.jsx)(J.Z,{name:"email",label:o.formatMessage({id:"ticket.contact.email",defaultMessage:"邮箱"}),placeholder:o.formatMessage({id:"ticket.contact.email.placeholder",defaultMessage:"请输入邮箱地址"}),rules:[{type:"email",message:o.formatMessage({id:"ticket.contact.email.invalid",defaultMessage:"请输入有效的邮箱地址"})}]}),(0,ue.jsx)(J.Z,{name:"phone",label:o.formatMessage({id:"ticket.contact.phone",defaultMessage:"手机"}),rules:[{required:!0,message:o.formatMessage({id:"ticket.contact.phone.required",defaultMessage:"请输入手机号码"})}],placeholder:o.formatMessage({id:"ticket.contact.phone.placeholder",defaultMessage:"请输入手机号码"}),extra:o.formatMessage({id:"ticket.contact.extra",defaultMessage:"请留下您的联系方式，以便我们及时回复"})})]}),Ue&&(0,ue.jsx)(ke.Z,{type:Z.hcJ,isModalOpen:Ue,handleSubmit:function(e){Ie((function(t){var a=new Map;return t.forEach((function(e){null!=e&&e.uid&&a.set(e.uid,e)})),(e||[]).forEach((function(e){null!=e&&e.uid&&a.set(e.uid,e)})),Array.from(a.values())})),Ee(!1)},handleCancel:function(){return Ee(!1)}})]})},be="df_org_uid",ye=function(){var e=(0,m.useIntl)(),t=l.Z.useApp().message,a=(0,m.useSearchParams)(),r=c()(a,2),s=r[0],o=r[1],w=s.get("status")||"todo",j=(0,p.useState)(w),U=c()(j,2),P=U[0],N=U[1],I=(0,p.useState)(!1),q=c()(I,2),T=q[0],A=q[1],R=(0,p.useRef)(),B=(0,C.Z)().isDarkMode,O=(0,p.useState)(null),_=c()(O,2),z=_[0],K=_[1],G=(0,p.useState)(!1),J=c()(G,2),L=(J[0],J[1]),X=(0,m.useModel)("@@initialState").initialState,V=(null!=X?X:{}).userInfo;(0,p.useEffect)((function(){if(null==X||!X.userInfo){m.history.push("/auth/login?redirect=".concat(encodeURIComponent("/ticket-center")))}}),[X]),(0,p.useEffect)((function(){N(w)}),[w]),(0,p.useEffect)((function(){var a=function(){var a=i()(n()().mark((function a(){var r,s;return n()().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return L(!0),a.prev=1,a.next=4,S();case 4:r=a.sent,E.Z.debug("平台工单中心配置:",null==r?void 0:r.data),200===(null==r?void 0:r.code)&&null!=r&&r.data&&K({workgroupUid:null==r?void 0:r.data.workgroupUid,ticketCenterEnabled:null===(s=null==r?void 0:r.data.ticketCenterEnabled)||void 0===s||s,description:null==r?void 0:r.data.description}),a.next=13;break;case 9:a.prev=9,a.t0=a.catch(1),console.error("加载平台工单中心配置失败:",a.t0),t.error(e.formatMessage({id:"ticket.center.settings.load.failed",defaultMessage:"加载平台工单中心配置失败"}));case 13:return a.prev=13,L(!1),a.finish(13);case 16:case"end":return a.stop()}}),a,null,[[1,9,13,16]])})));return function(){return a.apply(this,arguments)}}();a()}),[e]);var H,W,Q={NEW:{text:e.formatMessage({id:"ticket.status.new",defaultMessage:"新建"}),status:"Default"},OPEN:{text:e.formatMessage({id:"ticket.status.open",defaultMessage:"处理中"}),status:"Processing"},PENDING:{text:e.formatMessage({id:"ticket.status.pending",defaultMessage:"待处理"}),status:"Warning"},RESOLVED:{text:e.formatMessage({id:"ticket.status.resolved",defaultMessage:"已解决"}),status:"Success"},CLOSED:{text:e.formatMessage({id:"ticket.status.closed",defaultMessage:"已关闭"}),status:"Default"}},$=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left",align:"center",search:!1},{title:e.formatMessage({id:"ticket.number",defaultMessage:"工单编号"}),dataIndex:"ticketNumber",key:"ticketNumber",width:150},{title:e.formatMessage({id:"ticket.description",defaultMessage:"描述"}),dataIndex:"description",key:"description",ellipsis:!0},{title:e.formatMessage({id:"ticket.status",defaultMessage:"状态"}),dataIndex:"status",key:"status",width:100,valueType:"select",valueEnum:Q,render:function(t,a){return r=a.status,n={NEW:{color:"blue",text:e.formatMessage({id:"ticket.status.new",defaultMessage:"新建"})},OPEN:{color:"green",text:e.formatMessage({id:"ticket.status.open",defaultMessage:"处理中"})},PENDING:{color:"orange",text:e.formatMessage({id:"ticket.status.pending",defaultMessage:"待处理"})},RESOLVED:{color:"cyan",text:e.formatMessage({id:"ticket.status.resolved",defaultMessage:"已解决"})},CLOSED:{color:"default",text:e.formatMessage({id:"ticket.status.closed",defaultMessage:"已关闭"})}}[r]||{color:"default",text:r},(0,ue.jsx)(u.Z,{color:n.color,children:n.text});var r,n}},{title:e.formatMessage({id:"ticket.contact.name",defaultMessage:"联系人"}),dataIndex:"contactName",key:"contactName",width:120,search:!1},{title:e.formatMessage({id:"ticket.contact.email",defaultMessage:"邮箱"}),dataIndex:"email",key:"email",width:150,search:!1},{title:e.formatMessage({id:"ticket.contact.phone",defaultMessage:"手机"}),dataIndex:"phone",key:"phone",width:120,search:!1},{title:e.formatMessage({id:"ticket.createdAt",defaultMessage:"创建时间"}),dataIndex:"createdAt",key:"createdAt",width:180,search:!1}],Y=[{path:"/ticket-list",name:e.formatMessage({id:"ticket.list",defaultMessage:"工单列表"}),icon:(0,ue.jsx)(D,{})}];return(0,ue.jsxs)(g.f,{title:(H=(0,y.nt)(),W=(0,y.ye)(),H&&W?W:e.formatMessage({id:"app.title"})),logo:(0,y.do)(),layout:"mix",fixedHeader:!0,fixSiderbar:!0,splitMenus:!1,navTheme:B?"realDark":"light",route:{path:"/",routes:Y},location:{pathname:"/".concat(P)},menuItemRender:function(e,t){return(0,ue.jsx)("div",{onClick:function(){var t,a,r=null===(t=e.path)||void 0===t?void 0:t.replace("/","");r&&(a={key:r}.key,N(a),o({status:a}))},children:t})},actionsRender:function(){return[(0,ue.jsx)(v.Z,{},"fullScreen"),(0,ue.jsx)(b.Z,{},"trialTip"),(0,ue.jsx)(x.Z,{},"GotoGithub"),!1,(0,ue.jsx)(M.Z,{},"GotoAgent")]},avatarProps:{src:null==V?void 0:V.avatar,title:(0,ue.jsx)(k.gj,{}),render:function(e,t){return(0,ue.jsx)(k.Kd,{menu:!0,children:t})}},footerRender:function(){return(0,ue.jsx)(k.$_,{})},contentStyle:{margin:0,padding:0,background:B?"#141414":"#f0f2f5"},children:[(0,ue.jsx)(h.Z,{actionRef:R,columns:$,rowKey:"uid",style:{padding:10},request:function(){var a=i()(n()().mark((function a(r){var s,i;return n()().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,s={pageNumber:(r.current||1)-1,pageSize:r.pageSize||20,orgUid:be,ticketNumber:r.ticketNumber||void 0,level:Z.Hxq},a.next=4,(0,f.N2)(s);case 4:if(i=a.sent,E.Z.debug("工单列表数据:",i.data,s),200!==(null==i?void 0:i.code)||null==i||!i.data){a.next=10;break}return a.abrupt("return",{data:(null==i?void 0:i.data.content)||[],success:!0,total:(null==i?void 0:i.data.totalElements)||0});case 10:t.error(e.formatMessage({id:"ticket.list.load.failed",defaultMessage:"加载工单列表失败"}));case 11:return a.abrupt("return",{data:[],success:!1,total:0});case 14:return a.prev=14,a.t0=a.catch(0),console.error("加载工单列表失败:",a.t0),t.error(e.formatMessage({id:"ticket.list.load.failed",defaultMessage:"加载工单列表失败"})),a.abrupt("return",{data:[],success:!1,total:0});case 19:case"end":return a.stop()}}),a,null,[[0,14]])})));return function(e){return a.apply(this,arguments)}}(),search:{labelWidth:"auto"},pagination:{showSizeChanger:!0,showQuickJumper:!0,showTotal:function(t){return e.formatMessage({id:"pages.table.total",defaultMessage:"共 {total} 条"},{total:t})}},toolBarRender:function(){return[(0,ue.jsx)(d.ZP,{type:"primary",icon:(0,ue.jsx)(F.Z,{}),onClick:function(){return A(!0)},children:e.formatMessage({id:"ticket.create",defaultMessage:"创建工单"})},"create")]}}),(0,ue.jsx)(xe,{visible:T,onClose:function(e){var t;(A(!1),e)&&(null===(t=R.current)||void 0===t||t.reload())},orgUid:be,workgroupUid:null==z?void 0:z.workgroupUid})]})},we=function(){return(0,ue.jsx)(l.Z,{children:(0,ue.jsx)(ye,{})})}},56773:function(e,t,a){a.d(t,{j:function(){return d}});var r=a(73193),n=a.n(r),s=a(76711),i=a.n(s),o=a(6844),c=a(26557),l=a(26407),u=a(20744),d=(0,c.Ue)()((0,l.mW)((0,l.tJ)((0,u.n)((function(e,t){return{currentKbase:{uid:"",orgUid:""},kbaseResult:{data:{content:[]}},insertKbase:function(t){e((function(e){e.kbaseResult.data.content.unshift(t)}))},updateKbase:function(t){e((function(e){var a=e.kbaseResult.data.content,r=a.findIndex((function(e){return e.uid===t.uid}));-1!==r?a[r]=t:console.warn("Kbase with uid ".concat(t.uid," not found."))}))},setKbaseResult:function(t){var a;e({kbaseResult:t}),(null===(a=t.data)||void 0===a||null===(a=a.content)||void 0===a?void 0:a.length)>0&&e({currentKbase:t.data.content[0]})},setCurrentKbase:function(a){var r=t().kbaseResult.data.content,s=r.findIndex((function(e){return e.uid===a.uid}));if(-1!==s){var o=[].concat(i()(r.slice(0,s)),[a],i()(r.slice(s+1))),c=n()(n()({},t().kbaseResult),{},{data:{content:o}});e({kbaseResult:c,currentKbase:a})}else console.warn("Kbase with the specified uid not found."),e({currentKbase:a})},removeKbase:function(a){var r=t().kbaseResult.data.content,s=r.findIndex((function(e){return e.uid===a}));-1!==s?e({kbaseResult:n()(n()({},t().kbaseResult),{},{data:{content:[].concat(i()(r.slice(0,s)),i()(r.slice(s+1)))}})}):console.warn("Kbase not found in cache:",a),t().currentKbase.uid===a&&e({currentKbase:{uid:"",orgUid:""}})},deleteKbaseCache:function(){return e({},!0)}}})),{name:o.wKE})))}}]);