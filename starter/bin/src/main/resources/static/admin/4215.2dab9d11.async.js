"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[4215],{52491:function(e,t,n){var a=n(94433),r=n(38956),s=n(44194),i=n(35865),o=n(31549),l=["fieldProps","request","params","proFieldProps"],u=function(e,t){var n=e.fieldProps,s=e.request,u=e.params,d=e.proFieldProps,c=(0,r.Z)(e,l);return(0,o.jsx)(i.Z,(0,a.Z)({valueType:"treeSelect",fieldProps:n,ref:t,request:s,params:u,filedConfig:{customLightMode:!0},proFieldProps:d},c))},d=s.forwardRef(u);t.Z=d},67728:function(e,t,n){n.d(t,{D$:function(){return g},EP:function(){return h},hS:function(){return p},z_:function(){return c}});var a=n(90819),r=n.n(a),s=n(73193),i=n.n(s),o=n(89933),l=n.n(o),u=n(6844),d=n(19736);function c(e){return f.apply(this,arguments)}function f(){return(f=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/query/org",{method:"GET",params:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return m.apply(this,arguments)}function m(){return(m=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/create",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e){return v.apply(this,arguments)}function v(){return(v=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/update",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return M.apply(this,arguments)}function M(){return(M=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/delete",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},54605:function(e,t,n){n.d(t,{G:function(){return g}});var a=n(73193),r=n.n(a),s=(n(44194),n(87373)),i=n(6844),o=n(96596),l=n.n(o),u=n(36125),d=n(93527),c=n(65819),f=n(31549),g=function(e){var t=e.children,n=e.onSuccess,a=e.onError,o={file:null,fileName:"test.png",fileType:"image/png",isAvatar:"true",kbType:i.IrL,categoryUid:"",kbUid:"",channel:i.XtJ},g={name:"file",accept:"image/*",action:(0,c.M$)(),headers:{Authorization:"Bearer "+localStorage.getItem(i.LA8)},data:o,showUploadList:!1,beforeUpload:function(e){u.Z.log("beforeUpload",e);var t=l()(new Date).format("YYYYMMDDHHmmss")+"_"+e.name;return o.file=e,o.fileName=t,o.fileType=e.type,u.Z.log("beforeUpload",o),!0},onChange:function(e){if("uploading"!==e.file.status&&u.Z.log("not uploading:",e.file),"done"===e.file.status)if(u.Z.log("response: ",e.file.response),200===e.file.response.code){var t,r=null===(t=e.file.response)||void 0===t?void 0:t.data.fileUrl;n(r),d.yw.success("".concat(e.file.name," 上传成功"))}else a(e.file),d.yw.error("".concat(e.file.name," 上传失败"));else"error"===e.file.status&&(d.yw.error("".concat(e.file.name," 上传失败")),a(e.file))}};return(0,f.jsx)(s.Z,r()(r()({},g),{},{children:t}))}},88449:function(e,t,n){var a=n(26710);t.Z=function(){var e=(0,a.Z)().isDarkMode;return{leftSiderStyle:{borderRight:e?"1px solid #333":"1px solid #ccc",background:e?"#141414":"#f5f5f5",height:"100vh",overflow:"auto"},leftSiderWidth:250,headerStyle:{background:e?"#141414":"#fff"},rightSiderStyle:{borderLeft:e?"1px solid #333":"1px solid #ccc",background:e?"#141414":"#f5f5f5"},contentStyle:{minHeight:120,background:e?"#141414":"#f5f5f5",height:"100vh",overflow:"auto",padding:10}}}},89105:function(e,t,n){var a=n(90819),r=n.n(a),s=n(73193),i=n.n(s),o=n(89933),l=n.n(o),u=n(45332),d=n.n(u),c=n(44194),f=n(58867),g=n(46141),m=n(48769),p=n(65513),v=n(19736),h=n(93527),M=n(50989),b=n(31549);t.Z=function(e){var t=e.open,n=e.onOpenChange,a=e.orgUid,s=e.record,o=e.onSuccess,u=(0,v.useIntl)(),x=f.Z.useForm(),k=d()(x,1)[0];(0,c.useEffect)((function(){var e,n;t&&(s?k.setFieldsValue({name:s.name||"",description:s.description||"",enabled:null===(e=s.enabled)||void 0===e||e,isDefault:null!==(n=s.isDefault)&&void 0!==n&&n}):(k.resetFields(),k.setFieldsValue({enabled:!0,isDefault:!1})))}),[t,s,k]);var w=function(){var e=l()(r()().mark((function e(){var t,l,d,c;return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,k.validateFields();case 3:if(t=e.sent,l=i()(i()({},t),{},{orgUid:a,uid:null==s?void 0:s.uid}),null==s||!s.uid){e.next=11;break}return e.next=8,(0,M.wU)(l);case 8:e.t0=e.sent,e.next=14;break;case 11:return e.next=13,(0,M.IH)(l);case 13:e.t0=e.sent;case 14:(d=e.t0)&&200===d.code?(c=(null==d?void 0:d.data)||{},h.yw.success(u.formatMessage({id:null!=s&&s.uid?"common.updated":"common.created",defaultMessage:null!=s&&s.uid?"更新成功":"创建成功"})),null==o||o(c),n(!1)):h.yw.error((null==d?void 0:d.message)||"操作失败"),e.next=21;break;case 18:e.prev=18,e.t1=e.catch(0),console.error("Error saving agent settings:",e.t1);case 21:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(){return e.apply(this,arguments)}}();return(0,b.jsx)(g.Z,{title:(0,b.jsx)(v.FormattedMessage,{id:null!=s&&s.uid?"agent.settings.template.edit":"agent.settings.template.create",defaultMessage:null!=s&&s.uid?"编辑模板":"新建模板"}),open:t,onOk:w,onCancel:function(){n(!1)},okText:(0,b.jsx)(v.FormattedMessage,{id:"common.save",defaultMessage:"保存"}),cancelText:(0,b.jsx)(v.FormattedMessage,{id:"common.cancel",defaultMessage:"取消"}),destroyOnHidden:!0,width:600,children:(0,b.jsxs)(f.Z,{form:k,layout:"vertical",preserve:!1,children:[(0,b.jsx)(f.Z.Item,{name:"name",label:(0,b.jsx)(v.FormattedMessage,{id:"agent.settings.template.name",defaultMessage:"模板名称"}),rules:[{required:!0,message:u.formatMessage({id:"required",defaultMessage:"此项为必填项"})}],children:(0,b.jsx)(m.Z,{placeholder:u.formatMessage({id:"agent.settings.template.name.placeholder",defaultMessage:"请输入模板名称"})})}),(0,b.jsx)(f.Z.Item,{name:"description",label:(0,b.jsx)(v.FormattedMessage,{id:"description",defaultMessage:"描述"}),children:(0,b.jsx)(m.Z.TextArea,{rows:3,placeholder:u.formatMessage({id:"agent.settings.template.description.placeholder",defaultMessage:"请输入模板描述"})})}),(0,b.jsx)(f.Z.Item,{name:"enabled",label:(0,b.jsx)(v.FormattedMessage,{id:"enabled",defaultMessage:"启用"}),valuePropName:"checked",children:(0,b.jsx)(p.Z,{})})]})})}},73693:function(e,t,n){n.d(t,{Z:function(){return $}});var a=n(86222),r=n.n(a),s=n(73193),i=n.n(s),o=n(90819),l=n.n(o),u=n(89933),d=n.n(u),c=n(45332),f=n.n(c),g=n(44194),m=n(19736),p=n(86307),v=n(65100),h=n(66810),M=n(77359),b=n(3925),x=n(93527),k=n(43590),w=n(14888),y=n(6844),j=n(76711),S=n.n(j),Z=n(27625),C=n(30064),U=n(68263),I=n(86684),T=n(13847),F=n(9428),q=n(29589),A=n(10162),D=n(59908),O=n(67728),P=n(50989),E=n(89105),R=n(54605),z=n(31549),L=function(e){var t=e.value,n=e.onChange,a=e.options,r=e.loading,s=e.placeholder,i=e.emptyContent,o=e.onSearch,l=e.onDropdownOpen,u=e.onCreate,d=e.createLabel,c=e.createTitle;return(0,z.jsxs)(F.Z.Compact,{block:!0,children:[(0,z.jsx)(q.Z,{value:t,onChange:n,options:a,showSearch:!0,filterOption:!1,placeholder:s,loading:r,style:{flex:1},notFoundContent:i,onSearch:o,onOpenChange:function(e){e&&l()}}),(0,z.jsx)(b.ZP,{size:"small",icon:(0,z.jsx)(A.Z,{}),onClick:u,title:c,children:d})]})},V=function(e){var t,n,a=e.open,r=e.record,s=e.onClose,o=e.onSuccess,u=(0,m.useIntl)(),c=(0,w.u)((function(e){return e.currentOrg})),p=(0,g.useState)(!1),h=f()(p,2),M=h[0],y=h[1],j=(0,g.useState)([]),F=f()(j,2),q=F[0],V=F[1],B=(0,g.useState)(!1),N=f()(B,2),_=N[0],J=N[1],H=(0,g.useState)((null==r?void 0:r.avatar)||""),X=f()(H,2),W=X[0],Y=X[1],G=(0,g.useRef)(),$=(0,g.useMemo)((function(){return!(null==r||!r.uid)}),[r]),K=function(){var e=d()(l()().mark((function e(t){return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Y(t),x.yw.success(u.formatMessage({id:"update.success",defaultMessage:"更新成功"}));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Q=(0,g.useCallback)(function(){var e=d()(l()().mark((function e(t){var n,a,r,s;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(J(!0),e.prev=1,null!=c&&c.uid){e.next=5;break}return V([]),e.abrupt("return",[]);case 5:return a={pageNumber:0,pageSize:50,enabled:!0,orgUid:null==c?void 0:c.uid,searchText:t||""},e.next=8,(0,P.u9)(a);case 8:return r=e.sent,console.log("queryAgentSettingsByOrg request:",a,r),s=(null==r||null===(n=r.data)||void 0===n?void 0:n.content)||[],V(s),e.abrupt("return",s.map((function(e){return{label:"".concat(e.name||e.uid).concat(e.isDefault?" (默认)":"").concat(e.enabled?"":" (已停用)"),value:e.uid}})));case 13:return e.prev=13,J(!1),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,,13,16]])})));return function(t){return e.apply(this,arguments)}}(),[null==c?void 0:c.uid]);(0,g.useEffect)((function(){Q()}),[Q]);var ee=(0,g.useMemo)((function(){return q.map((function(e){return{label:"".concat(e.name||e.uid).concat(e.isDefault?" (默认)":"").concat(e.enabled?"":" (已停用)"),value:e.uid}}))}),[q]),te=(0,g.useRef)(),ne=(0,g.useCallback)((function(e){te.current&&clearTimeout(te.current),te.current=setTimeout((function(){Q(e)}),300)}),[Q]);(0,g.useEffect)((function(){return function(){te.current&&clearTimeout(te.current)}}),[]);var ae=(0,g.useCallback)((function(){q.length||Q()}),[Q,q.length]);return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsxs)(Z.a,{open:a,onOpenChange:function(e){e||s()},title:$?u.formatMessage({id:"agent.edit",defaultMessage:"编辑客服"}):u.formatMessage({id:"agent.new",defaultMessage:"新建客服"}),width:520,formRef:G,initialValues:$?{nickname:null==r?void 0:r.nickname,email:null==r?void 0:r.email,mobile:null==r?void 0:r.mobile,description:null==r?void 0:r.description,memberUid:(null==r||null===(t=r.member)||void 0===t?void 0:t.uid)||(null==r?void 0:r.memberUid),settingsUid:null==r||null===(n=r.settings)||void 0===n?void 0:n.uid}:{},autoFocusFirstInput:!0,drawerProps:{destroyOnHidden:!0,maskClosable:!0},submitter:{searchConfig:{submitText:u.formatMessage({id:"save",defaultMessage:"保存"}),resetText:u.formatMessage({id:"cancel",defaultMessage:"取消"})},resetButtonProps:{onClick:function(){return s()}}},onFinish:function(){var e=d()(l()().mark((function e(t){var n,a,d,f,g;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,x.yw.loading(u.formatMessage({id:$?"updating":"creating",defaultMessage:$?"Updating":"Creating"})),!$){e.next=10;break}return d=i()(i()(i()({},r),t),{},{avatar:W||(null==r?void 0:r.avatar)}),e.next=6,(0,k.sE)(d);case 6:a=e.sent,console.log("updateAgent payload:",d,a),e.next=15;break;case 10:return f={nickname:t.nickname,email:t.email,mobile:t.mobile,description:t.description,memberUid:t.memberUid,settingsUid:t.settingsUid,orgUid:null==c?void 0:c.uid,avatar:W},e.next=13,(0,k.x_)(f);case 13:a=e.sent,console.log("createAgent payload:",f,a);case 15:if(x.yw.destroy(),200!==(null===(n=a)||void 0===n?void 0:n.code)){e.next=23;break}return x.yw.success(u.formatMessage({id:"save.success",defaultMessage:"保存成功"})),null==o||o(a.data),s(),e.abrupt("return",!0);case 23:return x.yw.error((null===(g=a)||void 0===g?void 0:g.message)||u.formatMessage({id:"save.failed",defaultMessage:"保存失败"})),e.abrupt("return",!1);case 25:e.next=32;break;case 27:return e.prev=27,e.t0=e.catch(0),x.yw.destroy(),x.yw.error(u.formatMessage({id:"save.error",defaultMessage:"保存出错"})),e.abrupt("return",!1);case 32:case"end":return e.stop()}}),e,null,[[0,27]])})));return function(t){return e.apply(this,arguments)}}(),children:[(0,z.jsx)(C.A.Item,{name:"avatar",valuePropName:"fileList",getValueFromEvent:function(e){return Array.isArray(e)?e:null==e?void 0:e.fileList},label:u.formatMessage({id:"pages.robot.tab.avatar",defaultMessage:"Avatar"}),children:(0,z.jsxs)(R.G,{onSuccess:K,onError:function(e){x.yw.error(String(e))},children:[(0,z.jsx)(v.Z,{src:W||(null==r?void 0:r.avatar)}),(0,z.jsxs)(b.ZP,{icon:(0,z.jsx)(D.Z,{}),children:[" ",u.formatMessage({id:"pages.robot.upload",defaultMessage:"Upload"})]})]})}),(0,z.jsx)(U.Z,{name:"memberUid",label:u.formatMessage({id:"agent.info.member.bind",defaultMessage:"绑定成员"}),placeholder:u.formatMessage({id:"agent.info.member.placeholder",defaultMessage:"请选择成员"}),disabled:$,rules:$?[]:[{required:!0,message:u.formatMessage({id:"agent.info.member.required",defaultMessage:"请选择成员"})}],showSearch:!0,debounceTime:300,request:function(){var e=d()(l()().mark((function e(t){var n,a,r,s;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.keyWords,e.next=3,(0,O.z_)({pageNumber:0,pageSize:20,orgUid:null==c?void 0:c.uid,searchText:a||""});case 3:return r=e.sent,s=(null==r||null===(n=r.data)||void 0===n?void 0:n.content)||[],e.abrupt("return",s.map((function(e){return{label:e.nickname,value:e.uid}})));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),fieldProps:{filterOption:!1}}),(0,z.jsx)(C.A.Item,{name:"settingsUid",label:u.formatMessage({id:"agent.settings",defaultMessage:"客服配置"}),rules:[{required:!0,message:u.formatMessage({id:"agent.settings.required",defaultMessage:"请选择客服配置"})}],children:(0,z.jsx)(L,{options:ee,loading:_,placeholder:u.formatMessage({id:"agent.settings.placeholder",defaultMessage:"请选择客服配置"}),emptyContent:0===ee.length?(0,z.jsxs)("div",{style:{textAlign:"center",padding:"12px 0"},children:[(0,z.jsx)("div",{style:{marginBottom:8,color:"#999"},children:u.formatMessage({id:"agent.settings.empty",defaultMessage:"暂无配置模板"})}),(0,z.jsx)(b.ZP,{size:"small",type:"primary",icon:(0,z.jsx)(A.Z,{}),onMouseDown:function(e){return e.preventDefault()},onClick:function(){return y(!0)},children:u.formatMessage({id:"agent.settings.create",defaultMessage:"创建配置"})})]}):void 0,onSearch:ne,onDropdownOpen:ae,onCreate:function(){return y(!0)},createLabel:u.formatMessage({id:"common.new",defaultMessage:"新建"}),createTitle:u.formatMessage({id:"agent.settings.create",defaultMessage:"创建配置"})})}),(0,z.jsx)(I.Z,{name:"nickname",label:u.formatMessage({id:"agent.info.nickname",defaultMessage:"昵称"}),rules:[{required:!0,message:u.formatMessage({id:"agent.info.nickname.required"})}]}),(0,z.jsx)(I.Z,{name:"email",label:u.formatMessage({id:"agent.info.email",defaultMessage:"邮箱"}),rules:[{required:!0,message:u.formatMessage({id:"agent.info.email.required"})}]}),(0,z.jsx)(I.Z,{name:"mobile",label:u.formatMessage({id:"agent.info.mobile",defaultMessage:"手机号"}),rules:[{required:!0,message:u.formatMessage({id:"agent.info.mobile.required"})}]}),(0,z.jsx)(T.Z,{name:"description",label:u.formatMessage({id:"agent.info.description",defaultMessage:"描述"})})]}),(0,z.jsx)(E.Z,{open:M,onOpenChange:y,orgUid:(null==c?void 0:c.uid)||"",record:null,onSuccess:function(e){var t;y(!1),V((function(t){return t.find((function(t){return t.uid===e.uid}))?t.map((function(t){return t.uid===e.uid?e:t})):[e].concat(S()(t))})),Q(),null===(t=G.current)||void 0===t||t.setFieldsValue({settingsUid:e.uid})}})]})},B=n(41587),N=n(46219),_=n(53827),J=n(52491),H=n(46141),X=n(48769),W=n(90727),Y=function(e){var t=e.open,n=e.onClose,a=e.onSubmit,r=(0,m.useIntl)(),s=_.ZP.useForm(),o=f()(s,1)[0],u=(0,w.u)((function(e){return e.currentOrg})),c=(0,B.Z)((function(e){return e.memberResult})),p=(0,B.Z)((function(e){return e.setMemberResult})),v=(0,N.E)((function(e){return e.agentResult})),h=(0,g.useState)(0),M=f()(h,2),x=M[0],k=M[1],y=(0,g.useState)(""),j=f()(y,2),Z=j[0],C=j[1],T=(0,g.useState)(!1),F=f()(T,2),q=F[0],A=F[1],D=(0,g.useState)([]),E=f()(D,2),R=E[0],L=E[1],V=(0,g.useRef)(null),Y=(0,g.useState)(0),G=f()(Y,2),$=G[0],K=G[1],Q=(0,g.useState)(!0),ee=f()(Q,2),te=ee[0],ne=ee[1],ae=(0,g.useState)(!1),re=f()(ae,2),se=re[0],ie=re[1],oe=(0,g.useState)(0),le=f()(oe,2),ue=le[0],de=le[1],ce=(0,g.useState)(!0),fe=f()(ce,2),ge=fe[0],me=fe[1],pe=(0,g.useState)(!1),ve=f()(pe,2),he=ve[0],Me=ve[1],be=(0,g.useState)(!1),xe=f()(be,2),ke=xe[0],we=xe[1],ye=(0,g.useState)([]),je=f()(ye,2),Se=je[0],Ze=je[1];(0,g.useEffect)((function(){var e;t&&(console.log("Modal opened, current agent data:",v),console.log("Current member data:",c),null!=c&&null!==(e=c.data)&&void 0!==e&&e.content&&0!==c.data.content.length||d()(l()().mark((function e(){var t,n,a,r;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={pageNumber:0,pageSize:100,orgUid:null==u?void 0:u.uid},e.next=4,(0,O.z_)(n);case 4:a=e.sent,console.log("Init load members response:",a,n),(r=(null==a||null===(t=a.data)||void 0===t?void 0:t.content)||[]).length>0&&p(i()(i()({},c),{},{data:i()(i()({},null==c?void 0:c.data),{},{content:r})})),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("Init load members failed:",e.t0);case 13:case"end":return e.stop()}}),e,null,[[0,10]])})))(),d()(l()().mark((function e(){var t,n,a,s,i;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,we(!0),n={pageNumber:0,pageSize:50,enabled:!0,orgUid:null==u?void 0:u.uid,searchText:""},e.next=5,(0,P.u9)(n);case 5:a=e.sent,s=(null==a||null===(t=a.data)||void 0===t?void 0:t.content)||[],i=s.map((function(e){return{label:"".concat(e.name||e.uid).concat(e.isDefault?" (".concat(r.formatMessage({id:"agent.settings.template.isDefault",defaultMessage:"默认"}),")"):"").concat(e.enabled?"":" (".concat(r.formatMessage({id:"app.disabled",defaultMessage:"已停用"}),")")),value:e.uid}})),Ze(i),!o.getFieldValue("settingsUid")&&i.length>0&&o.setFieldsValue({settingsUid:i[0].value}),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),console.error("Init load agent settings failed:",e.t0);case 16:return e.prev=16,we(!1),e.finish(16);case 19:case"end":return e.stop()}}),e,null,[[0,13,16,19]])})))())}),[t,v,c]),(0,g.useEffect)((function(){return function(){V.current&&clearTimeout(V.current)}}),[]);var Ce=(0,g.useMemo)((function(){var e=v.data.content.map((function(e){var t;return(null===(t=e.member)||void 0===t?void 0:t.uid)||e.memberUid})).filter((function(e){return e}));return console.log("Existing agent member UIDs:",e),console.log("Agent result data:",v.data.content),e}),[v]),Ue=(0,g.useMemo)((function(){var e,t,n,a=[],r=Z.trim()?R:(null==c||null===(e=c.data)||void 0===e?void 0:e.content)||[];console.log("Total members:",r.length),console.log("Existing agent member UIDs:",Ce),console.log("Using search results:",!!Z.trim());for(var s=0;s<r.length;s++){var i=r[s];if(Ce.includes(i.uid))console.log("Filtering out member:",i.nickname,i.uid);else{var o={title:"",value:"",children:[]};(n=o).title=(t=i).nickname,n.value=t.uid,a.push(o)}}return console.log("Filtered tree data:",a),a}),[c,R,Z,Ce]),Ie=function(){var e=d()(l()().mark((function e(t){var n,a,r,s,i=arguments;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.length>1&&void 0!==i[1]&&i[1],console.log("handleSearch:",t,"isLoadMore:",n),t.trim()||n){e.next=7;break}return L([]),K(0),ne(!0),e.abrupt("return");case 7:return n?ie(!0):A(!0),e.prev=8,a={pageNumber:n?$+1:0,pageSize:20,orgUid:null==u?void 0:u.uid,searchText:t.trim()},e.next=12,(0,O.z_)(a);case 12:r=e.sent,console.log("handleSearch Search members response:",r,a),200===r.code?(s=(null==r?void 0:r.data.content)||[],n?(L((function(e){return[].concat(S()(e),S()(s))})),K($+1)):(L(s),K(0)),ne(!(null!=r&&r.data.last))):(console.error("handleSearch Search failed:",r.message),n||L([])),e.next=21;break;case 17:e.prev=17,e.t0=e.catch(8),console.error("Search error:",e.t0),n||L([]);case 21:return e.prev=21,n?ie(!1):A(!1),e.finish(21);case 24:case"end":return e.stop()}}),e,null,[[8,17,21,24]])})));return function(t){return e.apply(this,arguments)}}(),Te=function(e){var t=e.target.value;C(t),V.current&&clearTimeout(V.current),t.trim()?V.current=setTimeout((function(){Ie(t)}),300):(L([]),K(0),ne(!0))},Fe=function(){Ie(Z)},qe=function(){!se&&te&&Z.trim()&&Ie(Z,!0)},Ae=function(){var e=d()(l()().mark((function e(){var t,n,a,r;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(he||!ge){e.next=17;break}return Me(!0),e.prev=2,t={pageNumber:ue+1,pageSize:20,orgUid:null==u?void 0:u.uid},e.next=6,(0,O.z_)(t);case 6:n=e.sent,console.log("Load more all members response:",n),200===n.code&&(a=(null==n?void 0:n.data.content)||[],r=[].concat(S()(c.data.content),S()(a)),p(i()(i()({},c),{},{data:i()(i()({},c.data),{},{content:r})})),de(ue+1),me(!(null!=n&&n.data.last))),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(2),console.error("Load more all members error:",e.t0);case 14:return e.prev=14,Me(!1),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[2,11,14,17]])})));return function(){return e.apply(this,arguments)}}();return(0,z.jsx)("div",{children:(0,z.jsx)(H.Z,{title:r.formatMessage({id:"agent.create",defaultMessage:"创建客服"}),open:t,forceRender:!0,onOk:function(){console.log("handleOk"),o.validateFields().then((function(e){var t;console.log("form values:",e);var n=o.getFieldValue("memberUids"),r=o.getFieldValue("nickname"),s=o.getFieldValue("email"),i=o.getFieldValue("mobile"),l=o.getFieldValue("settingsUid"),d=Z.trim()?R:(null==c||null===(t=c.data)||void 0===t?void 0:t.content)||[],f=[];if(1===n.length){var g={nickname:r,email:s,mobile:i,memberUid:n[0],orgUid:null==u?void 0:u.uid,settingsUid:l};f.push(g)}else n.forEach((function(e){var t=d.find((function(t){return t.uid===e}));if(t){var n={nickname:t.nickname,email:t.email,mobile:t.mobile,memberUid:e,orgUid:null==u?void 0:u.uid,settingsUid:l};f.push(n)}}));console.log("agents:",f),a(f)})).catch((function(e){console.log("Form errors:",e)}))},onCancel:function(){console.log("handleCancel"),n()},children:(0,z.jsxs)(_.ZP,{form:o,name:"agentForm",style:{maxWidth:400},submitter:!1,children:[(0,z.jsx)(U.Z,{label:r.formatMessage({id:"agent.settings",defaultMessage:"客服配置"}),name:"settingsUid",tooltip:r.formatMessage({id:"agent.settings.tooltip",defaultMessage:"为本次创建的客服指定配置模板"}),rules:[{required:!0,message:r.formatMessage({id:"agent.settings.required.message",defaultMessage:"请选择客服配置!"})}],fieldProps:{options:Se,loading:ke,showSearch:!0,filterOption:function(e,t){var n;return null==t||null===(n=t.label)||void 0===n?void 0:n.toLowerCase().includes(e.toLowerCase())},placeholder:r.formatMessage({id:"agent.settings.placeholder",defaultMessage:"请选择客服配置"})}}),(0,z.jsx)(J.Z,{label:r.formatMessage({id:"agent.info.member.bind",defaultMessage:"绑定成员"}),name:"memberUids",tooltip:r.formatMessage({id:"agent.info.member.tooltip",defaultMessage:"请先到组织-》成员-》创建成员，已创建过客服的成员将被过滤"}),rules:[{required:!0,message:r.formatMessage({id:"agent.info.member.required.message",defaultMessage:"请选择成员!"})}],fieldProps:{multiple:!0,treeDefaultExpandAll:!0,placeholder:r.formatMessage({id:"agent.info.member.placeholder.multiple",defaultMessage:"请选择成员（可多选）"}),onChange:function(e){var t;console.log("onTreeSelectChange:",e),k(e.length);var n=Z.trim()?R:(null==c||null===(t=c.data)||void 0===t?void 0:t.content)||[];if(0===e.length)o.setFieldsValue({nickname:"",email:"",mobile:""});else if(1===e.length){var a=n.find((function(t){return t.uid===e[0]}));a&&o.setFieldsValue({nickname:a.nickname||"",email:a.email||"",mobile:a.mobile||""})}else{var r=n.filter((function(t){return e.includes(t.uid)})),s=r.map((function(e){return e.nickname})).filter(Boolean).join(", "),i=r.map((function(e){return e.email})).filter(Boolean).join(", "),l=r.map((function(e){return e.mobile})).filter(Boolean).join(", ");o.setFieldsValue({nickname:s,email:i,mobile:l})}},treeData:Ue,variant:"outlined",popupRender:function(e){return(0,z.jsxs)("div",{children:[(0,z.jsx)("div",{style:{padding:"8px",borderBottom:"1px solid #f0f0f0"},children:(0,z.jsx)(X.Z,{placeholder:r.formatMessage({id:"agent.info.member.search",defaultMessage:"搜索成员"}),value:Z,onChange:Te,onPressEnter:function(){return Fe()},suffix:(0,z.jsx)(W.Z,{onClick:Fe,style:{cursor:"pointer",color:q?"#1890ff":void 0},spin:q}),allowClear:!0,size:"small"})}),e,(Z.trim()?te:ge)&&(0,z.jsx)("div",{style:{padding:"8px",textAlign:"center",borderTop:"1px solid #f0f0f0"},children:(0,z.jsx)(b.ZP,{type:"link",size:"small",loading:Z.trim()?se:he,onClick:Z.trim()?qe:Ae,disabled:Z.trim()?se:he,children:(Z.trim()?se:he)?r.formatMessage({id:"loading",defaultMessage:"加载中..."}):r.formatMessage({id:"load.more",defaultMessage:"加载更多"})})})]})}}}),(0,z.jsx)(I.Z,{label:r.formatMessage({id:"agent.info.nickname",defaultMessage:"昵称"}),name:"nickname",disabled:x>1,tooltip:x>1?r.formatMessage({id:"agent.info.nickname.tooltip.multiple",defaultMessage:"多选模式下昵称将自动从选中的成员信息中获取"}):r.formatMessage({id:"agent.info.nickname.tooltip",defaultMessage:"昵称将自动从选中的成员信息中获取"})}),(0,z.jsx)(I.Z,{label:r.formatMessage({id:"agent.info.email",defaultMessage:"邮箱"}),name:"email",disabled:x>1,tooltip:x>1?r.formatMessage({id:"agent.info.email.tooltip.multiple",defaultMessage:"多选模式下邮箱将自动从选中的成员信息中获取"}):r.formatMessage({id:"agent.info.email.tooltip",defaultMessage:"邮箱将自动从选中的成员信息中获取"})}),(0,z.jsx)(I.Z,{label:r.formatMessage({id:"agent.info.mobile",defaultMessage:"手机号"}),name:"mobile",disabled:x>1,tooltip:x>1?r.formatMessage({id:"agent.info.mobile.tooltip.multiple",defaultMessage:"多选模式下手机号将自动从选中的成员信息中获取"}):r.formatMessage({id:"agent.info.mobile.tooltip",defaultMessage:"手机号将自动从选中的成员信息中获取"})})]})})})},G=n(36125),$=function(e){var t=e.superUser,n=(0,m.useIntl)(),a=(0,g.useRef)(),s=(0,w.u)((function(e){return e.currentOrg})),o=(0,g.useState)(!1),u=f()(o,2),c=u[0],j=u[1],S=(0,g.useState)(!1),Z=f()(S,2),C=Z[0],U=Z[1],I=(0,g.useState)(null),T=f()(I,2),F=T[0],q=T[1],A=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:n.formatMessage({id:"nickname",defaultMessage:"Nickname"}),dataIndex:"nickname",copyable:!0,ellipsis:!0,fixed:"left",hideInSearch:!0},{title:n.formatMessage({id:"avatar",defaultMessage:"Avatar"}),dataIndex:"avatar",width:64,hideInSearch:!0,render:function(e,t){return(0,z.jsx)(v.Z,{src:null==t?void 0:t.avatar})}},{title:n.formatMessage({id:"uid",defaultMessage:"Uid"}),dataIndex:"uid",copyable:!0,width:220,hideInSearch:!0},{title:n.formatMessage({id:"agent.reception.status",defaultMessage:"接待状态"}),dataIndex:"status",width:140,hideInSearch:!0,render:function(e,t){switch(null==t?void 0:t.status){case y.Ra4:return(0,z.jsx)(h.Z,{color:"green",children:n.formatMessage({id:"agent.status.online",defaultMessage:"Online"})});case y.tU$:return(0,z.jsx)(h.Z,{color:"orange",children:n.formatMessage({id:"agent.status.busy",defaultMessage:"Busy"})});case y.LZ1:default:return(0,z.jsx)(h.Z,{color:"red",children:n.formatMessage({id:"agent.status.offline",defaultMessage:"Offline"})})}}},{title:n.formatMessage({id:"agent.connection.status",defaultMessage:"连接状态"}),dataIndex:"connected",width:140,hideInSearch:!0,render:function(e,t){return null!=t&&t.connected?(0,z.jsx)(h.Z,{color:"green",children:n.formatMessage({id:"agent.connection.success",defaultMessage:"Connected"})}):(0,z.jsx)(h.Z,{color:"red",children:n.formatMessage({id:"agent.connection.failed",defaultMessage:"Disconnected"})})}},{title:n.formatMessage({id:"agent.queue.stats",defaultMessage:"队列统计"}),dataIndex:"queueStats",width:280,hideInSearch:!0,render:function(e,t){var a,r,s,i=null==t?void 0:t.queueStats;return i?(0,z.jsxs)("span",{style:{fontSize:12},children:[(0,z.jsxs)(h.Z,{color:"blue",children:[n.formatMessage({id:"agent.queue.today",defaultMessage:"今日"}),": ",null!==(a=i.agentServedCount)&&void 0!==a?a:0]}),(0,z.jsxs)(h.Z,{color:"orange",children:[n.formatMessage({id:"agent.queue.queuing",defaultMessage:"排队中"}),": ",null!==(r=i.queuingCount)&&void 0!==r?r:0]}),(0,z.jsxs)(h.Z,{color:"green",children:[n.formatMessage({id:"agent.queue.chatting",defaultMessage:"接待中"}),": ",null!==(s=i.chattingCount)&&void 0!==s?s:0]})]}):(0,z.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:n.formatMessage({id:"agent.settings",defaultMessage:"客服配置"}),dataIndex:"settings",width:200,hideInSearch:!0,render:function(e,t){return null!=t&&t.settings?(0,z.jsx)("a",{onClick:function(){q(t),j(!0)},children:t.settings.name||n.formatMessage({id:"agent.settings.configured",defaultMessage:"已配置"})}):(0,z.jsx)("a",{style:{color:"#ff4d4f"},onClick:function(){q(t),j(!0)},children:n.formatMessage({id:"agent.settings.unconfigured",defaultMessage:"未配置，点击配置"})})}},{title:n.formatMessage({id:"description",defaultMessage:"Description"}),dataIndex:"description",ellipsis:!0,hideInSearch:!0},{title:n.formatMessage({id:"createdAt",defaultMessage:"Created At"}),dataIndex:"createdAt",width:180,sorter:!0,hideInSearch:!0},{title:n.formatMessage({id:"updatedAt",defaultMessage:"Updated At"}),dataIndex:"updatedAt",width:180,sorter:!0,hideInSearch:!0},{title:n.formatMessage({id:"actions",defaultMessage:"Actions"}),valueType:"option",key:"option",width:260,fixed:"right",render:function(e,t){return[(0,z.jsx)("a",{onClick:function(){return function(e){var t;if(null!=e&&e.uid){var a={chatConfig:{org:null==s?void 0:s.uid,t:y._0X,sid:e.uid}};null===(t=window.bytedesk)||void 0===t||t.showChat(a)}else x.yw.error(n.formatMessage({id:"agent.invalid",defaultMessage:"无效的客服"}))}(t)},children:n.formatMessage({id:"chat.test",defaultMessage:"测试"})},"test"),(0,z.jsx)("a",{onClick:function(){return m.history.push("/service/channel")},children:n.formatMessage({id:"agent.get.code",defaultMessage:"获取客服代码"})},"code"),(0,z.jsx)("a",{onClick:function(){q(t),j(!0)},children:n.formatMessage({id:"edit",defaultMessage:"编辑"})},"edit"),(0,z.jsx)(M.Z,{title:n.formatMessage({id:"deleteTip",defaultMessage:"删除确认"}),description:"".concat(n.formatMessage({id:"deleteAffirm",defaultMessage:"确认删除"}),"【").concat(null==t?void 0:t.nickname,"】？"),onConfirm:d()(l()().mark((function e(){var r,s;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return x.yw.loading(n.formatMessage({id:"deleting",defaultMessage:"Deleting..."})),e.prev=1,e.next=4,(0,k.Lr)(t);case 4:r=e.sent,x.yw.destroy(),200===(null==r?void 0:r.code)?(x.yw.success(n.formatMessage({id:"delete.success",defaultMessage:"Delete success"})),null===(s=a.current)||void 0===s||s.reload()):x.yw.error((null==r?void 0:r.message)||"Delete failed"),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),x.yw.destroy(),x.yw.error("Delete error");case 13:case"end":return e.stop()}}),e,null,[[1,9]])}))),okText:n.formatMessage({id:"ok",defaultMessage:"OK"}),cancelText:n.formatMessage({id:"cancel",defaultMessage:"Cancel"}),children:(0,z.jsx)("a",{children:n.formatMessage({id:"delete",defaultMessage:"删除"})})},"delete")]}},{title:n.formatMessage({id:"search",defaultMessage:"Search"}),dataIndex:"searchText",valueType:"text",hideInTable:!0,hideInSearch:!1}];return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(p.Z,{columns:A,actionRef:a,rowKey:"uid",cardBordered:!0,scroll:{x:"max-content"},search:{labelWidth:"auto"},toolBarRender:function(){return[(0,z.jsx)(b.ZP,{type:"primary",onClick:function(){q(null),U(!0)},children:n.formatMessage({id:"pages.robot.new",defaultMessage:"New"})},"new")]},request:function(){var e=d()(l()().mark((function e(n,a){var r,o,u,d,c,g,m,p,v,h,M,b,x,w,y,j,S,Z,C,U,I,T;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=(null!==(r=null==n?void 0:n.current)&&void 0!==r?r:1)-1,c=null!==(o=null==n?void 0:n.pageSize)&&void 0!==o?o:10,g=null!==(u=null==n?void 0:n.searchText)&&void 0!==u?u:"",(v=Object.entries(a||{})).length>0&&(h=v[0],M=f()(h,2),b=M[0],(x=M[1])&&(m=b,p="ascend"===x?"ascend":"descend")),w=i()(i()({pageNumber:d,pageSize:c,orgUid:null==s?void 0:s.uid,searchText:g,superUser:t},m?{sortBy:m}:{}),p?{sortDirection:p}:{}),e.prev=6,e.next=9,(0,k._t)(w);case 9:if(y=e.sent,G.Z.debug("queryAgentsByOrg response:",y,w),200!==(null==y?void 0:y.code)){e.next=15;break}return I=(null==y||null===(j=y.data)||void 0===j?void 0:j.content)||[],T=null!==(S=null!==(Z=null==y||null===(C=y.data)||void 0===C?void 0:C.totalElements)&&void 0!==Z?Z:null==y||null===(U=y.data)||void 0===U?void 0:U.numberOfElements)&&void 0!==S?S:I.length,e.abrupt("return",{data:I,total:T,success:!0});case 15:return e.abrupt("return",{data:[],total:0,success:!1});case 18:return e.prev=18,e.t0=e.catch(6),e.abrupt("return",{data:[],total:0,success:!1});case 21:case"end":return e.stop()}}),e,null,[[6,18]])})));return function(t,n){return e.apply(this,arguments)}}(),pagination:{showQuickJumper:!0},dateFormatter:"string",headerTitle:n.formatMessage({id:"agent",defaultMessage:"Agent"})}),c&&(0,z.jsx)(V,{open:c,record:F,onClose:function(){return j(!1)},onSuccess:function(){var e;return null===(e=a.current)||void 0===e?void 0:e.reload()}}),C&&(0,z.jsx)(Y,{open:C,onClose:function(){return U(!1)},onSubmit:function(){var e=d()(l()().mark((function e(t){var s,i,o,u,d,c,f,g,m,p,v,h,M,b,w,y;return l()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(((null==t?void 0:t.length)||0)>200)){e.next=3;break}return x.yw.warning(n.formatMessage({id:"agent.create.batch.limit",defaultMessage:"超过最大批量 200，请分批创建"})),e.abrupt("return");case 3:s="agent-batch-create",x.yw.loading({content:n.formatMessage({id:"saving",defaultMessage:"Saving..."}),key:s,duration:0}),i=[],o=function(e){return new Promise((function(t){return setTimeout(t,e)}))},u=r()(t),e.prev=8,u.s();case 10:if((d=u.n()).done){e.next=52;break}c=d.value,f=0,g=!1,m=null;case 15:if(!(f<3)||g){e.next=49;break}return e.prev=16,e.next=19,(0,k.x_)(c);case 19:if(200!==(null==(p=e.sent)?void 0:p.code)){e.next=24;break}return i.push({uid:c.memberUid,ok:!0}),g=!0,e.abrupt("break",49);case 24:return i.push({uid:c.memberUid,ok:!1,code:null==p?void 0:p.code,msg:null==p?void 0:p.message}),g=!0,e.abrupt("break",49);case 29:if(e.prev=29,e.t0=e.catch(16),h=null===e.t0||void 0===e.t0||null===(v=e.t0.response)||void 0===v?void 0:v.status,m=e.t0,f+=1,!(409===h&&f<3)){e.next=40;break}return e.next=37,o(300*f);case 37:return e.abrupt("continue",15);case 40:if(502!==h&&503!==h&&504!==h||!(f<3)){e.next=44;break}return e.next=43,o(300*f);case 43:return e.abrupt("continue",15);case 44:return i.push({uid:c.memberUid,ok:!1,code:h,msg:(null===e.t0||void 0===e.t0?void 0:e.t0.message)||"error"}),g=!0,e.abrupt("break",49);case 47:e.next=15;break;case 49:!g&&m&&i.push({uid:c.memberUid,ok:!1,msg:(null===(M=m)||void 0===M?void 0:M.message)||"error"});case 50:e.next=10;break;case 52:e.next=57;break;case 54:e.prev=54,e.t1=e.catch(8),u.e(e.t1);case 57:return e.prev=57,u.f(),e.finish(57);case 60:b=i.filter((function(e){return e.ok})).length,w=i.length-b,b>0?(x.yw.success({content:n.formatMessage({id:"create.success",defaultMessage:"Create success"})+" (".concat(b,")"),key:s}),U(!1),null===(y=a.current)||void 0===y||y.reload()):x.yw.destroy(s),w>0&&x.yw.warning(n.formatMessage({id:"create.partial.failed",defaultMessage:"部分创建失败，请查看失败项并重试"})+" (".concat(w,")"));case 64:case"end":return e.stop()}}),e,null,[[8,54,57,60],[16,29]])})));return function(t){return e.apply(this,arguments)}}()})]})}},41587:function(e,t,n){n.d(t,{Z:function(){return o}});var a=n(6844),r=n(26557),s=n(26407),i=n(20744),o=(0,r.Ue)()((0,s.mW)((0,s.tJ)((0,i.n)((function(e,t){return{memberResult:{data:{content:[],totalElements:0}},insertMember:function(t){e((function(e){e.memberResult.data.content.unshift(t)}))},updateMember:function(t){e((function(e){var n=e.memberResult.data.content,a=n.findIndex((function(e){return e.uid===t.uid}));-1!==a?n[a]=t:console.warn("Member with uid ".concat(t.uid," not found."))}))},deleteMember:function(t){e((function(e){var n=e.memberResult.data.content,a=n.findIndex((function(e){return e.uid===t.uid}));-1!==a?n.splice(a,1):console.warn("Member with uid ".concat(t.uid," not found."))}))},setMemberResult:function(t){e({memberResult:t})},deleteMemberCache:function(){return e({},!0)}}})),{name:a.PQL})))}}]);