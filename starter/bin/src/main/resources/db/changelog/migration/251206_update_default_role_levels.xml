<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="251206-update-default-role-levels" author="githubcopilot">
        <validCheckSum>9:6296377a79e87e59cf59cabc2e839cb5</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="bytedesk_core_role" />
        </preConditions>
        <comment>
            Align persisted default role level_type values with the new RoleInitializer configuration so that each
            system role reflects the maximum scope it should manage.
        </comment>
                <sql>
                        UPDATE bytedesk_core_role SET level_type = 'PLATFORM'
                        WHERE uuid = 'df_role_super_uid' AND is_deleted = 0
                            AND (level_type IS NULL OR level_type &lt;&gt; 'PLATFORM');

                        UPDATE bytedesk_core_role SET level_type = 'ORGANIZATION'
                        WHERE uuid = 'df_role_admin_uid' AND is_deleted = 0
                            AND (level_type IS NULL OR level_type &lt;&gt; 'ORGANIZATION');

                        UPDATE bytedesk_core_role SET level_type = 'DEPARTMENT'
                        WHERE uuid = 'df_role_dept_admin_uid' AND is_deleted = 0
                            AND (level_type IS NULL OR level_type &lt;&gt; 'DEPARTMENT');

                        UPDATE bytedesk_core_role SET level_type = 'WORKGROUP'
                        WHERE uuid = 'df_role_wg_admin_uid' AND is_deleted = 0
                            AND (level_type IS NULL OR level_type &lt;&gt; 'WORKGROUP');

                        UPDATE bytedesk_core_role SET level_type = 'AGENT'
                        WHERE uuid = 'df_role_agent_uid' AND is_deleted = 0
                            AND (level_type IS NULL OR level_type &lt;&gt; 'AGENT');

                        UPDATE bytedesk_core_role SET level_type = 'USER'
                        WHERE uuid = 'df_role_user_uid' AND is_deleted = 0
                            AND (level_type IS NULL OR level_type &lt;&gt; 'USER');
        </sql>
        <rollback>
            <sql>
                UPDATE bytedesk_core_role
                                SET level_type = 'PLATFORM'
                WHERE uuid IN (
                    'df_role_super_uid',
                    'df_role_admin_uid',
                    'df_role_dept_admin_uid',
                    'df_role_wg_admin_uid',
                    'df_role_agent_uid',
                    'df_role_user_uid'
                                )
                                AND is_deleted = 0
                                AND (level_type IS NULL OR level_type &lt;&gt; 'PLATFORM');
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
