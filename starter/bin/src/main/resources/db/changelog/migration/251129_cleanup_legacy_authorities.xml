<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Step 1: First delete role_authority associations for legacy authorities -->
    <changeSet id="251129-cleanup-role-authority-associations" author="githubcopilot">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="bytedesk_core_role_authority" />
                <tableExists tableName="bytedesk_core_authority" />
            </and>
        </preConditions>
        <comment>
            Remove role_authority associations that reference legacy authorities.
            Must run BEFORE deleting authorities due to foreign key constraint.
        </comment>
        <sql>
            DELETE FROM bytedesk_core_role_authority 
            WHERE authority_id IN (
                SELECT id FROM bytedesk_core_authority WHERE uuid IN (
                    'member_create', 'member_read', 'member_update', 'member_delete', 'member_export',
                    'role_create', 'role_read', 'role_update', 'role_delete', 'role_export',
                    'kbase_create', 'kbase_read', 'kbase_update', 'kbase_delete', 'kbase_export',
                    'robot_create', 'robot_read', 'robot_update', 'robot_delete', 'robot_export',
                    'agent_create', 'agent_read', 'agent_update', 'agent_delete', 'agent_export',
                    'workgroup_create', 'workgroup_read', 'workgroup_update', 'workgroup_delete', 'workgroup_export',
                    'ticket_create', 'ticket_read', 'ticket_update', 'ticket_delete', 'ticket_export'
                )
            )
        </sql>
        <rollback>
            <comment>No rollback needed - these are legacy records</comment>
        </rollback>
    </changeSet>

    <!-- Step 2: Now delete the legacy authority records -->
    <changeSet id="251129-cleanup-legacy-authorities" author="githubcopilot">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="bytedesk_core_authority" />
        </preConditions>
        <comment>
            Remove legacy non-hierarchical authority records by uuid.
            Old format uuid: module_action (e.g., member_create, role_read) - lowercase without level
            New format: MODULE_LEVEL_ACTION (e.g., MEMBER_PLATFORM_CREATE) - with level
        </comment>
        
        <!-- Delete all legacy authorities by uuid -->
        <delete tableName="bytedesk_core_authority">
            <where>uuid IN (
                'member_create', 'member_read', 'member_update', 'member_delete', 'member_export',
                'role_create', 'role_read', 'role_update', 'role_delete', 'role_export',
                'kbase_create', 'kbase_read', 'kbase_update', 'kbase_delete', 'kbase_export',
                'robot_create', 'robot_read', 'robot_update', 'robot_delete', 'robot_export',
                'agent_create', 'agent_read', 'agent_update', 'agent_delete', 'agent_export',
                'workgroup_create', 'workgroup_read', 'workgroup_update', 'workgroup_delete', 'workgroup_export',
                'ticket_create', 'ticket_read', 'ticket_update', 'ticket_delete', 'ticket_export'
            )</where>
        </delete>

        <rollback>
            <comment>No rollback needed - these are legacy records</comment>
        </rollback>
    </changeSet>

</databaseChangeLog>
