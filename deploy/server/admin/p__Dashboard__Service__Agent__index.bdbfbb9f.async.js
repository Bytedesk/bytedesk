"use strict";(self.webpackChunkadmin=self.webpackChunkadmin||[]).push([[1642],{74840:function(e,t,n){n.d(t,{Z:function(){return l}});var a=n(83910),r=n(44194),s={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M288 421a48 48 0 1096 0 48 48 0 10-96 0zm352 0a48 48 0 1096 0 48 48 0 10-96 0zM512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm263 711c-34.2 34.2-74 61-118.3 79.8C611 874.2 562.3 884 512 884c-50.3 0-99-9.8-144.8-29.2A370.4 370.4 0 01248.9 775c-34.2-34.2-61-74-79.8-118.3C149.8 611 140 562.3 140 512s9.8-99 29.2-144.8A370.4 370.4 0 01249 248.9c34.2-34.2 74-61 118.3-79.8C413 149.8 461.7 140 512 140c50.3 0 99 9.8 144.8 29.2A370.4 370.4 0 01775.1 249c34.2 34.2 61 74 79.8 118.3C874.2 413 884 461.7 884 512s-9.8 99-29.2 144.8A368.89 368.89 0 01775 775zM664 533h-48.1c-4.2 0-7.8 3.2-8.1 7.4C604 589.9 562.5 629 512 629s-92.1-39.1-95.8-88.6c-.3-4.2-3.9-7.4-8.1-7.4H360a8 8 0 00-8 8.4c4.4 84.3 74.5 151.6 160 151.6s155.6-67.3 160-151.6a8 8 0 00-8-8.4z"}}]},name:"smile",theme:"outlined"},i=n(54183),o=function(e,t){return r.createElement(i.Z,(0,a.Z)({},e,{ref:t,icon:s}))};var l=r.forwardRef(o)},59908:function(e,t,n){n.d(t,{Z:function(){return l}});var a=n(83910),r=n(44194),s={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M400 317.7h73.9V656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V317.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 163a8 8 0 00-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"upload",theme:"outlined"},i=n(54183),o=function(e,t){return r.createElement(i.Z,(0,a.Z)({},e,{ref:t,icon:s}))};var l=r.forwardRef(o)},39790:function(e,t,n){var a=n(94433),r=n(38956),s=n(44194),i=n(35074),o=n(31549),l=["fieldProps","request","params","proFieldProps"],u=function(e,t){var n=e.fieldProps,s=e.request,u=e.params,d=e.proFieldProps,c=(0,r.Z)(e,l);return(0,o.jsx)(i.Z,(0,a.Z)({valueType:"treeSelect",fieldProps:n,ref:t,request:s,params:u,filedConfig:{customLightMode:!0},proFieldProps:d},c))},d=s.forwardRef(u);t.Z=d},41245:function(e,t,n){n.d(t,{D$:function(){return f},EP:function(){return h},hS:function(){return p},z_:function(){return c}});var a=n(90819),r=n.n(a),s=n(73193),i=n.n(s),o=n(89933),l=n.n(o),u=n(39497),d=n(14906);function c(e){return g.apply(this,arguments)}function g(){return(g=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/query/org",{method:"GET",params:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function f(e){return m.apply(this,arguments)}function m(){return(m=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/create",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e){return v.apply(this,arguments)}function v(){return(v=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/update",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(e){return x.apply(this,arguments)}function x(){return(x=l()(r()().mark((function e(t){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,d.request)("/api/v1/member/delete",{method:"POST",data:i()(i()({},t),{},{channel:u.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},56663:function(e,t,n){var a=n(90819),r=n.n(a),s=n(89933),i=n.n(s),o=n(45332),l=n.n(o),u=n(73614),d=n(19433),c=n(12864),g=n(7704),f=n(91361),m=n(98830),p=n(39497),v=n(71256),h=n(25784),x=n(2250),M=n(14906),b=n(44194),w=n(11329),S=n(23753),y=n(31549);t.Z=function(e){var t,n,a,s,o=h.A.useForm(),k=l()(o,1)[0],j=(0,M.useIntl)(),C=(0,f.Z)().translateString,Z=(0,m.u)((function(e){return e.currentOrg})),F=(0,b.useState)(),U=l()(F,2),T=U[0],q=U[1],I=(0,b.useState)(),A=l()(I,2),P=A[0],R=A[1],E=(0,b.useState)(),L=l()(E,2),z=L[0],O=L[1],D=(0,b.useState)(""),N=l()(D,2),B=N[0],V=N[1],K=(0,b.useRef)(!1),W=(0,b.useRef)(),H=(0,b.useMemo)((function(){var t;return null!==(t=e.serviceSettings)&&void 0!==t?t:{}}),[e.serviceSettings]),J=(0,b.useMemo)((function(){var e,t;return null!==(e=null!==(t=null==H?void 0:H.draft)&&void 0!==t?t:null==H?void 0:H.live)&&void 0!==e?e:void 0}),[H]),Q=(0,b.useCallback)((function(t){var n;null===(n=e.onServiceSettingsChange)||void 0===n||n.call(e,t)}),[e.onServiceSettingsChange]),Y=(0,b.useCallback)((function(e){k.setFieldValue("welcomeTip",e),Q({welcomeTip:e})}),[k,Q]);(0,b.useEffect)((function(){if(null!=Z&&Z.uid&&(W.current!==Z.uid&&(W.current=Z.uid,K.current=!1),!K.current)){K.current=!0;var e=function(){var e=i()(r()().mark((function e(){var t,n,a,s,i,o,l;return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d.yw.loading(j.formatMessage({id:"loading",defaultMessage:"Loading"})),t={pageNumber:0,pageSize:50,type:p.QPQ,orgUid:Z.uid},e.next=4,(0,g.AP)(t);case 4:n=e.sent,S.Z.debug("TabServiceWelcome queryKbasesByOrg:",n,t),d.yw.destroy(),200===n.code?(R(n),i=(null===(a=n.data)||void 0===a?void 0:a.content)||[],o=null==J?void 0:J.welcomeKbUid,(l=o||z||(null===(s=i[0])||void 0===s?void 0:s.uid))&&(O(l),k.setFieldValue("welcomeKbUid",l),o!==l&&Q({welcomeKbUid:l}))):d.yw.error(n.message);case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),function(){}}}),[null==Z?void 0:Z.uid,j,null==J?void 0:J.welcomeKbUid,z,k,Q]),(0,b.useEffect)((function(){if(null!=Z&&Z.uid&&z){var e=function(){var e=i()(r()().mark((function e(){var t,n;return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d.yw.loading(j.formatMessage({id:"loading",defaultMessage:"Loading"})),t={pageNumber:0,pageSize:50,orgUid:Z.uid,kbUid:z},e.next=4,(0,c.pf)(t);case 4:n=e.sent,S.Z.debug("TabServiceWelcome queryFaqsByOrg:",n,t),d.yw.destroy(),200===n.code?q(n):d.yw.error(n.message);case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return e(),function(){}}}),[null==Z?void 0:Z.uid,z,j]),(0,b.useEffect)((function(){if(J){var e=null==J?void 0:J.welcomeFaqs,t=Array.isArray(J.welcomeFaqUids)?J.welcomeFaqUids:Array.isArray(e)?e.map((function(e){return null==e?void 0:e.uid})).filter(Boolean):[];k.setFieldValue("welcomeFaqUids",t)}}),[k,null==T||null===(t=T.data)||void 0===t||null===(t=t.content)||void 0===t?void 0:t.length,null==J?void 0:J.welcomeFaqUids,J]);var _=(0,b.useCallback)((function(e){O(e),k.setFieldValue("welcomeFaqUids",[]),Q({welcomeKbUid:e,welcomeFaqUids:[]})}),[Q,k]);return(0,b.useEffect)((function(){var e=C(null==J?void 0:J.welcomeTip);void 0!==e&&B!==e&&V(e),null!=J&&J.welcomeKbUid&&(k.setFieldValue("welcomeKbUid",J.welcomeKbUid),z!==J.welcomeKbUid&&O(J.welcomeKbUid))}),[C,null==J?void 0:J.welcomeTip,null==J?void 0:J.welcomeKbUid,B,k,z,null==P||null===(n=P.data)||void 0===n||null===(n=n.content)||void 0===n?void 0:n.length]),(0,y.jsxs)(h.A,{form:k,submitter:!1,style:{marginLeft:"20px"},children:[(0,y.jsx)(h.A.Item,{name:"welcomeTip",label:(0,y.jsxs)("span",{children:[j.formatMessage({id:"agent.settings.welcome.tip"}),(0,y.jsx)(u.Z,{type:"service",keys:["welcomeTip"],live:null==H?void 0:H.live,draft:null==H?void 0:H.draft})]}),tooltip:j.formatMessage({id:"agent.settings.welcome.tip"}),rules:[{required:!0,message:j.formatMessage({id:"agent.settings.welcome.tip.required"})}],children:(0,y.jsx)(w.Z,{placeholder:j.formatMessage({id:"agent.settings.welcome.tip.placeholder"}),value:B,toolbarKeys:(0,v.eD)(),style:{height:"150px",width:"600px"},maxLength:200,onChange:Y})}),(0,y.jsx)(x.Z,{name:"welcomeKbUid",width:"md",label:(0,y.jsxs)("span",{children:[j.formatMessage({id:"menu.kbase.select",defaultMessage:"选择欢迎语常见问题知识库"}),(0,y.jsx)(u.Z,{type:"service",keys:["welcomeKbUid"],live:null==H?void 0:H.live,draft:null==H?void 0:H.draft})]}),options:null==P||null===(a=P.data)||void 0===a||null===(a=a.content)||void 0===a?void 0:a.map((function(e){return{label:C(e.name)||e.name,value:e.uid}})),fieldProps:{onChange:function(e){return _(e)},allowClear:!0,placeholder:(0,y.jsx)(M.FormattedMessage,{id:"choose",defaultMessage:"Choose"})}}),(0,y.jsx)(x.Z,{name:"welcomeFaqUids",width:"md",label:(0,y.jsxs)("span",{children:[j.formatMessage({id:"menu.kbase.faq.welcome"}),(0,y.jsx)(u.Z,{type:"service",keys:["welcomeFaqUids"],live:null==H?void 0:H.live,draft:null==H?void 0:H.draft})]}),options:null==T||null===(s=T.data)||void 0===s||null===(s=s.content)||void 0===s?void 0:s.map((function(e){return{label:C(e.question),value:e.uid}})),fieldProps:{mode:"multiple",allowClear:!0,placeholder:(0,y.jsx)(M.FormattedMessage,{id:"choose",defaultMessage:"Choose"}),onChange:function(e){return Q({welcomeFaqUids:e})}}})]})}},2011:function(e,t,n){n.d(t,{G:function(){return f}});var a=n(73193),r=n.n(a),s=(n(44194),n(81637)),i=n(39497),o=n(96596),l=n.n(o),u=n(23753),d=n(19433),c=n(5932),g=n(31549),f=function(e){var t=e.children,n=e.onSuccess,a=e.onError,o={file:null,fileName:"test.png",fileType:"image/png",isAvatar:"true",kbType:i.IrL,categoryUid:"",kbUid:"",channel:i.XtJ},f={name:"file",accept:"image/*",action:(0,c.M$)(),headers:{Authorization:"Bearer "+localStorage.getItem(i.LA8)},data:o,showUploadList:!1,beforeUpload:function(e){u.Z.log("beforeUpload",e);var t=l()(new Date).format("YYYYMMDDHHmmss")+"_"+e.name;return o.file=e,o.fileName=t,o.fileType=e.type,u.Z.log("beforeUpload",o),!0},onChange:function(e){if("uploading"!==e.file.status&&u.Z.log("not uploading:",e.file),"done"===e.file.status)if(u.Z.log("response: ",e.file.response),200===e.file.response.code){var t=e.file.response.data.fileUrl;n(t),d.yw.success("".concat(e.file.name," 上传成功"))}else a(e.file),d.yw.error("".concat(e.file.name," 上传失败"));else"error"===e.file.status&&(d.yw.error("".concat(e.file.name," 上传失败")),a(e.file))}};return(0,g.jsx)(s.Z,r()(r()({},f),{},{children:t}))}},3391:function(e,t,n){n.r(t),n.d(t,{default:function(){return ze}});var a=n(44194),r=n(67738),s=n(14906),i=n(76711),o=n.n(i),l=n(90819),u=n.n(l),d=n(89933),c=n.n(d),g=n(73193),f=n.n(g),m=n(45332),p=n.n(m),v=n(77033),h=n(82770),x=n(39487),M=n(32525),b=n(50716),w=n(92354),S=n(81739),y=n(66431),k=n(63649),j=n(74840),C=n(29337),Z=n(68779),F=n(12322),U=n(31806),T=n(56482),q=n(10162),I=n(59304),A=n(54881),P=n(47944),R=n(80556),E=n(55785),L=n(49764),z=n(19433),O=n(2890),D=n(98830),N=n(75112),B=n(14597),V=n(39497),K=n(99665),W=n(27153),H=(n(84262),n(66547)),J=(n(94212),n(24479),n(41196)),Q=n(86895),Y=n(31549),_=function(e){var t=e.open,n=e.onOpenChange,r=e.orgUid,i=e.record,o=e.onSuccess,l=(0,s.useIntl)(),d=J.Z.useForm(),g=p()(d,1)[0];(0,a.useEffect)((function(){var e,n;t&&(i?g.setFieldsValue({name:i.name||"",description:i.description||"",enabled:null===(e=i.enabled)||void 0===e||e,isDefault:null!==(n=i.isDefault)&&void 0!==n&&n}):(g.resetFields(),g.setFieldsValue({enabled:!0,isDefault:!1})))}),[t,i,g]);var m=function(){var e=c()(u()().mark((function e(){var t,a,s,d;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,g.validateFields();case 3:if(t=e.sent,a=f()(f()({},t),{},{orgUid:r,uid:null==i?void 0:i.uid}),null==i||!i.uid){e.next=11;break}return e.next=8,(0,O.wU)(a);case 8:e.t0=e.sent,e.next=14;break;case 11:return e.next=13,(0,O.IH)(a);case 13:e.t0=e.sent;case 14:(s=e.t0)&&200===s.code?(d=s.data||{},z.yw.success(l.formatMessage({id:null!=i&&i.uid?"common.updated":"common.created",defaultMessage:null!=i&&i.uid?"更新成功":"创建成功"})),null==o||o(d),n(!1)):z.yw.error((null==s?void 0:s.message)||"操作失败"),e.next=21;break;case 18:e.prev=18,e.t1=e.catch(0),console.error("Error saving agent settings:",e.t1);case 21:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(){return e.apply(this,arguments)}}();return(0,Y.jsx)(Q.Z,{title:(0,Y.jsx)(s.FormattedMessage,{id:null!=i&&i.uid?"agent.settings.template.edit":"agent.settings.template.create",defaultMessage:null!=i&&i.uid?"编辑模板":"新建模板"}),open:t,onOk:m,onCancel:function(){n(!1)},okText:(0,Y.jsx)(s.FormattedMessage,{id:"common.save",defaultMessage:"保存"}),cancelText:(0,Y.jsx)(s.FormattedMessage,{id:"common.cancel",defaultMessage:"取消"}),destroyOnHidden:!0,width:600,children:(0,Y.jsxs)(J.Z,{form:g,layout:"vertical",preserve:!1,children:[(0,Y.jsx)(J.Z.Item,{name:"name",label:(0,Y.jsx)(s.FormattedMessage,{id:"agent.settings.template.name",defaultMessage:"模板名称"}),rules:[{required:!0,message:l.formatMessage({id:"required",defaultMessage:"此项为必填项"})}],children:(0,Y.jsx)(M.Z,{placeholder:l.formatMessage({id:"agent.settings.template.name.placeholder",defaultMessage:"请输入模板名称"})})}),(0,Y.jsx)(J.Z.Item,{name:"description",label:(0,Y.jsx)(s.FormattedMessage,{id:"description",defaultMessage:"描述"}),children:(0,Y.jsx)(M.Z.TextArea,{rows:3,placeholder:l.formatMessage({id:"agent.settings.template.description.placeholder",defaultMessage:"请输入模板描述"})})}),(0,Y.jsx)(J.Z.Item,{name:"enabled",label:(0,Y.jsx)(s.FormattedMessage,{id:"enabled",defaultMessage:"启用"}),valuePropName:"checked",children:(0,Y.jsx)(y.Z,{})})]})})},G=n(90631),X=n(1460),$=n(56663),ee=n(417),te=(n(52260),n(24476)),ne=n(58791),ae=n(23753),re=function(){var e=(0,s.useIntl)(),t=(0,D.u)((function(e){return e.currentOrg})),n=(0,N.Z)(),i=n.leftSiderStyle,l=(n.contentStyle,(0,B.Z)().isDarkMode),d=(0,a.useState)(!1),g=p()(d,2),m=g[0],V=g[1],J=(0,a.useState)([]),Q=p()(J,2),re=Q[0],se=Q[1],ie=(0,a.useState)(),oe=p()(ie,2),le=oe[0],ue=oe[1],de=(0,a.useState)(""),ce=p()(de,2),ge=ce[0],fe=ce[1],me=(0,a.useState)("tips"),pe=p()(me,2),ve=pe[0],he=pe[1],xe=(0,a.useState)(!1),Me=p()(xe,2),be=Me[0],we=Me[1],Se=(0,a.useState)(null),ye=p()(Se,2),ke=ye[0],je=ye[1],Ce=(0,a.useMemo)((function(){return re.find((function(e){return e.uid===le}))||null}),[re,le]),Ze=(0,a.useState)(!1),Fe=p()(Ze,2),Ue=Fe[0],Te=Fe[1],qe=(0,a.useState)(!1),Ie=p()(qe,2),Ae=Ie[0],Pe=Ie[1],Re=(0,K.z)((function(e){return{setCurrentAgentSettings:e.setCurrentAgentSettings,currentAgentSettings:e.currentAgentSettings}})),Ee=Re.setCurrentAgentSettings,Le=Re.currentAgentSettings,ze=(0,a.useState)(!1),Oe=p()(ze,2),De=Oe[0],Ne=Oe[1],Be=(0,a.useRef)(""),Ve=(0,a.useMemo)((function(){var e;return null!==(e=null!=Le?Le:Ce)&&void 0!==e?e:null}),[Le,Ce]),Ke=(0,a.useCallback)((function(e){if(Le){var t=Le.draftServiceSettings||Le.serviceSettings||{};Ee(f()(f()({},Le),{},{draftServiceSettings:f()(f()({},t),e)}))}}),[Le,Ee]),We=(0,a.useCallback)((function(e){if(Le){var t=Le.draftInviteSettings||Le.inviteSettings||{};Ee(f()(f()({},Le),{},{draftInviteSettings:f()(f()({},t),e)}))}}),[Le,Ee]),He=(0,a.useCallback)((function(e){if(Le){var t=Le.draftMessageLeaveSettings||Le.messageLeaveSettings||{};Ee(f()(f()({},Le),{},{draftMessageLeaveSettings:f()(f()({},t),e)}))}}),[Le,Ee]),Je=(0,a.useCallback)((function(e){if(Le){var t=Le.draftWorktimeSettings||Le.worktimeSettings||{};Ee(f()(f()({},Le),{},{draftWorktimeSettings:f()(f()({},t),e)}))}}),[Le,Ee]),Qe=(0,a.useCallback)((function(e){if(Le){var t=Le.draftQueueSettings||Le.queueSettings||{};Ee(f()(f()({},Le),{},{draftQueueSettings:f()(f()({},t),e)}))}}),[Le,Ee]),Ye=(0,a.useCallback)((function(e){Le&&Ee(f()(f()({},Le),e))}),[Le,Ee]),_e=(0,a.useMemo)((function(){if(!ge)return re;var e=ge.toLowerCase();return re.filter((function(t){var n=(t.name||t.uid||"").toLowerCase(),a=(t.description||"").toLowerCase();return n.includes(e)||a.includes(e)}))}),[re,ge]),Ge=(0,a.useCallback)(function(){var e=c()(u()().mark((function e(n,a){var r,s,i,o,l,d;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t&&t.uid){e.next=2;break}return e.abrupt("return");case 2:return V(!0),r="welcome",e.prev=4,i=(null!=n?n:"").trim(),o={orgUid:t.uid,pageNumber:0,pageSize:100,searchText:i||void 0},e.next=9,(0,O.u9)(o);case 9:l=e.sent,ae.Z.debug("加载客服配置模板列表: ",l,o),d=(null==l||null===(s=l.data)||void 0===s?void 0:s.content)||[],se(d),!(d.length>0)||le&&d.some((function(e){return e.uid===le}))||(ue(d[0].uid),null!=a&&a.keepActive||he(r));case 14:return e.prev=14,V(!1),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[4,,14,17]])})));return function(t,n){return e.apply(this,arguments)}}(),[null==t?void 0:t.uid,le]);(0,a.useEffect)((function(){Ge(ge)}),[null==t?void 0:t.uid]),(0,a.useEffect)((function(){Ce?(Ee(Ce),Be.current=JSON.stringify(null!=Ce?Ce:{}),Ne(!1)):(Ee(null),Be.current=JSON.stringify({}),Ne(!1))}),[le]),(0,a.useEffect)((function(){if(Ce)try{var e=JSON.stringify(null!=Le?Le:{});Ne(e!==Be.current)}catch(e){Ne(!0)}}),[Le,null==Ce?void 0:Ce.uid]);var Xe=function(){var n=c()(u()().mark((function n(a){var r,s,i;return u()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!=(r=null!=a?a:Ce)&&r.uid){n.next=3;break}return n.abrupt("return");case 3:return s={uid:r.uid,orgUid:null==t?void 0:t.uid,pageNumber:0,pageSize:100},n.next=6,(0,O.SJ)(s);case 6:i=n.sent,console.log("删除客服配置模板结果：",i,s),i&&200===i.code?(z.yw.success(e.formatMessage({id:"common.deleted",defaultMessage:"删除成功"})),Ge(ge)):z.yw.error((null==i?void 0:i.message)||"删除失败");case 9:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),$e=function(){var n=c()(u()().mark((function n(a,r){var s,i;return u()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,s={uid:a,orgUid:null==t?void 0:t.uid},!r){n.next=8;break}return n.next=5,(0,O.RB)(s);case 5:n.t0=n.sent,n.next=11;break;case 8:return n.next=10,(0,O.iO)(s);case 10:n.t0=n.sent;case 11:(i=n.t0)&&200===i.code?(z.yw.success(e.formatMessage({id:r?"common.enabled":"common.disabled",defaultMessage:r?"已启用":"已停用"})),Ge(ge)):z.yw.error((null==i?void 0:i.message)||"操作失败"),n.next=19;break;case 15:n.prev=15,n.t1=n.catch(0),console.error("切换启用状态失败:",n.t1),z.yw.error("操作失败");case 19:case"end":return n.stop()}}),n,null,[[0,15]])})));return function(e,t){return n.apply(this,arguments)}}(),et=function(e,t){if(e){var n={};return t.forEach((function(t){void 0!==e[t]&&(n[t]=e[t])})),n}},tt=function(e){if(e){var t=et(e,["language","autoPopup","showTopTip","topTip","topTipStart","topTipEnd","showRateBtn","autoInviteRate","inviteRateTip","rateMsgCount","showPreForm","preFormRequired","preForm","showPreSearch","showHistory","showInputAssociation","showCaptcha","welcomeTip","welcomeFaqUids","welcomeKbUid","enableWorkflow","workflowUid","autoCloseMin","autoCloseTip","agentCloseTip","queueTip","leavemsgTip","showRightIframe","rightIframeUrl","showFaqs","faqUids","faqKbUid","showQuickFaqs","quickFaqUids","quickFaqKbUid","showGuessFaqs","guessFaqUids","showHotFaqs","hotFaqUids","showShortcutFaqs","shortcutFaqUids","relatedQuestionGuide","enableProactiveTrigger","noResponseTimeout","proactiveMessage","maxProactiveCount","proactiveInterval","triggerConditions","proactiveFaqUids","showLogo","validateUntil"]),n=function(n,a){if(void 0===t[n]){var r=null==e?void 0:e[a];if(Array.isArray(r)){var s=r.map((function(e){return null==e?void 0:e.uid})).filter(Boolean);s.length>0&&(t[n]=s)}}};n("welcomeFaqUids","welcomeFaqs"),n("faqUids","faqs"),n("quickFaqUids","quickFaqs"),n("guessFaqUids","guessFaqs"),n("hotFaqUids","hotFaqs"),n("shortcutFaqUids","shortcutFaqs"),n("proactiveFaqUids","proactiveFaqs");var a=function(e){if(e)return et(e,["smile","image","file","rate","leavemsg","orderSelector","ticket","audio","video","tel","order"])}(e.toolbar);return f()(f()({},t),a?{toolbar:a}:{})}},nt=function(e){if(e)return et(e,["name","description","defaultTemplate","show","text","icon","delay","loop","loopDelay","loopCount","messageList","targetedInvite","targetedInviteUrls","smartTrigger","pageStayTriggerSeconds","scrollTrigger","scrollTriggerPerceninviteSettinge","exitIntentTrigger","referrerTrigger","referrerPatterns","deviceTypes","visitorSegmentation","newVisitorMessage","returningVisitorMessage","vipVisitorMessage","inviteStyle","inviteAnimation","abTesting"])},at=function(e){if(e)return et(e,["name","description","color","order"])},rt=function(e){if(e)return et(e,["messageLeaveEnabled","messageLeaveTip","messageLeaveAgentUid","messageLeaveNotify","messageLeaveNotifyType","messageLeaveNotifyEmail","messageLeaveNotifyMobile","messageLeaveForm"])},st=function(e){if(e)return et(e,["queueRobot","showQueuePosition","showEstimatedWaitTime","avgWaitTimePerPerson","maxWaiting","maxWaitTime","queueTip","queueNoticeBatchWindowMs"])},it=function(e){if(e)return et(e,["enabled","regularWorktimes","specialWorktimes","holidays"])},ot=function(e){if(e)return et(e,["autoReplyEnabled","autoReplyType","autoReplyUid","autoReplyContentType","autoReplyContent","kbUid"])},lt=function(e){if(e)return et(e,["name","description","defaultTemplate","enabled","rateDownTagList","maxTagSelection","allowCustomFeedback","maxFeedbackLength","requireFollowup","showThankYouMessage","thankYouMessage","triggerSatisfactionSurvey","markForQualityInspection","offerHumanAgent"])},ut=function(e){if(e)return et(e,["name","description","needReview","reviewTimeType","reviewStartTime","reviewEndTime","reviewMethod","reviewTimeoutMinutes"])},dt=function(){var n=c()(u()().mark((function n(){var a,r,s,i,o,l,d;return u()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!=Ce&&Ce.uid){n.next=3;break}return z.yw.warning(e.formatMessage({id:"agent.settings.template.select",defaultMessage:"请从左侧选择模板"})),n.abrupt("return");case 3:return Te(!0),n.prev=4,a=Le&&Le.uid===Ce.uid?Le:Ce,r=function(e,t){return f()(f()({},e||{}),t||{})},s={uid:Ce.uid,orgUid:null==t?void 0:t.uid,name:null==a?void 0:a.name,description:null==a?void 0:a.description,isDefault:null==a?void 0:a.isDefault,enabled:null==a?void 0:a.enabled,serviceSettings:tt(r(null==a?void 0:a.serviceSettings,null==a?void 0:a.draftServiceSettings)),inviteSettings:nt(r(null==a?void 0:a.inviteSettings,null==a?void 0:a.draftInviteSettings)),intentionSettings:at(r(null==a?void 0:a.intentionSettings,null==a?void 0:a.draftIntentionSettings)),maxThreadCount:null==a?void 0:a.maxThreadCount,timeoutRemindEnabled:null==a?void 0:a.timeoutRemindEnabled,timeoutRemindTime:null==a?void 0:a.timeoutRemindTime,timeoutRemindTip:null==a?void 0:a.timeoutRemindTip,messageLeaveSettings:rt(r(null==a?void 0:a.messageLeaveSettings,null==a?void 0:a.draftMessageLeaveSettings)),worktimeSettings:it(r(null==a?void 0:a.worktimeSettings,null==a?void 0:a.draftWorktimeSettings)),autoReplySettings:ot(r(null==a?void 0:a.autoReplySettings,null==a?void 0:a.draftAutoReplySettings)),queueSettings:st(r(null==a?void 0:a.queueSettings,null==a?void 0:a.draftQueueSettings)),rateDownSettings:lt(r(null==a?void 0:a.rateDownSettings,null==a?void 0:a.draftRateDownSettings)),agentStatusSettings:ut(r(null==a?void 0:a.agentStatusSettings,null==a?void 0:a.draftAgentStatusSettings))},n.next=10,(0,O.wU)(s);case 10:i=n.sent,console.log("保存客服配置模板结果：",i,s),i&&200===i.code?(z.yw.success(e.formatMessage({id:"common.saved",defaultMessage:"保存成功"})),d=null!==(o=null!==(l=i.data)&&void 0!==l?l:a)&&void 0!==o?o:{},Be.current=JSON.stringify(d),Ne(!1),Ge(ge,{keepActive:!0})):z.yw.error((null==i?void 0:i.message)||"保存失败"),n.next=19;break;case 15:n.prev=15,n.t0=n.catch(4),console.error("保存失败:",n.t0),z.yw.error("保存失败");case 19:return n.prev=19,Te(!1),n.finish(19);case 22:case"end":return n.stop()}}),n,null,[[4,15,19,22]])})));return function(){return n.apply(this,arguments)}}(),ct=function(){var n=c()(u()().mark((function n(){var a,r,s;return u()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!=Ce&&Ce.uid){n.next=3;break}return z.yw.warning(e.formatMessage({id:"agent.settings.template.select",defaultMessage:"请从左侧选择模板"})),n.abrupt("return");case 3:if(Pe(!0),n.prev=4,!De){n.next=8;break}return n.next=8,dt();case 8:return a={uid:Ce.uid,orgUid:null==t?void 0:t.uid},n.next=11,(0,O.Xy)(a);case 11:(r=n.sent)&&200===r.code?(z.yw.success(e.formatMessage({id:"common.published",defaultMessage:"发布成功"})),Be.current=JSON.stringify(null!==(s=r.data)&&void 0!==s?s:{}),Ne(!1),Ge(ge)):z.yw.error((null==r?void 0:r.message)||"发布失败"),n.next=19;break;case 15:n.prev=15,n.t0=n.catch(4),console.error("发布失败:",n.t0),z.yw.error("发布失败");case 19:return n.prev=19,Pe(!1),n.finish(19);case 22:case"end":return n.stop()}}),n,null,[[4,15,19,22]])})));return function(){return n.apply(this,arguments)}}(),gt=(0,a.useMemo)((function(){return null!=Ce&&Ce.uid?[{key:"welcome",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(j.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"agent.settings.service.welcome",defaultMessage:"欢迎语设置"})]}),children:(0,Y.jsx)($.Z,{serviceSettings:{live:null==Ve?void 0:Ve.serviceSettings,draft:null==Ve?void 0:Ve.draftServiceSettings},onServiceSettingsChange:Ke})},{key:"tips",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(C.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"agent.settings.service.tips",defaultMessage:"提示信息"})]}),children:(0,Y.jsx)(X.Z,{variant:"agent",serviceSettings:{live:null==Ve?void 0:Ve.serviceSettings,draft:null==Ve?void 0:Ve.draftServiceSettings},onServiceSettingsChange:Ke})},{key:"service",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(Z.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"agent.settings.service",defaultMessage:"服务设置"})]}),children:(0,Y.jsx)(G.Z,{variant:"agent",serviceSettings:{live:null==Ve?void 0:Ve.serviceSettings,draft:null==Ve?void 0:Ve.draftServiceSettings},agentMeta:{maxThreadCount:null==Ve?void 0:Ve.maxThreadCount,timeoutRemindTime:null==Ve?void 0:Ve.timeoutRemindTime},onServiceSettingsChange:Ke,onAgentMetaChange:Ye})},{key:"rate",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(F.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"rate",defaultMessage:"Rate"})]}),children:(0,Y.jsx)(W.Z,{variant:"agent",serviceSettings:{live:null==Ve?void 0:Ve.serviceSettings,draft:null==Ve?void 0:Ve.draftServiceSettings},onServiceSettingsChange:Ke})},{key:"messageLeave",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(U.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"agent.settings.message.leave",defaultMessage:"Leave Message"})]}),children:(0,Y.jsx)(ee.Z,{variant:"agent",messageLeaveSettings:{live:null==Ve?void 0:Ve.messageLeaveSettings,draft:null==Ve?void 0:Ve.draftMessageLeaveSettings},onMessageLeaveSettingsChange:He})},{key:"queue",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(ne.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"agent.settings.queue",defaultMessage:"排队设置"})]}),children:(0,Y.jsx)(te.Z,{variant:"agent",queueSettings:{live:null==Ve?void 0:Ve.queueSettings,draft:null==Ve?void 0:Ve.draftQueueSettings},onQueueSettingsChange:Qe})}].concat(o()([]),o()([]),[{key:"right",label:(0,Y.jsxs)("span",{children:[(0,Y.jsx)(T.Z,{})," ",(0,Y.jsx)(s.FormattedMessage,{id:"right",defaultMessage:"Right"})]}),children:(0,Y.jsx)(H.Z,{variant:"agent",serviceSettings:{live:null==Ve?void 0:Ve.serviceSettings,draft:null==Ve?void 0:Ve.draftServiceSettings},onServiceSettingsChange:Ke,settingsUid:Ce.uid,isActive:"right"===ve})}],o()([]),o()([])):[]}),[null==Ce?void 0:Ce.uid,Ve,Ke,We,He,Je,Qe,e,ve]);return(0,Y.jsxs)(Y.Fragment,{children:[(0,Y.jsxs)(v.Z,{style:{minHeight:"calc(100vh - 160px)"},children:[(0,Y.jsx)(v.Z.Panel,{defaultSize:"20%",min:"14%",max:"40%",style:i,children:(0,Y.jsxs)(L.Z,{title:e.formatMessage({id:"agent.settings.templates",defaultMessage:"模板列表"}),extra:(0,Y.jsx)(h.ZP,{size:"small",icon:(0,Y.jsx)(q.Z,{}),type:"primary",onClick:function(){je(null),we(!0)},children:(0,Y.jsx)(s.FormattedMessage,{id:"common.new",defaultMessage:"新建"})}),bodyStyle:{padding:8},loading:m,children:[(0,Y.jsx)("div",{style:{margin:"0 0 8px 0"},children:(0,Y.jsxs)(x.Z.Compact,{style:{width:"100%"},children:[(0,Y.jsx)(M.Z,{placeholder:e.formatMessage({id:"agent.settings.template.search",defaultMessage:"搜索模板名称"}),value:ge,onChange:function(e){return fe(e.target.value)},onPressEnter:function(e){Ge(ge)},allowClear:!0,size:"middle"}),(0,Y.jsx)(h.ZP,{type:"primary",size:"middle",onClick:function(){return Ge(ge)},children:"搜索"})]})}),(0,Y.jsx)("div",{style:{overflow:"auto",maxHeight:"calc(100vh - 280px)"},children:(0,Y.jsx)(b.Z,{dataSource:_e,locale:{emptyText:(0,Y.jsx)(w.Z,{description:e.formatMessage({id:"empty",defaultMessage:"暂无数据"}),image:w.Z.PRESENTED_IMAGE_SIMPLE})},renderItem:function(e){return(0,Y.jsx)(b.Z.Item,{style:le===e.uid?{backgroundColor:l?"#333333":"#dddddd",cursor:"pointer",borderRadius:6,marginBottom:8,padding:10}:{cursor:"pointer",borderRadius:6,marginBottom:8,padding:10},onClick:function(){return ue(e.uid)},children:(0,Y.jsx)(b.Z.Item.Meta,{title:(0,Y.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,Y.jsx)("div",{style:{fontWeight:500,flex:1},children:e.name||e.uid}),(0,Y.jsx)(x.Z,{size:4,children:e.isDefault?(0,Y.jsx)(S.Z,{color:"blue",children:"默认"}):null})]}),description:e.description?(0,Y.jsx)("div",{style:{color:l?"#aaa":"#999",fontSize:12},children:e.description}):null})},e.uid)}})})]})}),(0,Y.jsx)(v.Z.Panel,{children:Ce?(0,Y.jsx)(L.Z,{title:(0,Y.jsxs)(x.Z,{children:[(0,Y.jsxs)("span",{children:[e.formatMessage({id:"agent.settings.editing",defaultMessage:"编辑模板"}),": ",Ce.name||Ce.uid]}),(0,Y.jsx)(y.Z,{checked:Ce.enabled,onChange:function(e){return $e(Ce.uid,e)},checkedChildren:e.formatMessage({id:"common.enabled",defaultMessage:"启用"}),unCheckedChildren:e.formatMessage({id:"common.disabled",defaultMessage:"停用"})}),(0,Y.jsx)(h.ZP,{size:"small",icon:(0,Y.jsx)(I.Z,{}),onClick:function(e){var t;e.stopPropagation(),je(null!=(t=Ce)?t:Ce),we(!0)},children:"编辑"}),(0,Y.jsx)(k.Z,{title:e.formatMessage({id:"common.delete.confirm",defaultMessage:"确定要删除吗?"}),onConfirm:function(e){null==e||e.stopPropagation(),Xe(Ce)},onCancel:function(e){return null==e?void 0:e.stopPropagation()},okText:e.formatMessage({id:"common.confirm",defaultMessage:"确定"}),cancelText:e.formatMessage({id:"common.cancel",defaultMessage:"取消"}),children:(0,Y.jsx)(h.ZP,{size:"small",danger:!0,icon:(0,Y.jsx)(A.Z,{}),onClick:function(e){e.stopPropagation()},children:"删除"})}),Ce.isDefault?(0,Y.jsx)(S.Z,{color:"blue",children:"默认"}):null]}),extra:(0,Y.jsxs)(x.Z,{children:[(0,Y.jsx)(k.Z,{title:"发布到线上环境",description:"只有发布之后，才会应用到线上环境",okText:"继续发布",cancelText:"取消",onConfirm:function(e){var t;null==e||null===(t=e.stopPropagation)||void 0===t||t.call(e),ct()},onCancel:function(e){var t;return null==e||null===(t=e.stopPropagation)||void 0===t?void 0:t.call(e)},children:(0,Y.jsx)(h.ZP,{onClick:function(e){return e.stopPropagation()},loading:Ae,type:"default",icon:(0,Y.jsx)(P.Z,{}),children:(0,Y.jsx)(s.FormattedMessage,{id:"common.publish",defaultMessage:"发布"})})}),(0,Y.jsx)(h.ZP,{onClick:function(){Ce&&(Ee(Ce),Be.current=JSON.stringify(null!=Ce?Ce:{}),Ne(!1))},disabled:!De,icon:(0,Y.jsx)(R.Z,{}),children:(0,Y.jsx)(s.FormattedMessage,{id:"common.reset",defaultMessage:"重置"})}),(0,Y.jsx)(h.ZP,{type:"primary",loading:Ue,onClick:dt,disabled:!De,icon:(0,Y.jsx)(E.Z,{}),children:(0,Y.jsx)(s.FormattedMessage,{id:"common.save",defaultMessage:"保存"})})]}),children:(0,Y.jsx)(r.Z,{activeKey:ve,onChange:he,items:gt,style:{minHeight:"calc(100vh - 280px)"}})}):(0,Y.jsx)(L.Z,{children:(0,Y.jsx)(w.Z,{description:e.formatMessage({id:"agent.settings.template.select",defaultMessage:"请从左侧选择模板"})})})})]}),(0,Y.jsx)(_,{open:be,onOpenChange:we,orgUid:(null==t?void 0:t.uid)||"",record:ke,onSuccess:function(){we(!1),Ge(ge)}})]})},se=n(86222),ie=n.n(se),oe=n(89246),le=n(33797),ue=n(33019),de=n(75864),ce=n(25784),ge=n(2250),fe=n(89965),me=n(80953),pe=n(13847),ve=n(59908),he=n(41245),xe=n(2011),Me=function(e){var t=e.value,n=e.onChange,a=e.options,r=e.loading,s=e.placeholder,i=e.emptyContent,o=e.onSearch,l=e.onDropdownOpen,u=e.onCreate,d=e.createLabel,c=e.createTitle;return(0,Y.jsxs)(x.Z.Compact,{block:!0,children:[(0,Y.jsx)(pe.Z,{value:t,onChange:n,options:a,showSearch:!0,filterOption:!1,placeholder:s,loading:r,style:{flex:1},notFoundContent:i,onSearch:o,onOpenChange:function(e){e&&l()}}),(0,Y.jsx)(h.ZP,{size:"small",icon:(0,Y.jsx)(q.Z,{}),onClick:u,title:c,children:d})]})},be=function(e){var t,n,r=e.open,i=e.record,l=e.onClose,d=e.onSuccess,g=(0,s.useIntl)(),m=(0,D.u)((function(e){return e.currentOrg})),v=(0,a.useState)(!1),x=p()(v,2),M=x[0],b=x[1],w=(0,a.useState)([]),S=p()(w,2),y=S[0],k=S[1],j=(0,a.useState)(!1),C=p()(j,2),Z=C[0],F=C[1],U=(0,a.useState)((null==i?void 0:i.avatar)||""),T=p()(U,2),I=T[0],A=T[1],P=(0,a.useRef)(),R=(0,a.useMemo)((function(){return!(null==i||!i.uid)}),[i]),E=function(){var e=c()(u()().mark((function e(t){return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:A(t),z.yw.success(g.formatMessage({id:"update.success",defaultMessage:"更新成功"}));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),L=(0,a.useCallback)(function(){var e=c()(u()().mark((function e(t){var n,a,r,s;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(F(!0),e.prev=1,null!=m&&m.uid){e.next=5;break}return k([]),e.abrupt("return",[]);case 5:return a={pageNumber:0,pageSize:50,enabled:!0,orgUid:null==m?void 0:m.uid,searchText:t||""},e.next=8,(0,O.u9)(a);case 8:return r=e.sent,console.log("queryAgentSettingsByOrg request:",a,r),s=(null==r||null===(n=r.data)||void 0===n?void 0:n.content)||[],k(s),e.abrupt("return",s.map((function(e){return{label:"".concat(e.name||e.uid).concat(e.isDefault?" (默认)":"").concat(e.enabled?"":" (已停用)"),value:e.uid}})));case 13:return e.prev=13,F(!1),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[1,,13,16]])})));return function(t){return e.apply(this,arguments)}}(),[null==m?void 0:m.uid]);(0,a.useEffect)((function(){L()}),[L]);var N=(0,a.useMemo)((function(){return y.map((function(e){return{label:"".concat(e.name||e.uid).concat(e.isDefault?" (默认)":"").concat(e.enabled?"":" (已停用)"),value:e.uid}}))}),[y]),B=(0,a.useRef)(),V=(0,a.useCallback)((function(e){B.current&&clearTimeout(B.current),B.current=setTimeout((function(){L(e)}),300)}),[L]);(0,a.useEffect)((function(){return function(){B.current&&clearTimeout(B.current)}}),[]);var K=(0,a.useCallback)((function(){y.length||L()}),[L,y.length]);return(0,Y.jsxs)(Y.Fragment,{children:[(0,Y.jsxs)(de.a,{open:r,onOpenChange:function(e){e||l()},title:R?g.formatMessage({id:"agent.edit",defaultMessage:"编辑客服"}):g.formatMessage({id:"agent.new",defaultMessage:"新建客服"}),width:520,formRef:P,initialValues:R?{nickname:null==i?void 0:i.nickname,email:null==i?void 0:i.email,mobile:null==i?void 0:i.mobile,description:null==i?void 0:i.description,memberUid:(null==i||null===(t=i.member)||void 0===t?void 0:t.uid)||(null==i?void 0:i.memberUid),settingsUid:null==i||null===(n=i.settings)||void 0===n?void 0:n.uid}:{},autoFocusFirstInput:!0,drawerProps:{destroyOnHidden:!0,maskClosable:!0},submitter:{searchConfig:{submitText:g.formatMessage({id:"save",defaultMessage:"保存"}),resetText:g.formatMessage({id:"cancel",defaultMessage:"取消"})},resetButtonProps:{onClick:function(){return l()}}},onFinish:function(){var e=c()(u()().mark((function e(t){var n,a,r,s,o;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,z.yw.loading(g.formatMessage({id:R?"updating":"creating",defaultMessage:R?"Updating":"Creating"})),!R){e.next=10;break}return r=f()(f()(f()({},i),t),{},{avatar:I||(null==i?void 0:i.avatar)}),e.next=6,(0,ue.sE)(r);case 6:a=e.sent,console.log("updateAgent payload:",r,a),e.next=15;break;case 10:return s={nickname:t.nickname,email:t.email,mobile:t.mobile,description:t.description,memberUid:t.memberUid,settingsUid:t.settingsUid,orgUid:null==m?void 0:m.uid,avatar:I},e.next=13,(0,ue.x_)(s);case 13:a=e.sent,console.log("createAgent payload:",s,a);case 15:if(z.yw.destroy(),200!==(null===(n=a)||void 0===n?void 0:n.code)){e.next=23;break}return z.yw.success(g.formatMessage({id:"save.success",defaultMessage:"保存成功"})),null==d||d(a.data),l(),e.abrupt("return",!0);case 23:return z.yw.error((null===(o=a)||void 0===o?void 0:o.message)||g.formatMessage({id:"save.failed",defaultMessage:"保存失败"})),e.abrupt("return",!1);case 25:e.next=32;break;case 27:return e.prev=27,e.t0=e.catch(0),z.yw.destroy(),z.yw.error(g.formatMessage({id:"save.error",defaultMessage:"保存出错"})),e.abrupt("return",!1);case 32:case"end":return e.stop()}}),e,null,[[0,27]])})));return function(t){return e.apply(this,arguments)}}(),children:[(0,Y.jsx)(ce.A.Item,{name:"avatar",valuePropName:"fileList",getValueFromEvent:function(e){return Array.isArray(e)?e:null==e?void 0:e.fileList},label:g.formatMessage({id:"pages.robot.tab.avatar",defaultMessage:"Avatar"}),children:(0,Y.jsxs)(xe.G,{onSuccess:E,onError:function(e){z.yw.error(String(e))},children:[(0,Y.jsx)(le.Z,{src:I||(null==i?void 0:i.avatar)}),(0,Y.jsxs)(h.ZP,{icon:(0,Y.jsx)(ve.Z,{}),children:[" ",g.formatMessage({id:"pages.robot.upload",defaultMessage:"Upload"})]})]})}),(0,Y.jsx)(ge.Z,{name:"memberUid",label:g.formatMessage({id:"agent.info.member.bind",defaultMessage:"绑定成员"}),placeholder:g.formatMessage({id:"agent.info.member.placeholder",defaultMessage:"请选择成员"}),disabled:R,rules:R?[]:[{required:!0,message:g.formatMessage({id:"agent.info.member.required",defaultMessage:"请选择成员"})}],showSearch:!0,debounceTime:300,request:function(){var e=c()(u()().mark((function e(t){var n,a,r,s;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.keyWords,e.next=3,(0,he.z_)({pageNumber:0,pageSize:20,orgUid:null==m?void 0:m.uid,searchText:a||""});case 3:return r=e.sent,s=(null==r||null===(n=r.data)||void 0===n?void 0:n.content)||[],e.abrupt("return",s.map((function(e){return{label:e.nickname,value:e.uid}})));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),fieldProps:{filterOption:!1}}),(0,Y.jsx)(ce.A.Item,{name:"settingsUid",label:g.formatMessage({id:"agent.settings",defaultMessage:"客服配置"}),rules:[{required:!0,message:g.formatMessage({id:"agent.settings.required",defaultMessage:"请选择客服配置"})}],children:(0,Y.jsx)(Me,{options:N,loading:Z,placeholder:g.formatMessage({id:"agent.settings.placeholder",defaultMessage:"请选择客服配置"}),emptyContent:0===N.length?(0,Y.jsxs)("div",{style:{textAlign:"center",padding:"12px 0"},children:[(0,Y.jsx)("div",{style:{marginBottom:8,color:"#999"},children:g.formatMessage({id:"agent.settings.empty",defaultMessage:"暂无配置模板"})}),(0,Y.jsx)(h.ZP,{size:"small",type:"primary",icon:(0,Y.jsx)(q.Z,{}),onMouseDown:function(e){return e.preventDefault()},onClick:function(){return b(!0)},children:g.formatMessage({id:"agent.settings.create",defaultMessage:"创建配置"})})]}):void 0,onSearch:V,onDropdownOpen:K,onCreate:function(){return b(!0)},createLabel:g.formatMessage({id:"common.new",defaultMessage:"新建"}),createTitle:g.formatMessage({id:"agent.settings.create",defaultMessage:"创建配置"})})}),(0,Y.jsx)(fe.Z,{name:"nickname",label:g.formatMessage({id:"agent.info.nickname",defaultMessage:"昵称"}),rules:[{required:!0,message:g.formatMessage({id:"agent.info.nickname.required"})}]}),(0,Y.jsx)(fe.Z,{name:"email",label:g.formatMessage({id:"agent.info.email",defaultMessage:"邮箱"}),rules:[{required:!0,message:g.formatMessage({id:"agent.info.email.required"})}]}),(0,Y.jsx)(fe.Z,{name:"mobile",label:g.formatMessage({id:"agent.info.mobile",defaultMessage:"手机号"}),rules:[{required:!0,message:g.formatMessage({id:"agent.info.mobile.required"})}]}),(0,Y.jsx)(me.Z,{name:"description",label:g.formatMessage({id:"agent.info.description",defaultMessage:"描述"})})]}),(0,Y.jsx)(_,{open:M,onOpenChange:b,orgUid:(null==m?void 0:m.uid)||"",record:null,onSuccess:function(e){var t;b(!1),k((function(t){return t.find((function(t){return t.uid===e.uid}))?t.map((function(t){return t.uid===e.uid?e:t})):[e].concat(o()(t))})),L(),null===(t=P.current)||void 0===t||t.setFieldsValue({settingsUid:e.uid})}})]})},we=n(50246),Se=n(10404),ye=n(76273),ke=n(39790),je=n(90727),Ce=function(e){var t=e.open,n=e.onClose,r=e.onSubmit,i=(0,s.useIntl)(),l=ye.ZP.useForm(),d=p()(l,1)[0],g=(0,D.u)((function(e){return e.currentOrg})),m=(0,we.Z)((function(e){return e.memberResult})),v=(0,we.Z)((function(e){return e.setMemberResult})),x=(0,Se.E)((function(e){return e.agentResult})),b=(0,a.useState)(0),w=p()(b,2),S=w[0],y=w[1],k=(0,a.useState)(""),j=p()(k,2),C=j[0],Z=j[1],F=(0,a.useState)(!1),U=p()(F,2),T=U[0],q=U[1],I=(0,a.useState)([]),A=p()(I,2),P=A[0],R=A[1],E=(0,a.useRef)(null),L=(0,a.useState)(0),z=p()(L,2),N=z[0],B=z[1],V=(0,a.useState)(!0),K=p()(V,2),W=K[0],H=K[1],J=(0,a.useState)(!1),_=p()(J,2),G=_[0],X=_[1],$=(0,a.useState)(0),ee=p()($,2),te=ee[0],ne=ee[1],ae=(0,a.useState)(!0),re=p()(ae,2),se=re[0],ie=re[1],oe=(0,a.useState)(!1),le=p()(oe,2),ue=le[0],de=le[1],ce=(0,a.useState)(!1),me=p()(ce,2),pe=me[0],ve=me[1],xe=(0,a.useState)([]),Me=p()(xe,2),be=Me[0],Ce=Me[1];(0,a.useEffect)((function(){var e;t&&(console.log("Modal opened, current agent data:",x),console.log("Current member data:",m),null!=m&&null!==(e=m.data)&&void 0!==e&&e.content&&0!==m.data.content.length||c()(u()().mark((function e(){var t,n,a,r;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={pageNumber:0,pageSize:100,orgUid:null==g?void 0:g.uid},e.next=4,(0,he.z_)(n);case 4:a=e.sent,console.log("Init load members response:",a,n),(r=(null==a||null===(t=a.data)||void 0===t?void 0:t.content)||[]).length>0&&v(f()(f()({},m),{},{data:f()(f()({},null==m?void 0:m.data),{},{content:r})})),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("Init load members failed:",e.t0);case 13:case"end":return e.stop()}}),e,null,[[0,10]])})))(),c()(u()().mark((function e(){var t,n,a,r,s;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,ve(!0),n={pageNumber:0,pageSize:50,enabled:!0,orgUid:null==g?void 0:g.uid,searchText:""},e.next=5,(0,O.u9)(n);case 5:a=e.sent,r=(null==a||null===(t=a.data)||void 0===t?void 0:t.content)||[],s=r.map((function(e){return{label:"".concat(e.name||e.uid).concat(e.isDefault?" (".concat(i.formatMessage({id:"agent.settings.template.isDefault",defaultMessage:"默认"}),")"):"").concat(e.enabled?"":" (".concat(i.formatMessage({id:"app.disabled",defaultMessage:"已停用"}),")")),value:e.uid}})),Ce(s),!d.getFieldValue("settingsUid")&&s.length>0&&d.setFieldsValue({settingsUid:s[0].value}),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),console.error("Init load agent settings failed:",e.t0);case 16:return e.prev=16,ve(!1),e.finish(16);case 19:case"end":return e.stop()}}),e,null,[[0,13,16,19]])})))())}),[t,x,m]),(0,a.useEffect)((function(){return function(){E.current&&clearTimeout(E.current)}}),[]);var Ze=(0,a.useMemo)((function(){var e=x.data.content.map((function(e){var t;return(null===(t=e.member)||void 0===t?void 0:t.uid)||e.memberUid})).filter((function(e){return e}));return console.log("Existing agent member UIDs:",e),console.log("Agent result data:",x.data.content),e}),[x]),Fe=(0,a.useMemo)((function(){var e,t,n,a=[],r=C.trim()?P:(null==m||null===(e=m.data)||void 0===e?void 0:e.content)||[];console.log("Total members:",r.length),console.log("Existing agent member UIDs:",Ze),console.log("Using search results:",!!C.trim());for(var s=0;s<r.length;s++){var i=r[s];if(Ze.includes(i.uid))console.log("Filtering out member:",i.nickname,i.uid);else{var o={title:"",value:"",children:[]};(n=o).title=(t=i).nickname,n.value=t.uid,a.push(o)}}return console.log("Filtered tree data:",a),a}),[m,P,C,Ze]),Ue=function(){var e=c()(u()().mark((function e(t){var n,a,r,s,i=arguments;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.length>1&&void 0!==i[1]&&i[1],console.log("handleSearch:",t,"isLoadMore:",n),t.trim()||n){e.next=7;break}return R([]),B(0),H(!0),e.abrupt("return");case 7:return n?X(!0):q(!0),e.prev=8,a={pageNumber:n?N+1:0,pageSize:20,orgUid:null==g?void 0:g.uid,searchText:t.trim()},e.next=12,(0,he.z_)(a);case 12:r=e.sent,console.log("handleSearch Search members response:",r,a),200===r.code?(s=r.data.content||[],n?(R((function(e){return[].concat(o()(e),o()(s))})),B(N+1)):(R(s),B(0)),H(!r.data.last)):(console.error("handleSearch Search failed:",r.message),n||R([])),e.next=21;break;case 17:e.prev=17,e.t0=e.catch(8),console.error("Search error:",e.t0),n||R([]);case 21:return e.prev=21,n?X(!1):q(!1),e.finish(21);case 24:case"end":return e.stop()}}),e,null,[[8,17,21,24]])})));return function(t){return e.apply(this,arguments)}}(),Te=function(e){var t=e.target.value;Z(t),E.current&&clearTimeout(E.current),t.trim()?E.current=setTimeout((function(){Ue(t)}),300):(R([]),B(0),H(!0))},qe=function(){Ue(C)},Ie=function(){!G&&W&&C.trim()&&Ue(C,!0)},Ae=function(){var e=c()(u()().mark((function e(){var t,n,a,r;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(ue||!se){e.next=17;break}return de(!0),e.prev=2,t={pageNumber:te+1,pageSize:20,orgUid:null==g?void 0:g.uid},e.next=6,(0,he.z_)(t);case 6:n=e.sent,console.log("Load more all members response:",n),200===n.code&&(a=n.data.content||[],r=[].concat(o()(m.data.content),o()(a)),v(f()(f()({},m),{},{data:f()(f()({},m.data),{},{content:r})})),ne(te+1),ie(!n.data.last)),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(2),console.error("Load more all members error:",e.t0);case 14:return e.prev=14,de(!1),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[2,11,14,17]])})));return function(){return e.apply(this,arguments)}}();return(0,Y.jsx)("div",{children:(0,Y.jsx)(Q.Z,{title:i.formatMessage({id:"agent.create",defaultMessage:"创建客服"}),open:t,forceRender:!0,onOk:function(){console.log("handleOk"),d.validateFields().then((function(e){var t;console.log("form values:",e);var n=d.getFieldValue("memberUids"),a=d.getFieldValue("nickname"),s=d.getFieldValue("email"),i=d.getFieldValue("mobile"),o=d.getFieldValue("settingsUid"),l=C.trim()?P:(null==m||null===(t=m.data)||void 0===t?void 0:t.content)||[],u=[];if(1===n.length){var c={nickname:a,email:s,mobile:i,memberUid:n[0],orgUid:null==g?void 0:g.uid,settingsUid:o};u.push(c)}else n.forEach((function(e){var t=l.find((function(t){return t.uid===e}));if(t){var n={nickname:t.nickname,email:t.email,mobile:t.mobile,memberUid:e,orgUid:null==g?void 0:g.uid,settingsUid:o};u.push(n)}}));console.log("agents:",u),r(u)})).catch((function(e){console.log("Form errors:",e)}))},onCancel:function(){console.log("handleCancel"),n()},children:(0,Y.jsxs)(ye.ZP,{form:d,name:"agentForm",style:{maxWidth:400},submitter:!1,children:[(0,Y.jsx)(ge.Z,{label:i.formatMessage({id:"agent.settings",defaultMessage:"客服配置"}),name:"settingsUid",tooltip:i.formatMessage({id:"agent.settings.tooltip",defaultMessage:"为本次创建的客服指定配置模板"}),rules:[{required:!0,message:i.formatMessage({id:"agent.settings.required.message",defaultMessage:"请选择客服配置!"})}],fieldProps:{options:be,loading:pe,showSearch:!0,filterOption:function(e,t){var n;return null==t||null===(n=t.label)||void 0===n?void 0:n.toLowerCase().includes(e.toLowerCase())},placeholder:i.formatMessage({id:"agent.settings.placeholder",defaultMessage:"请选择客服配置"})}}),(0,Y.jsx)(ke.Z,{label:i.formatMessage({id:"agent.info.member.bind",defaultMessage:"绑定成员"}),name:"memberUids",tooltip:i.formatMessage({id:"agent.info.member.tooltip",defaultMessage:"请先到组织-》成员-》创建成员，已创建过客服的成员将被过滤"}),rules:[{required:!0,message:i.formatMessage({id:"agent.info.member.required.message",defaultMessage:"请选择成员!"})}],fieldProps:{multiple:!0,treeDefaultExpandAll:!0,placeholder:i.formatMessage({id:"agent.info.member.placeholder.multiple",defaultMessage:"请选择成员（可多选）"}),onChange:function(e){var t;console.log("onTreeSelectChange:",e),y(e.length);var n=C.trim()?P:(null==m||null===(t=m.data)||void 0===t?void 0:t.content)||[];if(0===e.length)d.setFieldsValue({nickname:"",email:"",mobile:""});else if(1===e.length){var a=n.find((function(t){return t.uid===e[0]}));a&&d.setFieldsValue({nickname:a.nickname||"",email:a.email||"",mobile:a.mobile||""})}else{var r=n.filter((function(t){return e.includes(t.uid)})),s=r.map((function(e){return e.nickname})).filter(Boolean).join(", "),i=r.map((function(e){return e.email})).filter(Boolean).join(", "),o=r.map((function(e){return e.mobile})).filter(Boolean).join(", ");d.setFieldsValue({nickname:s,email:i,mobile:o})}},treeData:Fe,variant:"outlined",popupRender:function(e){return(0,Y.jsxs)("div",{children:[(0,Y.jsx)("div",{style:{padding:"8px",borderBottom:"1px solid #f0f0f0"},children:(0,Y.jsx)(M.Z,{placeholder:i.formatMessage({id:"agent.info.member.search",defaultMessage:"搜索成员"}),value:C,onChange:Te,onPressEnter:function(){return qe()},suffix:(0,Y.jsx)(je.Z,{onClick:qe,style:{cursor:"pointer",color:T?"#1890ff":void 0},spin:T}),allowClear:!0,size:"small"})}),e,(C.trim()?W:se)&&(0,Y.jsx)("div",{style:{padding:"8px",textAlign:"center",borderTop:"1px solid #f0f0f0"},children:(0,Y.jsx)(h.ZP,{type:"link",size:"small",loading:C.trim()?G:ue,onClick:C.trim()?Ie:Ae,disabled:C.trim()?G:ue,children:(C.trim()?G:ue)?i.formatMessage({id:"loading",defaultMessage:"加载中..."}):i.formatMessage({id:"load.more",defaultMessage:"加载更多"})})})]})}}}),(0,Y.jsx)(fe.Z,{label:i.formatMessage({id:"agent.info.nickname",defaultMessage:"昵称"}),name:"nickname",disabled:S>1,tooltip:S>1?i.formatMessage({id:"agent.info.nickname.tooltip.multiple",defaultMessage:"多选模式下昵称将自动从选中的成员信息中获取"}):i.formatMessage({id:"agent.info.nickname.tooltip",defaultMessage:"昵称将自动从选中的成员信息中获取"})}),(0,Y.jsx)(fe.Z,{label:i.formatMessage({id:"agent.info.email",defaultMessage:"邮箱"}),name:"email",disabled:S>1,tooltip:S>1?i.formatMessage({id:"agent.info.email.tooltip.multiple",defaultMessage:"多选模式下邮箱将自动从选中的成员信息中获取"}):i.formatMessage({id:"agent.info.email.tooltip",defaultMessage:"邮箱将自动从选中的成员信息中获取"})}),(0,Y.jsx)(fe.Z,{label:i.formatMessage({id:"agent.info.mobile",defaultMessage:"手机号"}),name:"mobile",disabled:S>1,tooltip:S>1?i.formatMessage({id:"agent.info.mobile.tooltip.multiple",defaultMessage:"多选模式下手机号将自动从选中的成员信息中获取"}):i.formatMessage({id:"agent.info.mobile.tooltip",defaultMessage:"手机号将自动从选中的成员信息中获取"})})]})})})},Ze=function(){var e=(0,s.useIntl)(),t=(0,a.useRef)(),n=(0,D.u)((function(e){return e.currentOrg})),r=(0,a.useState)(!1),i=p()(r,2),o=i[0],l=i[1],d=(0,a.useState)(!1),g=p()(d,2),m=g[0],v=g[1],x=(0,a.useState)(null),M=p()(x,2),b=M[0],w=M[1],y=[{dataIndex:"index",valueType:"indexBorder",width:48,fixed:"left"},{title:e.formatMessage({id:"nickname",defaultMessage:"Nickname"}),dataIndex:"nickname",copyable:!0,ellipsis:!0,fixed:"left",hideInSearch:!0},{title:e.formatMessage({id:"avatar",defaultMessage:"Avatar"}),dataIndex:"avatar",width:64,hideInSearch:!0,render:function(e,t){return(0,Y.jsx)(le.Z,{src:null==t?void 0:t.avatar})}},{title:e.formatMessage({id:"uid",defaultMessage:"Uid"}),dataIndex:"uid",copyable:!0,width:220,hideInSearch:!0},{title:e.formatMessage({id:"agent.reception.status",defaultMessage:"接待状态"}),dataIndex:"status",width:140,hideInSearch:!0,render:function(t,n){switch(null==n?void 0:n.status){case V.Ra4:return(0,Y.jsx)(S.Z,{color:"green",children:e.formatMessage({id:"agent.status.online",defaultMessage:"Online"})});case V.tU$:return(0,Y.jsx)(S.Z,{color:"orange",children:e.formatMessage({id:"agent.status.busy",defaultMessage:"Busy"})});case V.LZ1:default:return(0,Y.jsx)(S.Z,{color:"red",children:e.formatMessage({id:"agent.status.offline",defaultMessage:"Offline"})})}}},{title:e.formatMessage({id:"agent.connection.status",defaultMessage:"连接状态"}),dataIndex:"connected",width:140,hideInSearch:!0,render:function(t,n){return null!=n&&n.connected?(0,Y.jsx)(S.Z,{color:"green",children:e.formatMessage({id:"agent.connection.success",defaultMessage:"Connected"})}):(0,Y.jsx)(S.Z,{color:"red",children:e.formatMessage({id:"agent.connection.failed",defaultMessage:"Disconnected"})})}},{title:e.formatMessage({id:"agent.queue.stats",defaultMessage:"队列统计"}),dataIndex:"queueStats",width:280,hideInSearch:!0,render:function(t,n){var a,r,s,i=null==n?void 0:n.queueStats;return i?(0,Y.jsxs)("span",{style:{fontSize:12},children:[(0,Y.jsxs)(S.Z,{color:"blue",children:[e.formatMessage({id:"agent.queue.today",defaultMessage:"今日"}),": ",null!==(a=i.agentServedCount)&&void 0!==a?a:0]}),(0,Y.jsxs)(S.Z,{color:"orange",children:[e.formatMessage({id:"agent.queue.queuing",defaultMessage:"排队中"}),": ",null!==(r=i.queuingCount)&&void 0!==r?r:0]}),(0,Y.jsxs)(S.Z,{color:"green",children:[e.formatMessage({id:"agent.queue.chatting",defaultMessage:"接待中"}),": ",null!==(s=i.chattingCount)&&void 0!==s?s:0]})]}):(0,Y.jsx)("span",{style:{color:"#999"},children:"-"})}},{title:e.formatMessage({id:"agent.settings",defaultMessage:"客服配置"}),dataIndex:"settings",width:200,hideInSearch:!0,render:function(t,n){return null!=n&&n.settings?(0,Y.jsx)("a",{onClick:function(){w(n),l(!0)},children:n.settings.name||e.formatMessage({id:"agent.settings.configured",defaultMessage:"已配置"})}):(0,Y.jsx)("a",{style:{color:"#ff4d4f"},onClick:function(){w(n),l(!0)},children:e.formatMessage({id:"agent.settings.unconfigured",defaultMessage:"未配置，点击配置"})})}},{title:e.formatMessage({id:"description",defaultMessage:"Description"}),dataIndex:"description",ellipsis:!0,hideInSearch:!0},{title:e.formatMessage({id:"createdAt",defaultMessage:"Created At"}),dataIndex:"createdAt",width:180,sorter:!0,hideInSearch:!0},{title:e.formatMessage({id:"updatedAt",defaultMessage:"Updated At"}),dataIndex:"updatedAt",width:180,sorter:!0,hideInSearch:!0},{title:e.formatMessage({id:"actions",defaultMessage:"Actions"}),valueType:"option",key:"option",width:260,fixed:"right",render:function(a,r){return[(0,Y.jsx)("a",{onClick:function(){return function(t){var a;if(null!=t&&t.uid){var r={chatConfig:{org:null==n?void 0:n.uid,t:V._0X,sid:t.uid}};null===(a=window.bytedesk)||void 0===a||a.showChat(r)}else z.yw.error(e.formatMessage({id:"agent.invalid",defaultMessage:"无效的客服"}))}(r)},children:e.formatMessage({id:"chat.test",defaultMessage:"测试"})},"test"),(0,Y.jsx)("a",{onClick:function(){return s.history.push("/service/channel")},children:e.formatMessage({id:"agent.get.code",defaultMessage:"获取客服代码"})},"code"),(0,Y.jsx)("a",{onClick:function(){w(r),l(!0)},children:e.formatMessage({id:"edit",defaultMessage:"编辑"})},"edit"),(0,Y.jsx)(k.Z,{title:e.formatMessage({id:"deleteTip",defaultMessage:"删除确认"}),description:"".concat(e.formatMessage({id:"deleteAffirm",defaultMessage:"确认删除"}),"【").concat(null==r?void 0:r.nickname,"】？"),onConfirm:c()(u()().mark((function n(){var a,s;return u()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return z.yw.loading(e.formatMessage({id:"deleting",defaultMessage:"Deleting..."})),n.prev=1,n.next=4,(0,ue.Lr)(r);case 4:a=n.sent,z.yw.destroy(),200===(null==a?void 0:a.code)?(z.yw.success(e.formatMessage({id:"delete.success",defaultMessage:"Delete success"})),null===(s=t.current)||void 0===s||s.reload()):z.yw.error((null==a?void 0:a.message)||"Delete failed"),n.next=13;break;case 9:n.prev=9,n.t0=n.catch(1),z.yw.destroy(),z.yw.error("Delete error");case 13:case"end":return n.stop()}}),n,null,[[1,9]])}))),okText:e.formatMessage({id:"ok",defaultMessage:"OK"}),cancelText:e.formatMessage({id:"cancel",defaultMessage:"Cancel"}),children:(0,Y.jsx)("a",{children:e.formatMessage({id:"delete",defaultMessage:"删除"})})},"delete")]}},{title:e.formatMessage({id:"search",defaultMessage:"Search"}),dataIndex:"searchText",valueType:"text",hideInTable:!0,hideInSearch:!1}];return(0,Y.jsxs)(Y.Fragment,{children:[(0,Y.jsx)(oe.Z,{columns:y,actionRef:t,rowKey:"uid",cardBordered:!0,scroll:{x:"max-content"},search:{labelWidth:"auto"},toolBarRender:function(){return[(0,Y.jsx)(h.ZP,{type:"primary",onClick:function(){w(null),v(!0)},children:e.formatMessage({id:"pages.robot.new",defaultMessage:"New"})},"new")]},request:function(){var e=c()(u()().mark((function e(t,a){var r,s,i,o,l,d,c,g,m,v,h,x,M,b,w,S,y,k,j,C,Z,F;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=(null!==(r=null==t?void 0:t.current)&&void 0!==r?r:1)-1,l=null!==(s=null==t?void 0:t.pageSize)&&void 0!==s?s:10,d=null!==(i=null==t?void 0:t.searchText)&&void 0!==i?i:"",(m=Object.entries(a||{})).length>0&&(v=m[0],h=p()(v,2),x=h[0],(M=h[1])&&(c=x,g="ascend"===M?"ascend":"descend")),b=f()(f()({pageNumber:o,pageSize:l,orgUid:null==n?void 0:n.uid,searchText:d},c?{sortBy:c}:{}),g?{sortDirection:g}:{}),e.prev=6,e.next=9,(0,ue._t)(b);case 9:if(w=e.sent,ae.Z.debug("queryAgentsByOrg response:",w,b),200!==(null==w?void 0:w.code)){e.next=15;break}return Z=(null==w||null===(S=w.data)||void 0===S?void 0:S.content)||[],F=null!==(y=null!==(k=null==w||null===(j=w.data)||void 0===j?void 0:j.totalElements)&&void 0!==k?k:null==w||null===(C=w.data)||void 0===C?void 0:C.numberOfElements)&&void 0!==y?y:Z.length,e.abrupt("return",{data:Z,total:F,success:!0});case 15:return e.abrupt("return",{data:[],total:0,success:!1});case 18:return e.prev=18,e.t0=e.catch(6),e.abrupt("return",{data:[],total:0,success:!1});case 21:case"end":return e.stop()}}),e,null,[[6,18]])})));return function(t,n){return e.apply(this,arguments)}}(),pagination:{showQuickJumper:!0},dateFormatter:"string",headerTitle:e.formatMessage({id:"agent",defaultMessage:"Agent"})}),o&&(0,Y.jsx)(be,{open:o,record:b,onClose:function(){return l(!1)},onSuccess:function(){var e;return null===(e=t.current)||void 0===e?void 0:e.reload()}}),m&&(0,Y.jsx)(Ce,{open:m,onClose:function(){return v(!1)},onSubmit:function(){var n=c()(u()().mark((function n(a){var r,s,i,o,l,d,c,g,f,m,p,h,x,M,b,w;return u()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!(((null==a?void 0:a.length)||0)>200)){n.next=3;break}return z.yw.warning(e.formatMessage({id:"agent.create.batch.limit",defaultMessage:"超过最大批量 200，请分批创建"})),n.abrupt("return");case 3:r="agent-batch-create",z.yw.loading({content:e.formatMessage({id:"saving",defaultMessage:"Saving..."}),key:r,duration:0}),s=[],i=function(e){return new Promise((function(t){return setTimeout(t,e)}))},o=ie()(a),n.prev=8,o.s();case 10:if((l=o.n()).done){n.next=52;break}d=l.value,c=0,g=!1,f=null;case 15:if(!(c<3)||g){n.next=49;break}return n.prev=16,n.next=19,(0,ue.x_)(d);case 19:if(200!==(null==(m=n.sent)?void 0:m.code)){n.next=24;break}return s.push({uid:d.memberUid,ok:!0}),g=!0,n.abrupt("break",49);case 24:return s.push({uid:d.memberUid,ok:!1,code:null==m?void 0:m.code,msg:null==m?void 0:m.message}),g=!0,n.abrupt("break",49);case 29:if(n.prev=29,n.t0=n.catch(16),h=null===n.t0||void 0===n.t0||null===(p=n.t0.response)||void 0===p?void 0:p.status,f=n.t0,c+=1,!(409===h&&c<3)){n.next=40;break}return n.next=37,i(300*c);case 37:return n.abrupt("continue",15);case 40:if(502!==h&&503!==h&&504!==h||!(c<3)){n.next=44;break}return n.next=43,i(300*c);case 43:return n.abrupt("continue",15);case 44:return s.push({uid:d.memberUid,ok:!1,code:h,msg:(null===n.t0||void 0===n.t0?void 0:n.t0.message)||"error"}),g=!0,n.abrupt("break",49);case 47:n.next=15;break;case 49:!g&&f&&s.push({uid:d.memberUid,ok:!1,msg:(null===(x=f)||void 0===x?void 0:x.message)||"error"});case 50:n.next=10;break;case 52:n.next=57;break;case 54:n.prev=54,n.t1=n.catch(8),o.e(n.t1);case 57:return n.prev=57,o.f(),n.finish(57);case 60:M=s.filter((function(e){return e.ok})).length,b=s.length-M,M>0?(z.yw.success({content:e.formatMessage({id:"create.success",defaultMessage:"Create success"})+" (".concat(M,")"),key:r}),v(!1),null===(w=t.current)||void 0===w||w.reload()):z.yw.destroy(r),b>0&&z.yw.warning(e.formatMessage({id:"create.partial.failed",defaultMessage:"部分创建失败，请查看失败项并重试"})+" (".concat(b,")"));case 64:case"end":return n.stop()}}),n,null,[[8,54,57,60],[16,29]])})));return function(e){return n.apply(this,arguments)}}()})]})},Fe=n(84176),Ue=n.n(Fe);function Te(e){return qe.apply(this,arguments)}function qe(){return(qe=c()(u()().mark((function e(t){return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,s.request)("/api/v1/agent/status/query/org",{method:"GET",params:f()(f()({},t),{},{channel:V.XtJ})}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Ie=n(5932),Ae=n(61107),Pe=n(96596),Re=n.n(Pe),Ee=["current","pageSize"],Le=function(){var e=(0,s.useIntl)(),t=(0,a.useRef)(),n=(0,a.useState)(1),r=p()(n,2),i=r[0],o=r[1],l=(0,a.useState)(10),d=p()(l,2),g=d[0],m=d[1],v=(0,D.u)((function(e){return e.currentOrg})),x=[{dataIndex:"index",valueType:"indexBorder"},{title:(0,Y.jsx)(s.FormattedMessage,{id:"nickname",defaultMessage:"Nickname"}),dataIndex:"agent",copyable:!0,tooltip:(0,Y.jsx)(s.FormattedMessage,{id:"agent.tooltip.nickname"}),render:function(e,t){var n;return(0,Y.jsx)(Y.Fragment,{children:null==t||null===(n=t.agent)||void 0===n?void 0:n.nickname})}},{title:(0,Y.jsx)(s.FormattedMessage,{id:"status",defaultMessage:"Status"}),dataIndex:"status",copyable:!0,hideInSearch:!1,tooltip:(0,Y.jsx)(s.FormattedMessage,{id:"agent.tooltip.status"}),valueEnum:{AVAILABLE:{text:e.formatMessage({id:"agent.status.available"}),status:"Success"},OFFLINE:{text:e.formatMessage({id:"agent.status.offline"}),status:"Error"},BUSY:{text:e.formatMessage({id:"agent.status.busy"}),status:"Warning"}},render:function(e,t){return"AVAILABLE"===t.status?(0,Y.jsx)(S.Z,{color:"green",children:(0,Y.jsx)(s.FormattedMessage,{id:"agent.status.available"})}):"OFFLINE"===t.status?(0,Y.jsx)(S.Z,{color:"red",children:(0,Y.jsx)(s.FormattedMessage,{id:"agent.status.offline"})}):"BUSY"===t.status?(0,Y.jsx)(S.Z,{color:"orange",children:(0,Y.jsx)(s.FormattedMessage,{id:"agent.status.busy"})}):void 0}},{title:(0,Y.jsx)(s.FormattedMessage,{id:"createdAt",defaultMessage:"createdAt"}),key:"createdAt",dataIndex:"createdAt",sorter:!0,sortDirections:["descend","ascend"],hideInSearch:!0,tooltip:(0,Y.jsx)(s.FormattedMessage,{id:"agent.tooltip.createdAt"}),render:function(e,t,n,a){return Re()(t.createdAt).format("YYYY-MM-DD HH:mm:ss")}}],M=function(){var e=c()(u()().mark((function e(){var t;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("handleExportExcel",i,g),t=localStorage.getItem(V.LA8),window.open((0,Ie.kG)()+"/api/v1/agent/status/export?"+new URLSearchParams({orgUid:(null==v?void 0:v.uid)||"",pageNumber:String(i-1),pageSize:String(g),accessToken:t||""}).toString());case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,Y.jsx)(oe.Z,{columns:x,actionRef:t,cardBordered:!0,rowClassName:function(){return"cursor-pointer"},request:function(){var e=c()(u()().mark((function e(t,n,a){var r,s,i,l,d;return u()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("request:",t,n,a),r=t.current,s=t.pageSize,i=Ue()(t,Ee),o(r),m(s),l=f()({pageNumber:r-1,pageSize:s,orgUid:null==v?void 0:v.uid},i),e.next=7,Te(l);case 7:return d=e.sent,console.log("queryAgentStatusByOrg response:",l,d),200===d.code||z.yw.error(d.message),e.abrupt("return",{data:d.data.content,success:!0,total:d.data.totalElements});case 11:case"end":return e.stop()}}),e)})));return function(t,n,a){return e.apply(this,arguments)}}(),editable:{type:"multiple"},rowKey:"uid",search:{labelWidth:"auto"},pagination:{showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],onChange:function(e,t){o(e),m(t)}},dateFormatter:"string",headerTitle:e.formatMessage({id:"agent.status.list"}),toolBarRender:function(){return[(0,Y.jsx)(h.ZP,{onClick:function(){t.current&&t.current.reload()},icon:(0,Y.jsx)(R.Z,{}),children:(0,Y.jsx)(s.FormattedMessage,{id:"refresh",defaultMessage:"Refresh"})},"refresh"),(0,Y.jsx)(h.ZP,{onClick:M,type:"primary",icon:(0,Y.jsx)(Ae.Z,{}),children:(0,Y.jsx)(s.FormattedMessage,{id:"export.excel",defaultMessage:"Export Excel"})},"export")]}})},ze=function(){return(0,Y.jsx)(r.Z,{defaultActiveKey:"table",style:{padding:"10px"},items:[{key:"table",label:(0,Y.jsx)(s.FormattedMessage,{id:"menu.agent.table",defaultMessage:"客服账号"}),children:(0,Y.jsx)(Ze,{})},{key:"settings",label:(0,Y.jsx)(s.FormattedMessage,{id:"menu.agent.settings",defaultMessage:"客服配置"}),children:(0,Y.jsx)(re,{})},{key:"agentStatus",label:(0,Y.jsx)(s.FormattedMessage,{id:"action.tab.agentStatus",defaultMessage:"Agent Status"}),children:(0,Y.jsx)(Le,{})}]})}},50246:function(e,t,n){n.d(t,{Z:function(){return o}});var a=n(39497),r=n(58063),s=n(66266),i=n(31403),o=(0,r.Ue)()((0,s.mW)((0,s.tJ)((0,i.n)((function(e,t){return{memberResult:{data:{content:[],totalElements:0}},insertMember:function(t){e((function(e){e.memberResult.data.content.unshift(t)}))},updateMember:function(t){e((function(e){var n=e.memberResult.data.content,a=n.findIndex((function(e){return e.uid===t.uid}));-1!==a?n[a]=t:console.warn("Member with uid ".concat(t.uid," not found."))}))},deleteMember:function(t){e((function(e){var n=e.memberResult.data.content,a=n.findIndex((function(e){return e.uid===t.uid}));-1!==a?n.splice(a,1):console.warn("Member with uid ".concat(t.uid," not found."))}))},setMemberResult:function(t){e({memberResult:t})},deleteMemberCache:function(){return e({},!0)}}})),{name:a.PQL})))}}]);