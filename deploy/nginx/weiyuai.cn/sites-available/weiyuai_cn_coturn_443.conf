#
# HTTPS server for coturn.weiyuai.cn - Coturn Monitoring and Testing
#
# 注意：Coturn 是 STUN/TURN 服务器（UDP/TCP），不是 HTTP 服务器
# Nginx 无法直接代理 STUN/TURN 协议
# 此配置仅提供监控接口和测试页面的 HTTPS 访问
# 
# urls: "stun:coturn.weiyuai.cn:3478"
# urls: "turn:coturn.weiyuai.cn:3478"
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    ssl_certificate /etc/letsencrypt/live/weiyuai.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/weiyuai.cn/privkey.pem;

    # urls: "stun:coturn.weiyuai.cn:3478"
    # urls: "turn:coturn.weiyuai.cn:3478"
    server_name coturn.weiyuai.cn;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    # Enforce HTTPS on this subdomain
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Web Admin 管理界面（需要在 turnserver.conf 中启用 web-admin）
    # 在 /etc/turnserver.conf 中添加:
    # web-admin
    # web-admin-ip=0.0.0.0
    # web-admin-port=8080
    location /admin {
        # 注意：Web Admin 使用 HTTPS
        # 若后端 web-admin 使用 HTTPS:
        proxy_pass https://14.103.165.199:8080;
        # 若后端为 HTTP，请使用如下（保留一份注释以便切换）：
        # proxy_pass http://14.103.165.199:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # SSL 验证（如果后端使用自签名证书，可能需要禁用）
        proxy_ssl_verify off;
        # 如果启用验证，可指定 SNI：
        # proxy_ssl_server_name on;
        # proxy_ssl_name coturn.weiyuai.cn;
        
        # 基础认证（建议启用）
        # auth_basic "Coturn Admin";
        # auth_basic_user_file /etc/nginx/.htpasswd;
        # 或者基于 IP 访问控制（示例）：
        # allow 10.0.0.0/8;
        # allow 192.168.0.0/16;
        # deny all;
    }

    # WebRTC 测试页面 - 代理到远程服务器
    location /test {
        proxy_pass http://14.103.165.199/test_coturn.html;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://coturn.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://coturn.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }
    
    # 服务信息和使用说明（备用路径）
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Coturn STUN/TURN Server</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 20px; }
        .info { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .warning {
            background: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        code { 
            background: #f5f5f5; 
            padding: 2px 6px; 
            border-radius: 3px;
            font-family: monospace;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        a { color: #2196f3; text-decoration: none; }
        a:hover { text-decoration: underline; }
        ul { line-height: 1.8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔌 Coturn STUN/TURN Server</h1>
        
        <div class="warning">
            <strong>⚠️ 重要提示：</strong> Coturn 是 STUN/TURN 服务器，使用 UDP/TCP 协议，不是 HTTP 服务器。
            无法通过浏览器直接访问 STUN/TURN 端口。
        </div>

        <h2>📋 服务器配置</h2>
        <div class="info">
            <strong>STUN 服务器：</strong><br>
            <code>stun:14.103.165.199:3478</code><br><br>
            
            <strong>TURN 服务器：</strong><br>
            <code>turn:14.103.165.199:3478</code><br>
            用户名: <code>username1</code><br>
            密码: <code>password1</code>
        </div>

        <h2>🧪 测试方法</h2>
        <ul>
            <li><a href="/test" target="_blank">本地测试工具</a> - 使用我们提供的测试页面</li>
            <li><a href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/" target="_blank">WebRTC 官方测试</a> - 使用官方测试工具</li>
            <li><a href="/metrics" target="_blank">Prometheus 监控</a> - 查看服务器监控数据（需先启用）</li>
        </ul>

        <h2>💻 WebRTC 配置示例</h2>
        <pre>const config = {
  iceServers: [
    {
      urls: "stun:14.103.165.199:3478"
    },
    {
      urls: "turn:14.103.165.199:3478",
      username: "username1",
      credential: "password1"
    }
  ]
};

const pc = new RTCPeerConnection(config);</pre>

        <h2>📚 更多信息</h2>
        <ul>
            <li><a href="https://github.com/coturn/coturn" target="_blank">Coturn 官方文档</a></li>
            <li><a href="https://webrtc.org/" target="_blank">WebRTC 官网</a></li>
        </ul>
    </div>
</body>
</html>';
    }

    # 简单健康检查端点
    location = /health {
        default_type text/plain;
        return 200 'ok';
    }
}
