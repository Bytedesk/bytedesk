#
# HTTPS server for coturn.weiyuai.cn - Coturn Monitoring and Testing
#
# æ³¨æ„ï¼šCoturn æ˜¯ STUN/TURN æœåŠ¡å™¨ï¼ˆUDP/TCPï¼‰ï¼Œä¸æ˜¯ HTTP æœåŠ¡å™¨
# Nginx æ— æ³•ç›´æ¥ä»£ç† STUN/TURN åè®®
# æ­¤é…ç½®ä»…æä¾›ç›‘æ§æ¥å£å’Œæµ‹è¯•é¡µé¢çš„ HTTPS è®¿é—®
# 
# urls: "stun:coturn.weiyuai.cn:3478"
# urls: "turn:coturn.weiyuai.cn:3478"
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    ssl_certificate /etc/letsencrypt/live/weiyuai.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/weiyuai.cn/privkey.pem;

    # urls: "stun:coturn.weiyuai.cn:3478"
    # urls: "turn:coturn.weiyuai.cn:3478"
    server_name coturn.weiyuai.cn;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    # Enforce HTTPS on this subdomain
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Web Admin ç®¡ç†ç•Œé¢ï¼ˆéœ€è¦åœ¨ turnserver.conf ä¸­å¯ç”¨ web-adminï¼‰
    # åœ¨ /etc/turnserver.conf ä¸­æ·»åŠ :
    # web-admin
    # web-admin-ip=0.0.0.0
    # web-admin-port=8080
    location /admin {
        # æ³¨æ„ï¼šWeb Admin ä½¿ç”¨ HTTPS
        # è‹¥åç«¯ web-admin ä½¿ç”¨ HTTPS:
        proxy_pass https://14.103.165.199:8080;
        # è‹¥åç«¯ä¸º HTTPï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹ï¼ˆä¿ç•™ä¸€ä»½æ³¨é‡Šä»¥ä¾¿åˆ‡æ¢ï¼‰ï¼š
        # proxy_pass http://14.103.165.199:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # SSL éªŒè¯ï¼ˆå¦‚æœåç«¯ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œå¯èƒ½éœ€è¦ç¦ç”¨ï¼‰
        proxy_ssl_verify off;
        # å¦‚æœå¯ç”¨éªŒè¯ï¼Œå¯æŒ‡å®š SNIï¼š
        # proxy_ssl_server_name on;
        # proxy_ssl_name coturn.weiyuai.cn;
        
        # åŸºç¡€è®¤è¯ï¼ˆå»ºè®®å¯ç”¨ï¼‰
        # auth_basic "Coturn Admin";
        # auth_basic_user_file /etc/nginx/.htpasswd;
        # æˆ–è€…åŸºäº IP è®¿é—®æ§åˆ¶ï¼ˆç¤ºä¾‹ï¼‰ï¼š
        # allow 10.0.0.0/8;
        # allow 192.168.0.0/16;
        # deny all;
    }

    # WebRTC æµ‹è¯•é¡µé¢ - ä»£ç†åˆ°è¿œç¨‹æœåŠ¡å™¨
    location /test {
        proxy_pass http://14.103.165.199/test_coturn.html;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://coturn.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://coturn.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }
    
    # æœåŠ¡ä¿¡æ¯å’Œä½¿ç”¨è¯´æ˜ï¼ˆå¤‡ç”¨è·¯å¾„ï¼‰
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Coturn STUN/TURN Server</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 20px; }
        .info { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .warning {
            background: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        code { 
            background: #f5f5f5; 
            padding: 2px 6px; 
            border-radius: 3px;
            font-family: monospace;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        a { color: #2196f3; text-decoration: none; }
        a:hover { text-decoration: underline; }
        ul { line-height: 1.8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ Coturn STUN/TURN Server</h1>
        
        <div class="warning">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> Coturn æ˜¯ STUN/TURN æœåŠ¡å™¨ï¼Œä½¿ç”¨ UDP/TCP åè®®ï¼Œä¸æ˜¯ HTTP æœåŠ¡å™¨ã€‚
            æ— æ³•é€šè¿‡æµè§ˆå™¨ç›´æ¥è®¿é—® STUN/TURN ç«¯å£ã€‚
        </div>

        <h2>ğŸ“‹ æœåŠ¡å™¨é…ç½®</h2>
        <div class="info">
            <strong>STUN æœåŠ¡å™¨ï¼š</strong><br>
            <code>stun:14.103.165.199:3478</code><br><br>
            
            <strong>TURN æœåŠ¡å™¨ï¼š</strong><br>
            <code>turn:14.103.165.199:3478</code><br>
            ç”¨æˆ·å: <code>username1</code><br>
            å¯†ç : <code>password1</code>
        </div>

        <h2>ğŸ§ª æµ‹è¯•æ–¹æ³•</h2>
        <ul>
            <li><a href="/test" target="_blank">æœ¬åœ°æµ‹è¯•å·¥å…·</a> - ä½¿ç”¨æˆ‘ä»¬æä¾›çš„æµ‹è¯•é¡µé¢</li>
            <li><a href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/" target="_blank">WebRTC å®˜æ–¹æµ‹è¯•</a> - ä½¿ç”¨å®˜æ–¹æµ‹è¯•å·¥å…·</li>
            <li><a href="/metrics" target="_blank">Prometheus ç›‘æ§</a> - æŸ¥çœ‹æœåŠ¡å™¨ç›‘æ§æ•°æ®ï¼ˆéœ€å…ˆå¯ç”¨ï¼‰</li>
        </ul>

        <h2>ğŸ’» WebRTC é…ç½®ç¤ºä¾‹</h2>
        <pre>const config = {
  iceServers: [
    {
      urls: "stun:14.103.165.199:3478"
    },
    {
      urls: "turn:14.103.165.199:3478",
      username: "username1",
      credential: "password1"
    }
  ]
};

const pc = new RTCPeerConnection(config);</pre>

        <h2>ğŸ“š æ›´å¤šä¿¡æ¯</h2>
        <ul>
            <li><a href="https://github.com/coturn/coturn" target="_blank">Coturn å®˜æ–¹æ–‡æ¡£</a></li>
            <li><a href="https://webrtc.org/" target="_blank">WebRTC å®˜ç½‘</a></li>
        </ul>
    </div>
</body>
</html>';
    }

    # ç®€å•å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location = /health {
        default_type text/plain;
        return 200 'ok';
    }
}
