#
# HTTPS server for janus.weiyuai.cn - proxy to Janus server
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    ssl_certificate /etc/letsencrypt/live/weiyuai.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/weiyuai.cn/privkey.pem;

    server_name janus.weiyuai.cn;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    # Enforce HTTPS on this subdomain
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Janus HTTP API
    location /janus {
        proxy_pass http://121.36.247.120:8088;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # Janus Admin HTTP API - more specific path first
    location /admin/ {
        proxy_pass http://121.36.247.120:7088/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # Janus Admin HTTP API - exact path
    location = /admin {
        proxy_pass http://121.36.247.120:7088;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # Janus WebSocket API (both WS and WSS use same backend)
    location /janus/ {
        proxy_pass http://121.36.247.120:8188/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_connect_timeout 60s;
        proxy_buffering off;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # Janus Admin WebSocket API (port 7188)
    location /admin-ws/ {
        proxy_pass http://121.36.247.120:7188/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_connect_timeout 60s;
        proxy_buffering off;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # Static file serving for Janus demos
    location /demos {
        alias /var/www/html/janus;
        index index.html index.htm;
        
        # Enable directory listing (optional)
        autoindex on;
        autoindex_format html;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # CORS headers for demos
        add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://janus.weiyuai.cn" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
        
        # Try to serve file directly, fallback to index.html
        try_files $uri $uri/ /demos/index.html;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # 默认根路径：返回服务说明页
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Janus WebRTC Gateway</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 24px; }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 16px 0;
            border-left: 4px solid #2196f3;
        }
        .warning {
            background: #fff3e0;
            padding: 15px;
            border-radius: 6px;
            margin: 16px 0;
            border-left: 4px solid #ff9800;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        a { color: #2196f3; text-decoration: none; }
        a:hover { text-decoration: underline; }
        ul { line-height: 1.8; }
    </style>
    
</head>
<body>
    <div class="container">
        <h1>🚪 Janus WebRTC Gateway</h1>

        <div class="warning">
            <strong>提示：</strong> 这是反向代理到 Janus 的 HTTPS 入口。媒体传输使用 UDP/TCP 端口，由 Janus/插件直接处理，非通过本页面。
        </div>

        <h2>可用端点</h2>
        <div class="info">
            <ul>
                <li>HTTP API：<code>https://janus.weiyuai.cn/janus</code></li>
                <li>Admin API：<code>https://janus.weiyuai.cn/admin</code></li>
                <li>WebSocket API：<code>wss://janus.weiyuai.cn/janus/</code></li>
                <li>Admin WebSocket：<code>wss://janus.weiyuai.cn/admin-ws/</code></li>
                <li>Demos：<a href="/demos/" target="_blank">/demos/</a></li>
                <li>健康检查：<a href="/health" target="_blank">/health</a></li>
            </ul>
        </div>

        <h2>快速测试（WebSocket）</h2>
        <pre>const ws = new WebSocket("wss://janus.weiyuai.cn/janus/");
ws.onopen = () => {
  // 发送创建会话请求（示例，实际需生成唯一事务ID）
  ws.send(JSON.stringify({
    janus: "create",
    transaction: "tx-123456"
  }));
};
ws.onmessage = (evt) => console.log("Janus:", evt.data);
ws.onerror = (e) => console.error("WS error", e);
        </pre>

        <h2>参考</h2>
        <ul>
            <li><a href="https://janus.conf.meetecho.com/" target="_blank">Janus 官方站点</a></li>
            <li><a href="https://github.com/meetecho/janus-gateway" target="_blank">GitHub - janus-gateway</a></li>
            <li><a href="/demos/" target="_blank">本机 Demos 集合</a></li>
        </ul>
    </div>
</body>
</html>';
    }
} 